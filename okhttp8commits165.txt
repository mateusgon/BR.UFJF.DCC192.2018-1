/Fim/
diff --git a/src/main/java/libcore/net/http/HeaderParser.java b/src/main/java/libcore/net/http/HeaderParser.java
index 4a4ac2a..2da4e1d 100644
--- a/src/main/java/libcore/net/http/HeaderParser.java
+++ b/src/main/java/libcore/net/http/HeaderParser.java
@@ -66,60 +66,11 @@
     }
 
     /**
-     * Parse RFC 2617 challenges. This API is only interested in the scheme
-     * name and realm.
-     */
-    public static List<Challenge> parseChallenges(
-            RawHeaders responseHeaders, String challengeHeader) {
-        /*
-         * auth-scheme = token
-         * auth-param  = token "=" ( token | quoted-string )
-         * challenge   = auth-scheme 1*SP 1#auth-param
-         * realm       = "realm" "=" realm-value
-         * realm-value = quoted-string
-         */
-        List<Challenge> result = new ArrayList<Challenge>();
-        for (int h = 0; h < responseHeaders.length(); h++) {
-            if (!challengeHeader.equalsIgnoreCase(responseHeaders.getFieldName(h))) {
-                continue;
-            }
-            String value = responseHeaders.getValue(h);
-            int pos = 0;
-            while (pos < value.length()) {
-                int tokenStart = pos;
-                pos = skipUntil(value, pos, " ");
-
-                String scheme = value.substring(tokenStart, pos).trim();
-                pos = skipWhitespace(value, pos);
-
-                // TODO: This currently only handles schemes with a 'realm' parameter;
-                //       It needs to be fixed to handle any scheme and any parameters
-                //       http://code.google.com/p/android/issues/detail?id=11140
-
-                if (!value.regionMatches(pos, "realm=\"", 0, "realm=\"".length())) {
-                    break; // unexpected challenge parameter; give up
-                }
-
-                pos += "realm=\"".length();
-                int realmStart = pos;
-                pos = skipUntil(value, pos, "\"");
-                String realm = value.substring(realmStart, pos);
-                pos++; // consume '"' close quote
-                pos = skipUntil(value, pos, ",");
-                pos++; // consume ',' comma
-                pos = skipWhitespace(value, pos);
-                result.add(new Challenge(scheme, realm));
-            }
-        }
-        return result;
-    }
-
-    /**
      * Returns the next index in {@code input} at or after {@code pos} that
      * contains a character from {@code characters}. Returns the input length if
      * none of the requested characters can be found.
      */
-    private static int skipUntil(String input, int pos, String characters) {
+    public static int skipUntil(String input, int pos, String characters) {
         for (; pos < input.length(); pos++) {
             if (characters.indexOf(input.charAt(pos)) != -1) {
                 break;
@@ -132,7 +83,7 @@
      * Returns the next non-whitespace character in {@code input} that is white
      * space. Result is undefined if input contains newline characters.
      */
-    private static int skipWhitespace(String input, int pos) {
+    public static int skipWhitespace(String input, int pos) {
         for (; pos < input.length(); pos++) {
             char c = input.charAt(pos);
             if (c != ' ' && c != '\t') {
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpAuthenticator.java b/src/main/java/libcore/net/http/HttpAuthenticator.java
new file mode 100644
index 0000000..8404e2b
--- /dev/null
+++ b/src/main/java/libcore/net/http/HttpAuthenticator.java
@@ -0,0 +1,183 @@
+/*
+ * Copyright (C) 2012 Square, Inc.
+ * Copyright (C) 2011 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package libcore.net.http;
+
+import static com.squareup.okhttp.OkHttpConnection.HTTP_PROXY_AUTH;
+import static com.squareup.okhttp.OkHttpConnection.HTTP_UNAUTHORIZED;
+import java.io.IOException;
+import java.net.Authenticator;
+import java.net.InetAddress;
+import java.net.InetSocketAddress;
+import java.net.PasswordAuthentication;
+import java.net.Proxy;
+import java.net.URL;
+import java.util.ArrayList;
+import java.util.List;
+import libcore.io.Base64;
+
+/**
+ * Handles HTTP authentication headers from origin and proxy servers.
+ */
+public final class HttpAuthenticator {
+    /**
+     * React to a failed authorization response by looking up new credentials.
+     *
+     * @return true if credentials have been added to successorRequestHeaders
+     *     and another request should be attempted.
+     */
+    public static final boolean processAuthHeader(int responseCode, RawHeaders responeHeaders,
+            RawHeaders successorRequestHeaders, Proxy proxy, URL url) throws IOException {
+        if (responseCode != HTTP_PROXY_AUTH && responseCode != HTTP_UNAUTHORIZED) {
+            throw new IllegalArgumentException();
+        }
+
+        // Keep asking for username/password until authorized.
+        String challengeHeader = responseCode == HTTP_PROXY_AUTH
+                ? "Proxy-Authenticate"
+                : "WWW-Authenticate";
+        String credentials = getCredentials(responeHeaders, challengeHeader, proxy, url);
+        if (credentials == null) {
+            return false; // Could not find credentials so end the request cycle.
+        }
+
+        // Add authorization credentials, bypassing the already-connected check.
+        String fieldName = responseCode == HTTP_PROXY_AUTH
+                ? "Proxy-Authorization"
+                : "Authorization";
+        successorRequestHeaders.set(fieldName, credentials);
+        return true;
+    }
+
+    /**
+     * Returns the authorization credentials that may satisfy the challenge.
+     * Returns null if a challenge header was not provided or if credentials
+     * were not available.
+     */
+    private static String getCredentials(RawHeaders responseHeaders,
+            String challengeHeader, Proxy proxy, URL url) throws IOException {
+        List<Challenge> challenges = parseChallenges(responseHeaders, challengeHeader);
+        if (challenges.isEmpty()) {
+            return null;
+        }
+
+        for (Challenge challenge : challenges) {
+            // Use the global authenticator to get the password.
+            PasswordAuthentication auth;
+            if (responseHeaders.getResponseCode() == HTTP_PROXY_AUTH) {
+                InetSocketAddress proxyAddress = (InetSocketAddress) proxy.address();
+                auth = Authenticator.requestPasswordAuthentication(
+                        proxyAddress.getHostName(), getConnectToInetAddress(proxy, url),
+                        proxyAddress.getPort(), url.getProtocol(), challenge.realm,
+                        challenge.scheme, url, Authenticator.RequestorType.PROXY);
+            } else {
+                auth = Authenticator.requestPasswordAuthentication(
+                        url.getHost(), getConnectToInetAddress(proxy, url), url.getPort(),
+                        url.getProtocol(), challenge.realm, challenge.scheme, url,
+                        Authenticator.RequestorType.SERVER);
+            }
+            if (auth == null) {
+                continue;
+            }
+
+            // Use base64 to encode the username and password.
+            String usernameAndPassword = auth.getUserName() + ":" + new String(auth.getPassword());
+            byte[] bytes = usernameAndPassword.getBytes("ISO-8859-1");
+            String encoded = Base64.encode(bytes);
+            return challenge.scheme + " " + encoded;
+        }
+
+        return null;
+    }
+
+    private static InetAddress getConnectToInetAddress(Proxy proxy, URL url) throws IOException {
+        return (proxy != null && proxy.type() != Proxy.Type.DIRECT)
+                ? ((InetSocketAddress) proxy.address()).getAddress()
+                : InetAddress.getByName(url.getHost());
+    }
+
+    /**
+     * Parse RFC 2617 challenges. This API is only interested in the scheme
+     * name and realm.
+     */
+    private static List<Challenge> parseChallenges(
+            RawHeaders responseHeaders, String challengeHeader) {
+        /*
+         * auth-scheme = token
+         * auth-param  = token "=" ( token | quoted-string )
+         * challenge   = auth-scheme 1*SP 1#auth-param
+         * realm       = "realm" "=" realm-value
+         * realm-value = quoted-string
+         */
+        List<Challenge> result = new ArrayList<Challenge>();
+        for (int h = 0; h < responseHeaders.length(); h++) {
+            if (!challengeHeader.equalsIgnoreCase(responseHeaders.getFieldName(h))) {
+                continue;
+            }
+            String value = responseHeaders.getValue(h);
+            int pos = 0;
+            while (pos < value.length()) {
+                int tokenStart = pos;
+                pos = HeaderParser.skipUntil(value, pos, " ");
+
+                String scheme = value.substring(tokenStart, pos).trim();
+                pos = HeaderParser.skipWhitespace(value, pos);
+
+                // TODO: This currently only handles schemes with a 'realm' parameter;
+                //       It needs to be fixed to handle any scheme and any parameters
+                //       http://code.google.com/p/android/issues/detail?id=11140
+
+                if (!value.regionMatches(pos, "realm=\"", 0, "realm=\"".length())) {
+                    break; // Unexpected challenge parameter; give up!
+                }
+
+                pos += "realm=\"".length();
+                int realmStart = pos;
+                pos = HeaderParser.skipUntil(value, pos, "\"");
+                String realm = value.substring(realmStart, pos);
+                pos++; // Consume '"' close quote.
+                pos = HeaderParser.skipUntil(value, pos, ",");
+                pos++; // Consume ',' comma.
+                pos = HeaderParser.skipWhitespace(value, pos);
+                result.add(new Challenge(scheme, realm));
+            }
+        }
+        return result;
+    }
+
+    /**
+     * An RFC 2617 challenge.
+     */
+    private static final class Challenge {
+        final String scheme;
+        final String realm;
+
+        Challenge(String scheme, String realm) {
+            this.scheme = scheme;
+            this.realm = realm;
+        }
+
+        @Override public boolean equals(Object o) {
+            return o instanceof Challenge
+                    && ((Challenge) o).scheme.equals(scheme)
+                    && ((Challenge) o).realm.equals(realm);
+        }
+
+        @Override public int hashCode() {
+            return scheme.hashCode() + 31 * realm.hashCode();
+        }
+    }
+}
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpConnection.java b/src/main/java/libcore/net/http/HttpConnection.java
index 89a6ec9..51ee957 100644
--- a/src/main/java/libcore/net/http/HttpConnection.java
+++ b/src/main/java/libcore/net/http/HttpConnection.java
@@ -17,22 +17,26 @@
 
 package libcore.net.http;
 
+import static com.squareup.okhttp.OkHttpConnection.HTTP_PROXY_AUTH;
 import java.io.BufferedInputStream;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
+import static java.net.HttpURLConnection.HTTP_OK;
 import java.net.InetAddress;
 import java.net.InetSocketAddress;
 import java.net.Proxy;
 import java.net.ProxySelector;
 import java.net.Socket;
 import java.net.SocketAddress;
-import java.net.SocketException;
 import java.net.URI;
+import java.net.URL;
 import java.net.UnknownHostException;
+import java.security.cert.CertificateException;
 import java.util.Arrays;
 import java.util.List;
 import javax.net.ssl.HostnameVerifier;
+import javax.net.ssl.SSLHandshakeException;
 import javax.net.ssl.SSLSocket;
 import javax.net.ssl.SSLSocketFactory;
 import libcore.io.IoUtils;
@@ -62,15 +66,19 @@
     };
 
     private final Address address;
-    private final Socket socket;
-    private InputStream inputStream;
-    private OutputStream outputStream;
-    private SSLSocket sslSocket;
-    private InputStream sslInputStream;
-    private OutputStream sslOutputStream;
+    private Socket socket;
+    private InputStream in;
+    private OutputStream out;
     private boolean recycled = false;
     private SpdyConnection spdyConnection;
 
+    HttpConnection(Address address, Socket socket, InputStream in, OutputStream out) {
+        this.address = address;
+        this.socket = socket;
+        this.in = in;
+        this.out = out;
+    }
+
     /**
      * The version this client will use. Either 0 for HTTP/1.0, or 1 for
      * HTTP/1.1. Upon receiving a non-HTTP/1.1 response, this client
@@ -78,66 +86,30 @@
      */
     int httpMinorVersion = 1; // Assume HTTP/1.1
 
-    private HttpConnection(Address config, int connectTimeout) throws IOException {
-        this.address = config;
-
-        /*
-         * Try each of the host's addresses for best behavior in mixed IPv4/IPv6
-         * environments. See http://b/2876927
-         * TODO: add a hidden method so that Socket.tryAllAddresses can does this for us
-         */
-        Socket socketCandidate = null;
-        InetAddress[] addresses = InetAddress.getAllByName(config.socketHost);
-        for (int i = 0; i < addresses.length; i++) {
-            socketCandidate = (config.proxy != null && config.proxy.type() != Proxy.Type.HTTP)
-                    ? new Socket(config.proxy)
-                    : new Socket();
-            try {
-                socketCandidate.connect(
-                        new InetSocketAddress(addresses[i], config.socketPort), connectTimeout);
-                break;
-            } catch (IOException e) {
-                if (i == addresses.length - 1) {
-                    throw e;
-                }
-            }
-        }
-
-        if (socketCandidate == null) {
-            throw new IOException();
-        }
-
-        this.socket = socketCandidate;
-
-        /*
-         * Buffer the socket stream to permit efficient parsing of HTTP headers
-         * and chunk sizes. Benchmarks suggest 128 is sufficient. We cannot
-         * buffer when setting up a tunnel because we may consume bytes intended
-         * for the SSL socket.
-         */
-        int bufferSize = 128;
-        inputStream = address.requiresTunnel()
-                ? socket.getInputStream()
-                : new BufferedInputStream(socket.getInputStream(), bufferSize);
-        outputStream = socket.getOutputStream();
+    public static HttpConnection connect(URI uri, SSLSocketFactory sslSocketFactory,
+            HostnameVerifier hostnameVerifier, Proxy proxy, int connectTimeout, int readTimeout,
+            TunnelConfig tunnelConfig) throws IOException {
+        HttpConnection result = getConnection(uri, sslSocketFactory, hostnameVerifier, proxy,
+                connectTimeout, tunnelConfig);
+        result.socket.setSoTimeout(readTimeout);
+        return result;
     }
 
-    public static HttpConnection connect(URI uri, SSLSocketFactory sslSocketFactory,
-            Proxy proxy, int connectTimeout) throws IOException {
-        /*
-         * Try an explicitly-specified proxy.
-         */
+    /**
+     * Selects a proxy and gets a connection with that proxy.
+     */
+    private static HttpConnection getConnection(URI uri, SSLSocketFactory sslSocketFactory,
+            HostnameVerifier hostnameVerifier, Proxy proxy, int connectTimeout,
+            TunnelConfig tunnelConfig) throws IOException {
+        // Try an explicitly-specified proxy.
         if (proxy != null) {
             Address address = (proxy.type() == Proxy.Type.DIRECT)
-                    ? new Address(uri, sslSocketFactory)
-                    : new Address(uri, sslSocketFactory, proxy);
-            return HttpConnectionPool.INSTANCE.get(address, connectTimeout);
+                    ? new Address(uri, sslSocketFactory, hostnameVerifier)
+                    : new Address(uri, sslSocketFactory, hostnameVerifier, proxy);
+            return getConnectionToAddress(address, connectTimeout, tunnelConfig);
         }
 
-        /*
-         * Try connecting to each of the proxies provided by the ProxySelector
-         * until a connection succeeds.
-         */
+        // Try each proxy provided by the ProxySelector until a connection succeeds.
         ProxySelector selector = ProxySelector.getDefault();
         List<Proxy> proxyList = selector.select(uri);
         if (proxyList != null) {
@@ -148,8 +120,8 @@
                     continue;
                 }
                 try {
-                    Address address = new Address(uri, sslSocketFactory, selectedProxy);
-                    return HttpConnectionPool.INSTANCE.get(address, connectTimeout);
+                    return getConnectionToAddress(new Address(uri, sslSocketFactory,
+                            hostnameVerifier, selectedProxy), connectTimeout, tunnelConfig);
                 } catch (IOException e) {
                     // failed to connect, tell it to the selector
                     selector.connectFailed(uri, selectedProxy.address(), e);
@@ -157,49 +129,109 @@
             }
         }
 
-        /*
-         * Try a direct connection. If this fails, this method will throw.
-         */
-        return HttpConnectionPool.INSTANCE.get(new Address(uri, sslSocketFactory), connectTimeout);
-    }
-
-    public void closeSocketAndStreams() {
-        IoUtils.closeQuietly(sslOutputStream);
-        IoUtils.closeQuietly(sslInputStream);
-        IoUtils.closeQuietly(sslSocket);
-        IoUtils.closeQuietly(outputStream);
-        IoUtils.closeQuietly(inputStream);
-        IoUtils.closeQuietly(socket);
-    }
-
-    public void setSoTimeout(int readTimeout) throws SocketException {
-        socket.setSoTimeout(readTimeout);
-    }
-
-    Socket getSocket() {
-        return sslSocket != null ? sslSocket : socket;
-    }
-
-    public Address getAddress() {
-        return address;
+        // Try a direct connection. If this fails, this method will throw.
+        return getConnectionToAddress(new Address(uri, sslSocketFactory, hostnameVerifier),
+                connectTimeout, tunnelConfig);
     }
 
     /**
-     * Create an {@code SSLSocket} and perform the SSL handshake
-     * (performing certificate validation.
-     *
-     * @param sslSocketFactory Source of new {@code SSLSocket} instances.
-     * @param tlsTolerant If true, assume server can handle common
+     * Selects a proxy and gets a connection with that proxy.
      */
-    public SSLSocket setupSecureSocket(SSLSocketFactory sslSocketFactory,
-            HostnameVerifier hostnameVerifier, boolean tlsTolerant) throws IOException {
-        if (spdyConnection != null || sslOutputStream != null || sslInputStream != null) {
-            throw new IllegalStateException();
+    private static HttpConnection getConnectionToAddress(Address address, int connectTimeout,
+            TunnelConfig tunnelConfig) throws IOException {
+        HttpConnection pooled = HttpConnectionPool.INSTANCE.get(address);
+        if (pooled != null) {
+            return pooled;
+        }
+
+        Socket socket = connectSocket(address, connectTimeout);
+        HttpConnection result = new HttpConnection(
+                address, socket, socket.getInputStream(), socket.getOutputStream());
+
+        if (address.sslSocketFactory != null) {
+            // First try an SSL connection with compression and various TLS
+            // extensions enabled, if it fails (and its not unheard of that it
+            // will) fallback to a barebones connection.
+            try {
+                result = new HttpConnection(
+                        address, socket, socket.getInputStream(), socket.getOutputStream());
+                result.upgradeToTls(true, tunnelConfig);
+            } catch (IOException e) {
+                // If the problem was a CertificateException from the X509TrustManager,
+                // do not retry, we didn't have an abrupt server initiated exception.
+                if (e instanceof SSLHandshakeException
+                        && e.getCause() instanceof CertificateException) {
+                    throw e;
+                }
+                result.closeSocketAndStreams();
+
+                socket = connectSocket(address, connectTimeout);
+                result = new HttpConnection(
+                        address, socket, socket.getInputStream(), socket.getOutputStream());
+                result.upgradeToTls(false, tunnelConfig);
+            }
+        }
+
+        /*
+         * Buffer the socket stream to permit efficient parsing of HTTP headers
+         * and chunk sizes. This also masks SSL InputStream's degenerate
+         * available() implementation. That way we can read the end of a chunked
+         * response without blocking and will recycle connections more reliably.
+         * http://code.google.com/p/android/issues/detail?id=38817
+         */
+        int bufferSize = 128;
+        result.in = new BufferedInputStream(result.in, bufferSize);
+
+        return result;
+    }
+
+    /**
+     * Try each of the host's addresses for best behavior in mixed IPv4/IPv6
+     * environments. See http://b/2876927
+     */
+    private static Socket connectSocket(Address address, int connectTimeout) throws IOException {
+        Socket socket = null;
+        InetAddress[] addresses = InetAddress.getAllByName(address.socketHost);
+        for (int i = 0; i < addresses.length; i++) {
+            socket = (address.proxy != null && address.proxy.type() != Proxy.Type.HTTP)
+                    ? new Socket(address.proxy)
+                    : new Socket();
+            try {
+                socket.connect(
+                        new InetSocketAddress(addresses[i], address.socketPort), connectTimeout);
+                break;
+            } catch (IOException e) {
+                if (i == addresses.length - 1) {
+                    throw e;
+                }
+            }
+        }
+
+        if (socket == null) {
+            throw new IOException();
+        }
+
+        return socket;
+    }
+
+    /**
+     * Create an {@code SSLSocket} and perform the TLS handshake and certificate
+     * validation.
+     *
+     * @param tlsTolerant If true, assume server can handle common TLS
+     *     extensions and SSL deflate compression. If false, use an SSL3 only
+     *     fallback mode without compression.
+     */
+    private void upgradeToTls(boolean tlsTolerant, TunnelConfig tunnelConfig) throws IOException {
+        // Make an SSL Tunnel on the first message pair of each SSL + proxy connection.
+        if (address.requiresTunnel()) {
+            makeTunnel(tunnelConfig);
         }
 
         // Create the wrapper over connected socket.
-        sslSocket = (SSLSocket) sslSocketFactory.createSocket(socket,
-                address.uriHost, address.uriPort, true /* autoClose */);
+        socket = address.sslSocketFactory.createSocket(
+                socket, address.uriHost, address.uriPort, true /* autoClose */);
+        SSLSocket sslSocket = (SSLSocket) socket;
         Libcore.makeTlsTolerant(sslSocket, address.uriHost, tlsTolerant);
 
         if (tlsTolerant) {
@@ -210,40 +242,38 @@
         sslSocket.startHandshake();
 
         // Verify that the socket's certificates are acceptable for the target host.
-        if (!hostnameVerifier.verify(address.uriHost, sslSocket.getSession())) {
+        if (!address.hostnameVerifier.verify(address.uriHost, sslSocket.getSession())) {
             throw new IOException("Hostname '" + address.uriHost + "' was not verified");
         }
 
-        /*
-         * Buffer the input to mask SSL InputStream's degenerate available()
-         * implementation. That way we can read the end of a chunked response
-         * without blocking and will recycle the connection more reliably.
-         * http://code.google.com/p/android/issues/detail?id=38817
-         */
-        sslOutputStream = sslSocket.getOutputStream();
-        sslInputStream = new BufferedInputStream(sslSocket.getInputStream(), 128);
+        out = sslSocket.getOutputStream();
+        in = sslSocket.getInputStream();
 
         byte[] selectedProtocol;
         if (tlsTolerant
                 && (selectedProtocol = Libcore.getNpnSelectedProtocol(sslSocket)) != null) {
             if (Arrays.equals(selectedProtocol, SPDY2)) {
-                spdyConnection = new SpdyConnection.Builder(
-                        true, sslInputStream, sslOutputStream).build();
+                spdyConnection = new SpdyConnection.Builder(true, in, out).build();
                 HttpConnectionPool.INSTANCE.share(this);
             } else if (!Arrays.equals(selectedProtocol, HTTP_11)) {
                 throw new IOException("Unexpected NPN transport "
                         + new String(selectedProtocol, "ISO-8859-1"));
             }
         }
-
-        return sslSocket;
     }
 
-    /**
-     * Return an {@code SSLSocket} if already connected, otherwise null.
-     */
-    public SSLSocket getSecureSocketIfConnected() {
-        return sslSocket;
+    public void closeSocketAndStreams() {
+        IoUtils.closeQuietly(out);
+        IoUtils.closeQuietly(in);
+        IoUtils.closeQuietly(socket);
+    }
+
+    public Socket getSocket() {
+        return socket;
+    }
+
+    public Address getAddress() {
+        return address;
     }
 
     /**
@@ -274,10 +304,8 @@
     public Transport newTransport(HttpEngine httpEngine) throws IOException {
         if (spdyConnection != null) {
             return new SpdyTransport(httpEngine, spdyConnection);
-        } else if (sslSocket != null) {
-            return new HttpTransport(httpEngine, sslOutputStream, sslInputStream);
         } else {
-            return new HttpTransport(httpEngine, outputStream, inputStream);
+            return new HttpTransport(httpEngine, out, in);
         }
     }
 
@@ -289,6 +317,76 @@
         return spdyConnection != null;
     }
 
+    public static final class TunnelConfig {
+        private final URL url;
+        private final String host;
+        private final String userAgent;
+        private final String proxyAuthorization;
+
+        public TunnelConfig(URL url, String host, String userAgent, String proxyAuthorization) {
+            if (url == null || host == null || userAgent == null) throw new NullPointerException();
+            this.url = url;
+            this.host = host;
+            this.userAgent = userAgent;
+            this.proxyAuthorization = proxyAuthorization;
+        }
+
+        /**
+         * If we're establishing an HTTPS tunnel with CONNECT (RFC 2817 5.2), send
+         * only the minimum set of headers. This avoids sending potentially
+         * sensitive data like HTTP cookies to the proxy unencrypted.
+         */
+        RawHeaders getRequestHeaders() {
+            RawHeaders result = new RawHeaders();
+            result.setRequestLine("CONNECT " + url.getHost() + ":"
+                    + Libcore.getEffectivePort(url) + " HTTP/1.1");
+
+            // Always set Host and User-Agent.
+            result.set("Host", host);
+            result.set("User-Agent", userAgent);
+
+            // Copy over the Proxy-Authorization header if it exists.
+            if (proxyAuthorization != null) {
+                result.set("Proxy-Authorization", proxyAuthorization);
+            }
+
+            // Always set the Proxy-Connection to Keep-Alive for the benefit of
+            // HTTP/1.0 proxies like Squid.
+            result.set("Proxy-Connection", "Keep-Alive");
+            return result;
+        }
+    }
+
+    /**
+     * To make an HTTPS connection over an HTTP proxy, send an unencrypted
+     * CONNECT request to create the proxy connection. This may need to be
+     * retried if the proxy requires authorization.
+     */
+    private void makeTunnel(TunnelConfig tunnelConfig) throws IOException {
+        RawHeaders requestHeaders = tunnelConfig.getRequestHeaders();
+        while (true) {
+            out.write(requestHeaders.toBytes());
+            RawHeaders responseHeaders = RawHeaders.fromBytes(in);
+
+            switch (responseHeaders.getResponseCode()) {
+            case HTTP_OK:
+                return;
+            case HTTP_PROXY_AUTH:
+                requestHeaders = new RawHeaders(requestHeaders);
+                boolean credentialsFound = HttpAuthenticator.processAuthHeader(HTTP_PROXY_AUTH,
+                        responseHeaders, requestHeaders, address.proxy, tunnelConfig.url);
+                if (credentialsFound) {
+                    continue;
+                } else {
+                    throw new IOException("Failed to authenticate with proxy");
+                }
+            default:
+                throw new IOException("Unexpected response code for CONNECT: "
+                        + responseHeaders.getResponseCode());
+            }
+        }
+    }
+
     /**
      * This address has two parts: the address we connect to directly and the
      * origin address of the resource. These are the same unless a proxy is
@@ -302,12 +400,15 @@
         private final String socketHost;
         private final int socketPort;
         private final SSLSocketFactory sslSocketFactory;
+        private final HostnameVerifier hostnameVerifier;
 
-        public Address(URI uri, SSLSocketFactory sslSocketFactory) throws UnknownHostException {
+        public Address(URI uri, SSLSocketFactory sslSocketFactory,
+                HostnameVerifier hostnameVerifier) throws UnknownHostException {
             this.proxy = null;
             this.uriHost = uri.getHost();
             this.uriPort = Libcore.getEffectivePort(uri);
             this.sslSocketFactory = sslSocketFactory;
+            this.hostnameVerifier = hostnameVerifier;
             this.socketHost = uriHost;
             this.socketPort = uriPort;
             if (uriHost == null) {
@@ -315,12 +416,13 @@
             }
         }
 
-        public Address(URI uri, SSLSocketFactory sslSocketFactory, Proxy proxy)
-                throws UnknownHostException {
+        public Address(URI uri, SSLSocketFactory sslSocketFactory,
+                HostnameVerifier hostnameVerifier, Proxy proxy) throws UnknownHostException {
             this.proxy = proxy;
             this.uriHost = uri.getHost();
             this.uriPort = Libcore.getEffectivePort(uri);
             this.sslSocketFactory = sslSocketFactory;
+            this.hostnameVerifier = hostnameVerifier;
 
             SocketAddress proxyAddress = proxy.address();
             if (!(proxyAddress instanceof InetSocketAddress)) {
@@ -345,7 +447,8 @@
                 return Objects.equal(this.proxy, that.proxy)
                         && this.uriHost.equals(that.uriHost)
                         && this.uriPort == that.uriPort
-                        && Objects.equal(this.sslSocketFactory, that.sslSocketFactory);
+                        && Objects.equal(this.sslSocketFactory, that.sslSocketFactory)
+                        && Objects.equal(this.hostnameVerifier, that.hostnameVerifier);
             }
             return false;
         }
@@ -355,14 +458,11 @@
             result = 31 * result + uriHost.hashCode();
             result = 31 * result + uriPort;
             result = 31 * result + (sslSocketFactory != null ? sslSocketFactory.hashCode() : 0);
+            result = 31 * result + (hostnameVerifier != null ? hostnameVerifier.hashCode() : 0);
             result = 31 * result + (proxy != null ? proxy.hashCode() : 0);
             return result;
         }
 
-        public HttpConnection connect(int connectTimeout) throws IOException {
-            return new HttpConnection(this, connectTimeout);
-        }
-
         /**
          * Returns true if the HTTP connection needs to tunnel one protocol over
          * another, such as when using HTTPS through an HTTP proxy. When doing so,
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpConnectionPool.java b/src/main/java/libcore/net/http/HttpConnectionPool.java
index 2bcdc48..0c2a188 100644
--- a/src/main/java/libcore/net/http/HttpConnectionPool.java
+++ b/src/main/java/libcore/net/http/HttpConnectionPool.java
@@ -17,7 +17,6 @@
 
 package libcore.net.http;
 
-import java.io.IOException;
 import java.net.Socket;
 import java.net.SocketException;
 import java.util.ArrayList;
@@ -59,8 +58,7 @@
                 : 5;
     }
 
-    public HttpConnection get(HttpConnection.Address address, int connectTimeout)
-            throws IOException {
+    public HttpConnection get(HttpConnection.Address address) {
         // First try to reuse an existing HTTP connection.
         synchronized (connectionPool) {
             List<HttpConnection> connections = connectionPool.get(address);
@@ -81,12 +79,7 @@
                 }
             }
         }
-
-        /*
-         * We couldn't find a reusable connection, so we need to create a new
-         * connection. We're careful not to do so while holding a lock!
-         */
-        return address.connect(connectTimeout);
+        return null;
     }
 
     /**
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpEngine.java b/src/main/java/libcore/net/http/HttpEngine.java
index de25581..0c8915f 100644
--- a/src/main/java/libcore/net/http/HttpEngine.java
+++ b/src/main/java/libcore/net/http/HttpEngine.java
@@ -36,6 +36,7 @@
 import java.util.List;
 import java.util.Map;
 import java.util.zip.GZIPInputStream;
+import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.SSLSocketFactory;
 import libcore.io.IoUtils;
 import libcore.util.EmptyArray;
@@ -86,7 +87,6 @@
     public static final String PUT = "PUT";
     public static final String DELETE = "DELETE";
     public static final String TRACE = "TRACE";
-    public static final String CONNECT = "CONNECT";
 
     public static final int HTTP_CONTINUE = 100;
 
@@ -274,22 +274,18 @@
      * Connect to the origin server either directly or via a proxy.
      */
     protected void connect() throws IOException {
-        if (connection == null) {
-            connection = openSocketConnection();
+        if (connection != null) {
+            return;
         }
-    }
-
-    protected final HttpConnection openSocketConnection() throws IOException {
-        HttpConnection result = HttpConnection.connect(uri, getSslSocketFactory(),
-                policy.getProxy(), policy.getConnectTimeout());
-        Proxy proxy = result.getAddress().getProxy();
+        connection = HttpConnection.connect(uri, getSslSocketFactory(), getHostnameVerifier(),
+                policy.getProxy(), policy.getConnectTimeout(), policy.getReadTimeout(),
+                getTunnelConfig());
+        Proxy proxy = connection.getAddress().getProxy();
         if (proxy != null) {
             policy.setProxy(proxy);
             // Add the authority to the request line when we're using a proxy.
             requestHeaders.getHeaders().setRequestLine(getRequestLine());
         }
-        result.setSoTimeout(policy.getReadTimeout());
-        return result;
     }
 
     /**
@@ -371,11 +367,6 @@
     }
 
     private void maybeCache() throws IOException {
-        // Never cache responses to proxy CONNECT requests.
-        if (method == CONNECT) {
-            return;
-        }
-
         // Are we caching at all?
         if (!policy.getUseCaches() || responseCache == null) {
             return;
@@ -458,8 +449,7 @@
             return false;
         }
 
-        if (method != CONNECT
-                && (responseCode < HTTP_CONTINUE || responseCode >= 200)
+        if ((responseCode < HTTP_CONTINUE || responseCode >= 200)
                 && responseCode != HttpURLConnectionImpl.HTTP_NO_CONTENT
                 && responseCode != HttpURLConnectionImpl.HTTP_NOT_MODIFIED) {
             return true;
@@ -569,15 +559,23 @@
         return null;
     }
 
-    protected final String getDefaultUserAgent() {
+    /**
+     * Returns the hostname verifier for connections created by this engine. We
+     * cannot reuse HTTPS connections if the hostname verifier has changed.
+     */
+    protected HostnameVerifier getHostnameVerifier() {
+        return null;
+    }
+
+    public static final String getDefaultUserAgent() {
         String agent = System.getProperty("http.agent");
         return agent != null ? agent : ("Java" + System.getProperty("java.version"));
     }
 
-    protected final String getOriginAddress(URL url) {
+    public static String getOriginAddress(URL url) {
         int port = url.getPort();
         String result = url.getHost();
-        if (port > 0 && port != policy.getDefaultPort()) {
+        if (port > 0 && port != Libcore.getDefaultPort(url.getProtocol())) {
             result = result + ":" + port;
         }
         return result;
@@ -642,4 +640,8 @@
 
         initContentStream(transport.getTransferStream(cacheRequest));
     }
+
+    protected HttpConnection.TunnelConfig getTunnelConfig() {
+        return null;
+    }
 }
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpTransport.java b/src/main/java/libcore/net/http/HttpTransport.java
index 3c55918..83440d8 100644
--- a/src/main/java/libcore/net/http/HttpTransport.java
+++ b/src/main/java/libcore/net/http/HttpTransport.java
@@ -23,7 +23,6 @@
 import java.io.OutputStream;
 import java.net.CacheRequest;
 import java.net.CookieHandler;
-import java.net.URL;
 import libcore.io.Streams;
 import libcore.util.Libcore;
 
@@ -124,8 +123,8 @@
         httpEngine.sentRequestMillis = System.currentTimeMillis();
 
         int contentLength = httpEngine.requestHeaders.getContentLength();
-        RawHeaders headersToSend = getNetworkRequestHeaders();
-        byte[] bytes = headersToSend.toRequestHeader().getBytes("ISO-8859-1");
+        RawHeaders headersToSend = httpEngine.requestHeaders.getHeaders();
+        byte[] bytes = headersToSend.toBytes();
 
         if (contentLength != -1 && bytes.length + contentLength <= MAX_REQUEST_BUFFER_LENGTH) {
             requestOut = new BufferedOutputStream(socketOut, bytes.length + contentLength);
@@ -134,71 +133,14 @@
         requestOut.write(bytes);
     }
 
-    private RawHeaders getNetworkRequestHeaders() {
-        return httpEngine.method == HttpEngine.CONNECT
-                ? getTunnelNetworkRequestHeaders()
-                : httpEngine.requestHeaders.getHeaders();
-    }
-
-    /**
-     * If we're establishing an HTTPS tunnel with CONNECT (RFC 2817 5.2), send
-     * only the minimum set of headers. This avoids sending potentially
-     * sensitive data like HTTP cookies to the proxy unencrypted.
-     */
-    private RawHeaders getTunnelNetworkRequestHeaders() {
-        RequestHeaders privateHeaders = httpEngine.requestHeaders;
-        URL url = httpEngine.policy.getURL();
-
-        RawHeaders result = new RawHeaders();
-        result.setRequestLine("CONNECT " + url.getHost() + ":" + Libcore.getEffectivePort(url)
-                + " HTTP/1.1");
-
-        // Always set Host and User-Agent.
-        String host = privateHeaders.getHost();
-        if (host == null) {
-            host = httpEngine.getOriginAddress(url);
-        }
-        result.set("Host", host);
-
-        String userAgent = privateHeaders.getUserAgent();
-        if (userAgent == null) {
-            userAgent = httpEngine.getDefaultUserAgent();
-        }
-        result.set("User-Agent", userAgent);
-
-        // Copy over the Proxy-Authorization header if it exists.
-        String proxyAuthorization = privateHeaders.getProxyAuthorization();
-        if (proxyAuthorization != null) {
-            result.set("Proxy-Authorization", proxyAuthorization);
-        }
-
-        // Always set the Proxy-Connection to Keep-Alive for the benefit of
-        // HTTP/1.0 proxies like Squid.
-        result.set("Proxy-Connection", "Keep-Alive");
-        return result;
-    }
-
     @Override public ResponseHeaders readResponseHeaders() throws IOException {
-        RawHeaders headers;
-        do {
-            headers = new RawHeaders();
-            headers.setStatusLine(Streams.readAsciiLine(socketIn));
-            httpEngine.connection.httpMinorVersion = headers.getHttpMinorVersion();
-            readHeaders(headers);
-        } while (headers.getResponseCode() == HttpEngine.HTTP_CONTINUE);
+        RawHeaders headers = RawHeaders.fromBytes(socketIn);
+        httpEngine.connection.httpMinorVersion = headers.getHttpMinorVersion();
+        receiveHeaders(headers);
         return new ResponseHeaders(httpEngine.uri, headers);
     }
 
-    /**
-     * Reads headers or trailers and updates the cookie store.
-     */
-    private void readHeaders(RawHeaders headers) throws IOException {
-        // parse the result headers until the first blank line
-        String line;
-        while ((line = Streams.readAsciiLine(socketIn)).length() != 0) {
-            headers.addLine(line);
-        }
-
+    private void receiveHeaders(RawHeaders headers) throws IOException {
         CookieHandler cookieHandler = CookieHandler.getDefault();
         if (cookieHandler != null) {
             cookieHandler.put(httpEngine.uri, headers.toMultimap(true));
@@ -211,11 +153,8 @@
             return false;
         }
 
-        // If the request specified that the connection shouldn't be reused,
-        // don't reuse it. This advice doesn't apply to CONNECT requests because
-        // the "Connection: close" header goes the origin server, not the proxy.
-        if (httpEngine.requestHeaders.hasConnectionClose()
-                && httpEngine.method != HttpEngine.CONNECT) {
+        // If the request specified that the connection shouldn't be reused, don't reuse it.
+        if (httpEngine.requestHeaders.hasConnectionClose()) {
             return false;
         }
 
@@ -531,7 +470,9 @@
             }
             if (bytesRemainingInChunk == 0) {
                 hasMoreChunks = false;
-                transport.readHeaders(httpEngine.responseHeaders.getHeaders());
+                RawHeaders rawResponseHeaders = httpEngine.responseHeaders.getHeaders();
+                RawHeaders.readHeaders(transport.socketIn, rawResponseHeaders);
+                transport.receiveHeaders(rawResponseHeaders);
                 endOfInput(true);
             }
         }
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpURLConnectionImpl.java b/src/main/java/libcore/net/http/HttpURLConnectionImpl.java
index 57c45bf..0806680 100644
--- a/src/main/java/libcore/net/http/HttpURLConnectionImpl.java
+++ b/src/main/java/libcore/net/http/HttpURLConnectionImpl.java
@@ -22,11 +22,8 @@
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
-import java.net.Authenticator;
 import java.net.HttpRetryException;
-import java.net.InetAddress;
 import java.net.InetSocketAddress;
-import java.net.PasswordAuthentication;
 import java.net.ProtocolException;
 import java.net.Proxy;
 import java.net.SocketPermission;
@@ -34,7 +31,6 @@
 import java.security.Permission;
 import java.util.List;
 import java.util.Map;
-import libcore.io.Base64;
 import libcore.io.IoUtils;
 import libcore.util.Libcore;
 
@@ -367,8 +363,8 @@
             }
             // fall-through
         case HTTP_UNAUTHORIZED:
-            boolean credentialsFound = processAuthHeader(getResponseCode(),
-                    httpEngine.getResponseHeaders(), rawRequestHeaders);
+            boolean credentialsFound = HttpAuthenticator.processAuthHeader(getResponseCode(),
+                    httpEngine.getResponseHeaders().getHeaders(), rawRequestHeaders, proxy, url);
             return credentialsFound ? Retry.SAME_CONNECTION : Retry.NONE;
 
         case HTTP_MULT_CHOICE:
@@ -402,81 +398,6 @@
         }
     }
 
-    /**
-     * React to a failed authorization response by looking up new credentials.
-     *
-     * @return true if credentials have been added to successorRequestHeaders
-     *     and another request should be attempted.
-     */
-    final boolean processAuthHeader(int responseCode, ResponseHeaders response,
-            RawHeaders successorRequestHeaders) throws IOException {
-        if (responseCode != HTTP_PROXY_AUTH && responseCode != HTTP_UNAUTHORIZED) {
-            throw new IllegalArgumentException();
-        }
-
-        // keep asking for username/password until authorized
-        String challengeHeader = responseCode == HTTP_PROXY_AUTH
-                ? "Proxy-Authenticate"
-                : "WWW-Authenticate";
-        String credentials = getAuthorizationCredentials(response.getHeaders(), challengeHeader);
-        if (credentials == null) {
-            return false; // could not find credentials, end request cycle
-        }
-
-        // add authorization credentials, bypassing the already-connected check
-        String fieldName = responseCode == HTTP_PROXY_AUTH
-                ? "Proxy-Authorization"
-                : "Authorization";
-        successorRequestHeaders.set(fieldName, credentials);
-        return true;
-    }
-
-    /**
-     * Returns the authorization credentials that may satisfy the challenge.
-     * Returns null if a challenge header was not provided or if credentials
-     * were not available.
-     */
-    private String getAuthorizationCredentials(RawHeaders responseHeaders, String challengeHeader)
-            throws IOException {
-        List<Challenge> challenges = HeaderParser.parseChallenges(responseHeaders, challengeHeader);
-        if (challenges.isEmpty()) {
-            return null;
-        }
-
-        for (Challenge challenge : challenges) {
-            // use the global authenticator to get the password
-            PasswordAuthentication auth;
-            if (responseHeaders.getResponseCode() == HTTP_PROXY_AUTH) {
-                InetSocketAddress proxyAddress = (InetSocketAddress) proxy.address();
-                auth = Authenticator.requestPasswordAuthentication(
-                        proxyAddress.getHostName(), getConnectToInetAddress(),
-                        proxyAddress.getPort(), url.getProtocol(), challenge.realm,
-                        challenge.scheme, url, Authenticator.RequestorType.PROXY);
-            } else {
-                auth = Authenticator.requestPasswordAuthentication(
-                        url.getHost(), getConnectToInetAddress(), url.getPort(), url.getProtocol(),
-                        challenge.realm, challenge.scheme, url, Authenticator.RequestorType.SERVER);
-            }
-            if (auth == null) {
-                continue;
-            }
-
-            // base64 encode the username and password
-            String usernameAndPassword = auth.getUserName() + ":" + new String(auth.getPassword());
-            byte[] bytes = usernameAndPassword.getBytes("ISO-8859-1");
-            String encoded = Base64.encode(bytes);
-            return challenge.scheme + " " + encoded;
-        }
-
-        return null;
-    }
-
-    private InetAddress getConnectToInetAddress() throws IOException {
-        return usingProxy()
-                ? ((InetSocketAddress) proxy.address()).getAddress()
-                : InetAddress.getByName(getURL().getHost());
-    }
-
     final int getDefaultPort() {
         return defaultPort;
     }
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java b/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
index bfb307c..2aaeaf4 100644
--- a/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
+++ b/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
@@ -29,10 +29,9 @@
 import java.security.Permission;
 import java.security.Principal;
 import java.security.cert.Certificate;
-import java.security.cert.CertificateException;
 import java.util.List;
 import java.util.Map;
-import javax.net.ssl.SSLHandshakeException;
+import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import javax.net.ssl.SSLSocket;
 import javax.net.ssl.SSLSocketFactory;
@@ -419,87 +418,10 @@
                 HttpConnection connection, RetryableOutputStream requestBody,
                 HttpsURLConnectionImpl enclosing) throws IOException {
             super(policy, method, requestHeaders, connection, requestBody);
-            this.sslSocket = connection != null ? connection.getSecureSocketIfConnected() : null;
+            this.sslSocket = connection != null ? (SSLSocket) connection.getSocket() : null;
             this.enclosing = enclosing;
         }
 
-        @Override protected void connect() throws IOException {
-            // First try an SSL connection with compression and various TLS
-            // extensions enabled, if it fails (and its not unheard of that it
-            // will) fallback to a barebones connection.
-            try {
-                makeSslConnection(true);
-            } catch (IOException e) {
-                // If the problem was a CertificateException from the X509TrustManager,
-                // do not retry, we didn't have an abrupt server initiated exception.
-                if (e instanceof SSLHandshakeException
-                        && e.getCause() instanceof CertificateException) {
-                    throw e;
-                }
-                release(false);
-                makeSslConnection(false);
-            }
-        }
-
-        /**
-         * Attempt to make an HTTPS connection.
-         *
-         * @param tlsTolerant If true, assume server can handle common
-         * TLS extensions and SSL deflate compression. If false, use
-         * an SSL3 only fallback mode without compression.
-         */
-        private void makeSslConnection(boolean tlsTolerant) throws IOException {
-            // Get a connection. This may return a pooled connection!
-            if (connection == null) {
-                connection = openSocketConnection();
-            }
-            sslSocket = connection.getSecureSocketIfConnected();
-
-            // If the TLS connection is ready, use it.
-            if (sslSocket != null) {
-                return;
-            }
-
-            // The TLS connection isn't ready. Build a tunnel if necessary and then handshake.
-            if (connection.getAddress().requiresTunnel()) {
-                makeTunnel(policy, connection, getRequestHeaders());
-            }
-            sslSocket = connection.setupSecureSocket(
-                    enclosing.getSSLSocketFactory(), enclosing.getHostnameVerifier(), tlsTolerant);
-        }
-
-        /**
-         * To make an HTTPS connection over an HTTP proxy, send an unencrypted
-         * CONNECT request to create the proxy connection. This may need to be
-         * retried if the proxy requires authorization.
-         */
-        private void makeTunnel(HttpURLConnectionImpl policy, HttpConnection connection,
-                RequestHeaders requestHeaders) throws IOException {
-            RawHeaders rawRequestHeaders = requestHeaders.getHeaders();
-            while (true) {
-                HttpEngine connect = new ProxyConnectEngine(policy, rawRequestHeaders, connection);
-                connect.sendRequest();
-                connect.readResponse();
-
-                int responseCode = connect.getResponseCode();
-                switch (connect.getResponseCode()) {
-                case HTTP_OK:
-                    return;
-                case HTTP_PROXY_AUTH:
-                    rawRequestHeaders = new RawHeaders(rawRequestHeaders);
-                    boolean credentialsFound = policy.processAuthHeader(HTTP_PROXY_AUTH,
-                            connect.getResponseHeaders(), rawRequestHeaders);
-                    if (credentialsFound) {
-                        continue;
-                    } else {
-                        throw new IOException("Failed to authenticate with proxy");
-                    }
-                default:
-                    throw new IOException("Unexpected response code for CONNECT: " + responseCode);
-                }
-            }
-        }
-
         @Override protected boolean acceptCacheResponseType(CacheResponse cacheResponse) {
             return cacheResponse instanceof SecureCacheResponse;
         }
@@ -513,15 +435,28 @@
             return enclosing.getSSLSocketFactory();
         }
 
+        @Override protected HostnameVerifier getHostnameVerifier() {
+            return enclosing.getHostnameVerifier();
+        }
+
         @Override protected OkHttpConnection getHttpConnectionToCache() {
             return enclosing;
         }
-    }
 
-    private static class ProxyConnectEngine extends HttpEngine {
-        public ProxyConnectEngine(HttpURLConnectionImpl policy, RawHeaders requestHeaders,
-                HttpConnection connection) throws IOException {
-            super(policy, HttpEngine.CONNECT, requestHeaders, connection, null);
+        @Override protected HttpConnection.TunnelConfig getTunnelConfig() {
+            String host = requestHeaders.getHost();
+            if (host == null) {
+                host = HttpEngine.getOriginAddress(policy.getURL());
+            }
+
+            String userAgent = requestHeaders.getUserAgent();
+            if (userAgent == null) {
+                userAgent = HttpEngine.getDefaultUserAgent();
+            }
+
+            String proxyAuthorization = requestHeaders.getProxyAuthorization();
+            return new HttpConnection.TunnelConfig(
+                    policy.getURL(), host, userAgent, proxyAuthorization);
         }
     }
 }
/Fim/
diff --git a/src/main/java/libcore/net/http/RawHeaders.java b/src/main/java/libcore/net/http/RawHeaders.java
index 7cbd5a9..ba315d6 100644
--- a/src/main/java/libcore/net/http/RawHeaders.java
+++ b/src/main/java/libcore/net/http/RawHeaders.java
@@ -18,6 +18,8 @@
 package libcore.net.http;
 
 import java.io.IOException;
+import java.io.InputStream;
+import java.io.UnsupportedEncodingException;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.Comparator;
@@ -28,6 +30,7 @@
 import java.util.Map.Entry;
 import java.util.Set;
 import java.util.TreeMap;
+import libcore.io.Streams;
 import libcore.util.Libcore;
 
 /**
@@ -74,6 +77,7 @@
 
     public RawHeaders(RawHeaders copyFrom) {
         namesAndValues.addAll(copyFrom.namesAndValues);
+        requestLine = copyFrom.requestLine;
         statusLine = copyFrom.statusLine;
         httpMinorVersion = copyFrom.httpMinorVersion;
         responseCode = copyFrom.responseCode;
@@ -284,7 +288,10 @@
         return result;
     }
 
-    public String toRequestHeader() {
+    /**
+     * Returns bytes of a request header for sending on an HTTP transport.
+     */
+    public byte[] toBytes() throws UnsupportedEncodingException {
         StringBuilder result = new StringBuilder(256);
         result.append(requestLine).append("\r\n");
         for (int i = 0; i < namesAndValues.size(); i += 2) {
@@ -292,7 +299,31 @@
                     .append(namesAndValues.get(i + 1)).append("\r\n");
         }
         result.append("\r\n");
-        return result.toString();
+        return result.toString().getBytes("ISO-8859-1");
+    }
+
+    /**
+     * Parses bytes of a response header from an HTTP transport.
+     */
+    public static RawHeaders fromBytes(InputStream in) throws IOException {
+        RawHeaders headers;
+        do {
+            headers = new RawHeaders();
+            headers.setStatusLine(Streams.readAsciiLine(in));
+            readHeaders(in, headers);
+        } while (headers.getResponseCode() == HttpEngine.HTTP_CONTINUE);
+        return headers;
+    }
+
+    /**
+     * Reads headers or trailers into {@code out}.
+     */
+    public static void readHeaders(InputStream in, RawHeaders out) throws IOException {
+        // parse the result headers until the first blank line
+        String line;
+        while ((line = Streams.readAsciiLine(in)).length() != 0) {
+            out.addLine(line);
+        }
     }
 
     /**
/Fim/
diff --git a/src/main/java/libcore/util/Libcore.java b/src/main/java/libcore/util/Libcore.java
index 52967eb..7053187 100644
--- a/src/main/java/libcore/util/Libcore.java
+++ b/src/main/java/libcore/util/Libcore.java
@@ -197,10 +197,12 @@
     }
 
     private static int getEffectivePort(String scheme, int specifiedPort) {
-        if (specifiedPort != -1) {
-            return specifiedPort;
-        }
+        return specifiedPort != -1
+                ? specifiedPort
+                : getDefaultPort(scheme);
+    }
 
+    public static int getDefaultPort(String scheme) {
         if ("http".equalsIgnoreCase(scheme)) {
             return 80;
         } else if ("https".equalsIgnoreCase(scheme)) {
/Fim/
diff --git a/src/test/java/libcore/net/http/URLConnectionTest.java b/src/test/java/libcore/net/http/URLConnectionTest.java
index c0f7025..eed3833 100644
--- a/src/test/java/libcore/net/http/URLConnectionTest.java
+++ b/src/test/java/libcore/net/http/URLConnectionTest.java
@@ -20,6 +20,10 @@
 import com.google.mockwebserver.MockWebServer;
 import com.google.mockwebserver.RecordedRequest;
 import com.google.mockwebserver.SocketPolicy;
+import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_END;
+import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_START;
+import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_INPUT_AT_END;
+import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_OUTPUT_AT_END;
 import com.squareup.okhttp.OkHttpConnection;
 import com.squareup.okhttp.OkHttpsConnection;
 import java.io.ByteArrayOutputStream;
@@ -69,11 +73,6 @@
 import junit.framework.TestCase;
 import libcore.net.ssl.SslContextBuilder;
 
-import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_END;
-import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_START;
-import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_INPUT_AT_END;
-import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_OUTPUT_AT_END;
-
 /**
  * Android's URLConnectionTest.
  */
@@ -478,15 +477,16 @@
 
         // The pool will only reuse sockets if the SSL socket factories are the same.
         SSLSocketFactory clientSocketFactory = sslContext.getSocketFactory();
+        RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
 
         OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(clientSocketFactory);
-        connection.setHostnameVerifier(new RecordingHostnameVerifier());
+        connection.setHostnameVerifier(hostnameVerifier);
         assertContent("this response comes via HTTPS", connection);
 
         connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(clientSocketFactory);
-        connection.setHostnameVerifier(new RecordingHostnameVerifier());
+        connection.setHostnameVerifier(hostnameVerifier);
         assertContent("another response via HTTPS", connection);
 
         assertEquals(0, server.takeRequest().getSequenceNumber());
@@ -516,7 +516,7 @@
 
     public void testConnectViaHttpsWithSSLFallback() throws IOException, InterruptedException {
         server.useHttps(sslContext.getSocketFactory(), false);
-        server.enqueue(new MockResponse().setSocketPolicy(DISCONNECT_AT_START));
+        server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
         server.enqueue(new MockResponse().setBody("this response comes via SSL"));
         server.play();
 
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/OkHttpClient.java b/src/main/java/com/squareup/okhttp/OkHttpClient.java
new file mode 100644
index 0000000..97d4505
--- /dev/null
+++ b/src/main/java/com/squareup/okhttp/OkHttpClient.java
@@ -0,0 +1,43 @@
+/*
+ * Copyright (C) 2012 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.squareup.okhttp;
+
+import java.net.HttpURLConnection;
+import java.net.Proxy;
+import java.net.URL;
+
+/**
+ * Configures and creates HTTP connections.
+ */
+public final class OkHttpClient {
+    private Proxy proxy;
+
+    public OkHttpClient setProxy(Proxy proxy) {
+        this.proxy = proxy;
+        return this;
+    }
+
+    public HttpURLConnection open(URL url) {
+        String protocol = url.getProtocol();
+        if (protocol.equals("http")) {
+            return new libcore.net.http.HttpURLConnectionImpl(url, 80, proxy);
+        } else if (protocol.equals("https")) {
+            return new libcore.net.http.HttpsURLConnectionImpl(url, 443, proxy);
+        } else {
+            throw new IllegalArgumentException();
+        }
+    }
+}
/Fim/
/Fim/
/Fim/
diff --git a/src/main/java/libcore/Platform.java b/src/main/java/libcore/Platform.java
index 9a91c25..1d1453f 100644
--- a/src/main/java/libcore/Platform.java
+++ b/src/main/java/libcore/Platform.java
@@ -16,7 +16,7 @@
  */
 package libcore;
 
-import com.squareup.okhttp.OkHttpsConnection;
+import com.squareup.okhttp.OkHttpClient;
 import java.io.OutputStream;
 import java.io.UnsupportedEncodingException;
 import java.lang.reflect.Constructor;
@@ -260,7 +260,7 @@
                 JettyNpnProvider provider = (JettyNpnProvider) Proxy.getInvocationHandler(
                         getMethod.invoke(null, socket));
                 if (!provider.unsupported && provider.selected == null) {
-                    Logger logger = Logger.getLogger(OkHttpsConnection.class.getName());
+                    Logger logger = Logger.getLogger(OkHttpClient.class.getName());
                     logger.log(Level.INFO, "NPN callback dropped so SPDY is disabled. "
                             + "Is npn-boot on the boot class path?");
                     return null;
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpEngine.java b/src/main/java/libcore/net/http/HttpEngine.java
index 1ac53ce..e1fa9be 100644
--- a/src/main/java/libcore/net/http/HttpEngine.java
+++ b/src/main/java/libcore/net/http/HttpEngine.java
@@ -17,7 +17,6 @@
 
 package libcore.net.http;
 
-import com.squareup.okhttp.OkHttpConnection;
 import java.io.ByteArrayInputStream;
 import java.io.IOException;
 import java.io.InputStream;
@@ -25,6 +24,7 @@
 import java.net.CacheRequest;
 import java.net.CacheResponse;
 import java.net.CookieHandler;
+import java.net.HttpURLConnection;
 import java.net.Proxy;
 import java.net.ProxySelector;
 import java.net.ResponseCache;
@@ -391,7 +391,7 @@
         cacheRequest = responseCache.put(uri, getHttpConnectionToCache());
     }
 
-    protected OkHttpConnection getHttpConnectionToCache() {
+    protected HttpURLConnection getHttpConnectionToCache() {
         return policy;
     }
 
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpResponseCache.java b/src/main/java/libcore/net/http/HttpResponseCache.java
index 653a920..2932e7e 100644
--- a/src/main/java/libcore/net/http/HttpResponseCache.java
+++ b/src/main/java/libcore/net/http/HttpResponseCache.java
@@ -16,9 +16,6 @@
 
 package libcore.net.http;
 
-import com.squareup.okhttp.OkHttpConnection;
-import com.squareup.okhttp.OkHttpsConnection;
-
 import java.io.BufferedWriter;
 import java.io.ByteArrayInputStream;
 import java.io.File;
@@ -32,6 +29,7 @@
 import java.io.Writer;
 import java.net.CacheRequest;
 import java.net.CacheResponse;
+import java.net.HttpURLConnection;
 import java.net.ResponseCache;
 import java.net.SecureCacheResponse;
 import java.net.URI;
@@ -47,6 +45,7 @@
 import java.util.Arrays;
 import java.util.List;
 import java.util.Map;
+import javax.net.ssl.HttpsURLConnection;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import libcore.io.Base64;
 import libcore.io.DiskLruCache;
@@ -121,11 +120,11 @@
     }
 
     @Override public CacheRequest put(URI uri, URLConnection urlConnection) throws IOException {
-        if (!(urlConnection instanceof OkHttpConnection)) {
+        if (!(urlConnection instanceof HttpURLConnection)) {
             return null;
         }
 
-        OkHttpConnection httpConnection = (OkHttpConnection) urlConnection;
+        HttpURLConnection httpConnection = (HttpURLConnection) urlConnection;
         String requestMethod = httpConnection.getRequestMethod();
         String key = uriToKey(uri);
 
@@ -181,8 +180,8 @@
      * not updated. If the stored response has changed since {@code
      * conditionalCacheHit} was returned, this does nothing.
      */
-    @Override public void update(CacheResponse conditionalCacheHit, OkHttpConnection httpConnection)
-            throws IOException {
+    @Override public void update(CacheResponse conditionalCacheHit,
+            HttpURLConnection httpConnection) throws IOException {
         HttpEngine httpEngine = getHttpEngine(httpConnection);
         URI uri = httpEngine.getUri();
         ResponseHeaders response = httpEngine.getResponseHeaders();
@@ -408,7 +407,7 @@
             }
         }
 
-        public Entry(URI uri, RawHeaders varyHeaders, OkHttpConnection httpConnection)
+        public Entry(URI uri, RawHeaders varyHeaders, HttpURLConnection httpConnection)
                 throws IOException {
             this.uri = uri.toString();
             this.varyHeaders = varyHeaders;
@@ -416,8 +415,7 @@
             this.responseHeaders = RawHeaders.fromMultimap(httpConnection.getHeaderFields(), true);
 
             if (isHttps()) {
-                OkHttpsConnection httpsConnection
-                        = (OkHttpsConnection) httpConnection;
+                HttpsURLConnection httpsConnection = (HttpsURLConnection) httpConnection;
                 cipherSuite = httpsConnection.getCipherSuite();
                 Certificate[] peerCertificatesNonFinal = null;
                 try {
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpURLConnectionImpl.java b/src/main/java/libcore/net/http/HttpURLConnectionImpl.java
index 9467848..acfd56a 100644
--- a/src/main/java/libcore/net/http/HttpURLConnectionImpl.java
+++ b/src/main/java/libcore/net/http/HttpURLConnectionImpl.java
@@ -17,12 +17,12 @@
 
 package libcore.net.http;
 
-import com.squareup.okhttp.OkHttpConnection;
 import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
 import java.net.HttpRetryException;
+import java.net.HttpURLConnection;
 import java.net.InetSocketAddress;
 import java.net.ProtocolException;
 import java.net.Proxy;
@@ -50,7 +50,7 @@
  * connection} field on this class for null/non-null to determine of an instance
  * is currently connected to a server.
  */
-public class HttpURLConnectionImpl extends OkHttpConnection {
+public class HttpURLConnectionImpl extends HttpURLConnection {
     /**
      * HTTP 1.1 doesn't specify how many redirects to follow, but HTTP/1.0
      * recommended 5. http://www.w3.org/Protocols/HTTP/1.0/spec.html#Code3xx
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java b/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
index 2aaeaf4..982c5cd 100644
--- a/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
+++ b/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
@@ -16,12 +16,11 @@
  */
 package libcore.net.http;
 
-import com.squareup.okhttp.OkHttpConnection;
-import com.squareup.okhttp.OkHttpsConnection;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
 import java.net.CacheResponse;
+import java.net.HttpURLConnection;
 import java.net.ProtocolException;
 import java.net.Proxy;
 import java.net.SecureCacheResponse;
@@ -32,11 +31,12 @@
 import java.util.List;
 import java.util.Map;
 import javax.net.ssl.HostnameVerifier;
+import javax.net.ssl.HttpsURLConnection;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import javax.net.ssl.SSLSocket;
 import javax.net.ssl.SSLSocketFactory;
 
-public final class HttpsURLConnectionImpl extends OkHttpsConnection {
+public final class HttpsURLConnectionImpl extends HttpsURLConnection {
 
     /** HttpUrlConnectionDelegate allows reuse of HttpURLConnectionImpl. */
     private final HttpUrlConnectionDelegate delegate;
@@ -439,7 +439,7 @@
             return enclosing.getHostnameVerifier();
         }
 
-        @Override protected OkHttpConnection getHttpConnectionToCache() {
+        @Override protected HttpURLConnection getHttpConnectionToCache() {
             return enclosing;
         }
 
/Fim/
diff --git a/src/main/java/libcore/util/ExtendedResponseCache.java b/src/main/java/libcore/util/ExtendedResponseCache.java
index 2d89569..75e5157 100644
--- a/src/main/java/libcore/util/ExtendedResponseCache.java
+++ b/src/main/java/libcore/util/ExtendedResponseCache.java
@@ -16,9 +16,9 @@
 
 package libcore.util;
 
-import com.squareup.okhttp.OkHttpConnection;
 import java.io.IOException;
 import java.net.CacheResponse;
+import java.net.HttpURLConnection;
 
 /**
  * A response cache that supports statistics tracking and updating stored
@@ -51,5 +51,6 @@
      * Updates stored HTTP headers using a hit on a conditional GET.
      * @hide
      */
-    void update(CacheResponse conditionalCacheHit, OkHttpConnection httpConnection) throws IOException;
+    void update(CacheResponse conditionalCacheHit, HttpURLConnection httpConnection)
+            throws IOException;
 }
/Fim/
diff --git a/src/test/java/libcore/net/http/ExternalSpdyExample.java b/src/test/java/libcore/net/http/ExternalSpdyExample.java
index dc8aa1e..70a4c07 100644
--- a/src/test/java/libcore/net/http/ExternalSpdyExample.java
+++ b/src/test/java/libcore/net/http/ExternalSpdyExample.java
@@ -16,18 +16,18 @@
 
 package libcore.net.http;
 
-import com.squareup.okhttp.OkHttpConnection;
-import com.squareup.okhttp.OkHttpsConnection;
+import com.squareup.okhttp.OkHttpClient;
 import java.io.BufferedReader;
 import java.io.InputStreamReader;
 import java.net.URL;
 import javax.net.ssl.HostnameVerifier;
+import javax.net.ssl.HttpsURLConnection;
 import javax.net.ssl.SSLSession;
 
 public final class ExternalSpdyExample {
     public static void main(String[] args) throws Exception {
         URL url = new URL("https://www.google.ca/");
-        OkHttpsConnection connection = (OkHttpsConnection) OkHttpConnection.open(url);
+        HttpsURLConnection connection = (HttpsURLConnection) new OkHttpClient().open(url);
 
         connection.setHostnameVerifier(new HostnameVerifier() {
             @Override public boolean verify(String s, SSLSession sslSession) {
/Fim/
diff --git a/src/test/java/libcore/net/http/HttpResponseCacheTest.java b/src/test/java/libcore/net/http/HttpResponseCacheTest.java
index 2094e9e..d9eb918 100644
--- a/src/test/java/libcore/net/http/HttpResponseCacheTest.java
+++ b/src/test/java/libcore/net/http/HttpResponseCacheTest.java
@@ -19,7 +19,7 @@
 import com.google.mockwebserver.MockResponse;
 import com.google.mockwebserver.MockWebServer;
 import com.google.mockwebserver.RecordedRequest;
-import com.squareup.okhttp.OkHttpConnection;
+import com.squareup.okhttp.OkHttpClient;
 import java.io.BufferedReader;
 import java.io.ByteArrayOutputStream;
 import java.io.File;
@@ -89,8 +89,8 @@
         super.tearDown();
     }
 
-    private static OkHttpConnection openConnection(URL url) {
-        return OkHttpConnection.open(url);
+    private static HttpURLConnection openConnection(URL url) {
+        return new OkHttpClient().open(url);
     }
 
     /**
@@ -142,7 +142,7 @@
         server.play();
 
         URL url = server.getUrl("/");
-        OkHttpConnection conn = openConnection(url);
+        HttpURLConnection conn = openConnection(url);
         try {
             conn.getResponseCode();
             fail();
@@ -172,7 +172,7 @@
         server.play();
 
         URL url = server.getUrl("/");
-        OkHttpConnection conn = openConnection(url);
+        HttpURLConnection conn = openConnection(url);
         assertEquals(responseCode, conn.getResponseCode());
 
         // exhaust the content stream
@@ -209,7 +209,7 @@
                 return null;
             }
             @Override public CacheRequest put(URI uri, URLConnection conn) throws IOException {
-                OkHttpConnection httpConnection = (OkHttpConnection) conn;
+                HttpURLConnection httpConnection = (HttpURLConnection) conn;
                 try {
                     httpConnection.getRequestProperties();
                     fail();
@@ -238,7 +238,7 @@
         });
 
         URL url = server.getUrl("/");
-        OkHttpConnection connection = openConnection(url);
+        HttpURLConnection connection = openConnection(url);
         assertEquals(body, readAscii(connection));
         assertEquals(1, cacheCount.get());
     }
@@ -270,7 +270,7 @@
         server.play();
 
         // Make sure that calling skip() doesn't omit bytes from the cache.
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         InputStream in = urlConnection.getInputStream();
         assertEquals("I love ", readAscii(urlConnection, "I love ".length()));
         reliableSkip(in, "puppies but hate ".length());
@@ -361,7 +361,7 @@
         server.enqueue(new MockResponse().setBody("DEF"));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("ABC", readAscii(connection));
 
         connection = openConnection(server.getUrl("/")); // cached!
@@ -721,7 +721,7 @@
 
         URL url = server.getUrl("/");
 
-        OkHttpConnection request1 = (OkHttpConnection) openConnection(url);
+        HttpURLConnection request1 = (HttpURLConnection) openConnection(url);
         request1.setRequestMethod(requestMethod);
         addRequestBodyIfNecessary(requestMethod, request1);
         assertEquals("1", request1.getHeaderField("X-Response-ID"));
@@ -762,7 +762,7 @@
 
         assertEquals("A", readAscii(openConnection(url)));
 
-        OkHttpConnection invalidate = openConnection(url);
+        HttpURLConnection invalidate = openConnection(url);
         invalidate.setRequestMethod(requestMethod);
         addRequestBodyIfNecessary(requestMethod, invalidate);
         assertEquals("B", readAscii(invalidate));
@@ -960,7 +960,7 @@
         // (no responses enqueued)
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.addRequestProperty("Cache-Control", "only-if-cached");
         assertGatewayTimeout(connection);
     }
@@ -984,7 +984,7 @@
         server.play();
 
         assertEquals("A", readAscii(openConnection(server.getUrl("/"))));
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.addRequestProperty("Cache-Control", "only-if-cached");
         assertGatewayTimeout(connection);
     }
@@ -994,7 +994,7 @@
         server.play();
 
         assertEquals("A", readAscii(openConnection(server.getUrl("/"))));
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.addRequestProperty("Cache-Control", "only-if-cached");
         assertGatewayTimeout(connection);
     }
@@ -1065,7 +1065,7 @@
         URL url = server.getUrl("/");
         assertEquals("A", readAscii(openConnection(url)));
 
-        OkHttpConnection connection = openConnection(url);
+        HttpURLConnection connection = openConnection(url);
         connection.addRequestProperty(conditionName, conditionValue);
         assertEquals(HttpURLConnection.HTTP_NOT_MODIFIED, connection.getResponseCode());
         assertEquals("", readAscii(connection));
@@ -1092,7 +1092,7 @@
                 .setResponseCode(HttpURLConnection.HTTP_NOT_MODIFIED));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         String clientIfModifiedSince = formatDate(-24, TimeUnit.HOURS);
         connection.addRequestProperty("If-Modified-Since", clientIfModifiedSince);
         assertEquals(HttpURLConnection.HTTP_NOT_MODIFIED, connection.getResponseCode());
@@ -1281,11 +1281,11 @@
         server.play();
 
         URL url = server.getUrl("/");
-        OkHttpConnection frConnection = openConnection(url);
+        HttpURLConnection frConnection = openConnection(url);
         frConnection.addRequestProperty("Accept-Language", "fr-CA");
         assertEquals("A", readAscii(frConnection));
 
-        OkHttpConnection enConnection = openConnection(url);
+        HttpURLConnection enConnection = openConnection(url);
         enConnection.addRequestProperty("Accept-Language", "en-US");
         assertEquals("B", readAscii(enConnection));
     }
@@ -1635,18 +1635,18 @@
         server.play();
 
         // cache miss; seed the cache
-        OkHttpConnection connection1 = openConnection(server.getUrl("/a"));
+        HttpURLConnection connection1 = openConnection(server.getUrl("/a"));
         assertEquals("A", readAscii(connection1));
         assertEquals(null, connection1.getHeaderField("Allow"));
 
         // conditional cache hit; update the cache
-        OkHttpConnection connection2 = openConnection(server.getUrl("/a"));
+        HttpURLConnection connection2 = openConnection(server.getUrl("/a"));
         assertEquals(HttpURLConnection.HTTP_OK, connection2.getResponseCode());
         assertEquals("A", readAscii(connection2));
         assertEquals("GET, HEAD", connection2.getHeaderField("Allow"));
 
         // full cache hit
-        OkHttpConnection connection3 = openConnection(server.getUrl("/a"));
+        HttpURLConnection connection3 = openConnection(server.getUrl("/a"));
         assertEquals("A", readAscii(connection3));
         assertEquals("GET, HEAD", connection3.getHeaderField("Allow"));
 
@@ -1668,7 +1668,7 @@
         return rfc1123.format(date);
     }
 
-    private void addRequestBodyIfNecessary(String requestMethod, OkHttpConnection invalidate)
+    private void addRequestBodyIfNecessary(String requestMethod, HttpURLConnection invalidate)
             throws IOException {
         if (requestMethod.equals("POST") || requestMethod.equals("PUT")) {
             invalidate.setDoOutput(true);
@@ -1728,21 +1728,21 @@
         server.play();
 
         URL valid = server.getUrl("/valid");
-        OkHttpConnection connection1 = openConnection(valid);
+        HttpURLConnection connection1 = openConnection(valid);
         assertEquals("A", readAscii(connection1));
         assertEquals(HttpURLConnection.HTTP_OK, connection1.getResponseCode());
         assertEquals("A-OK", connection1.getResponseMessage());
-        OkHttpConnection connection2 = openConnection(valid);
+        HttpURLConnection connection2 = openConnection(valid);
         assertEquals("A", readAscii(connection2));
         assertEquals(HttpURLConnection.HTTP_OK, connection2.getResponseCode());
         assertEquals("A-OK", connection2.getResponseMessage());
 
         URL invalid = server.getUrl("/invalid");
-        OkHttpConnection connection3 = openConnection(invalid);
+        HttpURLConnection connection3 = openConnection(invalid);
         assertEquals("B", readAscii(connection3));
         assertEquals(HttpURLConnection.HTTP_OK, connection3.getResponseCode());
         assertEquals("B-OK", connection3.getResponseMessage());
-        OkHttpConnection connection4 = openConnection(invalid);
+        HttpURLConnection connection4 = openConnection(invalid);
         assertEquals("C", readAscii(connection4));
         assertEquals(HttpURLConnection.HTTP_OK, connection4.getResponseCode());
         assertEquals("C-OK", connection4.getResponseMessage());
@@ -1781,7 +1781,7 @@
      * characters are returned and the stream is closed.
      */
     private String readAscii(URLConnection connection, int count) throws IOException {
-        OkHttpConnection httpConnection = (OkHttpConnection) connection;
+        HttpURLConnection httpConnection = (HttpURLConnection) connection;
         InputStream in = httpConnection.getResponseCode() < HttpURLConnection.HTTP_BAD_REQUEST
                 ? connection.getInputStream()
                 : httpConnection.getErrorStream();
@@ -1807,7 +1807,7 @@
         }
     }
 
-    private void assertGatewayTimeout(OkHttpConnection connection) throws IOException {
+    private void assertGatewayTimeout(HttpURLConnection connection) throws IOException {
         try {
             connection.getInputStream();
             fail();
/Fim/
diff --git a/src/test/java/libcore/net/http/URLConnectionTest.java b/src/test/java/libcore/net/http/URLConnectionTest.java
index 075059d..476e4af 100644
--- a/src/test/java/libcore/net/http/URLConnectionTest.java
+++ b/src/test/java/libcore/net/http/URLConnectionTest.java
@@ -20,8 +20,7 @@
 import com.google.mockwebserver.MockWebServer;
 import com.google.mockwebserver.RecordedRequest;
 import com.google.mockwebserver.SocketPolicy;
-import com.squareup.okhttp.OkHttpConnection;
-import com.squareup.okhttp.OkHttpsConnection;
+import com.squareup.okhttp.OkHttpClient;
 import java.io.ByteArrayOutputStream;
 import java.io.File;
 import java.io.IOException;
@@ -63,6 +62,7 @@
 import java.util.zip.GZIPInputStream;
 import java.util.zip.GZIPOutputStream;
 import javax.net.ssl.HostnameVerifier;
+import javax.net.ssl.HttpsURLConnection;
 import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLException;
 import javax.net.ssl.SSLSession;
@@ -124,12 +124,12 @@
         super.tearDown();
     }
 
-    private static OkHttpConnection openConnection(URL url) {
-        return OkHttpConnection.open(url);
+    private static HttpURLConnection openConnection(URL url) {
+        return new OkHttpClient().open(url);
     }
 
-    private static OkHttpConnection openConnection(URL url, Proxy proxy) {
-        return OkHttpConnection.open(url, proxy);
+    private static HttpURLConnection openConnection(URL url, Proxy proxy) {
+        return new OkHttpClient().setProxy(proxy).open(url);
     }
 
     // TODO: test that request bodies are retransmitted on IP address failures
@@ -139,7 +139,7 @@
         server.enqueue(new MockResponse());
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         urlConnection.addRequestProperty("D", "e");
         urlConnection.addRequestProperty("D", "f");
         assertEquals("f", urlConnection.getRequestProperty("D"));
@@ -200,7 +200,7 @@
 
     public void testGetRequestPropertyReturnsLastValue() throws Exception {
         server.play();
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         urlConnection.addRequestProperty("A", "value1");
         urlConnection.addRequestProperty("A", "value2");
         assertEquals("value2", urlConnection.getRequestProperty("A"));
@@ -215,7 +215,7 @@
                 .setChunkedBody("ABCDE\nFGHIJ\nKLMNO\nPQR", 8));
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         assertEquals(200, urlConnection.getResponseCode());
         assertEquals("Fantastic", urlConnection.getResponseMessage());
         assertEquals("HTTP/1.0 200 Fantastic", urlConnection.getHeaderField(null));
@@ -245,7 +245,7 @@
         server.enqueue(new MockResponse().setStatus("HTP/1.1 200 OK"));
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         try {
             urlConnection.getResponseCode();
             fail();
@@ -257,7 +257,7 @@
         server.enqueue(new MockResponse().setStatus("HTTP/1.1 2147483648 OK"));
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         try {
             urlConnection.getResponseCode();
             fail();
@@ -269,7 +269,7 @@
         server.enqueue(new MockResponse().setStatus("HTTP/1.1 00a OK"));
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         try {
             urlConnection.getResponseCode();
             fail();
@@ -281,7 +281,7 @@
         server.enqueue(new MockResponse().setStatus(" HTTP/1.1 2147483648 OK"));
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         try {
             urlConnection.getResponseCode();
             fail();
@@ -294,7 +294,7 @@
         URL url = server.getUrl("/foo");
         server.shutdown();
 
-        OkHttpConnection connection = openConnection(url);
+        HttpURLConnection connection = openConnection(url);
         try {
             connection.connect();
             fail();
@@ -325,7 +325,7 @@
         ProxySelector.setDefault(proxySelector);
         server2.shutdown();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/def"));
+        HttpURLConnection connection = openConnection(server.getUrl("/def"));
         connection.setDoOutput(true);
         transferKind.setForRequest(connection, 4);
         connection.getOutputStream().write("body".getBytes("UTF-8"));
@@ -337,14 +337,14 @@
     public void testGetErrorStreamOnSuccessfulRequest() throws Exception {
         server.enqueue(new MockResponse().setBody("A"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertNull(connection.getErrorStream());
     }
 
     public void testGetErrorStreamOnUnsuccessfulRequest() throws Exception {
         server.enqueue(new MockResponse().setResponseCode(404).setBody("A"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("A", readAscii(connection.getErrorStream(), Integer.MAX_VALUE));
     }
 
@@ -460,7 +460,7 @@
         server.enqueue(new MockResponse());
         server.play();
 
-        OkHttpConnection conn = openConnection(server.getUrl("/"));
+        HttpURLConnection conn = openConnection(server.getUrl("/"));
         conn.setDoOutput(true);
         conn.setRequestMethod("POST");
         if (uploadKind == TransferKind.CHUNKED) {
@@ -497,7 +497,7 @@
         server.play();
 
         URL url = server.getUrl("/");
-        OkHttpConnection conn = openConnection(url);
+        HttpURLConnection conn = openConnection(url);
         conn.setDoInput(false);
         assertEquals("def", conn.getHeaderField("abc"));
         assertEquals(200, conn.getResponseCode());
@@ -513,7 +513,7 @@
         server.enqueue(new MockResponse().setBody("this response comes via HTTPS"));
         server.play();
 
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/foo"));
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(server.getUrl("/foo"));
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
 
@@ -533,12 +533,12 @@
         SSLSocketFactory clientSocketFactory = sslContext.getSocketFactory();
         RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
 
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(clientSocketFactory);
         connection.setHostnameVerifier(hostnameVerifier);
         assertContent("this response comes via HTTPS", connection);
 
-        connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
+        connection = (HttpsURLConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(clientSocketFactory);
         connection.setHostnameVerifier(hostnameVerifier);
         assertContent("another response via HTTPS", connection);
@@ -555,12 +555,12 @@
         server.play();
 
         // install a custom SSL socket factory so the server can be authorized
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
         assertContent("this response comes via HTTPS", connection);
 
-        connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
+        connection = (HttpsURLConnection) openConnection(server.getUrl("/"));
         try {
             readAscii(connection.getInputStream(), Integer.MAX_VALUE);
             fail("without an SSL socket factory, the connection should fail");
@@ -574,7 +574,7 @@
         server.enqueue(new MockResponse().setBody("this response comes via SSL"));
         server.play();
 
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/foo"));
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(server.getUrl("/foo"));
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
 
@@ -626,7 +626,7 @@
         server.play();
 
         URL url = new URL("http://android.com/foo");
-        OkHttpConnection connection = proxyConfig.connect(server, url);
+        HttpURLConnection connection = proxyConfig.connect(server, url);
         assertContent("this response comes via a proxy", connection);
 
         RecordedRequest request = server.takeRequest();
@@ -675,7 +675,7 @@
         server.play();
 
         URL url = server.getUrl("/foo");
-        OkHttpsConnection connection = (OkHttpsConnection) proxyConfig.connect(server, url);
+        HttpsURLConnection connection = (HttpsURLConnection) proxyConfig.connect(server, url);
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
 
@@ -716,7 +716,7 @@
         server.play();
 
         URL url = new URL("https://android.com/foo");
-        OkHttpsConnection connection = (OkHttpsConnection) proxyConfig.connect(server, url);
+        HttpsURLConnection connection = (HttpsURLConnection) proxyConfig.connect(server, url);
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(hostnameVerifier);
 
@@ -754,7 +754,7 @@
         server.play();
 
         URL url = new URL("https://android.com/foo");
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(
                 url, server.toProxyAddress());
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
 
@@ -795,7 +795,7 @@
         server.play();
 
         URL url = new URL("https://android.com/foo");
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(
                 url, server.toProxyAddress());
         connection.addRequestProperty("Private", "Secret");
         connection.addRequestProperty("Proxy-Authorization", "bar");
@@ -829,7 +829,7 @@
         server.play();
 
         URL url = new URL("https://android.com/foo");
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(
                 url, server.toProxyAddress());
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
@@ -859,7 +859,7 @@
         server.play();
 
         URL url = new URL("https://android.com/foo");
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(
                 url, server.toProxyAddress());
         connection.setRequestProperty("Connection", "close");
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
@@ -881,13 +881,13 @@
         server.play();
 
         URL url = new URL("https://android.com/foo");
-        OkHttpsConnection connection1 = (OkHttpsConnection) openConnection(
+        HttpsURLConnection connection1 = (HttpsURLConnection) openConnection(
                 url, server.toProxyAddress());
         connection1.setSSLSocketFactory(socketFactory);
         connection1.setHostnameVerifier(hostnameVerifier);
         assertContent("response 1", connection1);
 
-        OkHttpsConnection connection2 = (OkHttpsConnection) openConnection(
+        HttpsURLConnection connection2 = (HttpsURLConnection) openConnection(
                 url, server.toProxyAddress());
         connection2.setSSLSocketFactory(socketFactory);
         connection2.setHostnameVerifier(hostnameVerifier);
@@ -898,7 +898,7 @@
         server.enqueue(new MockResponse().setBody("ABCDEFGHIJKLMNOPQR"));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         InputStream in = connection.getInputStream();
         assertEquals('A', (char) in.read());
         connection.disconnect();
@@ -913,7 +913,7 @@
         server.enqueue(new MockResponse().setBody("A"));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.disconnect();
 
         assertContent("A", connection);
@@ -1035,7 +1035,7 @@
         server.play();
 
         URL url = server.getUrl("/");
-        OkHttpConnection conn = openConnection(url);
+        HttpURLConnection conn = openConnection(url);
 
         assertEquals(401, conn.getResponseCode());
         assertEquals(401, conn.getResponseCode());
@@ -1165,8 +1165,8 @@
 
         URLConnection connection = openConnection(server.getUrl("/"));
         if (tls) {
-            ((OkHttpsConnection) connection).setSSLSocketFactory(socketFactory);
-            ((OkHttpsConnection) connection).setHostnameVerifier(hostnameVerifier);
+            ((HttpsURLConnection) connection).setSSLSocketFactory(socketFactory);
+            ((HttpsURLConnection) connection).setHostnameVerifier(hostnameVerifier);
         }
         connection.addRequestProperty("Accept-Encoding", "gzip");
         InputStream gunzippedIn = new GZIPInputStream(connection.getInputStream());
@@ -1175,8 +1175,8 @@
 
         connection = openConnection(server.getUrl("/"));
         if (tls) {
-            ((OkHttpsConnection) connection).setSSLSocketFactory(socketFactory);
-            ((OkHttpsConnection) connection).setHostnameVerifier(hostnameVerifier);
+            ((HttpsURLConnection) connection).setSSLSocketFactory(socketFactory);
+            ((HttpsURLConnection) connection).setHostnameVerifier(hostnameVerifier);
         }
         assertEquals("two (identity)", readAscii(connection.getInputStream(), Integer.MAX_VALUE));
         assertEquals(1, server.takeRequest().getSequenceNumber());
@@ -1206,7 +1206,7 @@
         assertEquals("ABCDE", readAscii(in1, 5));
         in1.close();
 
-        OkHttpConnection connection2 = openConnection(server.getUrl("/"));
+        HttpURLConnection connection2 = openConnection(server.getUrl("/"));
         InputStream in2 = connection2.getInputStream();
         assertEquals("LMNOP", readAscii(in2, 5));
         in2.close();
@@ -1225,7 +1225,7 @@
         server.enqueue(new MockResponse());
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         urlConnection.setChunkedStreamingMode(8);
         urlConnection.setDoOutput(true);
         OutputStream outputStream = urlConnection.getOutputStream();
@@ -1254,7 +1254,7 @@
         server.play();
 
         Authenticator.setDefault(new RecordingAuthenticator());
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setDoOutput(true);
         byte[] requestBody = { 'A', 'B', 'C', 'D' };
         if (streamingMode == StreamingMode.FIXED_LENGTH) {
@@ -1345,7 +1345,7 @@
         server.enqueue(pleaseAuthenticate);
         server.play();
 
-        OkHttpConnection connection = proxy
+        HttpURLConnection connection = proxy
                 ? openConnection(new URL("http://android.com"), server.toProxyAddress())
                 : openConnection(server.getUrl("/"));
         assertEquals(responseCode, connection.getResponseCode());
@@ -1364,7 +1364,7 @@
     }
 
     private void assertValidRequestMethod(String requestMethod) throws Exception {
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setRequestMethod(requestMethod);
         assertEquals(requestMethod, connection.getRequestMethod());
     }
@@ -1380,7 +1380,7 @@
     }
 
     private void assertInvalidRequestMethod(String requestMethod) throws Exception {
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         try {
             connection.setRequestMethod(requestMethod);
             fail();
@@ -1390,7 +1390,7 @@
 
     public void testCannotSetNegativeFixedLengthStreamingMode() throws Exception {
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         try {
             connection.setFixedLengthStreamingMode(-2);
             fail();
@@ -1400,14 +1400,14 @@
 
     public void testCanSetNegativeChunkedStreamingMode() throws Exception {
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setChunkedStreamingMode(-2);
     }
 
     public void testCannotSetFixedLengthStreamingModeAfterConnect() throws Exception {
         server.enqueue(new MockResponse().setBody("A"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("A", readAscii(connection.getInputStream(), Integer.MAX_VALUE));
         try {
             connection.setFixedLengthStreamingMode(1);
@@ -1419,7 +1419,7 @@
     public void testCannotSetChunkedStreamingModeAfterConnect() throws Exception {
         server.enqueue(new MockResponse().setBody("A"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("A", readAscii(connection.getInputStream(), Integer.MAX_VALUE));
         try {
             connection.setChunkedStreamingMode(1);
@@ -1430,7 +1430,7 @@
 
     public void testCannotSetFixedLengthStreamingModeAfterChunkedStreamingMode() throws Exception {
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setChunkedStreamingMode(1);
         try {
             connection.setFixedLengthStreamingMode(1);
@@ -1441,7 +1441,7 @@
 
     public void testCannotSetChunkedStreamingModeAfterFixedLengthStreamingMode() throws Exception {
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setFixedLengthStreamingMode(1);
         try {
             connection.setChunkedStreamingMode(1);
@@ -1467,7 +1467,7 @@
         server.enqueue(new MockResponse().setBody("Success!"));
         server.play();
 
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
         connection.setDoOutput(true);
@@ -1510,7 +1510,7 @@
         server.play();
 
         Authenticator.setDefault(new RecordingAuthenticator());
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setDoOutput(true);
         byte[] requestBody = { 'A', 'B', 'C', 'D' };
         OutputStream outputStream = connection.getOutputStream();
@@ -1545,7 +1545,7 @@
         server.play();
 
         Authenticator.setDefault(new RecordingAuthenticator());
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("Successful auth!", readAscii(connection.getInputStream(), Integer.MAX_VALUE));
 
         // no authorization header for the first request...
@@ -1574,7 +1574,7 @@
 
     private void testRedirected(TransferKind transferKind, boolean reuse) throws Exception {
         MockResponse response = new MockResponse()
-                .setResponseCode(OkHttpConnection.HTTP_MOVED_TEMP)
+                .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
                 .addHeader("Location: /foo");
         transferKind.setBody(response, "This page has moved!", 10);
         server.enqueue(response);
@@ -1603,7 +1603,7 @@
         server.enqueue(new MockResponse().setBody("This is the new location!"));
         server.play();
 
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
         assertEquals("This is the new location!",
@@ -1624,7 +1624,7 @@
                 .setBody("This page has moved!"));
         server.play();
 
-        OkHttpsConnection connection = (OkHttpsConnection) openConnection(server.getUrl("/"));
+        HttpsURLConnection connection = (HttpsURLConnection) openConnection(server.getUrl("/"));
         connection.setSSLSocketFactory(sslContext.getSocketFactory());
         connection.setHostnameVerifier(new RecordingHostnameVerifier());
         assertEquals("This page has moved!",
@@ -1633,12 +1633,12 @@
 
     public void testNotRedirectedFromHttpToHttps() throws IOException, InterruptedException {
         server.enqueue(new MockResponse()
-                .setResponseCode(OkHttpConnection.HTTP_MOVED_TEMP)
+                .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
                 .addHeader("Location: https://anyhost/foo")
                 .setBody("This page has moved!"));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("This page has moved!",
                 readAscii(connection.getInputStream(), Integer.MAX_VALUE));
     }
@@ -1649,7 +1649,7 @@
         server2.play();
 
         server.enqueue(new MockResponse()
-                .setResponseCode(OkHttpConnection.HTTP_MOVED_TEMP)
+                .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
                 .addHeader("Location: " + server2.getUrl("/").toString())
                 .setBody("This page has moved!"));
         server.enqueue(new MockResponse().setBody("This is the first server again!"));
@@ -1676,19 +1676,19 @@
 
     public void testResponse300MultipleChoiceWithPost() throws Exception {
         // Chrome doesn't follow the redirect, but Firefox and the RI both do
-        testResponseRedirectedWithPost(OkHttpConnection.HTTP_MULT_CHOICE);
+        testResponseRedirectedWithPost(HttpURLConnection.HTTP_MULT_CHOICE);
     }
 
     public void testResponse301MovedPermanentlyWithPost() throws Exception {
-        testResponseRedirectedWithPost(OkHttpConnection.HTTP_MOVED_PERM);
+        testResponseRedirectedWithPost(HttpURLConnection.HTTP_MOVED_PERM);
     }
 
     public void testResponse302MovedTemporarilyWithPost() throws Exception {
-        testResponseRedirectedWithPost(OkHttpConnection.HTTP_MOVED_TEMP);
+        testResponseRedirectedWithPost(HttpURLConnection.HTTP_MOVED_TEMP);
     }
 
     public void testResponse303SeeOtherWithPost() throws Exception {
-        testResponseRedirectedWithPost(OkHttpConnection.HTTP_SEE_OTHER);
+        testResponseRedirectedWithPost(HttpURLConnection.HTTP_SEE_OTHER);
     }
 
     private void testResponseRedirectedWithPost(int redirectCode) throws Exception {
@@ -1699,7 +1699,7 @@
         server.enqueue(new MockResponse().setBody("Page 2"));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/page1"));
+        HttpURLConnection connection = openConnection(server.getUrl("/page1"));
         connection.setDoOutput(true);
         byte[] requestBody = { 'A', 'B', 'C', 'D' };
         OutputStream outputStream = connection.getOutputStream();
@@ -1719,12 +1719,12 @@
     public void testResponse305UseProxy() throws Exception {
         server.play();
         server.enqueue(new MockResponse()
-                .setResponseCode(OkHttpConnection.HTTP_USE_PROXY)
+                .setResponseCode(HttpURLConnection.HTTP_USE_PROXY)
                 .addHeader("Location: " + server.getUrl("/"))
                 .setBody("This page has moved!"));
         server.enqueue(new MockResponse().setBody("Proxy Response"));
 
-        OkHttpConnection connection = openConnection(server.getUrl("/foo"));
+        HttpURLConnection connection = openConnection(server.getUrl("/foo"));
         // Fails on the RI, which gets "Proxy Response"
         assertEquals("This page has moved!",
                 readAscii(connection.getInputStream(), Integer.MAX_VALUE));
@@ -1819,7 +1819,7 @@
         server.enqueue(new MockResponse());
         server.play();
 
-        OkHttpConnection urlConnection = openConnection(server.getUrl("/"));
+        HttpURLConnection urlConnection = openConnection(server.getUrl("/"));
         urlConnection.setRequestProperty("Transfer-encoding", "chunked");
         urlConnection.setDoOutput(true);
         urlConnection.getOutputStream().write("ABC".getBytes("UTF-8"));
@@ -1834,11 +1834,11 @@
         server.enqueue(new MockResponse());
         server.play();
 
-        OkHttpConnection a = openConnection(server.getUrl("/"));
+        HttpURLConnection a = openConnection(server.getUrl("/"));
         a.setRequestProperty("Connection", "close");
         assertEquals(200, a.getResponseCode());
 
-        OkHttpConnection b = openConnection(server.getUrl("/"));
+        HttpURLConnection b = openConnection(server.getUrl("/"));
         assertEquals(200, b.getResponseCode());
 
         assertEquals(0, server.takeRequest().getSequenceNumber());
@@ -1851,10 +1851,10 @@
         server.enqueue(new MockResponse());
         server.play();
 
-        OkHttpConnection a = openConnection(server.getUrl("/"));
+        HttpURLConnection a = openConnection(server.getUrl("/"));
         assertEquals(200, a.getResponseCode());
 
-        OkHttpConnection b = openConnection(server.getUrl("/"));
+        HttpURLConnection b = openConnection(server.getUrl("/"));
         assertEquals(200, b.getResponseCode());
 
         assertEquals(0, server.takeRequest().getSequenceNumber());
@@ -1864,7 +1864,7 @@
 
     public void testConnectionCloseWithRedirect() throws IOException, InterruptedException {
         MockResponse response = new MockResponse()
-                .setResponseCode(OkHttpConnection.HTTP_MOVED_TEMP)
+                .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
                 .addHeader("Location: /foo")
                 .addHeader("Connection: close");
         server.enqueue(response);
@@ -1882,7 +1882,7 @@
 
     public void testResponseCodeDisagreesWithHeaders() throws IOException, InterruptedException {
         server.enqueue(new MockResponse()
-                .setResponseCode(OkHttpConnection.HTTP_NO_CONTENT)
+                .setResponseCode(HttpURLConnection.HTTP_NO_CONTENT)
                 .setBody("This body is not allowed!"));
         server.play();
 
@@ -1923,7 +1923,7 @@
         server.enqueue(new MockResponse().setBody("abc"));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setDoOutput(true);
         byte[] upload = "def".getBytes("UTF-8");
 
@@ -1954,7 +1954,7 @@
         }
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         try {
             connection.getInputStream();
             fail();
@@ -1969,7 +1969,7 @@
     }
 
     public void testDnsFailureThrowsIOException() throws IOException {
-        OkHttpConnection connection = openConnection(new URL("http://host.unlikelytld"));
+        HttpURLConnection connection = openConnection(new URL("http://host.unlikelytld"));
         try {
             connection.connect();
             fail();
@@ -1978,7 +1978,7 @@
     }
 
     public void testMalformedUrlThrowsUnknownHostException() throws IOException {
-        OkHttpConnection connection = openConnection(new URL("http:///foo.html"));
+        HttpURLConnection connection = openConnection(new URL("http:///foo.html"));
         try {
             connection.connect();
             fail();
@@ -2103,7 +2103,7 @@
         });
 
         try {
-            OkHttpConnection connection = openConnection(url);
+            HttpURLConnection connection = openConnection(url);
             connection.getResponseCode();
         } catch (Exception expected) {
             if (expected.getCause() instanceof URISyntaxException) {
@@ -2139,7 +2139,7 @@
         server.enqueue(new MockResponse().setBody("abcdef"));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         InputStream in = connection.getInputStream();
         assertEquals("abc", readAscii(in, 3));
         in.close();
@@ -2158,7 +2158,7 @@
                 .setSocketPolicy(SocketPolicy.DISCONNECT_AT_END));
         server.play();
 
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         InputStream in = connection.getInputStream();
         assertEquals("ABC", readAscii(in, 3));
         assertEquals(-1, in.read());
@@ -2170,7 +2170,7 @@
                 .addHeader("Content-Type: text/plain")
                 .setBody("A"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         InputStream in = (InputStream) connection.getContent();
         assertEquals("A", readAscii(in, Integer.MAX_VALUE));
     }
@@ -2180,7 +2180,7 @@
                 .addHeader("Content-Type: text/plain")
                 .setBody("A"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         try {
             connection.getContent(null);
             fail();
@@ -2198,7 +2198,7 @@
     public void testGetOutputStreamOnGetFails() throws Exception {
         server.enqueue(new MockResponse());
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         try {
             connection.getOutputStream();
             fail();
@@ -2209,7 +2209,7 @@
     public void testGetOutputAfterGetInputStreamFails() throws Exception {
         server.enqueue(new MockResponse());
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setDoOutput(true);
         try {
             connection.getInputStream();
@@ -2222,7 +2222,7 @@
     public void testSetDoOutputOrDoInputAfterConnectFails() throws Exception {
         server.enqueue(new MockResponse());
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.connect();
         try {
             connection.setDoOutput(true);
@@ -2240,7 +2240,7 @@
     public void testClientSendsContentLength() throws Exception {
         server.enqueue(new MockResponse().setBody("A"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         connection.setDoOutput(true);
         OutputStream out = connection.getOutputStream();
         out.write(new byte[] { 'A', 'B', 'C' });
@@ -2253,7 +2253,7 @@
     public void testGetContentLengthConnects() throws Exception {
         server.enqueue(new MockResponse().setBody("ABC"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals(3, connection.getContentLength());
         connection.disconnect();
     }
@@ -2263,7 +2263,7 @@
                 .addHeader("Content-Type: text/plain")
                 .setBody("ABC"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("text/plain", connection.getContentType());
         connection.disconnect();
     }
@@ -2273,7 +2273,7 @@
                 .addHeader("Content-Encoding: identity")
                 .setBody("ABC"));
         server.play();
-        OkHttpConnection connection = openConnection(server.getUrl("/"));
+        HttpURLConnection connection = openConnection(server.getUrl("/"));
         assertEquals("identity", connection.getContentEncoding());
         connection.disconnect();
     }
@@ -2336,7 +2336,7 @@
             throws IOException {
         connection.connect();
         assertEquals(expected, readAscii(connection.getInputStream(), limit));
-        ((OkHttpConnection) connection).disconnect();
+        ((HttpURLConnection) connection).disconnect();
     }
 
     private void assertContent(String expected, URLConnection connection) throws IOException {
@@ -2365,7 +2365,7 @@
                     throws IOException {
                 response.setChunkedBody(content, chunkSize);
             }
-            @Override void setForRequest(OkHttpConnection connection, int contentLength) {
+            @Override void setForRequest(HttpURLConnection connection, int contentLength) {
                 connection.setChunkedStreamingMode(5);
             }
         },
@@ -2373,7 +2373,7 @@
             @Override void setBody(MockResponse response, byte[] content, int chunkSize) {
                 response.setBody(content);
             }
-            @Override void setForRequest(OkHttpConnection connection, int contentLength) {
+            @Override void setForRequest(HttpURLConnection connection, int contentLength) {
                 connection.setChunkedStreamingMode(contentLength);
             }
         },
@@ -2388,14 +2388,14 @@
                     }
                 }
             }
-            @Override void setForRequest(OkHttpConnection connection, int contentLength) {
+            @Override void setForRequest(HttpURLConnection connection, int contentLength) {
             }
         };
 
         abstract void setBody(MockResponse response, byte[] content, int chunkSize)
                 throws IOException;
 
-        abstract void setForRequest(OkHttpConnection connection, int contentLength);
+        abstract void setForRequest(HttpURLConnection connection, int contentLength);
 
         void setBody(MockResponse response, String content, int chunkSize) throws IOException {
             setBody(response, content.getBytes("UTF-8"), chunkSize);
@@ -2404,21 +2404,21 @@
 
     enum ProxyConfig {
         NO_PROXY() {
-            @Override public OkHttpConnection connect(MockWebServer server, URL url)
+            @Override public HttpURLConnection connect(MockWebServer server, URL url)
                     throws IOException {
                 return openConnection(url, Proxy.NO_PROXY);
             }
         },
 
         CREATE_ARG() {
-            @Override public OkHttpConnection connect(MockWebServer server, URL url)
+            @Override public HttpURLConnection connect(MockWebServer server, URL url)
                     throws IOException {
                 return openConnection(url, server.toProxyAddress());
             }
         },
 
         PROXY_SYSTEM_PROPERTY() {
-            @Override public OkHttpConnection connect(MockWebServer server, URL url)
+            @Override public HttpURLConnection connect(MockWebServer server, URL url)
                     throws IOException {
                 System.setProperty("proxyHost", "localhost");
                 System.setProperty("proxyPort", Integer.toString(server.getPort()));
@@ -2427,7 +2427,7 @@
         },
 
         HTTP_PROXY_SYSTEM_PROPERTY() {
-            @Override public OkHttpConnection connect(MockWebServer server, URL url)
+            @Override public HttpURLConnection connect(MockWebServer server, URL url)
                     throws IOException {
                 System.setProperty("http.proxyHost", "localhost");
                 System.setProperty("http.proxyPort", Integer.toString(server.getPort()));
@@ -2436,7 +2436,7 @@
         },
 
         HTTPS_PROXY_SYSTEM_PROPERTY() {
-            @Override public OkHttpConnection connect(MockWebServer server, URL url)
+            @Override public HttpURLConnection connect(MockWebServer server, URL url)
                     throws IOException {
                 System.setProperty("https.proxyHost", "localhost");
                 System.setProperty("https.proxyPort", Integer.toString(server.getPort()));
@@ -2444,7 +2444,7 @@
             }
         };
 
-        public abstract OkHttpConnection connect(MockWebServer server, URL url) throws IOException;
+        public abstract HttpURLConnection connect(MockWebServer server, URL url) throws IOException;
     }
 
     private static class RecordingTrustManager implements X509TrustManager {
/Fim/
diff --git a/pom.xml b/pom.xml
index c7381d5..0e63c2d 100644
--- a/pom.xml
+++ b/pom.xml
@@ -102,31 +102,6 @@
                 </configuration>
             </plugin>
             <plugin>
-                <groupId>org.sonatype.plugins</groupId>
-                <artifactId>jarjar-maven-plugin</artifactId>
-                <version>1.5</version>
-                <executions>
-                    <execution>
-                        <phase>package</phase>
-                        <goals>
-                            <goal>jarjar</goal>
-                        </goals>
-                        <configuration>
-                            <includes>
-                                <include>asm:asm</include>
-                                <include>org.sonatype.sisu.inject:cglib</include>
-                            </includes>
-                            <rules>
-                                <rule>
-                                    <pattern>libcore.**</pattern>
-                                    <result>com.squareup.okhttp.libcore.@1</result>
-                                </rule>
-                            </rules>
-                        </configuration>
-                    </execution>
-                </executions>
-            </plugin>
-            <plugin>
                 <groupId>org.apache.maven.plugins</groupId>
                 <artifactId>maven-checkstyle-plugin</artifactId>
                 <version>2.9.1</version>
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/OkHttpClient.java b/src/main/java/com/squareup/okhttp/OkHttpClient.java
index 97d4505..183e936 100644
--- a/src/main/java/com/squareup/okhttp/OkHttpClient.java
+++ b/src/main/java/com/squareup/okhttp/OkHttpClient.java
@@ -15,6 +15,8 @@
  */
 package com.squareup.okhttp;
 
+import com.squareup.okhttp.internal.net.http.HttpURLConnectionImpl;
+import com.squareup.okhttp.internal.net.http.HttpsURLConnectionImpl;
 import java.net.HttpURLConnection;
 import java.net.Proxy;
 import java.net.URL;
@@ -33,9 +35,9 @@
     public HttpURLConnection open(URL url) {
         String protocol = url.getProtocol();
         if (protocol.equals("http")) {
-            return new libcore.net.http.HttpURLConnectionImpl(url, 80, proxy);
+            return new HttpURLConnectionImpl(url, 80, proxy);
         } else if (protocol.equals("https")) {
-            return new libcore.net.http.HttpsURLConnectionImpl(url, 443, proxy);
+            return new HttpsURLConnectionImpl(url, 443, proxy);
         } else {
             throw new IllegalArgumentException();
         }
/Fim/
diff --git a/src/main/java/libcore/Platform.java b/src/main/java/com/squareup/okhttp/internal/Platform.java
similarity index 99%
rename from src/main/java/libcore/Platform.java
rename to src/main/java/com/squareup/okhttp/internal/Platform.java
index 1d1453f..db089cf 100644
--- a/src/main/java/libcore/Platform.java
+++ b/src/main/java/com/squareup/okhttp/internal/Platform.java
@@ -14,7 +14,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore;
+package com.squareup.okhttp.internal;
 
 import com.squareup.okhttp.OkHttpClient;
 import java.io.OutputStream;
/Fim/
diff --git a/src/main/java/libcore/io/AsynchronousCloseMonitor.java b/src/main/java/com/squareup/okhttp/internal/io/AsynchronousCloseMonitor.java
similarity index 94%
rename from src/main/java/libcore/io/AsynchronousCloseMonitor.java
rename to src/main/java/com/squareup/okhttp/internal/io/AsynchronousCloseMonitor.java
index 62eec24..23cf2ce 100644
--- a/src/main/java/libcore/io/AsynchronousCloseMonitor.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/AsynchronousCloseMonitor.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
 import java.io.FileDescriptor;
 
/Fim/
diff --git a/src/main/java/libcore/io/Base64.java b/src/main/java/com/squareup/okhttp/internal/io/Base64.java
similarity index 98%
rename from src/main/java/libcore/io/Base64.java
rename to src/main/java/com/squareup/okhttp/internal/io/Base64.java
index 96d3b9d..e395052 100644
--- a/src/main/java/libcore/io/Base64.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/Base64.java
@@ -19,10 +19,10 @@
 * @author Alexander Y. Kleymenov
 */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
+import com.squareup.okhttp.internal.util.EmptyArray;
 import java.io.UnsupportedEncodingException;
-import libcore.util.EmptyArray;
 
 /**
  * <a href="http://www.ietf.org/rfc/rfc2045.txt">Base64</a> encoder/decoder.
/Fim/
diff --git a/src/main/java/libcore/io/BufferIterator.java b/src/main/java/com/squareup/okhttp/internal/io/BufferIterator.java
similarity index 97%
rename from src/main/java/libcore/io/BufferIterator.java
rename to src/main/java/com/squareup/okhttp/internal/io/BufferIterator.java
index 7f3ad47..f8b4611 100644
--- a/src/main/java/libcore/io/BufferIterator.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/BufferIterator.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
 /**
  * Iterates over big- or little-endian bytes. See {@link MemoryMappedFile#bigEndianIterator} and
/Fim/
diff --git a/src/main/java/libcore/io/DiskLruCache.java b/src/main/java/com/squareup/okhttp/internal/io/DiskLruCache.java
similarity index 99%
rename from src/main/java/libcore/io/DiskLruCache.java
rename to src/main/java/com/squareup/okhttp/internal/io/DiskLruCache.java
index 5b78838..2006257 100644
--- a/src/main/java/libcore/io/DiskLruCache.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/DiskLruCache.java
@@ -14,8 +14,10 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
+import com.squareup.okhttp.internal.util.Charsets;
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.BufferedWriter;
 import java.io.Closeable;
 import java.io.EOFException;
@@ -41,8 +43,6 @@
 import java.util.concurrent.LinkedBlockingQueue;
 import java.util.concurrent.ThreadPoolExecutor;
 import java.util.concurrent.TimeUnit;
-import libcore.util.Charsets;
-import libcore.util.Libcore;
 
 /**
  * A cache that uses a bounded amount of space on a filesystem. Each cache
/Fim/
diff --git a/src/main/java/libcore/io/IoUtils.java b/src/main/java/com/squareup/okhttp/internal/io/IoUtils.java
similarity index 97%
rename from src/main/java/libcore/io/IoUtils.java
rename to src/main/java/com/squareup/okhttp/internal/io/IoUtils.java
index 307737d..2b7ccb1 100644
--- a/src/main/java/libcore/io/IoUtils.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/IoUtils.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
 import java.io.Closeable;
 import java.io.File;
/Fim/
diff --git a/src/main/java/libcore/io/OsConstants.java b/src/main/java/com/squareup/okhttp/internal/io/OsConstants.java
similarity index 99%
rename from src/main/java/libcore/io/OsConstants.java
rename to src/main/java/com/squareup/okhttp/internal/io/OsConstants.java
index 68a165c..bbc6c26 100644
--- a/src/main/java/libcore/io/OsConstants.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/OsConstants.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
 public final class OsConstants {
     private OsConstants() { }
/Fim/
diff --git a/src/main/java/libcore/io/SizeOf.java b/src/main/java/com/squareup/okhttp/internal/io/SizeOf.java
similarity index 95%
rename from src/main/java/libcore/io/SizeOf.java
rename to src/main/java/com/squareup/okhttp/internal/io/SizeOf.java
index 728fbfc..cb9289c 100644
--- a/src/main/java/libcore/io/SizeOf.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/SizeOf.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
 public final class SizeOf {
     public static final int CHAR = 2;
/Fim/
diff --git a/src/main/java/libcore/io/Streams.java b/src/main/java/com/squareup/okhttp/internal/io/Streams.java
similarity index 98%
rename from src/main/java/libcore/io/Streams.java
rename to src/main/java/com/squareup/okhttp/internal/io/Streams.java
index 1ad2356..4a7a192 100644
--- a/src/main/java/libcore/io/Streams.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/Streams.java
@@ -14,8 +14,9 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.ByteArrayOutputStream;
 import java.io.EOFException;
 import java.io.IOException;
@@ -24,7 +25,6 @@
 import java.io.Reader;
 import java.io.StringWriter;
 import java.util.concurrent.atomic.AtomicReference;
-import libcore.util.Libcore;
 
 public final class Streams {
     private static AtomicReference<byte[]> skipBuffer = new AtomicReference<byte[]>();
/Fim/
diff --git a/src/main/java/libcore/io/StrictLineReader.java b/src/main/java/com/squareup/okhttp/internal/io/StrictLineReader.java
similarity index 98%
rename from src/main/java/libcore/io/StrictLineReader.java
rename to src/main/java/com/squareup/okhttp/internal/io/StrictLineReader.java
index dabb516..9c95b19 100644
--- a/src/main/java/libcore/io/StrictLineReader.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/StrictLineReader.java
@@ -14,15 +14,15 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
+import com.squareup.okhttp.internal.util.Charsets;
 import java.io.ByteArrayOutputStream;
 import java.io.Closeable;
 import java.io.EOFException;
 import java.io.IOException;
 import java.io.InputStream;
 import java.nio.charset.Charset;
-import libcore.util.Charsets;
 
 /**
  * Buffers input from an {@link InputStream} for reading lines.
/Fim/
diff --git a/src/main/java/libcore/net/Dns.java b/src/main/java/com/squareup/okhttp/internal/net/Dns.java
similarity index 95%
rename from src/main/java/libcore/net/Dns.java
rename to src/main/java/com/squareup/okhttp/internal/net/Dns.java
index 8b38fdf..7b2c8e5 100644
--- a/src/main/java/libcore/net/Dns.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/Dns.java
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net;
+package com.squareup.okhttp.internal.net;
 
 import java.net.InetAddress;
 import java.net.UnknownHostException;
/Fim/
diff --git a/src/main/java/libcore/net/MimeUtils.java b/src/main/java/com/squareup/okhttp/internal/net/MimeUtils.java
similarity index 99%
rename from src/main/java/libcore/net/MimeUtils.java
rename to src/main/java/com/squareup/okhttp/internal/net/MimeUtils.java
index 76193ff..2863755 100644
--- a/src/main/java/libcore/net/MimeUtils.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/MimeUtils.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net;
+package com.squareup.okhttp.internal.net;
 
 import java.io.File;
 import java.io.FileInputStream;
/Fim/
diff --git a/src/main/java/libcore/net/http/AbstractHttpInputStream.java b/src/main/java/com/squareup/okhttp/internal/net/http/AbstractHttpInputStream.java
similarity index 97%
rename from src/main/java/libcore/net/http/AbstractHttpInputStream.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/AbstractHttpInputStream.java
index 70f76b7..dca5505 100644
--- a/src/main/java/libcore/net/http/AbstractHttpInputStream.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/AbstractHttpInputStream.java
@@ -14,13 +14,13 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.io.Streams;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
 import java.net.CacheRequest;
-import libcore.io.Streams;
 
 /**
  * An input stream for the body of an HTTP response.
/Fim/
diff --git a/src/main/java/libcore/net/http/AbstractHttpOutputStream.java b/src/main/java/com/squareup/okhttp/internal/net/http/AbstractHttpOutputStream.java
similarity index 96%
rename from src/main/java/libcore/net/http/AbstractHttpOutputStream.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/AbstractHttpOutputStream.java
index 145bc50..336ecc3 100644
--- a/src/main/java/libcore/net/http/AbstractHttpOutputStream.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/AbstractHttpOutputStream.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import java.io.IOException;
 import java.io.OutputStream;
/Fim/
diff --git a/src/main/java/libcore/net/http/HeaderParser.java b/src/main/java/com/squareup/okhttp/internal/net/http/HeaderParser.java
similarity index 98%
rename from src/main/java/libcore/net/http/HeaderParser.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HeaderParser.java
index b35db78..051dc7e 100644
--- a/src/main/java/libcore/net/http/HeaderParser.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HeaderParser.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 final class HeaderParser {
 
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpAuthenticator.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpAuthenticator.java
similarity index 96%
rename from src/main/java/libcore/net/http/HttpAuthenticator.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpAuthenticator.java
index 882d16f..eed1a78 100644
--- a/src/main/java/libcore/net/http/HttpAuthenticator.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpAuthenticator.java
@@ -14,12 +14,13 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
-import static com.squareup.okhttp.OkHttpConnection.HTTP_PROXY_AUTH;
-import static com.squareup.okhttp.OkHttpConnection.HTTP_UNAUTHORIZED;
+import com.squareup.okhttp.internal.io.Base64;
 import java.io.IOException;
 import java.net.Authenticator;
+import static java.net.HttpURLConnection.HTTP_PROXY_AUTH;
+import static java.net.HttpURLConnection.HTTP_UNAUTHORIZED;
 import java.net.InetAddress;
 import java.net.InetSocketAddress;
 import java.net.PasswordAuthentication;
@@ -27,7 +28,6 @@
 import java.net.URL;
 import java.util.ArrayList;
 import java.util.List;
-import libcore.io.Base64;
 
 /**
  * Handles HTTP authentication headers from origin and proxy servers.
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpConnection.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpConnection.java
similarity index 97%
rename from src/main/java/libcore/net/http/HttpConnection.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpConnection.java
index 2fd2793..0771bbf 100644
--- a/src/main/java/libcore/net/http/HttpConnection.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpConnection.java
@@ -15,14 +15,19 @@
  *  limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
-import static com.squareup.okhttp.OkHttpConnection.HTTP_PROXY_AUTH;
+import com.squareup.okhttp.internal.Platform;
+import com.squareup.okhttp.internal.io.IoUtils;
+import com.squareup.okhttp.internal.net.spdy.SpdyConnection;
+import com.squareup.okhttp.internal.util.Libcore;
+import com.squareup.okhttp.internal.util.Objects;
 import java.io.BufferedInputStream;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
 import static java.net.HttpURLConnection.HTTP_OK;
+import static java.net.HttpURLConnection.HTTP_PROXY_AUTH;
 import java.net.InetSocketAddress;
 import java.net.Proxy;
 import java.net.Socket;
@@ -33,11 +38,6 @@
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.SSLSocket;
 import javax.net.ssl.SSLSocketFactory;
-import libcore.Platform;
-import libcore.io.IoUtils;
-import libcore.net.spdy.SpdyConnection;
-import libcore.util.Libcore;
-import libcore.util.Objects;
 
 /**
  * Holds the sockets and streams of an HTTP, HTTPS, or HTTPS+SPDY connection,
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpConnectionPool.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpConnectionPool.java
similarity index 97%
rename from src/main/java/libcore/net/http/HttpConnectionPool.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpConnectionPool.java
index 0c2a188..9e784b9 100644
--- a/src/main/java/libcore/net/http/HttpConnectionPool.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpConnectionPool.java
@@ -15,14 +15,14 @@
  *  limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.util.Libcore;
 import java.net.Socket;
 import java.net.SocketException;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.List;
-import libcore.util.Libcore;
 
 /**
  * A pool of HTTP and SPDY connections. This class exposes its tuning parameters
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpDate.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpDate.java
similarity index 98%
rename from src/main/java/libcore/net/http/HttpDate.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpDate.java
index 41ae5ef..d8f218b 100644
--- a/src/main/java/libcore/net/http/HttpDate.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpDate.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import java.text.DateFormat;
 import java.text.ParseException;
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpEngine.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpEngine.java
similarity index 98%
rename from src/main/java/libcore/net/http/HttpEngine.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpEngine.java
index e1fa9be..e3ba46e 100644
--- a/src/main/java/libcore/net/http/HttpEngine.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpEngine.java
@@ -15,8 +15,14 @@
  *  limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.io.IoUtils;
+import com.squareup.okhttp.internal.net.Dns;
+import com.squareup.okhttp.internal.util.EmptyArray;
+import com.squareup.okhttp.internal.util.ExtendedResponseCache;
+import com.squareup.okhttp.internal.util.Libcore;
+import com.squareup.okhttp.internal.util.ResponseSource;
 import java.io.ByteArrayInputStream;
 import java.io.IOException;
 import java.io.InputStream;
@@ -39,12 +45,6 @@
 import java.util.zip.GZIPInputStream;
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.SSLSocketFactory;
-import libcore.io.IoUtils;
-import libcore.net.Dns;
-import libcore.util.EmptyArray;
-import libcore.util.ExtendedResponseCache;
-import libcore.util.Libcore;
-import libcore.util.ResponseSource;
 
 /**
  * Handles a single HTTP request/response pair. Each HTTP engine follows this
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpResponseCache.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpResponseCache.java
similarity index 97%
rename from src/main/java/libcore/net/http/HttpResponseCache.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpResponseCache.java
index 2932e7e..a8b57dc 100644
--- a/src/main/java/libcore/net/http/HttpResponseCache.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpResponseCache.java
@@ -14,8 +14,16 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.io.Base64;
+import com.squareup.okhttp.internal.io.DiskLruCache;
+import com.squareup.okhttp.internal.io.IoUtils;
+import com.squareup.okhttp.internal.io.StrictLineReader;
+import com.squareup.okhttp.internal.util.Charsets;
+import com.squareup.okhttp.internal.util.ExtendedResponseCache;
+import com.squareup.okhttp.internal.util.IntegralToString;
+import com.squareup.okhttp.internal.util.ResponseSource;
 import java.io.BufferedWriter;
 import java.io.ByteArrayInputStream;
 import java.io.File;
@@ -47,14 +55,6 @@
 import java.util.Map;
 import javax.net.ssl.HttpsURLConnection;
 import javax.net.ssl.SSLPeerUnverifiedException;
-import libcore.io.Base64;
-import libcore.io.DiskLruCache;
-import libcore.io.IoUtils;
-import libcore.io.StrictLineReader;
-import libcore.util.Charsets;
-import libcore.util.ExtendedResponseCache;
-import libcore.util.IntegralToString;
-import libcore.util.ResponseSource;
 
 /**
  * Cache responses in a directory on the file system. Most clients should use
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpTransport.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpTransport.java
similarity index 98%
rename from src/main/java/libcore/net/http/HttpTransport.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpTransport.java
index ae9a8bc..f8efdff 100644
--- a/src/main/java/libcore/net/http/HttpTransport.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpTransport.java
@@ -14,8 +14,10 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.io.Streams;
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.BufferedOutputStream;
 import java.io.ByteArrayOutputStream;
 import java.io.IOException;
@@ -25,8 +27,6 @@
 import java.net.CookieHandler;
 import java.net.ProtocolException;
 import java.net.Socket;
-import libcore.io.Streams;
-import libcore.util.Libcore;
 
 final class HttpTransport implements Transport {
     /**
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpURLConnectionImpl.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpURLConnectionImpl.java
similarity index 98%
rename from src/main/java/libcore/net/http/HttpURLConnectionImpl.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpURLConnectionImpl.java
index acfd56a..9b94430 100644
--- a/src/main/java/libcore/net/http/HttpURLConnectionImpl.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpURLConnectionImpl.java
@@ -15,8 +15,10 @@
  *  limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.io.IoUtils;
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.io.InputStream;
@@ -33,8 +35,6 @@
 import java.util.List;
 import java.util.Map;
 import javax.net.ssl.SSLHandshakeException;
-import libcore.io.IoUtils;
-import libcore.util.Libcore;
 
 /**
  * This implementation uses HttpEngine to send requests and receive responses.
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpsHandler.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpsHandler.java
similarity index 96%
rename from src/main/java/libcore/net/http/HttpsHandler.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpsHandler.java
index ed9ba72..a0f5da6 100644
--- a/src/main/java/libcore/net/http/HttpsHandler.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpsHandler.java
@@ -15,7 +15,7 @@
  *  limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import java.io.IOException;
 import java.net.Proxy;
/Fim/
diff --git a/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpsURLConnectionImpl.java
similarity index 99%
rename from src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/HttpsURLConnectionImpl.java
index 982c5cd..41b1de2 100644
--- a/src/main/java/libcore/net/http/HttpsURLConnectionImpl.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpsURLConnectionImpl.java
@@ -14,7 +14,7 @@
  *  See the License for the specific language governing permissions and
  *  limitations under the License.
  */
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import java.io.IOException;
 import java.io.InputStream;
/Fim/
diff --git a/src/main/java/libcore/net/http/RawHeaders.java b/src/main/java/com/squareup/okhttp/internal/net/http/RawHeaders.java
similarity index 98%
rename from src/main/java/libcore/net/http/RawHeaders.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/RawHeaders.java
index 9072cfd..70a7adb 100644
--- a/src/main/java/libcore/net/http/RawHeaders.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/RawHeaders.java
@@ -15,8 +15,10 @@
  *  limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.io.Streams;
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.UnsupportedEncodingException;
@@ -31,8 +33,6 @@
 import java.util.Map.Entry;
 import java.util.Set;
 import java.util.TreeMap;
-import libcore.io.Streams;
-import libcore.util.Libcore;
 
 /**
  * The HTTP status and unparsed header fields of a single HTTP message. Values
/Fim/
diff --git a/src/main/java/libcore/net/http/RequestHeaders.java b/src/main/java/com/squareup/okhttp/internal/net/http/RequestHeaders.java
similarity index 99%
rename from src/main/java/libcore/net/http/RequestHeaders.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/RequestHeaders.java
index a84437e..ca872c2 100644
--- a/src/main/java/libcore/net/http/RequestHeaders.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/RequestHeaders.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import java.net.URI;
 import java.util.Date;
/Fim/
diff --git a/src/main/java/libcore/net/http/ResponseHeaders.java b/src/main/java/com/squareup/okhttp/internal/net/http/ResponseHeaders.java
similarity index 98%
rename from src/main/java/libcore/net/http/ResponseHeaders.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/ResponseHeaders.java
index 0d89fe5..5f2e1ae 100644
--- a/src/main/java/libcore/net/http/ResponseHeaders.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/ResponseHeaders.java
@@ -14,8 +14,10 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.util.Objects;
+import com.squareup.okhttp.internal.util.ResponseSource;
 import java.io.IOException;
 import java.net.HttpURLConnection;
 import java.net.URI;
@@ -26,8 +28,6 @@
 import java.util.Set;
 import java.util.TreeSet;
 import java.util.concurrent.TimeUnit;
-import libcore.util.Objects;
-import libcore.util.ResponseSource;
 
 /**
  * Parsed HTTP response headers.
/Fim/
diff --git a/src/main/java/libcore/net/http/RetryableOutputStream.java b/src/main/java/com/squareup/okhttp/internal/net/http/RetryableOutputStream.java
similarity index 95%
rename from src/main/java/libcore/net/http/RetryableOutputStream.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/RetryableOutputStream.java
index cda2e5e..7c80745 100644
--- a/src/main/java/libcore/net/http/RetryableOutputStream.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/RetryableOutputStream.java
@@ -14,13 +14,13 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.ByteArrayOutputStream;
 import java.io.IOException;
 import java.io.OutputStream;
 import java.net.ProtocolException;
-import libcore.util.Libcore;
 
 /**
  * An HTTP request body that's completely buffered in memory. This allows
/Fim/
diff --git a/src/main/java/libcore/net/http/RouteSelector.java b/src/main/java/com/squareup/okhttp/internal/net/http/RouteSelector.java
similarity index 94%
rename from src/main/java/libcore/net/http/RouteSelector.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/RouteSelector.java
index 1066034..3b7bf46 100644
--- a/src/main/java/libcore/net/http/RouteSelector.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/RouteSelector.java
@@ -13,8 +13,13 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.net.Dns;
+import static com.squareup.okhttp.internal.net.http.HttpConnection.TLS_MODE_AGGRESSIVE;
+import static com.squareup.okhttp.internal.net.http.HttpConnection.TLS_MODE_COMPATIBLE;
+import static com.squareup.okhttp.internal.net.http.HttpConnection.TLS_MODE_NULL;
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.IOException;
 import java.net.InetAddress;
 import java.net.InetSocketAddress;
@@ -26,11 +31,6 @@
 import java.util.Iterator;
 import java.util.List;
 import java.util.NoSuchElementException;
-import libcore.net.Dns;
-import static libcore.net.http.HttpConnection.TLS_MODE_AGGRESSIVE;
-import static libcore.net.http.HttpConnection.TLS_MODE_COMPATIBLE;
-import static libcore.net.http.HttpConnection.TLS_MODE_NULL;
-import libcore.util.Libcore;
 
 /**
  * Selects routes to connect to an origin server. Each connection requires a
/Fim/
diff --git a/src/main/java/libcore/net/http/SpdyTransport.java b/src/main/java/com/squareup/okhttp/internal/net/http/SpdyTransport.java
similarity index 95%
rename from src/main/java/libcore/net/http/SpdyTransport.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/SpdyTransport.java
index 16ad452..1cad6be 100644
--- a/src/main/java/libcore/net/http/SpdyTransport.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/SpdyTransport.java
@@ -14,16 +14,16 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.net.spdy.SpdyConnection;
+import com.squareup.okhttp.internal.net.spdy.SpdyStream;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.InterruptedIOException;
 import java.io.OutputStream;
 import java.net.CacheRequest;
 import java.util.List;
-import libcore.net.spdy.SpdyConnection;
-import libcore.net.spdy.SpdyStream;
 
 final class SpdyTransport implements Transport {
     private final HttpEngine httpEngine;
/Fim/
diff --git a/src/main/java/libcore/net/http/Transport.java b/src/main/java/com/squareup/okhttp/internal/net/http/Transport.java
similarity index 97%
rename from src/main/java/libcore/net/http/Transport.java
rename to src/main/java/com/squareup/okhttp/internal/net/http/Transport.java
index 3d4c8dd..3d73c15 100644
--- a/src/main/java/libcore/net/http/Transport.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/Transport.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import java.io.IOException;
 import java.io.InputStream;
/Fim/
diff --git a/src/main/java/libcore/net/spdy/IncomingStreamHandler.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/IncomingStreamHandler.java
similarity index 96%
rename from src/main/java/libcore/net/spdy/IncomingStreamHandler.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/IncomingStreamHandler.java
index 69cc8e1..ff8ea0e 100644
--- a/src/main/java/libcore/net/spdy/IncomingStreamHandler.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/IncomingStreamHandler.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
 import java.io.IOException;
 
/Fim/
diff --git a/src/main/java/libcore/net/spdy/Ping.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/Ping.java
similarity index 97%
rename from src/main/java/libcore/net/spdy/Ping.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/Ping.java
index 8eb5ebe..5912831 100644
--- a/src/main/java/libcore/net/spdy/Ping.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/Ping.java
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
 import java.util.concurrent.CountDownLatch;
 import java.util.concurrent.TimeUnit;
/Fim/
diff --git a/src/main/java/libcore/net/spdy/Settings.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/Settings.java
similarity index 98%
rename from src/main/java/libcore/net/spdy/Settings.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/Settings.java
index 0e3e40c..2f9a5a3 100644
--- a/src/main/java/libcore/net/spdy/Settings.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/Settings.java
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
 final class Settings {
     /** Peer request to clear durable settings. */
/Fim/
diff --git a/src/main/java/libcore/net/spdy/SpdyConnection.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyConnection.java
similarity index 98%
rename from src/main/java/libcore/net/spdy/SpdyConnection.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyConnection.java
index 0aa81fe..12fa547 100644
--- a/src/main/java/libcore/net/spdy/SpdyConnection.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyConnection.java
@@ -14,8 +14,10 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
+import com.squareup.okhttp.internal.io.Streams;
+import static com.squareup.okhttp.internal.net.spdy.Threads.newThreadFactory;
 import java.io.Closeable;
 import java.io.IOException;
 import java.io.InputStream;
@@ -29,9 +31,6 @@
 import java.util.concurrent.SynchronousQueue;
 import java.util.concurrent.ThreadPoolExecutor;
 import java.util.concurrent.TimeUnit;
-import libcore.io.Streams;
-
-import static libcore.net.spdy.Threads.newThreadFactory;
 
 /**
  * A socket connection to a remote peer. A connection hosts streams which can
/Fim/
diff --git a/src/main/java/libcore/net/spdy/SpdyReader.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyReader.java
similarity index 98%
rename from src/main/java/libcore/net/spdy/SpdyReader.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyReader.java
index 5240cd0..4ebc7ee 100644
--- a/src/main/java/libcore/net/spdy/SpdyReader.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyReader.java
@@ -14,8 +14,9 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
+import com.squareup.okhttp.internal.io.Streams;
 import java.io.DataInputStream;
 import java.io.EOFException;
 import java.io.IOException;
@@ -27,7 +28,6 @@
 import java.util.zip.DataFormatException;
 import java.util.zip.Inflater;
 import java.util.zip.InflaterInputStream;
-import libcore.io.Streams;
 
 /**
  * Read version 2 SPDY frames.
/Fim/
diff --git a/src/main/java/libcore/net/spdy/SpdyServer.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyServer.java
similarity index 98%
rename from src/main/java/libcore/net/spdy/SpdyServer.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyServer.java
index d2ad4ec..63273b9 100644
--- a/src/main/java/libcore/net/spdy/SpdyServer.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyServer.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
 import java.io.File;
 import java.io.FileInputStream;
/Fim/
diff --git a/src/main/java/libcore/net/spdy/SpdyStream.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyStream.java
similarity index 98%
rename from src/main/java/libcore/net/spdy/SpdyStream.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyStream.java
index 2e336de..725509f 100644
--- a/src/main/java/libcore/net/spdy/SpdyStream.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyStream.java
@@ -14,17 +14,16 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
+import com.squareup.okhttp.internal.io.Streams;
+import com.squareup.okhttp.internal.util.Libcore;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.InterruptedIOException;
 import java.io.OutputStream;
-import java.util.List;
-import libcore.io.Streams;
-import libcore.util.Libcore;
-
 import static java.nio.ByteOrder.BIG_ENDIAN;
+import java.util.List;
 
 /**
  * A logical bidirectional stream.
/Fim/
diff --git a/src/main/java/libcore/net/spdy/SpdyWriter.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyWriter.java
similarity index 97%
rename from src/main/java/libcore/net/spdy/SpdyWriter.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyWriter.java
index cc0f66e..281c3e6 100644
--- a/src/main/java/libcore/net/spdy/SpdyWriter.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/SpdyWriter.java
@@ -14,15 +14,15 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
+import com.squareup.okhttp.internal.Platform;
 import java.io.ByteArrayOutputStream;
 import java.io.DataOutputStream;
 import java.io.IOException;
 import java.io.OutputStream;
 import java.util.List;
 import java.util.zip.Deflater;
-import libcore.Platform;
 
 /**
  * Write version 2 SPDY frames.
/Fim/
diff --git a/src/main/java/libcore/net/spdy/Threads.java b/src/main/java/com/squareup/okhttp/internal/net/spdy/Threads.java
similarity index 95%
rename from src/main/java/libcore/net/spdy/Threads.java
rename to src/main/java/com/squareup/okhttp/internal/net/spdy/Threads.java
index 9e257f3..c7e5770 100644
--- a/src/main/java/libcore/net/spdy/Threads.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/spdy/Threads.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
 import java.util.concurrent.ThreadFactory;
 
/Fim/
diff --git a/src/main/java/libcore/util/BasicLruCache.java b/src/main/java/com/squareup/okhttp/internal/util/BasicLruCache.java
similarity index 98%
rename from src/main/java/libcore/util/BasicLruCache.java
rename to src/main/java/com/squareup/okhttp/internal/util/BasicLruCache.java
index b5f6fdf..75c5712 100644
--- a/src/main/java/libcore/util/BasicLruCache.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/BasicLruCache.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 import java.util.LinkedHashMap;
 import java.util.Map;
/Fim/
diff --git a/src/main/java/libcore/util/Charsets.java b/src/main/java/com/squareup/okhttp/internal/util/Charsets.java
similarity index 96%
rename from src/main/java/libcore/util/Charsets.java
rename to src/main/java/com/squareup/okhttp/internal/util/Charsets.java
index 95848ee..4e430ef 100644
--- a/src/main/java/libcore/util/Charsets.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/Charsets.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 import java.nio.charset.Charset;
 
/Fim/
diff --git a/src/main/java/libcore/util/CollectionUtils.java b/src/main/java/com/squareup/okhttp/internal/util/CollectionUtils.java
similarity index 98%
rename from src/main/java/libcore/util/CollectionUtils.java
rename to src/main/java/com/squareup/okhttp/internal/util/CollectionUtils.java
index 45edf4f..e481da3 100644
--- a/src/main/java/libcore/util/CollectionUtils.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/CollectionUtils.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 import java.lang.ref.Reference;
 import java.util.Collections;
/Fim/
diff --git a/src/main/java/libcore/util/DefaultFileNameMap.java b/src/main/java/com/squareup/okhttp/internal/util/DefaultFileNameMap.java
similarity index 87%
rename from src/main/java/libcore/util/DefaultFileNameMap.java
rename to src/main/java/com/squareup/okhttp/internal/util/DefaultFileNameMap.java
index e817a72..9b95233 100644
--- a/src/main/java/libcore/util/DefaultFileNameMap.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/DefaultFileNameMap.java
@@ -14,14 +14,15 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
+import com.squareup.okhttp.internal.net.MimeUtils;
 import java.net.FileNameMap;
 import java.util.Locale;
-import libcore.net.MimeUtils;
 
 /**
- * Implements {@link java.net.FileNameMap} in terms of {@link libcore.net.MimeUtils}.
+ * Implements {@link java.net.FileNameMap} in terms of
+ * {@link com.squareup.okhttp.internal.net.MimeUtils}.
  */
 class DefaultFileNameMap implements FileNameMap {
     public String getContentTypeFor(String filename) {
/Fim/
diff --git a/src/main/java/libcore/util/EmptyArray.java b/src/main/java/com/squareup/okhttp/internal/util/EmptyArray.java
similarity index 96%
rename from src/main/java/libcore/util/EmptyArray.java
rename to src/main/java/com/squareup/okhttp/internal/util/EmptyArray.java
index 0f919c5..2f12e1a 100644
--- a/src/main/java/libcore/util/EmptyArray.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/EmptyArray.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class EmptyArray {
     private EmptyArray() {
/Fim/
diff --git a/src/main/java/libcore/util/ExtendedResponseCache.java b/src/main/java/com/squareup/okhttp/internal/util/ExtendedResponseCache.java
similarity index 97%
rename from src/main/java/libcore/util/ExtendedResponseCache.java
rename to src/main/java/com/squareup/okhttp/internal/util/ExtendedResponseCache.java
index 75e5157..dbe492d 100644
--- a/src/main/java/libcore/util/ExtendedResponseCache.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/ExtendedResponseCache.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 import java.io.IOException;
 import java.net.CacheResponse;
/Fim/
diff --git a/src/main/java/libcore/util/IntegralToString.java b/src/main/java/com/squareup/okhttp/internal/util/IntegralToString.java
similarity index 98%
rename from src/main/java/libcore/util/IntegralToString.java
rename to src/main/java/com/squareup/okhttp/internal/util/IntegralToString.java
index 1b66e51..839f823 100644
--- a/src/main/java/libcore/util/IntegralToString.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/IntegralToString.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 /**
  * Converts integral types to strings. This class is public but hidden so that it can also be
/Fim/
diff --git a/src/main/java/libcore/util/Libcore.java b/src/main/java/com/squareup/okhttp/internal/util/Libcore.java
similarity index 98%
rename from src/main/java/libcore/util/Libcore.java
rename to src/main/java/com/squareup/okhttp/internal/util/Libcore.java
index 808933b..f3a92ba 100644
--- a/src/main/java/libcore/util/Libcore.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/Libcore.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 import java.io.File;
 import java.io.IOException;
/Fim/
diff --git a/src/main/java/libcore/util/MutableBoolean.java b/src/main/java/com/squareup/okhttp/internal/util/MutableBoolean.java
similarity index 94%
rename from src/main/java/libcore/util/MutableBoolean.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableBoolean.java
index 359a8f9..8cabec4 100644
--- a/src/main/java/libcore/util/MutableBoolean.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableBoolean.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableBoolean {
     public boolean value;
/Fim/
diff --git a/src/main/java/libcore/util/MutableByte.java b/src/main/java/com/squareup/okhttp/internal/util/MutableByte.java
similarity index 94%
rename from src/main/java/libcore/util/MutableByte.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableByte.java
index 13f780b..73b576d 100644
--- a/src/main/java/libcore/util/MutableByte.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableByte.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableByte {
     public byte value;
/Fim/
diff --git a/src/main/java/libcore/util/MutableChar.java b/src/main/java/com/squareup/okhttp/internal/util/MutableChar.java
similarity index 94%
rename from src/main/java/libcore/util/MutableChar.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableChar.java
index 1cafc3c..0960f5b 100644
--- a/src/main/java/libcore/util/MutableChar.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableChar.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableChar {
     public char value;
/Fim/
diff --git a/src/main/java/libcore/util/MutableDouble.java b/src/main/java/com/squareup/okhttp/internal/util/MutableDouble.java
similarity index 94%
rename from src/main/java/libcore/util/MutableDouble.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableDouble.java
index 4473ae6..d66ef7b 100644
--- a/src/main/java/libcore/util/MutableDouble.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableDouble.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableDouble {
     public double value;
/Fim/
diff --git a/src/main/java/libcore/util/MutableFloat.java b/src/main/java/com/squareup/okhttp/internal/util/MutableFloat.java
similarity index 94%
rename from src/main/java/libcore/util/MutableFloat.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableFloat.java
index f81fba5..5453a59 100644
--- a/src/main/java/libcore/util/MutableFloat.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableFloat.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableFloat {
     public float value;
/Fim/
diff --git a/src/main/java/libcore/util/MutableInt.java b/src/main/java/com/squareup/okhttp/internal/util/MutableInt.java
similarity index 94%
rename from src/main/java/libcore/util/MutableInt.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableInt.java
index c8feb3a..678dba4 100644
--- a/src/main/java/libcore/util/MutableInt.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableInt.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableInt {
     public int value;
/Fim/
diff --git a/src/main/java/libcore/util/MutableLong.java b/src/main/java/com/squareup/okhttp/internal/util/MutableLong.java
similarity index 94%
rename from src/main/java/libcore/util/MutableLong.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableLong.java
index ad9b78e..b46c38a 100644
--- a/src/main/java/libcore/util/MutableLong.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableLong.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableLong {
     public long value;
/Fim/
diff --git a/src/main/java/libcore/util/MutableShort.java b/src/main/java/com/squareup/okhttp/internal/util/MutableShort.java
similarity index 94%
rename from src/main/java/libcore/util/MutableShort.java
rename to src/main/java/com/squareup/okhttp/internal/util/MutableShort.java
index 78b4c33..b2521d5 100644
--- a/src/main/java/libcore/util/MutableShort.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/MutableShort.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class MutableShort {
     public short value;
/Fim/
diff --git a/src/main/java/libcore/util/Objects.java b/src/main/java/com/squareup/okhttp/internal/util/Objects.java
similarity index 95%
rename from src/main/java/libcore/util/Objects.java
rename to src/main/java/com/squareup/okhttp/internal/util/Objects.java
index 050888d..96da7a6 100644
--- a/src/main/java/libcore/util/Objects.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/Objects.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 public final class Objects {
     private Objects() {
/Fim/
diff --git a/src/main/java/libcore/util/ResponseSource.java b/src/main/java/com/squareup/okhttp/internal/util/ResponseSource.java
similarity index 96%
rename from src/main/java/libcore/util/ResponseSource.java
rename to src/main/java/com/squareup/okhttp/internal/util/ResponseSource.java
index 8e7bfae..9dd7678 100644
--- a/src/main/java/libcore/util/ResponseSource.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/ResponseSource.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 /**
  * Where the HTTP client should look for a response.
/Fim/
diff --git a/src/main/java/libcore/util/SneakyThrow.java b/src/main/java/com/squareup/okhttp/internal/util/SneakyThrow.java
similarity index 97%
rename from src/main/java/libcore/util/SneakyThrow.java
rename to src/main/java/com/squareup/okhttp/internal/util/SneakyThrow.java
index f5c077c..391c56f 100644
--- a/src/main/java/libcore/util/SneakyThrow.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/SneakyThrow.java
@@ -15,7 +15,7 @@
  *  limitations under the License.
  */
 
-package libcore.util;
+package com.squareup.okhttp.internal.util;
 
 /**
  * Exploits a weakness in the runtime to throw an arbitrary throwable without
/Fim/
diff --git a/src/test/java/libcore/io/DiskLruCacheTest.java b/src/test/java/com/squareup/okhttp/internal/io/DiskLruCacheTest.java
similarity index 98%
rename from src/test/java/libcore/io/DiskLruCacheTest.java
rename to src/test/java/com/squareup/okhttp/internal/io/DiskLruCacheTest.java
index 87b3e8e..7375be0 100644
--- a/src/test/java/libcore/io/DiskLruCacheTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/io/DiskLruCacheTest.java
@@ -14,8 +14,11 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
+import static com.squareup.okhttp.internal.io.DiskLruCache.JOURNAL_FILE;
+import static com.squareup.okhttp.internal.io.DiskLruCache.MAGIC;
+import static com.squareup.okhttp.internal.io.DiskLruCache.VERSION_1;
 import java.io.BufferedReader;
 import java.io.File;
 import java.io.FileReader;
@@ -29,10 +32,6 @@
 import java.util.List;
 import junit.framework.TestCase;
 
-import static libcore.io.DiskLruCache.JOURNAL_FILE;
-import static libcore.io.DiskLruCache.MAGIC;
-import static libcore.io.DiskLruCache.VERSION_1;
-
 public final class DiskLruCacheTest extends TestCase {
     private final int appVersion = 100;
     private String javaTmpDir;
/Fim/
diff --git a/src/test/java/libcore/io/StrictLineReaderTest.java b/src/test/java/com/squareup/okhttp/internal/io/StrictLineReaderTest.java
similarity index 96%
rename from src/test/java/libcore/io/StrictLineReaderTest.java
rename to src/test/java/com/squareup/okhttp/internal/io/StrictLineReaderTest.java
index 2b9e95e..b7e2b20 100644
--- a/src/test/java/libcore/io/StrictLineReaderTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/io/StrictLineReaderTest.java
@@ -14,14 +14,14 @@
  * limitations under the License.
  */
 
-package libcore.io;
+package com.squareup.okhttp.internal.io;
 
+import com.squareup.okhttp.internal.util.Charsets;
 import java.io.ByteArrayInputStream;
 import java.io.EOFException;
 import java.io.IOException;
 import java.io.InputStream;
 import junit.framework.TestCase;
-import libcore.util.Charsets;
 
 public class StrictLineReaderTest extends TestCase {
 
/Fim/
diff --git a/src/test/java/libcore/net/http/ExternalSpdyExample.java b/src/test/java/com/squareup/okhttp/internal/net/http/ExternalSpdyExample.java
similarity index 96%
rename from src/test/java/libcore/net/http/ExternalSpdyExample.java
rename to src/test/java/com/squareup/okhttp/internal/net/http/ExternalSpdyExample.java
index 70a4c07..4624b9d 100644
--- a/src/test/java/libcore/net/http/ExternalSpdyExample.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/ExternalSpdyExample.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import com.squareup.okhttp.OkHttpClient;
 import java.io.BufferedReader;
/Fim/
diff --git a/src/test/java/libcore/net/http/HttpResponseCacheTest.java b/src/test/java/com/squareup/okhttp/internal/net/http/HttpResponseCacheTest.java
similarity index 99%
rename from src/test/java/libcore/net/http/HttpResponseCacheTest.java
rename to src/test/java/com/squareup/okhttp/internal/net/http/HttpResponseCacheTest.java
index d9eb918..828ff92 100644
--- a/src/test/java/libcore/net/http/HttpResponseCacheTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/HttpResponseCacheTest.java
@@ -14,11 +14,12 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import com.google.mockwebserver.MockResponse;
 import com.google.mockwebserver.MockWebServer;
 import com.google.mockwebserver.RecordedRequest;
+import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_END;
 import com.squareup.okhttp.OkHttpClient;
 import java.io.BufferedReader;
 import java.io.ByteArrayOutputStream;
@@ -58,8 +59,6 @@
 import java.util.zip.GZIPOutputStream;
 import junit.framework.TestCase;
 
-import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_END;
-
 /**
  * Android's HttpResponseCacheTest.
  */
/Fim/
diff --git a/src/test/java/libcore/net/http/NewURLConnectionTest.java b/src/test/java/com/squareup/okhttp/internal/net/http/NewURLConnectionTest.java
similarity index 96%
rename from src/test/java/libcore/net/http/NewURLConnectionTest.java
rename to src/test/java/com/squareup/okhttp/internal/net/http/NewURLConnectionTest.java
index 8c6121e..183d15d 100644
--- a/src/test/java/libcore/net/http/NewURLConnectionTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/NewURLConnectionTest.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import junit.framework.TestCase;
 
/Fim/
diff --git a/src/test/java/libcore/net/http/RawHeadersTest.java b/src/test/java/com/squareup/okhttp/internal/net/http/RawHeadersTest.java
similarity index 97%
rename from src/test/java/libcore/net/http/RawHeadersTest.java
rename to src/test/java/com/squareup/okhttp/internal/net/http/RawHeadersTest.java
index 34f0985..2854767 100644
--- a/src/test/java/libcore/net/http/RawHeadersTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/RawHeadersTest.java
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import java.util.Arrays;
 import java.util.List;
/Fim/
diff --git a/src/test/java/libcore/net/http/RouteSelectorTest.java b/src/test/java/com/squareup/okhttp/internal/net/http/RouteSelectorTest.java
similarity index 97%
rename from src/test/java/libcore/net/http/RouteSelectorTest.java
rename to src/test/java/com/squareup/okhttp/internal/net/http/RouteSelectorTest.java
index 90baca1..e051462 100644
--- a/src/test/java/libcore/net/http/RouteSelectorTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/RouteSelectorTest.java
@@ -13,8 +13,12 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
+import com.squareup.okhttp.internal.net.Dns;
+import static com.squareup.okhttp.internal.net.http.HttpConnection.TLS_MODE_AGGRESSIVE;
+import static com.squareup.okhttp.internal.net.http.HttpConnection.TLS_MODE_COMPATIBLE;
+import com.squareup.okhttp.internal.net.ssl.SslContextBuilder;
 import java.io.IOException;
 import java.net.InetAddress;
 import java.net.InetSocketAddress;
@@ -32,10 +36,6 @@
 import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSocketFactory;
 import junit.framework.TestCase;
-import libcore.net.Dns;
-import static libcore.net.http.HttpConnection.TLS_MODE_AGGRESSIVE;
-import static libcore.net.http.HttpConnection.TLS_MODE_COMPATIBLE;
-import libcore.net.ssl.SslContextBuilder;
 
 public final class RouteSelectorTest extends TestCase {
     private static final int proxyAPort = 1001;
/Fim/
diff --git a/src/test/java/libcore/net/http/URLConnectionTest.java b/src/test/java/com/squareup/okhttp/internal/net/http/URLConnectionTest.java
similarity index 99%
rename from src/test/java/libcore/net/http/URLConnectionTest.java
rename to src/test/java/com/squareup/okhttp/internal/net/http/URLConnectionTest.java
index 476e4af..ae7a916 100644
--- a/src/test/java/libcore/net/http/URLConnectionTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/URLConnectionTest.java
@@ -14,13 +14,18 @@
  * limitations under the License.
  */
 
-package libcore.net.http;
+package com.squareup.okhttp.internal.net.http;
 
 import com.google.mockwebserver.MockResponse;
 import com.google.mockwebserver.MockWebServer;
 import com.google.mockwebserver.RecordedRequest;
 import com.google.mockwebserver.SocketPolicy;
+import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_END;
+import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_START;
+import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_INPUT_AT_END;
+import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_OUTPUT_AT_END;
 import com.squareup.okhttp.OkHttpClient;
+import com.squareup.okhttp.internal.net.ssl.SslContextBuilder;
 import java.io.ByteArrayOutputStream;
 import java.io.File;
 import java.io.IOException;
@@ -69,12 +74,6 @@
 import javax.net.ssl.SSLSocketFactory;
 import javax.net.ssl.X509TrustManager;
 import junit.framework.TestCase;
-import libcore.net.ssl.SslContextBuilder;
-
-import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_END;
-import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_START;
-import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_INPUT_AT_END;
-import static com.google.mockwebserver.SocketPolicy.SHUTDOWN_OUTPUT_AT_END;
 
 /**
  * Android's URLConnectionTest.
/Fim/
diff --git a/src/test/java/libcore/net/spdy/MockSpdyPeer.java b/src/test/java/com/squareup/okhttp/internal/net/spdy/MockSpdyPeer.java
similarity index 98%
rename from src/test/java/libcore/net/spdy/MockSpdyPeer.java
rename to src/test/java/com/squareup/okhttp/internal/net/spdy/MockSpdyPeer.java
index 0eb8208..f3dc3d0 100644
--- a/src/test/java/libcore/net/spdy/MockSpdyPeer.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/spdy/MockSpdyPeer.java
@@ -14,8 +14,9 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
+import com.squareup.okhttp.internal.io.Streams;
 import java.io.ByteArrayOutputStream;
 import java.io.IOException;
 import java.io.InputStream;
@@ -29,7 +30,6 @@
 import java.util.concurrent.Executor;
 import java.util.concurrent.Executors;
 import java.util.concurrent.LinkedBlockingQueue;
-import libcore.io.Streams;
 
 /**
  * Replays prerecorded outgoing frames and records incoming frames.
/Fim/
diff --git a/src/test/java/libcore/net/spdy/SettingsTest.java b/src/test/java/com/squareup/okhttp/internal/net/spdy/SettingsTest.java
similarity index 90%
rename from src/test/java/libcore/net/spdy/SettingsTest.java
rename to src/test/java/com/squareup/okhttp/internal/net/spdy/SettingsTest.java
index fe479cf..f0c83a7 100644
--- a/src/test/java/libcore/net/spdy/SettingsTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/spdy/SettingsTest.java
@@ -13,17 +13,16 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
+import static com.squareup.okhttp.internal.net.spdy.Settings.DOWNLOAD_BANDWIDTH;
+import static com.squareup.okhttp.internal.net.spdy.Settings.DOWNLOAD_RETRANS_RATE;
+import static com.squareup.okhttp.internal.net.spdy.Settings.MAX_CONCURRENT_STREAMS;
+import static com.squareup.okhttp.internal.net.spdy.Settings.PERSISTED;
+import static com.squareup.okhttp.internal.net.spdy.Settings.PERSIST_VALUE;
+import static com.squareup.okhttp.internal.net.spdy.Settings.UPLOAD_BANDWIDTH;
 import junit.framework.TestCase;
 
-import static libcore.net.spdy.Settings.DOWNLOAD_BANDWIDTH;
-import static libcore.net.spdy.Settings.DOWNLOAD_RETRANS_RATE;
-import static libcore.net.spdy.Settings.MAX_CONCURRENT_STREAMS;
-import static libcore.net.spdy.Settings.PERSISTED;
-import static libcore.net.spdy.Settings.PERSIST_VALUE;
-import static libcore.net.spdy.Settings.UPLOAD_BANDWIDTH;
-
 public final class SettingsTest extends TestCase {
     public void testUnsetField() {
         Settings settings = new Settings();
/Fim/
diff --git a/src/test/java/libcore/net/spdy/SpdyConnectionTest.java b/src/test/java/com/squareup/okhttp/internal/net/spdy/SpdyConnectionTest.java
similarity index 95%
rename from src/test/java/libcore/net/spdy/SpdyConnectionTest.java
rename to src/test/java/com/squareup/okhttp/internal/net/spdy/SpdyConnectionTest.java
index 4009599..9d1b1d1 100644
--- a/src/test/java/libcore/net/spdy/SpdyConnectionTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/spdy/SpdyConnectionTest.java
@@ -14,8 +14,18 @@
  * limitations under the License.
  */
 
-package libcore.net.spdy;
+package com.squareup.okhttp.internal.net.spdy;
 
+import static com.squareup.okhttp.internal.net.spdy.Settings.PERSIST_VALUE;
+import static com.squareup.okhttp.internal.net.spdy.SpdyConnection.FLAG_FIN;
+import static com.squareup.okhttp.internal.net.spdy.SpdyConnection.TYPE_DATA;
+import static com.squareup.okhttp.internal.net.spdy.SpdyConnection.TYPE_NOOP;
+import static com.squareup.okhttp.internal.net.spdy.SpdyConnection.TYPE_PING;
+import static com.squareup.okhttp.internal.net.spdy.SpdyConnection.TYPE_RST_STREAM;
+import static com.squareup.okhttp.internal.net.spdy.SpdyConnection.TYPE_SYN_REPLY;
+import static com.squareup.okhttp.internal.net.spdy.SpdyConnection.TYPE_SYN_STREAM;
+import static com.squareup.okhttp.internal.net.spdy.SpdyStream.RST_INVALID_STREAM;
+import static com.squareup.okhttp.internal.util.Charsets.UTF_8;
 import java.io.ByteArrayOutputStream;
 import java.io.IOException;
 import java.io.InputStream;
@@ -25,17 +35,6 @@
 import java.util.concurrent.atomic.AtomicInteger;
 import junit.framework.TestCase;
 
-import static libcore.net.spdy.Settings.PERSIST_VALUE;
-import static libcore.net.spdy.SpdyConnection.FLAG_FIN;
-import static libcore.net.spdy.SpdyConnection.TYPE_DATA;
-import static libcore.net.spdy.SpdyConnection.TYPE_NOOP;
-import static libcore.net.spdy.SpdyConnection.TYPE_PING;
-import static libcore.net.spdy.SpdyConnection.TYPE_RST_STREAM;
-import static libcore.net.spdy.SpdyConnection.TYPE_SYN_REPLY;
-import static libcore.net.spdy.SpdyConnection.TYPE_SYN_STREAM;
-import static libcore.net.spdy.SpdyStream.RST_INVALID_STREAM;
-import static libcore.util.Charsets.UTF_8;
-
 public final class SpdyConnectionTest extends TestCase {
     private static final IncomingStreamHandler REJECT_INCOMING_STREAMS
             = new IncomingStreamHandler() {
/Fim/
diff --git a/src/test/java/libcore/net/ssl/SslContextBuilder.java b/src/test/java/com/squareup/okhttp/internal/net/ssl/SslContextBuilder.java
similarity index 98%
rename from src/test/java/libcore/net/ssl/SslContextBuilder.java
rename to src/test/java/com/squareup/okhttp/internal/net/ssl/SslContextBuilder.java
index d88ca9c..09dba8d 100644
--- a/src/test/java/libcore/net/ssl/SslContextBuilder.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/ssl/SslContextBuilder.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package libcore.net.ssl;
+package com.squareup.okhttp.internal.net.ssl;
 
 import java.io.IOException;
 import java.io.InputStream;
/Fim/
/Fim/
/Fim/
/Fim/
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/io/Streams.java b/src/main/java/com/squareup/okhttp/internal/io/Streams.java
index 4a7a192..cf1465e 100644
--- a/src/main/java/com/squareup/okhttp/internal/io/Streams.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/Streams.java
@@ -17,7 +17,6 @@
 package com.squareup.okhttp.internal.io;
 
 import com.squareup.okhttp.internal.util.Libcore;
-import java.io.ByteArrayOutputStream;
 import java.io.EOFException;
 import java.io.IOException;
 import java.io.InputStream;
@@ -89,30 +88,6 @@
     }
 
     /**
-     * Returns a byte[] containing the remainder of 'in', closing it when done.
-     */
-    public static byte[] readFully(InputStream in) throws IOException {
-        try {
-            return readFullyNoClose(in);
-        } finally {
-            in.close();
-        }
-    }
-
-    /**
-     * Returns a byte[] containing the remainder of 'in'.
-     */
-    public static byte[] readFullyNoClose(InputStream in) throws IOException {
-        ByteArrayOutputStream bytes = new ByteArrayOutputStream();
-        byte[] buffer = new byte[1024];
-        int count;
-        while ((count = in.read(buffer)) != -1) {
-            bytes.write(buffer, 0, count);
-        }
-        return bytes.toByteArray();
-    }
-
-    /**
      * Returns the remainder of 'reader' as a string, closing it when done.
      */
     public static String readFully(Reader reader) throws IOException {
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/io/StrictLineReader.java b/src/main/java/com/squareup/okhttp/internal/io/StrictLineReader.java
index 9c95b19..c9b290a 100644
--- a/src/main/java/com/squareup/okhttp/internal/io/StrictLineReader.java
+++ b/src/main/java/com/squareup/okhttp/internal/io/StrictLineReader.java
@@ -213,16 +213,6 @@
     }
 
     /**
-     * Check whether there was an unterminated line at end of input after the line reader reported
-     * end-of-input with EOFException. The value is meaningless in any other situation.
-     *
-     * @return true if there was an unterminated line at end of input.
-     */
-    public boolean hasUnterminatedLine() {
-        return end == -1;
-    }
-
-    /**
      * Reads new input data into the buffer. Call only with pos == end or end == -1,
      * depending on the desired outcome if the function throws.
      *
/Fim/
/Fim/
/Fim/
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/util/Charsets.java b/src/main/java/com/squareup/okhttp/internal/util/Charsets.java
index 4e430ef..38a619d 100644
--- a/src/main/java/com/squareup/okhttp/internal/util/Charsets.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/Charsets.java
@@ -22,10 +22,6 @@
  * Provides convenient access to the most important built-in charsets. Saves a hash lookup and
  * unnecessary handling of UnsupportedEncodingException at call sites, compared to using the
  * charset's name.
- *
- * Also various special-case charset conversions (for performance).
- *
- * @hide internal use only
  */
 public final class Charsets {
     /**
/Fim/
/Fim/
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/util/EmptyArray.java b/src/main/java/com/squareup/okhttp/internal/util/EmptyArray.java
index 2f12e1a..fa24130 100644
--- a/src/main/java/com/squareup/okhttp/internal/util/EmptyArray.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/EmptyArray.java
@@ -20,15 +20,5 @@
     private EmptyArray() {
     }
 
-    public static final boolean[] BOOLEAN = new boolean[0];
     public static final byte[] BYTE = new byte[0];
-    public static final char[] CHAR = new char[0];
-    public static final double[] DOUBLE = new double[0];
-    public static final int[] INT = new int[0];
-
-    public static final Class<?>[] CLASS = new Class[0];
-    public static final Object[] OBJECT = new Object[0];
-    public static final String[] STRING = new String[0];
-    public static final Throwable[] THROWABLE = new Throwable[0];
-    public static final StackTraceElement[] STACK_TRACE_ELEMENT = new StackTraceElement[0];
 }
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/util/ExtendedResponseCache.java b/src/main/java/com/squareup/okhttp/internal/util/ExtendedResponseCache.java
index dbe492d..82aea81 100644
--- a/src/main/java/com/squareup/okhttp/internal/util/ExtendedResponseCache.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/ExtendedResponseCache.java
@@ -24,32 +24,21 @@
  * A response cache that supports statistics tracking and updating stored
  * responses. Implementations of {@link java.net.ResponseCache} should implement this
  * interface to receive additional support from the HTTP engine.
- *
- * @hide
  */
 public interface ExtendedResponseCache {
 
-    /*
-     * This hidden interface is defined in a non-hidden package (java.net) so
-     * its @hide tag will be parsed by Doclava. This hides this interface from
-     * implementing classes' documentation.
-     */
-
     /**
      * Track an HTTP response being satisfied by {@code source}.
-     * @hide
      */
     void trackResponse(ResponseSource source);
 
     /**
      * Track an conditional GET that was satisfied by this cache.
-     * @hide
      */
     void trackConditionalCacheHit();
 
     /**
      * Updates stored HTTP headers using a hit on a conditional GET.
-     * @hide
      */
     void update(CacheResponse conditionalCacheHit, HttpURLConnection httpConnection)
             throws IOException;
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/util/IntegralToString.java b/src/main/java/com/squareup/okhttp/internal/util/IntegralToString.java
index 839f823..fb24604 100644
--- a/src/main/java/com/squareup/okhttp/internal/util/IntegralToString.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/IntegralToString.java
@@ -31,8 +31,6 @@
  *
  * One day the performance advantage of the binary/hex/octal specializations will be small enough
  * that we can lose the duplication, but until then this class offers the full set.
- *
- * @hide
  */
 public final class IntegralToString {
     /**
/Fim/
/Fim/
/Fim/
/Fim/
/Fim/
/Fim/
/Fim/
/Fim/
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/util/ResponseSource.java b/src/main/java/com/squareup/okhttp/internal/util/ResponseSource.java
index 9dd7678..7f21048 100644
--- a/src/main/java/com/squareup/okhttp/internal/util/ResponseSource.java
+++ b/src/main/java/com/squareup/okhttp/internal/util/ResponseSource.java
@@ -18,8 +18,6 @@
 
 /**
  * Where the HTTP client should look for a response.
- *
- * @hide
  */
 public enum ResponseSource {
 
/Fim/
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/net/http/HttpDate.java b/src/main/java/com/squareup/okhttp/internal/net/http/HttpDate.java
index d8f218b..60f1f35 100644
--- a/src/main/java/com/squareup/okhttp/internal/net/http/HttpDate.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/HttpDate.java
@@ -26,7 +26,7 @@
 /**
  * Best-effort parser for HTTP dates.
  */
-public final class HttpDate {
+final class HttpDate {
 
     /**
      * Most websites serve cookies in the blessed format. Eagerly create the parser to ensure such
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/net/http/RequestHeaders.java b/src/main/java/com/squareup/okhttp/internal/net/http/RequestHeaders.java
index ca872c2..b53fc81 100644
--- a/src/main/java/com/squareup/okhttp/internal/net/http/RequestHeaders.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/RequestHeaders.java
@@ -24,7 +24,7 @@
 /**
  * Parsed HTTP request headers.
  */
-public final class RequestHeaders {
+final class RequestHeaders {
     private final URI uri;
     private final RawHeaders headers;
 
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/net/http/ResponseHeaders.java b/src/main/java/com/squareup/okhttp/internal/net/http/ResponseHeaders.java
index 2061960..5e6962d 100644
--- a/src/main/java/com/squareup/okhttp/internal/net/http/ResponseHeaders.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/ResponseHeaders.java
@@ -32,7 +32,7 @@
 /**
  * Parsed HTTP response headers.
  */
-public final class ResponseHeaders {
+final class ResponseHeaders {
 
     /** HTTP header name for the local time when the request was sent. */
     private static final String SENT_MILLIS = "X-Android-Sent-Millis";
/Fim/
diff --git a/src/main/java/com/squareup/okhttp/internal/net/http/RouteSelector.java b/src/main/java/com/squareup/okhttp/internal/net/http/RouteSelector.java
index 1d6571c..81ddf96 100644
--- a/src/main/java/com/squareup/okhttp/internal/net/http/RouteSelector.java
+++ b/src/main/java/com/squareup/okhttp/internal/net/http/RouteSelector.java
@@ -37,7 +37,7 @@
  * choice of proxy server, IP address, and TLS mode. Connections may also be
  * recycled.
  */
-public final class RouteSelector {
+final class RouteSelector {
     /**
      * A TLS connection with useful extensions enabled. This mode supports more
      * features, but is less likely to be compatible with older HTTP servers.
/Fim/
diff --git a/src/test/java/com/squareup/okhttp/internal/net/http/NewURLConnectionTest.java b/src/test/java/com/squareup/okhttp/internal/net/http/NewURLConnectionTest.java
index 183d15d..6a85448 100644
--- a/src/test/java/com/squareup/okhttp/internal/net/http/NewURLConnectionTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/NewURLConnectionTest.java
@@ -37,4 +37,8 @@
 
     // TODO: read the outgoing status line and incoming status line?
 
+    // TODO: test that request bodies are retransmitted on IP address failures
+
+    // TODO: pooled proxy failures are not reported to the proxy selector
+
 }
/Fim/
diff --git a/src/test/java/com/squareup/okhttp/internal/net/http/URLConnectionTest.java b/src/test/java/com/squareup/okhttp/internal/net/http/URLConnectionTest.java
index 52beed0..f721700 100644
--- a/src/test/java/com/squareup/okhttp/internal/net/http/URLConnectionTest.java
+++ b/src/test/java/com/squareup/okhttp/internal/net/http/URLConnectionTest.java
@@ -46,7 +46,6 @@
 import java.net.SocketAddress;
 import java.net.SocketTimeoutException;
 import java.net.URI;
-import java.net.URISyntaxException;
 import java.net.URL;
 import java.net.URLConnection;
 import java.net.UnknownHostException;
@@ -63,12 +62,12 @@
 import java.util.Set;
 import java.util.UUID;
 import java.util.concurrent.atomic.AtomicBoolean;
-import java.util.concurrent.atomic.AtomicReference;
 import java.util.zip.GZIPInputStream;
 import java.util.zip.GZIPOutputStream;
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLException;
+import javax.net.ssl.SSLHandshakeException;
 import javax.net.ssl.SSLSession;
 import javax.net.ssl.SSLSocketFactory;
 import javax.net.ssl.TrustManager;
@@ -120,9 +119,6 @@
         super.tearDown();
     }
 
-    // TODO: test that request bodies are retransmitted on IP address failures
-    // TODO: pooled proxy failures are not reported to the proxy selector
-
     public void testRequestHeaders() throws IOException, InterruptedException {
         server.enqueue(new MockResponse());
         server.play();
@@ -397,7 +393,7 @@
         testServerClosesOutput(SHUTDOWN_INPUT_AT_END);
     }
 
-    public void SUPPRESSED_testServerShutdownOutput() throws Exception {
+    public void testServerShutdownOutput() throws Exception {
         testServerClosesOutput(SHUTDOWN_OUTPUT_AT_END);
     }
 
@@ -405,15 +401,27 @@
         server.enqueue(new MockResponse()
                 .setBody("This connection won't pool properly")
                 .setSocketPolicy(socketPolicy));
-        server.enqueue(new MockResponse()
-                .setBody("This comes after a busted connection"));
+        MockResponse responseAfter = new MockResponse()
+                .setBody("This comes after a busted connection");
+        server.enqueue(responseAfter);
+        server.enqueue(responseAfter); // Enqueue 2x because the broken connection may be reused.
         server.play();
 
-        assertContent("This connection won't pool properly", client.open(server.getUrl("/a")));
+        HttpURLConnection connection1 = client.open(server.getUrl("/a"));
+        connection1.setReadTimeout(100);
+        assertContent("This connection won't pool properly", connection1);
         assertEquals(0, server.takeRequest().getSequenceNumber());
-        assertContent("This comes after a busted connection", client.open(server.getUrl("/b")));
+        HttpURLConnection connection2 = client.open(server.getUrl("/b"));
+        connection2.setReadTimeout(100);
+        assertContent("This comes after a busted connection", connection2);
+
+        // Check that a fresh connection was created, either immediately or after attempting reuse.
+        RecordedRequest requestAfter = server.takeRequest();
+        if (server.getRequestCount() == 3) {
+            requestAfter = server.takeRequest(); // The failure consumed a response.
+        }
         // sequence number 0 means the HTTP socket connection was not reused
-        assertEquals(0, server.takeRequest().getSequenceNumber());
+        assertEquals(0, requestAfter.getSequenceNumber());
     }
 
     enum WriteKind { BYTE_BY_BYTE, SMALL_BUFFERS, LARGE_BUFFERS }
@@ -430,7 +438,7 @@
         doUpload(TransferKind.CHUNKED, WriteKind.LARGE_BUFFERS);
     }
 
-    public void SUPPRESSED_test_fixedLengthUpload_byteByByte() throws Exception {
+    public void test_fixedLengthUpload_byteByByte() throws Exception {
         doUpload(TransferKind.FIXED_LENGTH, WriteKind.BYTE_BY_BYTE);
     }
 
@@ -576,24 +584,20 @@
      *
      * http://code.google.com/p/android/issues/detail?id=13178
      */
-//    public void testConnectViaHttpsToUntrustedServer() throws IOException, InterruptedException {
-//        TestSSLContext testSSLContext = TestSSLContext.create(TestKeyStore.getClientCA2(),
-//                                                              TestKeyStore.getServer());
-//
-//        server.useHttps(testSSLContext.serverContext.getSocketFactory(), false);
-//        server.enqueue(new MockResponse()); // unused
-//        server.play();
-//
-//        HttpsURLConnection connection = (HttpsURLConnection) server.getUrl("/foo").openConnection();
-//        connection.setSSLSocketFactory(testSSLContext.clientContext.getSocketFactory());
-//        try {
-//            connection.getInputStream();
-//            fail();
-//        } catch (SSLHandshakeException expected) {
-//            assertTrue(expected.getCause() instanceof CertificateException);
-//        }
-//        assertEquals(0, server.getRequestCount());
-//    }
+    public void testConnectViaHttpsToUntrustedServer() throws IOException, InterruptedException {
+        server.useHttps(sslContext.getSocketFactory(), false);
+        server.enqueue(new MockResponse()); // unused
+        server.play();
+
+        HttpURLConnection connection = client.open(server.getUrl("/foo"));
+        try {
+            connection.getInputStream();
+            fail();
+        } catch (SSLHandshakeException expected) {
+            assertTrue(expected.getCause() instanceof CertificateException);
+        }
+        assertEquals(0, server.getRequestCount());
+    }
 
     public void testConnectViaProxyUsingProxyArg() throws Exception {
         testConnectViaProxy(ProxyConfig.CREATE_ARG);
@@ -961,7 +965,7 @@
      * code 401. This causes a new HTTP request to be issued for every call into
      * the URLConnection.
      */
-    public void SUPPRESSED_testUnauthorizedResponseHandling() throws IOException {
+    public void testUnauthorizedResponseHandling() throws IOException {
         MockResponse response = new MockResponse()
                 .addHeader("WWW-Authenticate: challenge")
                 .setResponseCode(401) // UNAUTHORIZED
@@ -1578,7 +1582,7 @@
                 readAscii(connection.getInputStream(), Integer.MAX_VALUE));
     }
 
-    public void SUPPRESSED_testRedirectToAnotherOriginServer() throws Exception {
+    public void testRedirectToAnotherOriginServer() throws Exception {
         MockWebServer server2 = new MockWebServer();
         server2.enqueue(new MockResponse().setBody("This is the 2nd server!"));
         server2.play();
@@ -1597,7 +1601,7 @@
 
         // make sure the first server was careful to recycle the connection
         assertEquals("This is the first server again!",
-                readAscii(server.getUrl("/").openStream(), Integer.MAX_VALUE));
+                readAscii(client.open(server.getUrl("/")).getInputStream(), Integer.MAX_VALUE));
 
         RecordedRequest first = server.takeRequest();
         assertContains(first.getHeaders(), "Host: " + hostName + ":" + server.getPort());
@@ -1891,138 +1895,28 @@
         }
     }
 
-    public void SUPPRESSED_testGetKeepAlive() throws Exception {
+    public void testGetKeepAlive() throws Exception {
         MockWebServer server = new MockWebServer();
         server.enqueue(new MockResponse().setBody("ABC"));
         server.play();
 
         // The request should work once and then fail
-        URLConnection connection = client.open(server.getUrl(""));
-        InputStream input = connection.getInputStream();
+        URLConnection connection1 = client.open(server.getUrl(""));
+        connection1.setReadTimeout(100);
+        InputStream input = connection1.getInputStream();
         assertEquals("ABC", readAscii(input, Integer.MAX_VALUE));
         input.close();
+        server.shutdown();
         try {
-            client.open(server.getUrl("")).getInputStream();
+            HttpURLConnection connection2 = client.open(server.getUrl(""));
+            connection2.setReadTimeout(100);
+            connection2.getInputStream();
             fail();
         } catch (ConnectException expected) {
         }
     }
 
     /**
-     * This test goes through the exhaustive set of interesting ASCII characters
-     * because most of those characters are interesting in some way according to
-     * RFC 2396 and RFC 2732. http://b/1158780
-     */
-    public void SUPPRESSED_testLenientUrlToUri() throws Exception {
-        // alphanum
-        testUrlToUriMapping("abzABZ09", "abzABZ09", "abzABZ09", "abzABZ09", "abzABZ09");
-
-        // control characters
-        testUrlToUriMapping("\u0001", "%01", "%01", "%01", "%01");
-        testUrlToUriMapping("\u001f", "%1F", "%1F", "%1F", "%1F");
-
-        // ascii characters
-        testUrlToUriMapping("%20", "%20", "%20", "%20", "%20");
-        testUrlToUriMapping("%20", "%20", "%20", "%20", "%20");
-        testUrlToUriMapping(" ", "%20", "%20", "%20", "%20");
-        testUrlToUriMapping("!", "!", "!", "!", "!");
-        testUrlToUriMapping("\"", "%22", "%22", "%22", "%22");
-        testUrlToUriMapping("#", null, null, null, "%23");
-        testUrlToUriMapping("$", "$", "$", "$", "$");
-        testUrlToUriMapping("&", "&", "&", "&", "&");
-        testUrlToUriMapping("'", "'", "'", "'", "'");
-        testUrlToUriMapping("(", "(", "(", "(", "(");
-        testUrlToUriMapping(")", ")", ")", ")", ")");
-        testUrlToUriMapping("*", "*", "*", "*", "*");
-        testUrlToUriMapping("+", "+", "+", "+", "+");
-        testUrlToUriMapping(",", ",", ",", ",", ",");
-        testUrlToUriMapping("-", "-", "-", "-", "-");
-        testUrlToUriMapping(".", ".", ".", ".", ".");
-        testUrlToUriMapping("/", null, "/", "/", "/");
-        testUrlToUriMapping(":", null, ":", ":", ":");
-        testUrlToUriMapping(";", ";", ";", ";", ";");
-        testUrlToUriMapping("<", "%3C", "%3C", "%3C", "%3C");
-        testUrlToUriMapping("=", "=", "=", "=", "=");
-        testUrlToUriMapping(">", "%3E", "%3E", "%3E", "%3E");
-        testUrlToUriMapping("?", null, null, "?", "?");
-        testUrlToUriMapping("@", "@", "@", "@", "@");
-        testUrlToUriMapping("[", null, "%5B", null, "%5B");
-        testUrlToUriMapping("\\", "%5C", "%5C", "%5C", "%5C");
-        testUrlToUriMapping("]", null, "%5D", null, "%5D");
-        testUrlToUriMapping("^", "%5E", "%5E", "%5E", "%5E");
-        testUrlToUriMapping("_", "_", "_", "_", "_");
-        testUrlToUriMapping("`", "%60", "%60", "%60", "%60");
-        testUrlToUriMapping("{", "%7B", "%7B", "%7B", "%7B");
-        testUrlToUriMapping("|", "%7C", "%7C", "%7C", "%7C");
-        testUrlToUriMapping("}", "%7D", "%7D", "%7D", "%7D");
-        testUrlToUriMapping("~", "~", "~", "~", "~");
-        testUrlToUriMapping("~", "~", "~", "~", "~");
-        testUrlToUriMapping("\u007f", "%7F", "%7F", "%7F", "%7F");
-
-        // beyond ascii
-        testUrlToUriMapping("\u0080", "%C2%80", "%C2%80", "%C2%80", "%C2%80");
-        testUrlToUriMapping("\u20ac", "\u20ac", "\u20ac", "\u20ac", "\u20ac");
-        testUrlToUriMapping("\ud842\udf9f",
-                "\ud842\udf9f", "\ud842\udf9f", "\ud842\udf9f", "\ud842\udf9f");
-    }
-
-    public void SUPPRESSED_testLenientUrlToUriNul() throws Exception {
-        testUrlToUriMapping("\u0000", "%00", "%00", "%00", "%00"); // RI fails this
-    }
-
-    private void testUrlToUriMapping(String string, String asAuthority, String asFile,
-            String asQuery, String asFragment) throws Exception {
-        if (asAuthority != null) {
-            assertEquals("http://host" + asAuthority + ".tld/",
-                    backdoorUrlToUri(new URL("http://host" + string + ".tld/")).toString());
-        }
-        if (asFile != null) {
-            assertEquals("http://host.tld/file" + asFile + "/",
-                    backdoorUrlToUri(new URL("http://host.tld/file" + string + "/")).toString());
-        }
-        if (asQuery != null) {
-            assertEquals("http://host.tld/file?q" + asQuery + "=x",
-                    backdoorUrlToUri(new URL("http://host.tld/file?q" + string + "=x")).toString());
-        }
-        assertEquals("http://host.tld/file#" + asFragment + "-x",
-                backdoorUrlToUri(new URL("http://host.tld/file#" + asFragment + "-x")).toString());
-    }
-
-    /**
-     * Exercises HttpURLConnection to convert URL to a URI. Unlike URL#toURI,
-     * HttpURLConnection recovers from URLs with unescaped but unsupported URI
-     * characters like '{' and '|' by escaping these characters.
-     */
-    private URI backdoorUrlToUri(URL url) throws Exception {
-        final AtomicReference<URI> uriReference = new AtomicReference<URI>();
-
-        client.setResponseCache(new ResponseCache() {
-            @Override
-            public CacheRequest put(URI uri, URLConnection connection) throws IOException {
-                return null;
-            }
-
-            @Override
-            public CacheResponse get(URI uri, String requestMethod,
-                    Map<String, List<String>> requestHeaders) throws IOException {
-                uriReference.set(uri);
-                throw new UnsupportedOperationException();
-            }
-        });
-
-        try {
-            HttpURLConnection connection = client.open(url);
-            connection.getResponseCode();
-        } catch (Exception expected) {
-            if (expected.getCause() instanceof URISyntaxException) {
-                expected.printStackTrace();
-            }
-        }
-
-        return uriReference.get();
-    }
-
-    /**
      * Don't explode if the cache returns a null body. http://b/3373699
      */
     public void testResponseCacheReturnsNullOutputStream() throws Exception {
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/Connection.java b/okhttp/src/main/java/com/squareup/okhttp/Connection.java
index d6d7cf0..5ec99cc 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/Connection.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/Connection.java
@@ -108,7 +108,7 @@
 
     // Use MTU-sized buffers to send fewer packets.
     int mtu = Platform.get().getMtu(socket);
-    if (mtu < 256) mtu = 256;
+    if (mtu < 1024) mtu = 1024;
     if (mtu > 8192) mtu = 8192;
     in = new BufferedInputStream(in, mtu);
     out = new BufferedOutputStream(out, mtu);
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 323283c..82f9261 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,19 @@
 Change Log
 ==========
 
+Version 1.1.0 *(2013-06-15)*
+----------------------------
+
+ * Fix: Connection reuse was broken for most HTTPS connections due to a bug in
+   the way the hostname verifier was selected.
+ * Fix: Locking bug in SpdyConnection.
+ * Fix: Ignore null header values (for compatibility with HttpURLConnection).
+ * Add URLStreamHandlerFactory support so that `URL.openConnection()` uses
+   OkHttp.
+ * Expose the transport ("http/1.1", "spdy/3", etc.) via magic request headers.
+   Use `X-Android-Transports` to write the preferred transports and
+   `X-Android-Selected-Transport` to read the negotiated transport.
+
 Version 1.0.2 *(2013-05-11)*
 ----------------------------
 
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/OkHttpClient.java b/okhttp/src/main/java/com/squareup/okhttp/OkHttpClient.java
index 1feed31..68ff59b 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/OkHttpClient.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/OkHttpClient.java
@@ -22,7 +22,6 @@
 import com.squareup.okhttp.internal.http.OkResponseCache;
 import com.squareup.okhttp.internal.http.OkResponseCacheAdapter;
 import com.squareup.okhttp.internal.tls.OkHostnameVerifier;
-import java.io.IOException;
 import java.net.CookieHandler;
 import java.net.HttpURLConnection;
 import java.net.Proxy;
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/internal/http/ResponseHeaders.java b/okhttp/src/main/java/com/squareup/okhttp/internal/http/ResponseHeaders.java
index 97925c2..0be6abb 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/internal/http/ResponseHeaders.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/internal/http/ResponseHeaders.java
@@ -42,7 +42,7 @@
   /** HTTP synthetic header with the response source. */
   static final String RESPONSE_SOURCE = "X-Android-Response-Source";
 
-  /** HTTP synthetic header with the selected transport (spdy/3, http/1.1, etc.) */
+  /** HTTP synthetic header with the selected transport (spdy/3, http/1.1, etc). */
   static final String SELECTED_TRANSPORT = "X-Android-Selected-Transport";
 
   private final URI uri;
/Fim/
diff --git a/okhttp/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java b/okhttp/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
index 7f66519..9266683 100644
--- a/okhttp/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
+++ b/okhttp/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
@@ -157,17 +157,9 @@
       fail();
     } catch (NullPointerException expected) {
     }
-    try {
-      urlConnection.setRequestProperty("NullValue", null);
-      fail();
-    } catch (IllegalArgumentException expected) {
-    }
+    urlConnection.setRequestProperty("NullValue", null);
     assertNull(urlConnection.getRequestProperty("NullValue"));
-    try {
-      urlConnection.addRequestProperty("AnotherNullValue", null);
-      fail();
-    } catch (Exception expected) {
-    }
+    urlConnection.addRequestProperty("AnotherNullValue", null);
     assertNull(urlConnection.getRequestProperty("AnotherNullValue"));
 
     urlConnection.getResponseCode();
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 685095c..d350173 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.0.3-SNAPSHOT</version>
+    <version>1.1.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a36c2e6..95bde86 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.0.3-SNAPSHOT</version>
+    <version>1.1.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 3061b92..1e705b6 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>1.0.3-SNAPSHOT</version>
+  <version>1.1.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -43,7 +43,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-1.1.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index fc16e01..e00ee42 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.0.3-SNAPSHOT</version>
+    <version>1.1.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 754e80a..1324585 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.0.3-SNAPSHOT</version>
+    <version>1.1.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 1a5b5b9..28ae8cf 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.0.3-SNAPSHOT</version>
+    <version>1.1.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index d350173..7b9f9d1 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.0</version>
+    <version>1.1.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 95bde86..354decc 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.0</version>
+    <version>1.1.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 1e705b6..797808e 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>1.1.0</version>
+  <version>1.1.1-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -43,7 +43,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-1.1.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index e00ee42..df54bf0 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.0</version>
+    <version>1.1.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 1324585..133a538 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.0</version>
+    <version>1.1.1-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 28ae8cf..9ddde29 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.0</version>
+    <version>1.1.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 82f9261..1a5c033 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,13 @@
 Change Log
 ==========
 
+Version 1.1.1 *(2013-06-23)*
+----------------------------
+
+ * Fix: ClassCastException when caching responses that were redirected from
+   HTTP to HTTPS.
+
+
 Version 1.1.0 *(2013-06-15)*
 ----------------------------
 
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 7b9f9d1..fdadc62 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.1-SNAPSHOT</version>
+    <version>1.1.1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 354decc..a226fab 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.1-SNAPSHOT</version>
+    <version>1.1.1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 797808e..4655088 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>1.1.1-SNAPSHOT</version>
+  <version>1.1.1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -43,7 +43,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-1.1.1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index df54bf0..6599e37 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.1-SNAPSHOT</version>
+    <version>1.1.1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 133a538..d1b2891 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.1-SNAPSHOT</version>
+    <version>1.1.1</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 9ddde29..3a4136d 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.1-SNAPSHOT</version>
+    <version>1.1.1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index fdadc62..cebe947 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.1</version>
+    <version>1.1.2-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a226fab..853f0b9 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.1</version>
+    <version>1.1.2-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 4655088..8984052 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>1.1.1</version>
+  <version>1.1.2-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -43,7 +43,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-1.1.1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 6599e37..e2a1394 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.1</version>
+    <version>1.1.2-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d1b2891..ae149d9 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.1</version>
+    <version>1.1.2-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 3a4136d..ed7f390 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.1</version>
+    <version>1.1.2-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/mockwebserver/COPYING b/mockwebserver/COPYING
new file mode 100644
index 0000000..d645695
--- /dev/null
+++ b/mockwebserver/COPYING
@@ -0,0 +1,202 @@
+
+                                 Apache License
+                           Version 2.0, January 2004
+                        http://www.apache.org/licenses/
+
+   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
+
+   1. Definitions.
+
+      "License" shall mean the terms and conditions for use, reproduction,
+      and distribution as defined by Sections 1 through 9 of this document.
+
+      "Licensor" shall mean the copyright owner or entity authorized by
+      the copyright owner that is granting the License.
+
+      "Legal Entity" shall mean the union of the acting entity and all
+      other entities that control, are controlled by, or are under common
+      control with that entity. For the purposes of this definition,
+      "control" means (i) the power, direct or indirect, to cause the
+      direction or management of such entity, whether by contract or
+      otherwise, or (ii) ownership of fifty percent (50%) or more of the
+      outstanding shares, or (iii) beneficial ownership of such entity.
+
+      "You" (or "Your") shall mean an individual or Legal Entity
+      exercising permissions granted by this License.
+
+      "Source" form shall mean the preferred form for making modifications,
+      including but not limited to software source code, documentation
+      source, and configuration files.
+
+      "Object" form shall mean any form resulting from mechanical
+      transformation or translation of a Source form, including but
+      not limited to compiled object code, generated documentation,
+      and conversions to other media types.
+
+      "Work" shall mean the work of authorship, whether in Source or
+      Object form, made available under the License, as indicated by a
+      copyright notice that is included in or attached to the work
+      (an example is provided in the Appendix below).
+
+      "Derivative Works" shall mean any work, whether in Source or Object
+      form, that is based on (or derived from) the Work and for which the
+      editorial revisions, annotations, elaborations, or other modifications
+      represent, as a whole, an original work of authorship. For the purposes
+      of this License, Derivative Works shall not include works that remain
+      separable from, or merely link (or bind by name) to the interfaces of,
+      the Work and Derivative Works thereof.
+
+      "Contribution" shall mean any work of authorship, including
+      the original version of the Work and any modifications or additions
+      to that Work or Derivative Works thereof, that is intentionally
+      submitted to Licensor for inclusion in the Work by the copyright owner
+      or by an individual or Legal Entity authorized to submit on behalf of
+      the copyright owner. For the purposes of this definition, "submitted"
+      means any form of electronic, verbal, or written communication sent
+      to the Licensor or its representatives, including but not limited to
+      communication on electronic mailing lists, source code control systems,
+      and issue tracking systems that are managed by, or on behalf of, the
+      Licensor for the purpose of discussing and improving the Work, but
+      excluding communication that is conspicuously marked or otherwise
+      designated in writing by the copyright owner as "Not a Contribution."
+
+      "Contributor" shall mean Licensor and any individual or Legal Entity
+      on behalf of whom a Contribution has been received by Licensor and
+      subsequently incorporated within the Work.
+
+   2. Grant of Copyright License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      copyright license to reproduce, prepare Derivative Works of,
+      publicly display, publicly perform, sublicense, and distribute the
+      Work and such Derivative Works in Source or Object form.
+
+   3. Grant of Patent License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      (except as stated in this section) patent license to make, have made,
+      use, offer to sell, sell, import, and otherwise transfer the Work,
+      where such license applies only to those patent claims licensable
+      by such Contributor that are necessarily infringed by their
+      Contribution(s) alone or by combination of their Contribution(s)
+      with the Work to which such Contribution(s) was submitted. If You
+      institute patent litigation against any entity (including a
+      cross-claim or counterclaim in a lawsuit) alleging that the Work
+      or a Contribution incorporated within the Work constitutes direct
+      or contributory patent infringement, then any patent licenses
+      granted to You under this License for that Work shall terminate
+      as of the date such litigation is filed.
+
+   4. Redistribution. You may reproduce and distribute copies of the
+      Work or Derivative Works thereof in any medium, with or without
+      modifications, and in Source or Object form, provided that You
+      meet the following conditions:
+
+      (a) You must give any other recipients of the Work or
+          Derivative Works a copy of this License; and
+
+      (b) You must cause any modified files to carry prominent notices
+          stating that You changed the files; and
+
+      (c) You must retain, in the Source form of any Derivative Works
+          that You distribute, all copyright, patent, trademark, and
+          attribution notices from the Source form of the Work,
+          excluding those notices that do not pertain to any part of
+          the Derivative Works; and
+
+      (d) If the Work includes a "NOTICE" text file as part of its
+          distribution, then any Derivative Works that You distribute must
+          include a readable copy of the attribution notices contained
+          within such NOTICE file, excluding those notices that do not
+          pertain to any part of the Derivative Works, in at least one
+          of the following places: within a NOTICE text file distributed
+          as part of the Derivative Works; within the Source form or
+          documentation, if provided along with the Derivative Works; or,
+          within a display generated by the Derivative Works, if and
+          wherever such third-party notices normally appear. The contents
+          of the NOTICE file are for informational purposes only and
+          do not modify the License. You may add Your own attribution
+          notices within Derivative Works that You distribute, alongside
+          or as an addendum to the NOTICE text from the Work, provided
+          that such additional attribution notices cannot be construed
+          as modifying the License.
+
+      You may add Your own copyright statement to Your modifications and
+      may provide additional or different license terms and conditions
+      for use, reproduction, or distribution of Your modifications, or
+      for any such Derivative Works as a whole, provided Your use,
+      reproduction, and distribution of the Work otherwise complies with
+      the conditions stated in this License.
+
+   5. Submission of Contributions. Unless You explicitly state otherwise,
+      any Contribution intentionally submitted for inclusion in the Work
+      by You to the Licensor shall be under the terms and conditions of
+      this License, without any additional terms or conditions.
+      Notwithstanding the above, nothing herein shall supersede or modify
+      the terms of any separate license agreement you may have executed
+      with Licensor regarding such Contributions.
+
+   6. Trademarks. This License does not grant permission to use the trade
+      names, trademarks, service marks, or product names of the Licensor,
+      except as required for reasonable and customary use in describing the
+      origin of the Work and reproducing the content of the NOTICE file.
+
+   7. Disclaimer of Warranty. Unless required by applicable law or
+      agreed to in writing, Licensor provides the Work (and each
+      Contributor provides its Contributions) on an "AS IS" BASIS,
+      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
+      implied, including, without limitation, any warranties or conditions
+      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
+      PARTICULAR PURPOSE. You are solely responsible for determining the
+      appropriateness of using or redistributing the Work and assume any
+      risks associated with Your exercise of permissions under this License.
+
+   8. Limitation of Liability. In no event and under no legal theory,
+      whether in tort (including negligence), contract, or otherwise,
+      unless required by applicable law (such as deliberate and grossly
+      negligent acts) or agreed to in writing, shall any Contributor be
+      liable to You for damages, including any direct, indirect, special,
+      incidental, or consequential damages of any character arising as a
+      result of this License or out of the use or inability to use the
+      Work (including but not limited to damages for loss of goodwill,
+      work stoppage, computer failure or malfunction, or any and all
+      other commercial damages or losses), even if such Contributor
+      has been advised of the possibility of such damages.
+
+   9. Accepting Warranty or Additional Liability. While redistributing
+      the Work or Derivative Works thereof, You may choose to offer,
+      and charge a fee for, acceptance of support, warranty, indemnity,
+      or other liability obligations and/or rights consistent with this
+      License. However, in accepting such obligations, You may act only
+      on Your own behalf and on Your sole responsibility, not on behalf
+      of any other Contributor, and only if You agree to indemnify,
+      defend, and hold each Contributor harmless for any liability
+      incurred by, or claims asserted against, such Contributor by reason
+      of your accepting any such warranty or additional liability.
+
+   END OF TERMS AND CONDITIONS
+
+   APPENDIX: How to apply the Apache License to your work.
+
+      To apply the Apache License to your work, attach the following
+      boilerplate notice, with the fields enclosed by brackets "[]"
+      replaced with your own identifying information. (Don't include
+      the brackets!)  The text should be enclosed in the appropriate
+      comment syntax for the file format. We also recommend that a
+      file or class name and description of purpose be included on the
+      same "printed page" as the copyright notice for easier
+      identification within third-party archives.
+
+   Copyright [yyyy] [name of copyright owner]
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+   you may not use this file except in compliance with the License.
+   You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
/Fim/
diff --git a/mockwebserver/src/main/java/com/google/mockwebserver/Dispatcher.java b/mockwebserver/src/main/java/com/google/mockwebserver/Dispatcher.java
new file mode 100644
index 0000000..0456025
--- /dev/null
+++ b/mockwebserver/src/main/java/com/google/mockwebserver/Dispatcher.java
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2012 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.google.mockwebserver;
+
+/**
+ * Handler for mock server requests.
+ */
+public abstract class Dispatcher {
+    /**
+     * Returns a response to satisfy {@code request}. This method may block (for
+     * instance, to wait on a CountdownLatch).
+     */
+    public abstract MockResponse dispatch(RecordedRequest request) throws InterruptedException;
+
+    /**
+     * Returns the socket policy of the next request.  Default implementation
+     * returns {@link SocketPolicy#KEEP_OPEN}. Mischievous implementations can
+     * return other values to test HTTP edge cases.
+     */
+    public SocketPolicy peekSocketPolicy() {
+        return SocketPolicy.KEEP_OPEN;
+    }
+}
/Fim/
diff --git a/mockwebserver/src/main/java/com/google/mockwebserver/MockResponse.java b/mockwebserver/src/main/java/com/google/mockwebserver/MockResponse.java
new file mode 100644
index 0000000..674a911
--- /dev/null
+++ b/mockwebserver/src/main/java/com/google/mockwebserver/MockResponse.java
@@ -0,0 +1,240 @@
+/*
+ * Copyright (C) 2011 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.google.mockwebserver;
+
+import static com.google.mockwebserver.MockWebServer.ASCII;
+import java.io.ByteArrayInputStream;
+import java.io.ByteArrayOutputStream;
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.UnsupportedEncodingException;
+import java.util.ArrayList;
+import java.util.Iterator;
+import java.util.List;
+
+/**
+ * A scripted response to be replayed by the mock web server.
+ */
+public final class MockResponse implements Cloneable {
+    private static final String CHUNKED_BODY_HEADER = "Transfer-encoding: chunked";
+
+    private String status = "HTTP/1.1 200 OK";
+    private List<String> headers = new ArrayList<String>();
+
+    /** The response body content, or null if {@code bodyStream} is set. */
+    private byte[] body;
+    /** The response body content, or null if {@code body} is set. */
+    private InputStream bodyStream;
+
+    private int bytesPerSecond = Integer.MAX_VALUE;
+    private SocketPolicy socketPolicy = SocketPolicy.KEEP_OPEN;
+
+    /**
+     * Creates a new mock response with an empty body.
+     */
+    public MockResponse() {
+        setBody(new byte[0]);
+    }
+
+    @Override public MockResponse clone() {
+        try {
+            MockResponse result = (MockResponse) super.clone();
+            result.headers = new ArrayList<String>(result.headers);
+            return result;
+        } catch (CloneNotSupportedException e) {
+            throw new AssertionError();
+        }
+    }
+
+    /**
+     * Returns the HTTP response line, such as "HTTP/1.1 200 OK".
+     */
+    public String getStatus() {
+        return status;
+    }
+
+    public MockResponse setResponseCode(int code) {
+        this.status = "HTTP/1.1 " + code + " OK";
+        return this;
+    }
+
+    public MockResponse setStatus(String status) {
+        this.status = status;
+        return this;
+    }
+
+    /**
+     * Returns the HTTP headers, such as "Content-Length: 0".
+     */
+    public List<String> getHeaders() {
+        return headers;
+    }
+
+    /**
+     * Removes all HTTP headers including any "Content-Length" and
+     * "Transfer-encoding" headers that were added by default.
+     */
+    public MockResponse clearHeaders() {
+        headers.clear();
+        return this;
+    }
+
+    /**
+     * Adds {@code header} as an HTTP header. For well-formed HTTP {@code
+     * header} should contain a name followed by a colon and a value.
+     */
+    public MockResponse addHeader(String header) {
+        headers.add(header);
+        return this;
+    }
+
+    /**
+     * Adds a new header with the name and value. This may be used to add
+     * multiple headers with the same name.
+     */
+    public MockResponse addHeader(String name, Object value) {
+        return addHeader(name + ": " + String.valueOf(value));
+    }
+
+    /**
+     * Removes all headers named {@code name}, then adds a new header with the
+     * name and value.
+     */
+    public MockResponse setHeader(String name, Object value) {
+        removeHeader(name);
+        return addHeader(name, value);
+    }
+
+    /**
+     * Removes all headers named {@code name}.
+     */
+    public MockResponse removeHeader(String name) {
+        name += ":";
+        for (Iterator<String> i = headers.iterator(); i.hasNext(); ) {
+            String header = i.next();
+            if (name.regionMatches(true, 0, header, 0, name.length())) {
+                i.remove();
+            }
+        }
+        return this;
+    }
+
+    /**
+     * Returns the raw HTTP payload, or null if this response is streamed.
+     */
+    public byte[] getBody() {
+        return body;
+    }
+
+    /**
+     * Returns an input stream containing the raw HTTP payload.
+     */
+    InputStream getBodyStream() {
+        return bodyStream != null ? bodyStream : new ByteArrayInputStream(body);
+    }
+
+    public MockResponse setBody(byte[] body) {
+        setHeader("Content-Length", body.length);
+        this.body = body;
+        this.bodyStream = null;
+        return this;
+    }
+
+    public MockResponse setBody(InputStream bodyStream, long bodyLength) {
+        setHeader("Content-Length", bodyLength);
+        this.body = null;
+        this.bodyStream = bodyStream;
+        return this;
+    }
+
+    /**
+     * Sets the response body to the UTF-8 encoded bytes of {@code body}.
+     */
+    public MockResponse setBody(String body) {
+        try {
+            return setBody(body.getBytes("UTF-8"));
+        } catch (UnsupportedEncodingException e) {
+            throw new AssertionError();
+        }
+    }
+
+    /**
+     * Sets the response body to {@code body}, chunked every {@code
+     * maxChunkSize} bytes.
+     */
+    public MockResponse setChunkedBody(byte[] body, int maxChunkSize) {
+        removeHeader("Content-Length");
+        headers.add(CHUNKED_BODY_HEADER);
+
+        try {
+            ByteArrayOutputStream bytesOut = new ByteArrayOutputStream();
+            int pos = 0;
+            while (pos < body.length) {
+                int chunkSize = Math.min(body.length - pos, maxChunkSize);
+                bytesOut.write(Integer.toHexString(chunkSize).getBytes(ASCII));
+                bytesOut.write("\r\n".getBytes(ASCII));
+                bytesOut.write(body, pos, chunkSize);
+                bytesOut.write("\r\n".getBytes(ASCII));
+                pos += chunkSize;
+            }
+            bytesOut.write("0\r\n\r\n".getBytes(ASCII)); // last chunk + empty trailer + crlf
+
+            this.body = bytesOut.toByteArray();
+            return this;
+        } catch (IOException e) {
+            throw new AssertionError(); // In-memory I/O doesn't throw IOExceptions.
+        }
+    }
+
+    /**
+     * Sets the response body to the UTF-8 encoded bytes of {@code body},
+     * chunked every {@code maxChunkSize} bytes.
+     */
+    public MockResponse setChunkedBody(String body, int maxChunkSize) {
+        try {
+            return setChunkedBody(body.getBytes("UTF-8"), maxChunkSize);
+        } catch (UnsupportedEncodingException e) {
+            throw new AssertionError();
+        }
+    }
+
+    public SocketPolicy getSocketPolicy() {
+        return socketPolicy;
+    }
+
+    public MockResponse setSocketPolicy(SocketPolicy socketPolicy) {
+        this.socketPolicy = socketPolicy;
+        return this;
+    }
+
+    public int getBytesPerSecond() {
+        return bytesPerSecond;
+    }
+
+    /**
+     * Set simulated network speed, in bytes per second. This applies to the
+     * response body only; response headers are not throttled.
+     */
+    public MockResponse setBytesPerSecond(int bytesPerSecond) {
+        this.bytesPerSecond = bytesPerSecond;
+        return this;
+    }
+
+    @Override public String toString() {
+        return status;
+    }
+}
/Fim/
diff --git a/mockwebserver/src/main/java/com/google/mockwebserver/MockWebServer.java b/mockwebserver/src/main/java/com/google/mockwebserver/MockWebServer.java
new file mode 100644
index 0000000..6e80804
--- /dev/null
+++ b/mockwebserver/src/main/java/com/google/mockwebserver/MockWebServer.java
@@ -0,0 +1,585 @@
+/*
+ * Copyright (C) 2011 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.google.mockwebserver;
+
+import static com.google.mockwebserver.SocketPolicy.DISCONNECT_AT_START;
+import static com.google.mockwebserver.SocketPolicy.FAIL_HANDSHAKE;
+import java.io.BufferedInputStream;
+import java.io.BufferedOutputStream;
+import java.io.ByteArrayOutputStream;
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.OutputStream;
+import java.net.InetAddress;
+import java.net.InetSocketAddress;
+import java.net.MalformedURLException;
+import java.net.Proxy;
+import java.net.ServerSocket;
+import java.net.Socket;
+import java.net.SocketException;
+import java.net.URL;
+import java.net.UnknownHostException;
+import java.security.cert.CertificateException;
+import java.security.cert.X509Certificate;
+import java.util.ArrayList;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Map;
+import java.util.concurrent.BlockingQueue;
+import java.util.concurrent.ConcurrentHashMap;
+import java.util.concurrent.ExecutorService;
+import java.util.concurrent.Executors;
+import java.util.concurrent.LinkedBlockingQueue;
+import java.util.concurrent.atomic.AtomicInteger;
+import java.util.logging.Level;
+import java.util.logging.Logger;
+import javax.net.ssl.SSLContext;
+import javax.net.ssl.SSLSocket;
+import javax.net.ssl.SSLSocketFactory;
+import javax.net.ssl.TrustManager;
+import javax.net.ssl.X509TrustManager;
+
+/**
+ * A scriptable web server. Callers supply canned responses and the server
+ * replays them upon request in sequence.
+ */
+public final class MockWebServer {
+
+    static final String ASCII = "US-ASCII";
+
+    private static final Logger logger = Logger.getLogger(MockWebServer.class.getName());
+    private final BlockingQueue<RecordedRequest> requestQueue
+            = new LinkedBlockingQueue<RecordedRequest>();
+    /** All map values are Boolean.TRUE. (Collections.newSetFromMap isn't available in Froyo) */
+    private final Map<Socket, Boolean> openClientSockets = new ConcurrentHashMap<Socket, Boolean>();
+    private final AtomicInteger requestCount = new AtomicInteger();
+    private int bodyLimit = Integer.MAX_VALUE;
+    private ServerSocket serverSocket;
+    private SSLSocketFactory sslSocketFactory;
+    private ExecutorService executor;
+    private boolean tunnelProxy;
+    private Dispatcher dispatcher = new QueueDispatcher();
+
+    private int port = -1;
+
+    public int getPort() {
+        if (port == -1) {
+            throw new IllegalStateException("Cannot retrieve port before calling play()");
+        }
+        return port;
+    }
+
+    public String getHostName() {
+        try {
+            return InetAddress.getLocalHost().getHostName();
+        } catch (UnknownHostException e) {
+            throw new AssertionError(e);
+        }
+    }
+
+    public Proxy toProxyAddress() {
+        return new Proxy(Proxy.Type.HTTP, new InetSocketAddress(getHostName(), getPort()));
+    }
+
+    /**
+     * Returns a URL for connecting to this server.
+     *
+     * @param path the request path, such as "/".
+     */
+    public URL getUrl(String path) {
+        try {
+            return sslSocketFactory != null
+                    ? new URL("https://" + getHostName() + ":" + getPort() + path)
+                    : new URL("http://" + getHostName() + ":" + getPort() + path);
+        } catch (MalformedURLException e) {
+            throw new AssertionError(e);
+        }
+    }
+
+    /**
+     * Returns a cookie domain for this server. This returns the server's
+     * non-loopback host name if it is known. Otherwise this returns ".local"
+     * for this server's loopback name.
+     */
+    public String getCookieDomain() {
+        String hostName = getHostName();
+        return hostName.contains(".") ? hostName : ".local";
+    }
+
+    /**
+     * Sets the number of bytes of the POST body to keep in memory to the given
+     * limit.
+     */
+    public void setBodyLimit(int maxBodyLength) {
+        this.bodyLimit = maxBodyLength;
+    }
+
+    /**
+     * Serve requests with HTTPS rather than otherwise.
+     *
+     * @param tunnelProxy whether to expect the HTTP CONNECT method before
+     *     negotiating TLS.
+     */
+    public void useHttps(SSLSocketFactory sslSocketFactory, boolean tunnelProxy) {
+        this.sslSocketFactory = sslSocketFactory;
+        this.tunnelProxy = tunnelProxy;
+    }
+
+    /**
+     * Awaits the next HTTP request, removes it, and returns it. Callers should
+     * use this to verify the request sent was as intended.
+     */
+    public RecordedRequest takeRequest() throws InterruptedException {
+        return requestQueue.take();
+    }
+
+    /**
+     * Returns the number of HTTP requests received thus far by this server.
+     * This may exceed the number of HTTP connections when connection reuse is
+     * in practice.
+     */
+    public int getRequestCount() {
+        return requestCount.get();
+    }
+
+    /**
+     * Scripts {@code response} to be returned to a request made in sequence.
+     * The first request is served by the first enqueued response; the second
+     * request by the second enqueued response; and so on.
+     *
+     * @throws ClassCastException if the default dispatcher has been replaced
+     *     with {@link #setDispatcher(Dispatcher)}.
+     */
+    public void enqueue(MockResponse response) {
+        ((QueueDispatcher) dispatcher).enqueueResponse(response.clone());
+    }
+
+    /**
+     * Equivalent to {@code play(0)}.
+     */
+    public void play() throws IOException {
+        play(0);
+    }
+
+    /**
+     * Starts the server, serves all enqueued requests, and shuts the server
+     * down.
+     *
+     * @param port the port to listen to, or 0 for any available port.
+     *     Automated tests should always use port 0 to avoid flakiness when a
+     *     specific port is unavailable.
+     */
+    public void play(int port) throws IOException {
+        if (executor != null) {
+            throw new IllegalStateException("play() already called");
+        }
+        executor = Executors.newCachedThreadPool();
+        serverSocket = new ServerSocket(port);
+        serverSocket.setReuseAddress(true);
+
+        this.port = serverSocket.getLocalPort();
+        executor.execute(namedRunnable("MockWebServer-accept-" + port, new Runnable() {
+            public void run() {
+                try {
+                    acceptConnections();
+                } catch (Throwable e) {
+                    logger.log(Level.WARNING, "MockWebServer connection failed", e);
+                }
+
+                /*
+                 * This gnarly block of code will release all sockets and
+                 * all thread, even if any close fails.
+                 */
+                try {
+                    serverSocket.close();
+                } catch (Throwable e) {
+                    logger.log(Level.WARNING, "MockWebServer server socket close failed", e);
+                }
+                for (Iterator<Socket> s = openClientSockets.keySet().iterator(); s.hasNext(); ) {
+                    try {
+                        s.next().close();
+                        s.remove();
+                    } catch (Throwable e) {
+                        logger.log(Level.WARNING, "MockWebServer socket close failed", e);
+                    }
+                }
+                try {
+                    executor.shutdown();
+                } catch (Throwable e) {
+                    logger.log(Level.WARNING, "MockWebServer executor shutdown failed", e);
+                }
+            }
+
+            private void acceptConnections() throws Exception {
+                while (true) {
+                    Socket socket;
+                    try {
+                        socket = serverSocket.accept();
+                    } catch (SocketException e) {
+                        return;
+                    }
+                    final SocketPolicy socketPolicy = dispatcher.peekSocketPolicy();
+                    if (socketPolicy == DISCONNECT_AT_START) {
+                        dispatchBookkeepingRequest(0, socket);
+                        socket.close();
+                    } else {
+                        openClientSockets.put(socket, true);
+                        serveConnection(socket);
+                    }
+                }
+            }
+        }));
+    }
+
+    public void shutdown() throws IOException {
+        if (serverSocket != null) {
+            serverSocket.close(); // should cause acceptConnections() to break out
+        }
+    }
+
+    private void serveConnection(final Socket raw) {
+        String name = "MockWebServer-" + raw.getRemoteSocketAddress();
+        executor.execute(namedRunnable(name, new Runnable() {
+            int sequenceNumber = 0;
+
+            public void run() {
+                try {
+                    processConnection();
+                } catch (Exception e) {
+                    logger.log(Level.WARNING, "MockWebServer connection failed", e);
+                }
+            }
+
+            public void processConnection() throws Exception {
+                Socket socket;
+                if (sslSocketFactory != null) {
+                    if (tunnelProxy) {
+                        createTunnel();
+                    }
+                    final SocketPolicy socketPolicy = dispatcher.peekSocketPolicy();
+                    if (socketPolicy == FAIL_HANDSHAKE) {
+                        dispatchBookkeepingRequest(sequenceNumber, raw);
+                        processHandshakeFailure(raw, sequenceNumber++);
+                        return;
+                    }
+                    socket = sslSocketFactory.createSocket(
+                            raw, raw.getInetAddress().getHostAddress(), raw.getPort(), true);
+                    ((SSLSocket) socket).setUseClientMode(false);
+                    openClientSockets.put(socket, true);
+                    openClientSockets.remove(raw);
+                } else {
+                    socket = raw;
+                }
+
+                InputStream in = new BufferedInputStream(socket.getInputStream());
+                OutputStream out = new BufferedOutputStream(socket.getOutputStream());
+
+                while (processOneRequest(socket, in, out)) {
+                }
+
+                if (sequenceNumber == 0) {
+                    logger.warning("MockWebServer connection didn't make a request");
+                }
+
+                in.close();
+                out.close();
+                socket.close();
+                openClientSockets.remove(socket);
+            }
+
+            /**
+             * Respond to CONNECT requests until a SWITCH_TO_SSL_AT_END response
+             * is dispatched.
+             */
+            private void createTunnel() throws IOException, InterruptedException {
+                while (true) {
+                    final SocketPolicy socketPolicy = dispatcher.peekSocketPolicy();
+                    if (!processOneRequest(raw, raw.getInputStream(), raw.getOutputStream())) {
+                        throw new IllegalStateException("Tunnel without any CONNECT!");
+                    }
+                    if (socketPolicy == SocketPolicy.UPGRADE_TO_SSL_AT_END) {
+                        return;
+                    }
+                }
+            }
+
+            /**
+             * Reads a request and writes its response. Returns true if a request
+             * was processed.
+             */
+            private boolean processOneRequest(Socket socket, InputStream in, OutputStream out)
+                    throws IOException, InterruptedException {
+                RecordedRequest request = readRequest(socket, in, out, sequenceNumber);
+                if (request == null) {
+                    return false;
+                }
+                requestCount.incrementAndGet();
+                requestQueue.add(request);
+                MockResponse response = dispatcher.dispatch(request);
+                writeResponse(out, response);
+                if (response.getSocketPolicy() == SocketPolicy.DISCONNECT_AT_END) {
+                    in.close();
+                    out.close();
+                } else if (response.getSocketPolicy() == SocketPolicy.SHUTDOWN_INPUT_AT_END) {
+                    socket.shutdownInput();
+                } else if (response.getSocketPolicy() == SocketPolicy.SHUTDOWN_OUTPUT_AT_END) {
+                    socket.shutdownOutput();
+                }
+                logger.info("Received request: " + request + " and responded: " + response);
+                sequenceNumber++;
+                return true;
+            }
+        }));
+    }
+
+    private void processHandshakeFailure(Socket raw, int sequenceNumber) throws Exception {
+        X509TrustManager untrusted = new X509TrustManager() {
+            @Override public void checkClientTrusted(X509Certificate[] chain, String authType)
+                    throws CertificateException {
+                throw new CertificateException();
+            }
+            @Override public void checkServerTrusted(X509Certificate[] chain, String authType) {
+                throw new AssertionError();
+            }
+            @Override public X509Certificate[] getAcceptedIssuers() {
+                throw new AssertionError();
+            }
+        };
+        SSLContext context = SSLContext.getInstance("TLS");
+        context.init(null, new TrustManager[] { untrusted }, new java.security.SecureRandom());
+        SSLSocketFactory sslSocketFactory = context.getSocketFactory();
+        SSLSocket socket = (SSLSocket) sslSocketFactory.createSocket(
+                raw, raw.getInetAddress().getHostAddress(), raw.getPort(), true);
+        try {
+            socket.startHandshake(); // we're testing a handshake failure
+            throw new AssertionError();
+        } catch (IOException expected) {
+        }
+        socket.close();
+    }
+
+    private void dispatchBookkeepingRequest(int sequenceNumber, Socket socket) throws InterruptedException {
+        requestCount.incrementAndGet();
+        dispatcher.dispatch(new RecordedRequest(null, null, null, -1, null, sequenceNumber, socket));
+    }
+
+    /**
+     * @param sequenceNumber the index of this request on this connection.
+     */
+    private RecordedRequest readRequest(Socket socket, InputStream in, OutputStream out, int sequenceNumber)
+            throws IOException {
+        String request;
+        try {
+            request = readAsciiUntilCrlf(in);
+        } catch (IOException streamIsClosed) {
+            return null; // no request because we closed the stream
+        }
+        if (request.length() == 0) {
+            return null; // no request because the stream is exhausted
+        }
+
+        List<String> headers = new ArrayList<String>();
+        long contentLength = -1;
+        boolean chunked = false;
+        boolean expectContinue = false;
+        String header;
+        while ((header = readAsciiUntilCrlf(in)).length() != 0) {
+            headers.add(header);
+            String lowercaseHeader = header.toLowerCase();
+            if (contentLength == -1 && lowercaseHeader.startsWith("content-length:")) {
+                contentLength = Long.parseLong(header.substring(15).trim());
+            }
+            if (lowercaseHeader.startsWith("transfer-encoding:") &&
+                    lowercaseHeader.substring(18).trim().equals("chunked")) {
+                chunked = true;
+            }
+            if (lowercaseHeader.startsWith("expect:") &&
+                    lowercaseHeader.substring(7).trim().equals("100-continue")) {
+                expectContinue = true;
+            }
+        }
+
+        if (expectContinue) {
+            out.write(("HTTP/1.1 100 Continue\r\n").getBytes(ASCII));
+            out.write(("Content-Length: 0\r\n").getBytes(ASCII));
+            out.write(("\r\n").getBytes(ASCII));
+            out.flush();
+        }
+
+        boolean hasBody = false;
+        TruncatingOutputStream requestBody = new TruncatingOutputStream();
+        List<Integer> chunkSizes = new ArrayList<Integer>();
+        if (contentLength != -1) {
+            hasBody = true;
+            transfer(contentLength, in, requestBody);
+        } else if (chunked) {
+            hasBody = true;
+            while (true) {
+                int chunkSize = Integer.parseInt(readAsciiUntilCrlf(in).trim(), 16);
+                if (chunkSize == 0) {
+                    readEmptyLine(in);
+                    break;
+                }
+                chunkSizes.add(chunkSize);
+                transfer(chunkSize, in, requestBody);
+                readEmptyLine(in);
+            }
+        }
+
+        if (request.startsWith("OPTIONS ") || request.startsWith("GET ")
+                || request.startsWith("HEAD ") || request.startsWith("DELETE ")
+                || request.startsWith("TRACE ") || request.startsWith("CONNECT ")) {
+            if (hasBody) {
+                throw new IllegalArgumentException("Request must not have a body: " + request);
+            }
+        } else if (!request.startsWith("POST ") && !request.startsWith("PUT ")) {
+            throw new UnsupportedOperationException("Unexpected method: " + request);
+        }
+
+        return new RecordedRequest(request, headers, chunkSizes,
+                requestBody.numBytesReceived, requestBody.toByteArray(), sequenceNumber, socket);
+    }
+
+    private void writeResponse(OutputStream out, MockResponse response) throws IOException {
+        out.write((response.getStatus() + "\r\n").getBytes(ASCII));
+        for (String header : response.getHeaders()) {
+            out.write((header + "\r\n").getBytes(ASCII));
+        }
+        out.write(("\r\n").getBytes(ASCII));
+        out.flush();
+
+        final InputStream in = response.getBodyStream();
+        if (in == null) {
+            return;
+        }
+        final int bytesPerSecond = response.getBytesPerSecond();
+
+        // Stream data in MTU-sized increments, with a minimum of one packet per second.
+        final byte[] buffer = bytesPerSecond >= 1452
+                ? new byte[1452]
+                : new byte[bytesPerSecond];
+        final long delayMs;
+        if (bytesPerSecond == Integer.MAX_VALUE) {
+            delayMs = 0;
+        } else {
+            delayMs = (1000 * buffer.length) / bytesPerSecond;
+        }
+
+        int read;
+        long sinceDelay = 0;
+        while ((read = in.read(buffer)) != -1) {
+            out.write(buffer, 0, read);
+            out.flush();
+
+            sinceDelay += read;
+            if (sinceDelay >= buffer.length && delayMs > 0) {
+                sinceDelay %= buffer.length;
+                try {
+                    Thread.sleep(delayMs);
+                } catch (InterruptedException e) {
+                    throw new AssertionError();
+                }
+            }
+        }
+    }
+
+    /**
+     * Transfer bytes from {@code in} to {@code out} until either {@code length}
+     * bytes have been transferred or {@code in} is exhausted.
+     */
+    private void transfer(long length, InputStream in, OutputStream out) throws IOException {
+        byte[] buffer = new byte[1024];
+        while (length > 0) {
+            int count = in.read(buffer, 0, (int) Math.min(buffer.length, length));
+            if (count == -1) {
+                return;
+            }
+            out.write(buffer, 0, count);
+            length -= count;
+        }
+    }
+
+    /**
+     * Returns the text from {@code in} until the next "\r\n", or null if
+     * {@code in} is exhausted.
+     */
+    private String readAsciiUntilCrlf(InputStream in) throws IOException {
+        StringBuilder builder = new StringBuilder();
+        while (true) {
+            int c = in.read();
+            if (c == '\n' && builder.length() > 0 && builder.charAt(builder.length() - 1) == '\r') {
+                builder.deleteCharAt(builder.length() - 1);
+                return builder.toString();
+            } else if (c == -1) {
+                return builder.toString();
+            } else {
+                builder.append((char) c);
+            }
+        }
+    }
+
+    private void readEmptyLine(InputStream in) throws IOException {
+        String line = readAsciiUntilCrlf(in);
+        if (line.length() != 0) {
+            throw new IllegalStateException("Expected empty but was: " + line);
+        }
+    }
+
+    /**
+     * Sets the dispatcher used to match incoming requests to mock responses.
+     * The default dispatcher simply serves a fixed sequence of responses from
+     * a {@link #enqueue(MockResponse) queue}; custom dispatchers can vary the
+     * response based on timing or the content of the request.
+     */
+    public void setDispatcher(Dispatcher dispatcher) {
+        if (dispatcher == null) {
+            throw new NullPointerException();
+        }
+        this.dispatcher = dispatcher;
+    }
+
+    /**
+     * An output stream that drops data after bodyLimit bytes.
+     */
+    private class TruncatingOutputStream extends ByteArrayOutputStream {
+        private long numBytesReceived = 0;
+        @Override public void write(byte[] buffer, int offset, int len) {
+            numBytesReceived += len;
+            super.write(buffer, offset, Math.min(len, bodyLimit - count));
+        }
+        @Override public void write(int oneByte) {
+            numBytesReceived++;
+            if (count < bodyLimit) {
+                super.write(oneByte);
+            }
+        }
+    }
+
+    private static Runnable namedRunnable(final String name, final Runnable runnable) {
+        return new Runnable() {
+            public void run() {
+                String originalName = Thread.currentThread().getName();
+                Thread.currentThread().setName(name);
+                try {
+                    runnable.run();
+                } finally {
+                    Thread.currentThread().setName(originalName);
+                }
+            }
+        };
+    }
+}
/Fim/
diff --git a/mockwebserver/src/main/java/com/google/mockwebserver/QueueDispatcher.java b/mockwebserver/src/main/java/com/google/mockwebserver/QueueDispatcher.java
new file mode 100644
index 0000000..bc26694
--- /dev/null
+++ b/mockwebserver/src/main/java/com/google/mockwebserver/QueueDispatcher.java
@@ -0,0 +1,72 @@
+/*
+ * Copyright (C) 2012 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.google.mockwebserver;
+
+import java.net.HttpURLConnection;
+import java.util.concurrent.BlockingQueue;
+import java.util.concurrent.LinkedBlockingQueue;
+
+/**
+ * Default dispatcher that processes a script of responses.  Populate the script by calling
+ * {@link #enqueueResponse(MockResponse)}.
+ */
+public class QueueDispatcher extends Dispatcher {
+    protected final BlockingQueue<MockResponse> responseQueue
+            = new LinkedBlockingQueue<MockResponse>();
+    private MockResponse failFastResponse;
+
+    @Override public MockResponse dispatch(RecordedRequest request) throws InterruptedException {
+        // to permit interactive/browser testing, ignore requests for favicons
+        final String requestLine = request.getRequestLine();
+        if (requestLine != null && requestLine.equals("GET /favicon.ico HTTP/1.1")) {
+            System.out.println("served " + requestLine);
+            return new MockResponse()
+                    .setResponseCode(HttpURLConnection.HTTP_NOT_FOUND);
+        }
+
+        if (failFastResponse != null && responseQueue.peek() == null) {
+            // Fail fast if there's no response queued up.
+            return failFastResponse;
+        }
+
+        return responseQueue.take();
+    }
+
+    @Override public SocketPolicy peekSocketPolicy() {
+        MockResponse peek = responseQueue.peek();
+        if (peek == null) {
+            return failFastResponse != null
+                    ? failFastResponse.getSocketPolicy()
+                    : SocketPolicy.KEEP_OPEN;
+        }
+        return peek.getSocketPolicy();
+    }
+
+    public void enqueueResponse(MockResponse response) {
+        responseQueue.add(response);
+    }
+
+    public void setFailFast(boolean failFast) {
+        MockResponse failFastResponse = failFast
+                ? new MockResponse().setResponseCode(HttpURLConnection.HTTP_NOT_FOUND)
+                : null;
+        setFailFast(failFastResponse);
+    }
+
+    public void setFailFast(MockResponse failFastResponse) {
+        this.failFastResponse = failFastResponse;
+    }
+}
/Fim/
diff --git a/mockwebserver/src/main/java/com/google/mockwebserver/RecordedRequest.java b/mockwebserver/src/main/java/com/google/mockwebserver/RecordedRequest.java
new file mode 100644
index 0000000..ba83416
--- /dev/null
+++ b/mockwebserver/src/main/java/com/google/mockwebserver/RecordedRequest.java
@@ -0,0 +1,167 @@
+/*
+ * Copyright (C) 2011 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.google.mockwebserver;
+
+import java.io.UnsupportedEncodingException;
+import java.net.Socket;
+import java.util.ArrayList;
+import java.util.List;
+import javax.net.ssl.SSLSocket;
+
+/**
+ * An HTTP request that came into the mock web server.
+ */
+public final class RecordedRequest {
+    private final String requestLine;
+    private final String method;
+    private final String path;
+    private final List<String> headers;
+    private final List<Integer> chunkSizes;
+    private final long bodySize;
+    private final byte[] body;
+    private final int sequenceNumber;
+    private final String sslProtocol;
+
+    public RecordedRequest(String requestLine, List<String> headers, List<Integer> chunkSizes,
+            long bodySize, byte[] body, int sequenceNumber, Socket socket) {
+        this.requestLine = requestLine;
+        this.headers = headers;
+        this.chunkSizes = chunkSizes;
+        this.bodySize = bodySize;
+        this.body = body;
+        this.sequenceNumber = sequenceNumber;
+
+        if (socket instanceof SSLSocket) {
+            SSLSocket sslSocket = (SSLSocket) socket;
+            sslProtocol = sslSocket.getSession().getProtocol();
+        } else {
+            sslProtocol = null;
+        }
+
+        if (requestLine != null) {
+            int methodEnd = requestLine.indexOf(' ');
+            int pathEnd = requestLine.indexOf(' ', methodEnd + 1);
+            this.method = requestLine.substring(0, methodEnd);
+            this.path = requestLine.substring(methodEnd + 1, pathEnd);
+        } else {
+            this.method = null;
+            this.path = null;
+        }
+    }
+
+    public String getRequestLine() {
+        return requestLine;
+    }
+
+    public String getMethod() {
+        return method;
+    }
+
+    public String getPath() {
+        return path;
+    }
+
+    /**
+     * Returns all headers.
+     */
+    public List<String> getHeaders() {
+        return headers;
+    }
+
+    /**
+     * Returns the first header named {@code name}, or null if no such header
+     * exists.
+     */
+    public String getHeader(String name) {
+        name += ":";
+        for (String header : headers) {
+            if (name.regionMatches(true, 0, header, 0, name.length())) {
+                return header.substring(name.length()).trim();
+            }
+        }
+        return null;
+    }
+
+    /**
+     * Returns the headers named {@code name}.
+     */
+    public List<String> getHeaders(String name) {
+        List<String> result = new ArrayList<String>();
+        name += ":";
+        for (String header : headers) {
+            if (name.regionMatches(true, 0, header, 0, name.length())) {
+                result.add(header.substring(name.length()).trim());
+            }
+        }
+        return result;
+    }
+
+    /**
+     * Returns the sizes of the chunks of this request's body, or an empty list
+     * if the request's body was empty or unchunked.
+     */
+    public List<Integer> getChunkSizes() {
+        return chunkSizes;
+    }
+
+    /**
+     * Returns the total size of the body of this POST request (before
+     * truncation).
+     */
+    public long getBodySize() {
+        return bodySize;
+    }
+
+    /**
+     * Returns the body of this POST request. This may be truncated.
+     */
+    public byte[] getBody() {
+        return body;
+    }
+
+    /**
+     * Returns the body of this POST request decoded as a UTF-8 string.
+     */
+    public String getUtf8Body() {
+        try {
+            return new String(body, "UTF-8");
+        } catch (UnsupportedEncodingException e) {
+            throw new AssertionError();
+        }
+    }
+
+    /**
+     * Returns the index of this request on its HTTP connection. Since a single
+     * HTTP connection may serve multiple requests, each request is assigned its
+     * own sequence number.
+     */
+    public int getSequenceNumber() {
+        return sequenceNumber;
+    }
+
+    /**
+     * Returns the connection's SSL protocol like {@code TLSv1}, {@code SSLv3},
+     * {@code NONE} or null if the connection doesn't use SSL.
+     */
+    public String getSslProtocol() {
+        return sslProtocol;
+    }
+
+    @Override public String toString() {
+        return requestLine;
+    }
+}
\ No newline at end of file
/Fim/
diff --git a/mockwebserver/src/main/java/com/google/mockwebserver/SocketPolicy.java b/mockwebserver/src/main/java/com/google/mockwebserver/SocketPolicy.java
new file mode 100644
index 0000000..3a6797b
--- /dev/null
+++ b/mockwebserver/src/main/java/com/google/mockwebserver/SocketPolicy.java
@@ -0,0 +1,69 @@
+/*
+ * Copyright (C) 2011 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.google.mockwebserver;
+
+/**
+ * What should be done with the incoming socket.
+ */
+public enum SocketPolicy {
+
+    /**
+     * Keep the socket open after the response. This is the default HTTP/1.1
+     * behavior.
+     */
+    KEEP_OPEN,
+
+    /**
+     * Close the socket after the response. This is the default HTTP/1.0
+     * behavior.
+     */
+    DISCONNECT_AT_END,
+
+    /**
+     * Wrap the socket with SSL at the completion of this request/response
+     * pair. Used for CONNECT messages to tunnel SSL over an HTTP proxy.
+     */
+    UPGRADE_TO_SSL_AT_END,
+
+    /**
+     * Request immediate close of connection without even reading the
+     * request.
+     *
+     * <p>Use to simulate the real life case of losing connection
+     * because of bugger SSL server close connection when it seems
+     * something like a compression method or TLS extension it doesn't
+     * understand, instead of simply ignoring it like it should.
+     */
+    DISCONNECT_AT_START,
+
+    /**
+     * Don't trust the client during the SSL handshake.
+     */
+    FAIL_HANDSHAKE,
+
+    /**
+     * Shutdown the socket input after sending the response. For testing bad
+     * behavior.
+     */
+    SHUTDOWN_INPUT_AT_END,
+
+    /**
+     * Shutdown the socket output after sending the response. For testing bad
+     * behavior.
+     */
+    SHUTDOWN_OUTPUT_AT_END
+}
/Fim/
diff --git a/mockwebserver/src/test/java/com/google/mockwebserver/CustomDispatcherTest.java b/mockwebserver/src/test/java/com/google/mockwebserver/CustomDispatcherTest.java
new file mode 100644
index 0000000..e75b902
--- /dev/null
+++ b/mockwebserver/src/test/java/com/google/mockwebserver/CustomDispatcherTest.java
@@ -0,0 +1,100 @@
+/*
+ * Copyright (C) 2012 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.google.mockwebserver;
+
+import junit.framework.TestCase;
+
+import java.io.IOException;
+import java.net.HttpURLConnection;
+import java.net.URL;
+import java.util.ArrayList;
+import java.util.List;
+import java.util.concurrent.CountDownLatch;
+import java.util.concurrent.atomic.AtomicInteger;
+
+public class CustomDispatcherTest extends TestCase {
+
+    private MockWebServer mockWebServer = new MockWebServer();
+
+    @Override
+    public void tearDown() throws Exception {
+        mockWebServer.shutdown();
+    }
+
+    public void testSimpleDispatch() throws Exception {
+        mockWebServer.play();
+        final List<RecordedRequest> requestsMade = new ArrayList<RecordedRequest>();
+        final Dispatcher dispatcher = new Dispatcher() {
+            @Override
+            public MockResponse dispatch(RecordedRequest request) throws InterruptedException {
+                requestsMade.add(request);
+                return new MockResponse();
+            }
+        };
+        assertEquals(0, requestsMade.size());
+        mockWebServer.setDispatcher(dispatcher);
+        final URL url = mockWebServer.getUrl("/");
+        final HttpURLConnection conn = (HttpURLConnection) url.openConnection();
+        conn.getResponseCode(); // Force the connection to hit the "server".
+        // Make sure our dispatcher got the request.
+        assertEquals(1, requestsMade.size());
+    }
+
+    public void testOutOfOrderResponses() throws Exception {
+        AtomicInteger firstResponseCode = new AtomicInteger();
+        AtomicInteger secondResponseCode = new AtomicInteger();
+        mockWebServer.play();
+        final String secondRequest = "/bar";
+        final String firstRequest = "/foo";
+        final CountDownLatch latch = new CountDownLatch(1);
+        final Dispatcher dispatcher = new Dispatcher() {
+            @Override
+            public MockResponse dispatch(RecordedRequest request) throws InterruptedException {
+                if (request.getPath().equals(firstRequest)) {
+                    latch.await();
+                }
+                return new MockResponse();
+            }
+        };
+        mockWebServer.setDispatcher(dispatcher);
+        final Thread startsFirst = buildRequestThread(firstRequest, firstResponseCode);
+        startsFirst.start();
+        final Thread endsFirst = buildRequestThread(secondRequest, secondResponseCode);
+        endsFirst.start();
+        endsFirst.join();
+        assertEquals(0, firstResponseCode.get()); // First response is still waiting.
+        assertEquals(200, secondResponseCode.get()); // Second response is done.
+        latch.countDown();
+        startsFirst.join();
+        assertEquals(200, firstResponseCode.get()); // And now it's done!
+        assertEquals(200, secondResponseCode.get()); // (Still done).
+    }
+
+    private Thread buildRequestThread(final String path, final AtomicInteger responseCode) {
+        return new Thread(new Runnable() {
+            @Override public void run() {
+                final URL url = mockWebServer.getUrl(path);
+                final HttpURLConnection conn;
+                try {
+                    conn = (HttpURLConnection) url.openConnection();
+                    responseCode.set(conn.getResponseCode()); // Force the connection to hit the "server".
+                } catch (IOException e) {
+                }
+            }
+        });
+    }
+
+}
/Fim/
diff --git a/mockwebserver/src/test/java/com/google/mockwebserver/MockWebServerTest.java b/mockwebserver/src/test/java/com/google/mockwebserver/MockWebServerTest.java
new file mode 100644
index 0000000..5e62414
--- /dev/null
+++ b/mockwebserver/src/test/java/com/google/mockwebserver/MockWebServerTest.java
@@ -0,0 +1,289 @@
+/*
+ * Copyright (C) 2011 Google Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.google.mockwebserver;
+
+import java.io.BufferedReader;
+import java.io.ByteArrayInputStream;
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.InputStreamReader;
+import java.net.HttpURLConnection;
+import java.net.SocketTimeoutException;
+import java.net.URL;
+import java.net.URLConnection;
+import java.util.Arrays;
+import java.util.Collections;
+import java.util.List;
+import junit.framework.TestCase;
+
+public final class MockWebServerTest extends TestCase {
+
+    private MockWebServer server = new MockWebServer();
+
+    @Override protected void tearDown() throws Exception {
+        server.shutdown();
+        super.tearDown();
+    }
+
+    public void testRecordedRequestAccessors() {
+        List<String> headers = Arrays.asList(
+                "User-Agent: okhttp",
+                "Cookie: s=square",
+                "Cookie: a=android",
+                "X-Whitespace:  left",
+                "X-Whitespace:right  ",
+                "X-Whitespace:  both  "
+        );
+        List<Integer> chunkSizes = Collections.emptyList();
+        byte[] body = {'A', 'B', 'C'};
+        String requestLine = "GET / HTTP/1.1";
+        RecordedRequest request = new RecordedRequest(
+                requestLine, headers, chunkSizes, body.length, body, 0, null);
+        assertEquals("s=square", request.getHeader("cookie"));
+        assertEquals(Arrays.asList("s=square", "a=android"), request.getHeaders("cookie"));
+        assertEquals("left", request.getHeader("x-whitespace"));
+        assertEquals(Arrays.asList("left", "right", "both"), request.getHeaders("x-whitespace"));
+        assertEquals("ABC", request.getUtf8Body());
+    }
+
+    public void testDefaultMockResponse() {
+        MockResponse response = new MockResponse();
+        assertEquals(Arrays.asList("Content-Length: 0"), response.getHeaders());
+        assertEquals("HTTP/1.1 200 OK", response.getStatus());
+    }
+
+    public void testSetBodyAdjustsHeaders() throws IOException {
+        MockResponse response = new MockResponse().setBody("ABC");
+        assertEquals(Arrays.asList("Content-Length: 3"), response.getHeaders());
+        InputStream in = response.getBodyStream();
+        assertEquals('A', in.read());
+        assertEquals('B', in.read());
+        assertEquals('C', in.read());
+        assertEquals(-1, in.read());
+        assertEquals("HTTP/1.1 200 OK", response.getStatus());
+    }
+
+    public void testMockResponseAddHeader() {
+        MockResponse response = new MockResponse()
+                .clearHeaders()
+                .addHeader("Cookie: s=square")
+                .addHeader("Cookie", "a=android");
+        assertEquals(Arrays.asList("Cookie: s=square", "Cookie: a=android"),
+                response.getHeaders());
+    }
+
+    public void testMockResponseSetHeader() {
+        MockResponse response = new MockResponse()
+                .clearHeaders()
+                .addHeader("Cookie: s=square")
+                .addHeader("Cookie: a=android")
+                .addHeader("Cookies: delicious");
+        response.setHeader("cookie", "r=robot");
+        assertEquals(Arrays.asList("Cookies: delicious", "cookie: r=robot"),
+                response.getHeaders());
+    }
+
+    /**
+     * Clients who adhere to <a
+     * href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.2.3">100
+     * Status</a> expect the server to send an interim response with status code
+     * 100 before they send their payload.
+     * 
+     * <h4>Note</h4>
+     * 
+     * JRE 6 only passes this test if
+     * {@code -Dsun.net.http.allowRestrictedHeaders=true} is set.
+     */
+    public void testExpect100ContinueWithBody() throws Exception {
+        server.enqueue(new MockResponse());
+        server.play();
+
+        URL url = server.getUrl("/");
+        HttpURLConnection connection = (HttpURLConnection) url.openConnection();
+        connection.setRequestMethod("PUT");
+        connection.setAllowUserInteraction(false);
+        connection.setRequestProperty("Expect", "100-continue");
+        connection.setDoOutput(true);
+        connection.getOutputStream().write("hello".getBytes());
+        assertEquals(HttpURLConnection.HTTP_OK, connection.getResponseCode());
+
+        assertEquals(server.getRequestCount(), 1);
+        RecordedRequest request = server.takeRequest();
+        assertEquals(request.getRequestLine(), "PUT / HTTP/1.1");
+        assertEquals("5", request.getHeader("Content-Length"));
+        assertEquals(5, request.getBodySize());
+        assertEquals("hello", new String(request.getBody()));
+        // below fails on JRE 6 unless -Dsun.net.http.allowRestrictedHeaders=true is set
+        assertEquals("100-continue", request.getHeader("Expect"));
+    }
+
+    public void testExpect100ContinueWithNoBody() throws Exception {
+        server.enqueue(new MockResponse());
+        server.play();
+
+        URL url = server.getUrl("/");
+        HttpURLConnection connection = (HttpURLConnection) url.openConnection();
+        connection.setRequestMethod("PUT");
+        connection.setAllowUserInteraction(false);
+        connection.setRequestProperty("Expect", "100-continue");
+        connection.setRequestProperty("Content-Length", "0");
+        connection.setDoOutput(true);
+        connection.setFixedLengthStreamingMode(0);
+        assertEquals(HttpURLConnection.HTTP_OK, connection.getResponseCode());
+
+        assertEquals(server.getRequestCount(), 1);
+        RecordedRequest request = server.takeRequest();
+        assertEquals(request.getRequestLine(), "PUT / HTTP/1.1");
+        assertEquals("0", request.getHeader("Content-Length"));
+        assertEquals(0, request.getBodySize());
+        // below fails on JRE 6 unless -Dsun.net.http.allowRestrictedHeaders=true is set
+        assertEquals("100-continue", request.getHeader("Expect"));
+    }
+
+    public void testRegularResponse() throws Exception {
+        server.enqueue(new MockResponse().setBody("hello world"));
+        server.play();
+
+        URL url = server.getUrl("/");
+        HttpURLConnection connection = (HttpURLConnection) url.openConnection();
+        connection.setRequestProperty("Accept-Language", "en-US");
+        InputStream in = connection.getInputStream();
+        BufferedReader reader = new BufferedReader(new InputStreamReader(in));
+        assertEquals(HttpURLConnection.HTTP_OK, connection.getResponseCode());
+        assertEquals("hello world", reader.readLine());
+
+        RecordedRequest request = server.takeRequest();
+        assertEquals("GET / HTTP/1.1", request.getRequestLine());
+        assertTrue(request.getHeaders().contains("Accept-Language: en-US"));
+    }
+
+    public void testRedirect() throws Exception {
+        server.play();
+        server.enqueue(new MockResponse()
+                .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
+                .addHeader("Location: " + server.getUrl("/new-path"))
+                .setBody("This page has moved!"));
+        server.enqueue(new MockResponse().setBody("This is the new location!"));
+
+        URLConnection connection = server.getUrl("/").openConnection();
+        InputStream in = connection.getInputStream();
+        BufferedReader reader = new BufferedReader(new InputStreamReader(in));
+        assertEquals("This is the new location!", reader.readLine());
+
+        RecordedRequest first = server.takeRequest();
+        assertEquals("GET / HTTP/1.1", first.getRequestLine());
+        RecordedRequest redirect = server.takeRequest();
+        assertEquals("GET /new-path HTTP/1.1", redirect.getRequestLine());
+    }
+
+    /**
+     * Test that MockWebServer blocks for a call to enqueue() if a request
+     * is made before a mock response is ready.
+     */
+    public void testDispatchBlocksWaitingForEnqueue() throws Exception {
+        server.play();
+
+        new Thread() {
+            @Override public void run() {
+                try {
+                    Thread.sleep(1000);
+                } catch (InterruptedException ignored) {
+                }
+                server.enqueue(new MockResponse().setBody("enqueued in the background"));
+            }
+        }.start();
+
+        URLConnection connection = server.getUrl("/").openConnection();
+        InputStream in = connection.getInputStream();
+        BufferedReader reader = new BufferedReader(new InputStreamReader(in));
+        assertEquals("enqueued in the background", reader.readLine());
+    }
+
+    public void testNonHexadecimalChunkSize() throws Exception {
+        server.enqueue(new MockResponse()
+                .setBody("G\r\nxxxxxxxxxxxxxxxx\r\n0\r\n\r\n")
+                .clearHeaders()
+                .addHeader("Transfer-encoding: chunked"));
+        server.play();
+
+        URLConnection connection = server.getUrl("/").openConnection();
+        InputStream in = connection.getInputStream();
+        try {
+            in.read();
+            fail();
+        } catch (IOException expected) {
+        }
+    }
+
+    public void testResponseTimeout() throws Exception {
+        server.enqueue(new MockResponse()
+                .setBody("ABC")
+                .clearHeaders()
+                .addHeader("Content-Length: 4"));
+        server.enqueue(new MockResponse()
+                .setBody("DEF"));
+        server.play();
+
+        URLConnection urlConnection = server.getUrl("/").openConnection();
+        urlConnection.setReadTimeout(1000);
+        InputStream in = urlConnection.getInputStream();
+        assertEquals('A', in.read());
+        assertEquals('B', in.read());
+        assertEquals('C', in.read());
+        try {
+            in.read(); // if Content-Length was accurate, this would return -1 immediately
+            fail();
+        } catch (SocketTimeoutException expected) {
+        }
+
+        URLConnection urlConnection2 = server.getUrl("/").openConnection();
+        InputStream in2 = urlConnection2.getInputStream();
+        assertEquals('D', in2.read());
+        assertEquals('E', in2.read());
+        assertEquals('F', in2.read());
+        assertEquals(-1, in2.read());
+
+        assertEquals(0, server.takeRequest().getSequenceNumber());
+        assertEquals(0, server.takeRequest().getSequenceNumber());
+    }
+
+    public void testDisconnectAtStart() throws Exception {
+        server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.DISCONNECT_AT_START));
+        server.enqueue(new MockResponse()); // The jdk's HttpUrlConnection is a bastard.
+        server.enqueue(new MockResponse());
+        server.play();
+        try {
+            server.getUrl("/a").openConnection().getInputStream();
+        } catch (IOException e) {
+            // Expected.
+        }
+        server.getUrl("/b").openConnection().getInputStream(); // Should succeed.
+    }
+
+    public void testStreamingResponseBody() throws Exception {
+        InputStream responseBody = new ByteArrayInputStream("ABC".getBytes("UTF-8"));
+        server.enqueue(new MockResponse().setBody(responseBody, 3));
+        server.play();
+
+        InputStream in = server.getUrl("/").openConnection().getInputStream();
+        assertEquals('A', in.read());
+        assertEquals('B', in.read());
+        assertEquals('C', in.read());
+
+        assertEquals(-1, responseBody.read()); // The body is exhausted.
+    }
+}
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index abe3194..1d39c5c 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.2-SNAPSHOT</version>
+    <version>1.2</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 95540b4..83f3df4 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.2-SNAPSHOT</version>
+    <version>1.2</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-protocols/pom.xml b/okhttp-protocols/pom.xml
index 6821a8b..3838a5a 100644
--- a/okhttp-protocols/pom.xml
+++ b/okhttp-protocols/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.2-SNAPSHOT</version>
+    <version>1.2</version>
   </parent>
 
   <artifactId>okhttp-protocols</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 3007b1d..650b039 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.2-SNAPSHOT</version>
+    <version>1.2</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 42a1169..11dae37 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>1.1.2-SNAPSHOT</version>
+  <version>1.2</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -44,7 +44,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-1.2</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index e2a1394..d7daaeb 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.2-SNAPSHOT</version>
+    <version>1.2</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index ae149d9..f3b4423 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.1.2-SNAPSHOT</version>
+    <version>1.2</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index ed7f390..ae3f2a3 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.1.2-SNAPSHOT</version>
+    <version>1.2</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 1d39c5c..499511a 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.2</version>
+    <version>1.3-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 83f3df4..dbf268a 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.2</version>
+    <version>1.3-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-protocols/pom.xml b/okhttp-protocols/pom.xml
index 3838a5a..61305c5 100644
--- a/okhttp-protocols/pom.xml
+++ b/okhttp-protocols/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.2</version>
+    <version>1.3-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-protocols</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 650b039..c318fc2 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.2</version>
+    <version>1.3-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 11dae37..726de24 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>1.2</version>
+  <version>1.3-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -44,7 +44,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-1.2</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index d7daaeb..1277a78 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.2</version>
+    <version>1.3-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index f3b4423..0d8ec82 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>1.2</version>
+    <version>1.3-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index ae3f2a3..7b7caab 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>1.2</version>
+    <version>1.3-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/BufferedSink.java b/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/BufferedSink.java
index da1f070..cbd2716 100644
--- a/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/BufferedSink.java
+++ b/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/BufferedSink.java
@@ -73,7 +73,7 @@
     emitCompleteSegments(deadline);
   }
 
-  private void emitCompleteSegments(Deadline deadline) throws IOException {
+  void emitCompleteSegments(Deadline deadline) throws IOException {
     long byteCount = buffer.byteCount;
     if (byteCount == 0) return;
 
/Fim/
diff --git a/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/DeflaterSink.java b/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/DeflaterSink.java
new file mode 100644
index 0000000..707d8b3
--- /dev/null
+++ b/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/DeflaterSink.java
@@ -0,0 +1,99 @@
+/*
+ * Copyright (C) 2014 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.squareup.okhttp.internal.bytes;
+
+import java.io.IOException;
+import java.util.zip.Deflater;
+
+import static com.squareup.okhttp.internal.Util.checkOffsetAndCount;
+
+/**
+ * A sink that uses <a href="http://tools.ietf.org/html/rfc1951">DEFLATE</a> to
+ * compress data written to another source.
+ *
+ * <h3>Sync flush</h3>
+ * Aggressive flushing of this stream may result in reduced compression. Each
+ * call to {@link #flush} immediately compresses all currently-buffered data;
+ * this early compression may be less effective than compression performed
+ * without flushing.
+ *
+ * <p>This is equivalent to using {@link Deflater} with the sync flush option.
+ * This class does not offer any partial flush mechanism. For best performance,
+ * only call {@link #flush} when application behavior requires it.
+ */
+public final class DeflaterSink implements Sink {
+  private final BufferedSink sink;
+  private final Deflater deflater;
+
+  public DeflaterSink(Sink sink, Deflater deflater) {
+    this.sink = new BufferedSink(sink);
+    this.deflater = deflater;
+  }
+
+  @Override public void write(OkBuffer source, long byteCount, Deadline deadline)
+      throws IOException {
+    checkOffsetAndCount(source.byteCount, 0, byteCount);
+    while (byteCount > 0) {
+      // Share bytes from the head segment of 'source' with the deflater.
+      Segment head = source.head;
+      int toDeflate = (int) Math.min(byteCount, head.limit - head.pos);
+      deflater.setInput(head.data, head.pos, toDeflate);
+
+      // Deflate those bytes into sink.
+      deflate(deadline, false);
+
+      // Mark those bytes as read.
+      source.byteCount -= toDeflate;
+      head.pos += toDeflate;
+      if (head.pos == head.limit) {
+        source.head = head.pop();
+        SegmentPool.INSTANCE.recycle(head);
+      }
+
+      byteCount -= toDeflate;
+    }
+  }
+
+  private void deflate(Deadline deadline, boolean syncFlush) throws IOException {
+    while (true) {
+      Segment s = sink.buffer.writableSegment(1);
+
+      // The 4-parameter overload of deflate() doesn't exist in the RI until
+      // Java 1.7, and is public (although with @hide) on Android since 2.3.
+      // The @hide tag means that this code won't compile against the Android
+      // 2.3 SDK, but it will run fine there.
+      int deflated = syncFlush
+          ? deflater.deflate(s.data, s.limit, Segment.SIZE - s.limit, Deflater.SYNC_FLUSH)
+          : deflater.deflate(s.data, s.limit, Segment.SIZE - s.limit);
+
+      if (deflated == 0) return;
+      s.limit += deflated;
+      sink.buffer.byteCount += deflated;
+      sink.emitCompleteSegments(deadline);
+    }
+  }
+
+  @Override public void flush(Deadline deadline) throws IOException {
+    deflate(deadline, true);
+    sink.flush(deadline);
+  }
+
+  @Override public void close(Deadline deadline) throws IOException {
+    deflater.finish();
+    deflate(deadline, false);
+    sink.close(deadline);
+  }
+}
/Fim/
diff --git a/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/InflaterSource.java b/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/InflaterSource.java
index 6681487..790dcfd 100644
--- a/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/InflaterSource.java
+++ b/okhttp-protocols/src/main/java/com/squareup/okhttp/internal/bytes/InflaterSource.java
@@ -20,7 +20,10 @@
 import java.util.zip.DataFormatException;
 import java.util.zip.Inflater;
 
-/** A source that inflates another source. */
+/**
+ * A source that uses <a href="http://tools.ietf.org/html/rfc1951">DEFLATE</a>
+ * to decompress data read from another source.
+ */
 public final class InflaterSource implements Source {
   private final BufferedSource source;
   private final Inflater inflater;
/Fim/
diff --git a/okhttp-protocols/src/test/java/com/squareup/okhttp/internal/bytes/DeflaterSinkTest.java b/okhttp-protocols/src/test/java/com/squareup/okhttp/internal/bytes/DeflaterSinkTest.java
new file mode 100644
index 0000000..e1d22b9
--- /dev/null
+++ b/okhttp-protocols/src/test/java/com/squareup/okhttp/internal/bytes/DeflaterSinkTest.java
@@ -0,0 +1,107 @@
+/*
+ * Copyright (C) 2014 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.squareup.okhttp.internal.bytes;
+
+import java.io.IOException;
+import java.io.InputStream;
+import java.util.Arrays;
+import java.util.Random;
+import java.util.zip.Deflater;
+import java.util.zip.Inflater;
+import java.util.zip.InflaterInputStream;
+import org.junit.Test;
+
+import static org.junit.Assert.assertEquals;
+
+public final class DeflaterSinkTest {
+  @Test public void deflateWithClose() throws Exception {
+    OkBuffer data = new OkBuffer();
+    String original = "They're moving in herds. They do move in herds.";
+    data.writeUtf8(original);
+    OkBuffer sink = new OkBuffer();
+    DeflaterSink deflaterSink = new DeflaterSink(sink, new Deflater());
+    deflaterSink.write(data, data.byteCount(), Deadline.NONE);
+    deflaterSink.close(Deadline.NONE);
+    OkBuffer inflated = inflate(sink);
+    assertEquals(original, inflated.readUtf8((int) inflated.byteCount()));
+  }
+
+  @Test public void deflateWithSyncFlush() throws Exception {
+    String original = "Yes, yes, yes. That's why we're taking extreme precautions.";
+    OkBuffer data = new OkBuffer();
+    data.writeUtf8(original);
+    OkBuffer sink = new OkBuffer();
+    DeflaterSink deflaterSink = new DeflaterSink(sink, new Deflater());
+    deflaterSink.write(data, data.byteCount(), Deadline.NONE);
+    deflaterSink.flush(Deadline.NONE);
+    OkBuffer inflated = inflate(sink);
+    assertEquals(original, inflated.readUtf8((int) inflated.byteCount()));
+  }
+
+  @Test public void deflateWellCompressed() throws IOException {
+    String original = repeat('a', 1024 * 1024);
+    OkBuffer data = new OkBuffer();
+    data.writeUtf8(original);
+    OkBuffer sink = new OkBuffer();
+    DeflaterSink deflaterSink = new DeflaterSink(sink, new Deflater());
+    deflaterSink.write(data, data.byteCount(), Deadline.NONE);
+    deflaterSink.close(Deadline.NONE);
+    OkBuffer inflated = inflate(sink);
+    assertEquals(original, inflated.readUtf8((int) inflated.byteCount()));
+  }
+
+  @Test public void deflatePoorlyCompressed() throws IOException {
+    ByteString original = randomBytes(1024 * 1024);
+    OkBuffer data = new OkBuffer();
+    data.write(original);
+    OkBuffer sink = new OkBuffer();
+    DeflaterSink deflaterSink = new DeflaterSink(sink, new Deflater());
+    deflaterSink.write(data, data.byteCount(), Deadline.NONE);
+    deflaterSink.close(Deadline.NONE);
+    OkBuffer inflated = inflate(sink);
+    assertEquals(original, inflated.readByteString((int) inflated.byteCount()));
+  }
+
+  /**
+   * Uses streaming decompression to inflate {@code deflated}. The input must
+   * either be finished or have a trailing sync flush.
+   */
+  private OkBuffer inflate(OkBuffer deflated) throws IOException {
+    InputStream deflatedIn = new BufferedSource(deflated).inputStream();
+    Inflater inflater = new Inflater();
+    InputStream inflatedIn = new InflaterInputStream(deflatedIn, inflater);
+    OkBuffer result = new OkBuffer();
+    byte[] buffer = new byte[8192];
+    while (!inflater.needsInput() || deflated.byteCount() > 0 || deflatedIn.available() > 0) {
+      int count = inflatedIn.read(buffer, 0, buffer.length);
+      result.write(buffer, 0, count);
+    }
+    return result;
+  }
+
+  private ByteString randomBytes(int length) {
+    Random random = new Random(0);
+    byte[] randomBytes = new byte[length];
+    random.nextBytes(randomBytes);
+    return ByteString.of(randomBytes);
+  }
+
+  private String repeat(char c, int count) {
+    char[] array = new char[count];
+    Arrays.fill(array, c);
+    return new String(array);
+  }
+}
/Fim/
diff --git a/okhttp-protocols/src/test/java/com/squareup/okhttp/internal/bytes/InflaterSourceTest.java b/okhttp-protocols/src/test/java/com/squareup/okhttp/internal/bytes/InflaterSourceTest.java
index a272e37..481f024 100644
--- a/okhttp-protocols/src/test/java/com/squareup/okhttp/internal/bytes/InflaterSourceTest.java
+++ b/okhttp-protocols/src/test/java/com/squareup/okhttp/internal/bytes/InflaterSourceTest.java
@@ -26,7 +26,7 @@
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.fail;
 
-public class InflaterSourceTest {
+public final class InflaterSourceTest {
   @Test public void inflate() throws Exception {
     OkBuffer deflated = decodeBase64("eJxzz09RyEjNKVAoLdZRKE9VL0pVyMxTKMlIVchIzEspVshPU0jNS8/MS00tK"
         + "tYDAF6CD5s=");
/Fim/
diff --git a/mockwebserver/README.md b/mockwebserver/README.md
new file mode 100644
index 0000000..fe854b4
--- /dev/null
+++ b/mockwebserver/README.md
@@ -0,0 +1,177 @@
+MockWebServer
+=============
+
+A scriptable web server for testing HTTP clients
+
+
+Motivation
+----------
+
+This library makes it easy to test that your app Does The Right Thing when it
+makes HTTP and HTTPS calls. It lets you specify which responses to return and
+then verify that requests were made as expected.
+
+Because it exercises your full HTTP stack, you can be confident that you're
+testing everything. You can even copy & paste HTTP responses from your real web
+server to create representative test cases. Or test that your code survives in
+awkward-to-reproduce situations like 500 errors or slow-loading responses.
+
+
+Hello World
+-----------
+
+```
+  public static void main(String[] args) throws Exception {
+    MockWebServer server = new MockWebServer();
+    server.enqueue(new MockResponse().setBody("hello, world!"));
+    server.play();
+
+    URL url = server.getUrl("/hello.json");
+    URLConnection connection = url.openConnection();
+    connection.setRequestProperty("Accept", "text/plain; charset=utf-8");
+    InputStream in = connection.getInputStream();
+    BufferedReader reader = new BufferedReader(new InputStreamReader(in));
+    assertEquals("hello, world!", reader.readLine());
+
+    RecordedRequest request = server.takeRequest();
+    assertEquals("GET /hello.json HTTP/1.1", request.getRequestLine());
+    assertTrue(request.getHeaders().contains("Accept: text/plain; charset=utf-8"));
+
+    server.shutdown();
+  }
+```
+
+
+Walking through a MockWebServer test
+------------------------------------
+
+Use MockWebServer the same way that you use mocking frameworks like
+[Mockito](https://code.google.com/p/mockito/):
+
+1. Script the mocks.
+2. Run application code.
+3. Verify that the expected requests were made.
+
+Here's a complete example:
+
+```
+  public void test() throws Exception {
+    // Create a MockWebServer. These are lean enough that you can create a new
+    // instance for every unit test.
+    MockWebServer server = new MockWebServer();
+
+    // Schedule some responses.
+    server.enqueue(new MockResponse().setBody("hello, world!"));
+    server.enqueue(new MockResponse().setBody("sup, bra?"));
+    server.enqueue(new MockResponse().setBody("yo dog"));
+
+    // Start the server.
+    server.play();
+
+    // Ask the server for its URL. You'll need this to make HTTP requests.
+    URL baseUrl = server.getUrl("/v1/chat/");
+
+    // Exercise your application code, which should make those HTTP requests.
+    // Responses are returned in the same order that they are enqueued.
+    Chat chat = new Chat(baseUrl);
+
+    chat.loadMore();
+    assertEquals("hello, world!", chat.messages());
+
+    chat.loadMore();
+    chat.loadMore();
+    assertEquals(""
+        + "hello, world!\n"
+        + "sup, bra?\n"
+        + "yo dog", chat.messages());
+
+    // Optional: confirm that your app made the HTTP requests you were expecting.
+    RecordedRequest request1 = server.takeRequest();
+    assertEquals("/v1/chat/messages/", request1.getPath());
+    assertNotNull(request1.getHeader("Authorization"));
+
+    RecordedRequest request2 = server.takeRequest();
+    assertEquals("/v1/chat/messages/2", request2.getPath());
+
+    RecordedRequest request3 = server.takeRequest();
+    assertEquals("/v1/chat/messages/3", request3.getPath());
+
+    // Shut down the server. Instances cannot be reused.
+    server.shutdown();
+  }
+```
+
+Your unit tests might move the `server` into a field so you can shut it down
+from your test's `tearDown()`.
+
+
+MockResponse
+------------
+
+Mock responses default to an empty response body and a `200` status code.
+You can set a custom body with a string, input stream or byte array. Also
+add headers with a fluent builder API.
+
+```
+    MockResponse response = new MockResponse()
+        .setBody("{}")
+        .addHeader("Cache-Control", "no-cache")
+        .addHeader("Content-Type", "application/json; charset=utf-8");
+```
+
+MockResponse can be used to simulate a slow network. This is useful for
+testing timeouts and interactive testing.
+
+```
+    response.throttleBody(1024, 1, TimeUnit.SECONDS);
+```
+
+
+RecordedRequest
+---------------
+
+Verify requests by their method, path, HTTP version, body, and headers.
+
+```
+    RecordedRequest request = server.takeRequest();
+    assertEquals("POST /v1/chat/send HTTP/1.1", request.getRequestLine());
+    assertEquals("{}", request.getUtf8Body());
+    assertEquals("application/json; charset=utf-8", request.getHeader("Content-Type"));
+```
+
+Dispatcher
+----------
+
+By default MockWebServer uses a queue to specify a series of responses. Use a
+Dispatcher to handle requests using another policy. One natural policy is to
+dispatch on the request path.
+
+
+Download
+--------
+
+The best way to get MockWebServer is via Maven:
+
+```
+<dependency>
+  <groupId>com.squareup.okhttp</groupId>
+  <artifactId>mockwebserver</artifactId>
+  <version>(insert latest version)</version>
+  <scope>test</scope>
+</dependency>
+```
+
+License
+-------
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
/Fim/
diff --git a/mockwebserver/README.md b/mockwebserver/README.md
index fe854b4..39257be 100644
--- a/mockwebserver/README.md
+++ b/mockwebserver/README.md
@@ -4,8 +4,7 @@
 A scriptable web server for testing HTTP clients
 
 
-Motivation
-----------
+### Motivation
 
 This library makes it easy to test that your app Does The Right Thing when it
 makes HTTP and HTTPS calls. It lets you specify which responses to return and
@@ -17,33 +16,7 @@
 awkward-to-reproduce situations like 500 errors or slow-loading responses.
 
 
-Hello World
------------
-
-```
-  public static void main(String[] args) throws Exception {
-    MockWebServer server = new MockWebServer();
-    server.enqueue(new MockResponse().setBody("hello, world!"));
-    server.play();
-
-    URL url = server.getUrl("/hello.json");
-    URLConnection connection = url.openConnection();
-    connection.setRequestProperty("Accept", "text/plain; charset=utf-8");
-    InputStream in = connection.getInputStream();
-    BufferedReader reader = new BufferedReader(new InputStreamReader(in));
-    assertEquals("hello, world!", reader.readLine());
-
-    RecordedRequest request = server.takeRequest();
-    assertEquals("GET /hello.json HTTP/1.1", request.getRequestLine());
-    assertTrue(request.getHeaders().contains("Accept: text/plain; charset=utf-8"));
-
-    server.shutdown();
-  }
-```
-
-
-Walking through a MockWebServer test
-------------------------------------
+### Example
 
 Use MockWebServer the same way that you use mocking frameworks like
 [Mockito](https://code.google.com/p/mockito/):
@@ -104,9 +77,9 @@
 Your unit tests might move the `server` into a field so you can shut it down
 from your test's `tearDown()`.
 
+### API
 
-MockResponse
-------------
+#### MockResponse
 
 Mock responses default to an empty response body and a `200` status code.
 You can set a custom body with a string, input stream or byte array. Also
@@ -114,9 +87,9 @@
 
 ```
     MockResponse response = new MockResponse()
-        .setBody("{}")
+        .addHeader("Content-Type", "application/json; charset=utf-8")
         .addHeader("Cache-Control", "no-cache")
-        .addHeader("Content-Type", "application/json; charset=utf-8");
+        .setBody("{}");
 ```
 
 MockResponse can be used to simulate a slow network. This is useful for
@@ -127,28 +100,25 @@
 ```
 
 
-RecordedRequest
----------------
+#### RecordedRequest
 
 Verify requests by their method, path, HTTP version, body, and headers.
 
 ```
     RecordedRequest request = server.takeRequest();
     assertEquals("POST /v1/chat/send HTTP/1.1", request.getRequestLine());
-    assertEquals("{}", request.getUtf8Body());
     assertEquals("application/json; charset=utf-8", request.getHeader("Content-Type"));
+    assertEquals("{}", request.getUtf8Body());
 ```
 
-Dispatcher
-----------
+#### Dispatcher
 
 By default MockWebServer uses a queue to specify a series of responses. Use a
 Dispatcher to handle requests using another policy. One natural policy is to
 dispatch on the request path.
 
 
-Download
---------
+### Download
 
 The best way to get MockWebServer is via Maven:
 
@@ -161,8 +131,7 @@
 </dependency>
 ```
 
-License
--------
+### License
 
     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index f52d93a..a34e2d2 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,8 +1,51 @@
 Change Log
 ==========
 
-Version 1.3.0 *(2014-01-11)*
-----------------------------
+## Version 1.5.0
+
+_2014-03-05_
+
+
+##### OkHttp no longer uses the default SSL context.
+
+Applications that want to use the global SSL context with OkHttp should configure their
+OkHttpClient instances with the following:
+
+```
+    okHttpClient.setSslSocketFactory(HttpsURLConnection.getDefaultSSLSocketFactory());
+```
+
+A simpler solution is to avoid the shared default SSL socket factory. Instead, if you
+need to customize SSL, do so for your specific OkHttpClient instance only.
+
+##### Synthetic headers have changed
+
+Previously OkHttp added a synthetic response header, `OkHttp-Selected-Transport`. It
+has been replaced with a new synthetic header, `OkHttp-Selected-Protocol`.
+
+##### Changes
+
+ * New: Support for `HTTP-draft-09/2.0`.
+ * New: Support for `spdy/3.1`. Dropped support for `spdy/3`.
+ * New: Use ALPN on Android platforms that support it (4.4+)
+ * New: CacheControl model and parser.
+ * New: Protocol selection in MockWebServer.
+ * Fix: Route selection shouldn't use TLS modes that we know will fail.
+ * Fix: Cache SPDY responses even if the response body is closed prematurely.
+ * Fix: Use strict timeouts when aborting a download.
+ * Fix: Support Shoutcast HTTP responses like `ICY 200 OK`.
+ * Fix: Don't unzip if there isn't a response body.
+ * Fix: Don't leak gzip streams on redirects.
+ * Fix: Don't do DNS lookups on invalid hosts.
+ * Fix: Exhaust the underlying stream when reading gzip streams.
+ * Fix: Support the `PATCH` method.
+ * Fix: Drop the `okhttp-protocols` module.
+ * Internal: Replaced internal byte array buffers with pooled buffers ("OkBuffer").
+
+
+## Version 1.3.0
+
+_2014-01-11_
 
  * New: Support for "PATCH" HTTP method in client and MockWebServer.
  * Fix: Drop `Content-Length` header when redirected from POST to GET.
@@ -20,15 +63,17 @@
  * Fix: Honor read timeout when parsing SPDY headers.
 
 
-Version 1.2.1 *(2013-08-23)*
-----------------------------
+## Version 1.2.1
+
+_2013-08-23_
 
  * Resolve issue with 'jar-with-dependencies' artifact creation.
  * Fix: Support empty SPDY header values.
 
 
-Version 1.2.0 *(2013-08-11)*
-----------------------------
+## Version 1.2.0
+
+_2013-08-11_
 
  *  New APIs on OkHttpClient to set default timeouts for connect and read.
  *  Fix bug when caching SPDY responses.
@@ -53,15 +98,17 @@
  *  Bring MockWebServer into OkHttp and teach it SPDY.
 
 
-Version 1.1.1 *(2013-06-23)*
-----------------------------
+## Version 1.1.1
+
+_2013-06-23_
 
  * Fix: ClassCastException when caching responses that were redirected from
    HTTP to HTTPS.
 
 
-Version 1.1.0 *(2013-06-15)*
-----------------------------
+## Version 1.1.0
+
+_2013-06-15_
 
  * Fix: Connection reuse was broken for most HTTPS connections due to a bug in
    the way the hostname verifier was selected.
@@ -73,22 +120,26 @@
    Use `X-Android-Transports` to write the preferred transports and
    `X-Android-Selected-Transport` to read the negotiated transport.
 
-Version 1.0.2 *(2013-05-11)*
-----------------------------
+
+## Version 1.0.2
+
+_2013-05-11_
 
  * Fix: Remove use of Java 6-only APIs.
  * Fix: Properly handle exceptions from `NetworkInterface` when querying MTU.
  * Fix: Ensure MTU has a reasonable default and upper-bound.
 
 
-Version 1.0.1 *(2013-05-06)*
-----------------------------
+## Version 1.0.1
+
+_2013-05-06_
 
  * Correct casing of SSL in method names (`getSslSocketFactory`/`setSslSocketFactory`).
 
 
-Version 1.0.0 *(2013-05-06)*
-----------------------------
+## Version 1.0.0
+
+_2013-05-06_
 
 Initial release.
 
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 404aaa6..1fc6899 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -11,6 +11,8 @@
  * Fix problems where spdy/3.1 headers may not have been compressed properly.
  * Fix problems with spdy/3.1 and http/2 where the wrong window size was being
    used.
+ * Fix 1.5.0 regression where conditional cache responses could corrupt the
+   connection pool.
 
 
 ## Version 1.5.0
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 1fc6899..860b62b 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,15 @@
 Change Log
 ==========
 
+## Version 1.5.2
+
+_2014-03-17_
+
+ * Fix bug where deleting a file that was absent from the `HttpResponseCache`
+   caused an IOException.
+ * Fix bug in HTTP/2 where our HPACK decoder wasn't emitting entries in
+   certain eviction scenarios, leading to dropped response headers.
+
 ## Version 1.5.1
 
 _2014-03-11_
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 860b62b..6140fb7 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,16 @@
 Change Log
 ==========
 
+## Version 1.5.3
+
+_2014-03-29_
+
+ * Fix bug where the Content-Length header was not always dropped when
+   following a redirect from a POST to a GET.
+ * Implement basic support for `Thread.interrupt()`. OkHttp now checks
+   for an interruption before doing a blocking call. If it is interrupted,
+   it throws an `InterruptedIOException`.
+
 ## Version 1.5.2
 
 _2014-03-17_
/Fim/
diff --git a/website/index.html b/website/index.html
index 095102d..ee1e55c 100644
--- a/website/index.html
+++ b/website/index.html
@@ -57,8 +57,9 @@
             <p>OkHttp perseveres when the network is troublesome: it will silently recover from
                 common connection problems. If your service has multiple IP addresses OkHttp will
                 attempt alternate addresses if the first connect fails. This is necessary for IPv4+IPv6
-                and for services hosted in redundant data centers. OkHttp also recovers from problematic
-                proxy servers and failed SSL handshakes.</p>
+                and for services hosted in redundant data centers. OkHttp initiates new connections
+                with modern TLS features (SNI, NPN), and falls back to SSLv3 if the handshake
+                fails.</p>
 
             <p>You can try OkHttp without rewriting your network code. The core module implements
                 the familiar <code>java.net.HttpURLConnection</code> API. And the optional
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 6140fb7..360a36a 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,15 @@
 Change Log
 ==========
 
+## Version 1.5.4
+
+_2014-04-14_
+
+ * Drop ALPN support in Android. There's a concurrency bug in all
+   currently-shipping versions.
+ * Support asynchronous disconnects by breaking the socket only. This should
+   prevent flakiness from multiple threads concurrently accessing a stream.
+
 ## Version 1.5.3
 
 _2014-03-29_
/Fim/
diff --git a/README.md b/README.md
index 67eecc9..8a8eb4c 100644
--- a/README.md
+++ b/README.md
@@ -5,7 +5,80 @@
 
 For more information please see [the website][1].
 
+Making Connections
+------------------
 
+Although you provide only the URL, OkHttp plans its connection to your webserver
+using three types: URL, Address, and Route.
+
+#### [URLs](http://developer.android.com/reference/java/net/URL.html)
+
+URLs (like `https://github.com/square/okhttp`) are fundamental to HTTP and the
+Internet. In addition to being a universal, decentralized naming scheme for
+everything on the web, they also specify how to access web resources.
+
+URLs are abstract:
+
+ * They specify that the call may be plaintext (`http`) or encrypted (`https`),
+   but not which cryptographic algorithms should be used. Nor do they specify
+   how to verify the peer's certificates (the [HostnameVerifier](http://developer.android.com/reference/javax/net/ssl/HostnameVerifier.html))
+   or which certificates can be trusted (the [SSLSocketFactory](http://developer.android.com/reference/org/apache/http/conn/ssl/SSLSocketFactory.html)).
+ * They don't specify whether a specific proxy server should be used or how to
+   authenticate with that proxy server.
+
+They're also concrete: each URL identifies a specific path (like `/square/okhttp`)
+and query (like `?q=sharks&lang=en`). Each webserver hosts many URLs.
+
+#### [Addresses](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Address.html)
+
+Addresses specify a webserver (like `github.com`) and all of the **static**
+configuration necessary to connect to that server: the port number, HTTPS
+settings, and preferred network protocols (like HTTP/2 or SPDY).
+
+URLs that share the same address may also share the same underlying TCP socket
+connection. Sharing a connection has substantial performance benefits: lower
+latency, higher throughput (due to [TCP slow start](http://www.igvita.com/2011/10/20/faster-web-vs-tcp-slow-start/))
+and conserved battery. OkHttp uses a [ConnectionPool](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/ConnectionPool.html)
+that automatically reuses HTTP/1.x connections and multiplexes HTTP/2 and SPDY
+connections.
+
+In OkHttp some fields of the address come from the URL (scheme, hostname, port)
+and the rest come from the [OkHttpClient](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/OkHttpClient.html).
+
+#### [Routes](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Route.html)
+
+Routes supply the **dynamic** information necessary to actually connect to a webserver.
+This is the specific IP address to attempt (as discovered by a DNS query), the
+exact proxy server to use (if a [ProxySelector](http://developer.android.com/reference/java/net/ProxySelector.html)
+is in use), and which version of TLS to negotiate (for HTTPS connections).
+
+There may be many routes for a single address. For example, a webserver that
+is hosted in multiple datacenters may yield multiple IP addresses in its DNS
+response.
+
+#### [Connections](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Connection.html)
+
+When you request a URL with OkHttp, here's what it does:
+
+ 1. Use the URL and configured OkHttpClient to create an **address**. This address
+    specifies how we'll connect to the webserver.
+ 2. Attempt to retrieve a connection with that address in the **connection pool**.
+ 3. If it didn't find a connection in the pool, select a **route** to attempt.
+    This usually means making a DNS request to get the server's IP addresses.
+    Select a TLS version and proxy server if necessary.
+ 4. If it's a new route, connect. Build either a direct socket connection, a TLS
+    tunnel (for HTTPS over an HTTP proxy), or a direct TLS connection. Do TLS
+    handshakes as necessary.
+ 5. Send the HTTP request and read its HTTP response.
+
+If there's a problem with the connection, OkHttp will select another route and
+try again. This can be used to automatically fail over on webservers that offer
+multiple IP addresses. It's also useful when a pooled connection is stale or if
+the attempted TLS version is unsupported.
+
+Once the response has been received, the connection will be returned to the pool
+so it can be reused for a future request. Connections are evicted from the pool
+after a period of inactivity.
 
 Download
 --------
/Fim/
diff --git a/README.md b/README.md
index 8a8eb4c..86558bf 100644
--- a/README.md
+++ b/README.md
@@ -5,81 +5,6 @@
 
 For more information please see [the website][1].
 
-Making Connections
-------------------
-
-Although you provide only the URL, OkHttp plans its connection to your webserver
-using three types: URL, Address, and Route.
-
-#### [URLs](http://developer.android.com/reference/java/net/URL.html)
-
-URLs (like `https://github.com/square/okhttp`) are fundamental to HTTP and the
-Internet. In addition to being a universal, decentralized naming scheme for
-everything on the web, they also specify how to access web resources.
-
-URLs are abstract:
-
- * They specify that the call may be plaintext (`http`) or encrypted (`https`),
-   but not which cryptographic algorithms should be used. Nor do they specify
-   how to verify the peer's certificates (the [HostnameVerifier](http://developer.android.com/reference/javax/net/ssl/HostnameVerifier.html))
-   or which certificates can be trusted (the [SSLSocketFactory](http://developer.android.com/reference/org/apache/http/conn/ssl/SSLSocketFactory.html)).
- * They don't specify whether a specific proxy server should be used or how to
-   authenticate with that proxy server.
-
-They're also concrete: each URL identifies a specific path (like `/square/okhttp`)
-and query (like `?q=sharks&lang=en`). Each webserver hosts many URLs.
-
-#### [Addresses](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Address.html)
-
-Addresses specify a webserver (like `github.com`) and all of the **static**
-configuration necessary to connect to that server: the port number, HTTPS
-settings, and preferred network protocols (like HTTP/2 or SPDY).
-
-URLs that share the same address may also share the same underlying TCP socket
-connection. Sharing a connection has substantial performance benefits: lower
-latency, higher throughput (due to [TCP slow start](http://www.igvita.com/2011/10/20/faster-web-vs-tcp-slow-start/))
-and conserved battery. OkHttp uses a [ConnectionPool](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/ConnectionPool.html)
-that automatically reuses HTTP/1.x connections and multiplexes HTTP/2 and SPDY
-connections.
-
-In OkHttp some fields of the address come from the URL (scheme, hostname, port)
-and the rest come from the [OkHttpClient](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/OkHttpClient.html).
-
-#### [Routes](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Route.html)
-
-Routes supply the **dynamic** information necessary to actually connect to a webserver.
-This is the specific IP address to attempt (as discovered by a DNS query), the
-exact proxy server to use (if a [ProxySelector](http://developer.android.com/reference/java/net/ProxySelector.html)
-is in use), and which version of TLS to negotiate (for HTTPS connections).
-
-There may be many routes for a single address. For example, a webserver that
-is hosted in multiple datacenters may yield multiple IP addresses in its DNS
-response.
-
-#### [Connections](http://square.github.io/okhttp/javadoc/com/squareup/okhttp/Connection.html)
-
-When you request a URL with OkHttp, here's what it does:
-
- 1. Use the URL and configured OkHttpClient to create an **address**. This address
-    specifies how we'll connect to the webserver.
- 2. Attempt to retrieve a connection with that address in the **connection pool**.
- 3. If it didn't find a connection in the pool, select a **route** to attempt.
-    This usually means making a DNS request to get the server's IP addresses.
-    Select a TLS version and proxy server if necessary.
- 4. If it's a new route, connect. Build either a direct socket connection, a TLS
-    tunnel (for HTTPS over an HTTP proxy), or a direct TLS connection. Do TLS
-    handshakes as necessary.
- 5. Send the HTTP request and read its HTTP response.
-
-If there's a problem with the connection, OkHttp will select another route and
-try again. This can be used to automatically fail over on webservers that offer
-multiple IP addresses. It's also useful when a pooled connection is stale or if
-the attempted TLS version is unsupported.
-
-Once the response has been received, the connection will be returned to the pool
-so it can be reused for a future request. Connections are evicted from the pool
-after a period of inactivity.
-
 Download
 --------
 
@@ -94,45 +19,6 @@
 ```
 
 
-Building
---------
-
-OkHttp requires Java 7 to build and run tests. Runtime compatibility with Java 6 is enforced as
-part of the build to ensure compliance with Android and older versions of the JVM.
-
-
-
-Testing
--------
-
-### On the Desktop
-
-Run OkHttp tests on the desktop with Maven. Running HTTP/2 and SPDY tests on the desktop uses
-[Jetty-NPN][3] when running OpenJDK 7 or [Jetty-ALPN][4] when OpenJDK 8.
-
-```
-mvn clean test
-```
-
-### On a Device
-
-OkHttp's test suite creates an in-process HTTPS server. Prior to Android 2.3, SSL server sockets
-were broken, and so HTTPS tests will time out when run on such devices.
-
-Test on a USB-attached Android using [Vogar][5]. Unfortunately `dx` requires that you build with
-Java 6, otherwise the test class will be silently omitted from the `.dex` file.
-
-```
-mvn clean
-mvn package -DskipTests
-vogar \
-    --classpath ~/.m2/repository/org/bouncycastle/bcprov-jdk15on/1.48/bcprov-jdk15on-1.48.jar \
-    --classpath mockwebserver/target/mockwebserver-2.0.0-SNAPSHOT.jar \
-    --classpath okhttp-protocols/target/okhttp-protocols-2.0.0-SNAPSHOT.jar \
-    --classpath okhttp/target/okhttp-2.0.0-SNAPSHOT.jar \
-    okhttp/src/test
-```
-
 MockWebServer
 -------------
 
@@ -142,7 +28,7 @@
 
 ### Download
 
-Download [the latest JAR][6] or grab via Maven:
+Download [the latest JAR][3] or grab via Maven:
 
 ```xml
 <dependency>
@@ -170,11 +56,6 @@
     limitations under the License.
 
 
-
-
  [1]: http://square.github.io/okhttp
  [2]: http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=com.squareup.okhttp&a=okhttp&v=LATEST
- [3]: https://github.com/jetty-project/jetty-npn
- [4]: https://github.com/jetty-project/jetty-alpn
- [5]: https://code.google.com/p/vogar/
- [6]: http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=com.squareup.okhttp&a=mockwebserver&v=LATEST
+ [3]: http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=com.squareup.okhttp&a=mockwebserver&v=LATEST
/Fim/
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index a786649..1b043e7 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -3,7 +3,7 @@
 
 ## Version 2.0.0-RC1
 
-_RELEASE DATE TBA_
+_2014-05-23_
 
 OkHttp 2 is designed around a new API that is true to HTTP, with classes for
 requests, responses, headers, and calls. It uses modern Java patterns like
@@ -95,6 +95,14 @@
  * Support OAuth in `Authenticator`.
  * Permit a dangling semicolon in media type parsing.
 
+## Version 1.6.0
+
+_2014-05-23_
+
+ * Offer bridges to make it easier to migrate from OkHttp 1.x to OkHttp 2.0.
+   This adds `OkUrlFactory`, `Cache`, and `@Deprecated` annotations for APIs
+   dropped in 2.0.
+
 ## Version 1.5.4
 
 _2014-04-14_
/Fim/
diff --git a/pom.xml b/pom.xml
index 4202ae2..5289004 100644
--- a/pom.xml
+++ b/pom.xml
@@ -34,7 +34,7 @@
 
     <!-- Compilation -->
     <java.version>1.6</java.version>
-    <okio.version>0.9.0</okio.version>
+    <okio.version>1.0.0</okio.version>
     <!-- Targetted to jdk7u60-b13; Oracle jdk7u55-b13. -->
     <npn.version>1.1.7.v20140316</npn.version>
     <!-- Targetted to OpenJDK 8 b132 -->
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 59b7104..75c511d 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
@@ -88,7 +88,7 @@
             <argument>-Xmx512m</argument>
             <commandlineArgs>-Xbootclasspath/p:${bootclasspath}</commandlineArgs>
             <argument>-classpath</argument>
-            <classpath/>
+            <classpath />
             <argument>com.squareup.okhttp.benchmarks.Benchmark</argument>
           </arguments>
         </configuration>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 63ea9e6..d06ea62 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index af0ba2e..6bdca9b 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 14eb349..2c3764d 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 41e6b6a..d508d25 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 2c2e357..9ef3fa7 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8b99441..866ac85 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index f04ca20..1aaa90c 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.0.0-SNAPSHOT</version>
+  <version>2.0.0-RC1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.0.0-RC1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0015f7c..b79cbb2 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 61e5875..e4ce1d6 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 62d1240..e8f01df 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 93657e2..66764b3 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 70188c7..4662c54 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 75c511d..33d04ad 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index d06ea62..63ea9e6 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 6bdca9b..af0ba2e 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 2c3764d..14eb349 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index d508d25..41e6b6a 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 9ef3fa7..2c2e357 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 866ac85..8b99441 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 1aaa90c..f04ca20 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.0.0-RC1</version>
+  <version>2.0.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.0.0-RC1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index b79cbb2..0015f7c 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index e4ce1d6..61e5875 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index e8f01df..62d1240 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 66764b3..93657e2 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 4662c54..70188c7 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC1</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/samples/guide/src/main/java/com/squareup/okhttp/guide/GetExample.java b/samples/guide/src/main/java/com/squareup/okhttp/guide/GetExample.java
index 25f9c86..aa2f200 100644
--- a/samples/guide/src/main/java/com/squareup/okhttp/guide/GetExample.java
+++ b/samples/guide/src/main/java/com/squareup/okhttp/guide/GetExample.java
@@ -8,16 +8,18 @@
 public class GetExample {
   OkHttpClient client = new OkHttpClient();
 
-  void run() throws IOException {
+  String run(String url) throws IOException {
     Request request = new Request.Builder()
-        .url("https://raw.github.com/square/okhttp/master/README.md")
+        .url(url)
         .build();
 
     Response response = client.newCall(request).execute();
-    System.out.println(response.body().string());
+    return response.body().string();
   }
 
   public static void main(String[] args) throws IOException {
-    new GetExample().run();
+    GetExample example = new GetExample();
+    String response = example.run("https://raw.github.com/square/okhttp/master/README.md");
+    System.out.println(response);
   }
 }
/Fim/
diff --git a/samples/guide/src/main/java/com/squareup/okhttp/guide/PostExample.java b/samples/guide/src/main/java/com/squareup/okhttp/guide/PostExample.java
index d2a1520..5de644c 100644
--- a/samples/guide/src/main/java/com/squareup/okhttp/guide/PostExample.java
+++ b/samples/guide/src/main/java/com/squareup/okhttp/guide/PostExample.java
@@ -8,15 +8,19 @@
 import java.io.IOException;
 
 public class PostExample {
+  public static final MediaType JSON
+      = MediaType.parse("application/json; charset=utf-8");
+
   OkHttpClient client = new OkHttpClient();
 
-  void run() throws IOException {
-    String json = bowlingJson("Jesse", "Jake");
-    RequestBody body = RequestBody.create(MediaType.parse("application/json"), json);
-    Request request = new Request.Builder().url("http://www.roundsapp.com/post").post(body).build();
-
+  String post(String url, String json) throws IOException {
+    RequestBody body = RequestBody.create(JSON, json);
+    Request request = new Request.Builder()
+        .url(url)
+        .post(body)
+        .build();
     Response response = client.newCall(request).execute();
-    System.out.println(response.body().string());
+    return response.body().string();
   }
 
   String bowlingJson(String player1, String player2) {
@@ -32,6 +36,9 @@
   }
 
   public static void main(String[] args) throws IOException {
-    new PostExample().run();
+    PostExample example = new PostExample();
+    String json = example.bowlingJson("Jesse", "Jake");
+    String response = example.post("http://www.roundsapp.com/post", json);
+    System.out.println(response);
   }
 }
/Fim/
diff --git a/website/index.html b/website/index.html
index e9ccd18..bc1f4c3 100644
--- a/website/index.html
+++ b/website/index.html
@@ -61,11 +61,16 @@
                 with modern TLS features (SNI, ALPN), and falls back to SSLv3 if the handshake
                 fails.</p>
 
-            <p>You can try OkHttp without rewriting your network code. The core module implements
-                the familiar <code>java.net.HttpURLConnection</code> API. And the optional
-                okhttp-apache module implements the Apache <code>HttpClient</code> API.</p>
+            <p>Using OkHttp is easy. Its 2.0 API is designed with fluent builders and
+                immutability. It supports both synchronous blocking calls and async calls with
+                callbacks.</p>
 
-            <p>OkHttp supports Android 2.2 and above. For Java, the minimum requirement is 1.5.</p>
+            <p>You can try out OkHttp without rewriting your network code. The
+                <code>okhttp-urlconnection</code> module implements the familiar
+                <code>java.net.HttpURLConnection</code> API and the <code>okhttp-apache</code>
+                module implements the Apache <code>HttpClient</code> API.</p>
+
+            <p>OkHttp supports Android 2.3 and above. For Java, the minimum requirement is 1.6.</p>
 
             <h3 id="examples">Examples</h3>
             <h4>Get a URL</h4>
@@ -73,63 +78,41 @@
 <pre class="prettyprint">
     OkHttpClient client = new OkHttpClient();
 
-    String get(URL url) throws IOException {
-      HttpURLConnection connection = client.open(url);
-      InputStream in = null;
-      try {
-        // Read the response.
-        in = connection.getInputStream();
-        byte[] response = readFully(in);
-        return new String(response, "UTF-8");
-      } finally {
-        if (in != null) in.close();
-      }
+    String run(String url) throws IOException {
+      Request request = new Request.Builder()
+          .url(url)
+          .build();
+
+      Response response = client.newCall(request).execute();
+      return response.body().string();
     }
 </pre>
             <h4>Post to a Server</h4>
             <p>This program posts data to a service. <a href="https://raw.github.com/square/okhttp/master/samples/guide/src/main/java/com/squareup/okhttp/guide/PostExample.java">Full source</a>.
 
 <pre class="prettyprint">
-    OkHttpClient client = new OkHttpClient();
+  public static final MediaType JSON
+      = MediaType.parse("application/json; charset=utf-8");
 
-    String post(URL url, byte[] body) throws IOException {
-      HttpURLConnection connection = client.open(url);
-      OutputStream out = null;
-      InputStream in = null;
-      try {
-        // Write the request.
-        connection.setRequestMethod("POST");
-        out = connection.getOutputStream();
-        out.write(body);
-        out.close();
+  OkHttpClient client = new OkHttpClient();
 
-        // Read the response.
-        if (connection.getResponseCode() != HttpURLConnection.HTTP_OK) {
-          throw new IOException("Unexpected HTTP response: "
-              + connection.getResponseCode() + " " + connection.getResponseMessage());
-        }
-        in = connection.getInputStream();
-        return readFirstLine(in);
-      } finally {
-        // Clean up.
-        if (out != null) out.close();
-        if (in != null) in.close();
-      }
-    }
+  String post(String url, String json) throws IOException {
+    RequestBody body = RequestBody.create(JSON, json);
+    Request request = new Request.Builder()
+        .url(url)
+        .post(body)
+        .build();
+    Response response = client.newCall(request).execute();
+    return response.body().string();
+  }
 </pre>
 
-                <!--
-                TODO
-                Error Handling
-                Authentication
-                Cookies
-                Response Caching
-                Captive Gateways
-                -->
-
             <h3 id="download">Download</h3>
             <p><a href="http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=com.squareup.okhttp&a=okhttp&v=LATEST" class="dl version-href">&darr; <span class="version-tag">Latest</span> JAR</a></p>
-            <p>The source code to the OkHttp, its samples, and this website is <a href="http://github.com/square/okhttp">available on GitHub</a>.</p>
+            <p>You'll also need <a href="http://github.com/square/okio">Okio</a>, which OkHttp
+                uses for fast I/O and resizable buffers. Download the
+                <a href="http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=com.squareup.okio&a=okio&v=LATEST">latest JAR</a>.
+            <p>The source code to OkHttp, its samples, and this website is <a href="http://github.com/square/okhttp">available on GitHub</a>.</p>
 
             <h4>Maven</h4>
             <pre class="prettyprint">&lt;dependency>
@@ -144,7 +127,7 @@
             <p>Before your code can be accepted into the project you must also sign the <a href="http://squ.re/sign-the-cla">Individual Contributor License Agreement (CLA)</a>.</p>
 
             <h3 id="license">License</h3>
-            <pre>Copyright 2013 Square, Inc.
+            <pre>Copyright 2014 Square, Inc.
 
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
@@ -168,6 +151,7 @@
                 <li><a href="#license">License</a></li>
               </ul>
               <ul class="nav nav-pills nav-stacked secondary">
+                <li><a href="https://github.com/square/okhttp/wiki">Wiki</a></li>
                 <li><a href="javadoc/index.html">Javadoc</a></li>
                 <li><a href="http://stackoverflow.com/questions/tagged/okhttp?sort=active">StackOverflow</a></li>
               </ul>
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/ComplexExamplesTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/ComplexExamplesTest.java
new file mode 100644
index 0000000..142fa9d
--- /dev/null
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/ComplexExamplesTest.java
@@ -0,0 +1,70 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.ByteArrayOutputStream;
+import java.util.Collections;
+import org.junit.Test;
+
+import static com.squareup.okhttp.TestUtils.UTF_8;
+import static org.junit.Assert.assertEquals;
+
+public class ComplexExamplesTest {
+  @Test public void fieldAndTwoFiles() throws Exception {
+    String expected = ""
+        + "--AaB03x\r\n"
+        + "Content-Disposition: form-data; name=\"submit-name\"\r\n"
+        + "Content-Length: 5\r\n"
+        + "\r\n"
+        + "Larry\r\n"
+        + "--AaB03x\r\n"
+        + "Content-Disposition: form-data; name=\"files\"\r\n"
+        + "Content-Type: multipart/mixed; boundary=BbC04y\r\n"
+        + "\r\n"
+        + "--BbC04y\r\n"
+        + "Content-Disposition: file; filename=\"file1.txt\"\r\n"
+        + "Content-Type: text/plain\r\n"
+        + "Content-Length: 29\r\n"
+        + "\r\n"
+        + "... contents of file1.txt ...\r\n"
+        + "--BbC04y\r\n"
+        + "Content-Disposition: file; filename=\"file2.gif\"\r\n"
+        + "Content-Type: image/gif\r\n"
+        + "Content-Length: 29\r\n"
+        + "Content-Transfer-Encoding: binary\r\n"
+        + "\r\n"
+        + "... contents of file2.gif ...\r\n"
+        + "--BbC04y--\r\n"
+        + "--AaB03x--";
+
+    Multipart m = new Multipart.Builder("AaB03x") //
+        .type(Multipart.Type.FORM) //
+        .addPart(new Part.Builder() //
+            .contentDisposition("form-data; name=\"submit-name\"") //
+            .body("Larry") //
+            .build()) //
+        .addPart(new Part.Builder() //
+            .contentDisposition("form-data; name=\"files\"") //
+            .body(new Multipart.Builder("BbC04y") //
+                .addPart(new Part.Builder() //
+                    .contentDisposition("file; filename=\"file1.txt\"") //
+                    .contentType("text/plain") //
+                    .body("... contents of file1.txt ...") //
+                    .build()) //
+                .addPart(new Part.Builder() //
+                    .contentDisposition("file; filename=\"file2.gif\"") //
+                    .contentType("image/gif") //
+                    .contentEncoding("binary") //
+                    .body("... contents of file2.gif ...") //
+                    .build()) //
+                .build()) //
+            .build()) //
+        .build();
+
+    ByteArrayOutputStream out = new ByteArrayOutputStream();
+    m.writeBodyTo(out);
+    String actual = new String(out.toByteArray(), UTF_8);
+    assertEquals(expected, actual);
+    assertEquals(Collections.singletonMap("Content-Type", "multipart/form-data; boundary=AaB03x"),
+        m.getHeaders());
+  }
+}
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/FormWriterTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/FormWriterTest.java
new file mode 100644
index 0000000..8505c6f
--- /dev/null
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/FormWriterTest.java
@@ -0,0 +1,47 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.ByteArrayOutputStream;
+import java.util.Collections;
+import org.junit.Test;
+
+import static com.squareup.okhttp.TestUtils.UTF_8;
+import static org.junit.Assert.assertEquals;
+
+public class FormWriterTest {
+  @Test public void urlEncoding() throws Exception {
+    FormEncoding fe = new FormEncoding.Builder() //
+        .add("a&b", "c=d") //
+        .add("space, the", "final frontier") //
+        .build();
+
+    assertEquals(Collections.singletonMap("Content-Type", "application/x-www-form-urlencoded"),
+        fe.getHeaders());
+    ByteArrayOutputStream out = new ByteArrayOutputStream();
+    fe.writeBodyTo(out);
+    String actual = new String(out.toByteArray(), UTF_8);
+    assertEquals("a%26b=c%3Dd&space%2C+the=final+frontier", actual);
+  }
+
+  @Test public void encodedPairs() throws Exception {
+    FormEncoding fe1 = new FormEncoding.Builder() //
+        .add("sim", "ple") //
+        .build();
+
+    ByteArrayOutputStream out1 = new ByteArrayOutputStream();
+    fe1.writeBodyTo(out1);
+    String actual1 = new String(out1.toByteArray(), UTF_8);
+    assertEquals("sim=ple", actual1);
+
+    FormEncoding fe2 = new FormEncoding.Builder() //
+        .add("sim", "ple") //
+        .add("hey", "there") //
+        .add("help", "me") //
+        .build();
+
+    ByteArrayOutputStream out2 = new ByteArrayOutputStream();
+    fe2.writeBodyTo(out2);
+    String actual2 = new String(out2.toByteArray(), UTF_8);
+    assertEquals("sim=ple&hey=there&help=me", actual2);
+  }
+}
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/MultipartWriterTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/MultipartWriterTest.java
new file mode 100644
index 0000000..5d8bae8
--- /dev/null
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/MultipartWriterTest.java
@@ -0,0 +1,63 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.ByteArrayOutputStream;
+import java.util.Collections;
+import org.junit.Test;
+
+import static com.squareup.okhttp.TestUtils.UTF_8;
+import static org.junit.Assert.assertEquals;
+
+
+public class MultipartWriterTest {
+  @Test(expected = IllegalStateException.class)
+  public void onePartRequired() throws Exception {
+    new Multipart.Builder().build();
+  }
+
+  @Test public void singlePart() throws Exception {
+    String expected = "" //
+        + "--123\r\n" //
+        + "\r\n" //
+        + "Hello, World!\r\n" //
+        + "--123--";
+
+    Multipart m = new Multipart.Builder("123")
+        .addPart(new TestPart("Hello, World!"))
+        .build();
+
+    ByteArrayOutputStream out = new ByteArrayOutputStream();
+    m.writeBodyTo(out);
+    String actual = new String(out.toByteArray(), UTF_8);
+    assertEquals(expected, actual);
+    assertEquals(Collections.singletonMap("Content-Type", "multipart/mixed; boundary=123"),
+        m.getHeaders());
+  }
+
+  @Test public void threeParts() throws Exception {
+    String expected = ""
+        + "--123\r\n"
+        + "\r\n"
+        + "Quick\r\n"
+        + "--123\r\n"
+        + "\r\n"
+        + "Brown\r\n"
+        + "--123\r\n"
+        + "\r\n"
+        + "Fox\r\n"
+        + "--123--";
+
+    Multipart m = new Multipart.Builder("123")
+        .addPart(new TestPart("Quick"))
+        .addPart(new TestPart("Brown"))
+        .addPart(new TestPart("Fox"))
+        .build();
+
+    ByteArrayOutputStream out = new ByteArrayOutputStream();
+    m.writeBodyTo(out);
+    String actual = new String(out.toByteArray(), UTF_8);
+    assertEquals(expected, actual);
+    assertEquals(Collections.singletonMap("Content-Type", "multipart/mixed; boundary=123"),
+        m.getHeaders());
+  }
+}
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/PartTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/PartTest.java
new file mode 100644
index 0000000..d39fde1
--- /dev/null
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/PartTest.java
@@ -0,0 +1,152 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.ByteArrayInputStream;
+import java.io.ByteArrayOutputStream;
+import java.io.File;
+import java.io.InputStream;
+import java.util.Collections;
+import java.util.LinkedHashMap;
+import java.util.Map;
+import org.junit.Test;
+
+import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.fail;
+
+public class PartTest {
+  @Test(expected = IllegalStateException.class)
+  public void noBodyThrowsException() {
+    new Part.Builder().build();
+  }
+
+  @Test public void settingHeaderTwiceThrowsException() {
+    try {
+      new Part.Builder().contentEncoding("foo").contentEncoding("bar");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      new Part.Builder().contentLanguage("foo").contentLanguage("bar");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      new Part.Builder().contentLength(42).contentLength(108);
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      new Part.Builder().contentType("foo").contentType("bar");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+  }
+
+  @Test public void settingBodyTwiceThrowsException() {
+    try {
+      new Part.Builder().body("foo").body("bar");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      byte[] bytes = { 'a', 'b' };
+      new Part.Builder().body(bytes).body(bytes);
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      InputStream is = new ByteArrayInputStream(new byte[0]);
+      new Part.Builder().body(is).body(is);
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      File file = new File("/foo/bar");
+      new Part.Builder().body(file).body(file);
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+  }
+
+  @Test public void blankHeadersThrowsException() {
+    try {
+      new Part.Builder().contentType("");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      new Part.Builder().contentLength(0);
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      new Part.Builder().contentLength(-1);
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      new Part.Builder().contentLanguage("");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+    try {
+      new Part.Builder().contentEncoding("");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+  }
+
+  @Test public void bodyBytesSetsContentLength() {
+    Part.Builder b = new Part.Builder();
+    assertEquals(0, b.headerLength);
+    b.body("1234567");
+    assertEquals(7, b.headerLength);
+  }
+
+  @Test public void bodyBytesOverridesLength() {
+    Part.Builder b = new Part.Builder();
+    assertEquals(0, b.headerLength);
+    b.contentLength(108);
+    assertEquals(108, b.headerLength);
+    b.body("1234567");
+    assertEquals(7, b.headerLength);
+  }
+
+  @Test public void completePart() throws Exception {
+    Part p = new Part.Builder() //
+        .contentDisposition("form-data; filename=\"foo.txt\"") //
+        .contentType("application/json") //
+        .contentLength(13) //
+        .contentLanguage("English") //
+        .contentEncoding("UTF-8") //
+        .body("{'foo':'bar'}") //
+        .build();
+
+    ByteArrayOutputStream baos = new ByteArrayOutputStream();
+    p.writeBodyTo(baos);
+    String actual = new String(baos.toByteArray(), TestUtils.UTF_8);
+    assertEquals("{'foo':'bar'}", actual);
+
+    Map<String, String> expectedHeaders = new LinkedHashMap<String, String>();
+    expectedHeaders.put("Content-Disposition", "form-data; filename=\"foo.txt\"");
+    expectedHeaders.put("Content-Type", "application/json");
+    expectedHeaders.put("Content-Length", "13");
+    expectedHeaders.put("Content-Language", "English");
+    expectedHeaders.put("Content-Transfer-Encoding", "UTF-8");
+    assertEquals(expectedHeaders, p.getHeaders());
+  }
+
+  @Test public void multipartBodySetsType() throws Exception {
+    Multipart m = new Multipart.Builder().addPart(new TestPart("hi")).build();
+
+    try {
+      new Part.Builder().body(m).contentType("break me!");
+      fail();
+    } catch (IllegalStateException expected) {
+    }
+
+    Part p = new Part.Builder().body(m).build();
+    assertEquals(Collections.singletonMap("Content-Type", m.getHeaders().get("Content-Type")),
+        p.getHeaders());
+  }
+}
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/TestPart.java b/okhttp-tests/src/test/java/com/squareup/okhttp/TestPart.java
new file mode 100644
index 0000000..9951a45
--- /dev/null
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/TestPart.java
@@ -0,0 +1,25 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.IOException;
+import java.io.OutputStream;
+import java.util.Collections;
+import java.util.Map;
+
+import static com.squareup.okhttp.TestUtils.UTF_8;
+
+public class TestPart implements Part {
+  private final byte[] content;
+
+  public TestPart(String content) {
+    this.content = content.getBytes(UTF_8);
+  }
+
+  @Override public Map<String, String> getHeaders() {
+    return Collections.emptyMap();
+  }
+
+  @Override public void writeBodyTo(OutputStream out) throws IOException {
+    out.write(content);
+  }
+}
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/TestUtils.java b/okhttp-tests/src/test/java/com/squareup/okhttp/TestUtils.java
new file mode 100644
index 0000000..e487267
--- /dev/null
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/TestUtils.java
@@ -0,0 +1,11 @@
+package com.squareup.okhttp;
+
+import java.nio.charset.Charset;
+
+final class TestUtils {
+  static final Charset UTF_8 = Charset.forName("UTF-8");
+
+  private TestUtils() {
+    // prevent instantiation
+  }
+}
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/FormEncoding.java b/okhttp/src/main/java/com/squareup/okhttp/FormEncoding.java
new file mode 100644
index 0000000..70d9858
--- /dev/null
+++ b/okhttp/src/main/java/com/squareup/okhttp/FormEncoding.java
@@ -0,0 +1,64 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.IOException;
+import java.io.OutputStream;
+import java.io.UnsupportedEncodingException;
+import java.net.URLEncoder;
+import java.util.Collections;
+import java.util.Map;
+
+/**
+ * <a href="http://www.w3.org/MarkUp/html-spec/html-spec_8.html#SEC8.2.1">HTML 2.0</a>-compliant
+ * form data.
+ */
+public final class FormEncoding implements Part {
+  private static final Map<String, String> HEADERS =
+      Collections.singletonMap("Content-Type", "application/x-www-form-urlencoded");
+
+  /** Fluent API to build {@link FormEncoding} instances. */
+  public static class Builder {
+    private final StringBuilder content = new StringBuilder();
+
+    /** Add new key-value pair. */
+    public Builder add(String name, String value) {
+      if (content.length() > 0) {
+        content.append('&');
+      }
+      try {
+        content.append(URLEncoder.encode(name, "UTF-8"))
+            .append('=')
+            .append(URLEncoder.encode(value, "UTF-8"));
+      } catch (UnsupportedEncodingException e) {
+        throw new AssertionError(e);
+      }
+      return this;
+    }
+
+    /** Create {@link FormEncoding} instance. */
+    public FormEncoding build() {
+      if (content.length() == 0) {
+        throw new IllegalStateException("Form encoded body must have at least one part.");
+      }
+      return new FormEncoding(content.toString());
+    }
+  }
+
+  private final byte[] data;
+
+  private FormEncoding(String data) {
+    try {
+      this.data = data.getBytes("UTF-8");
+    } catch (UnsupportedEncodingException e) {
+      throw new IllegalArgumentException("Unable to convert input to UTF-8: " + data, e);
+    }
+  }
+
+  @Override public Map<String, String> getHeaders() {
+    return HEADERS;
+  }
+
+  @Override public void writeBodyTo(OutputStream stream) throws IOException {
+    stream.write(data);
+  }
+}
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/Multipart.java b/okhttp/src/main/java/com/squareup/okhttp/Multipart.java
new file mode 100644
index 0000000..deba341
--- /dev/null
+++ b/okhttp/src/main/java/com/squareup/okhttp/Multipart.java
@@ -0,0 +1,155 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.IOException;
+import java.io.OutputStream;
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.List;
+import java.util.Map;
+import java.util.UUID;
+
+import static com.squareup.okhttp.Utils.isNotNull;
+
+/** <a href="http://www.ietf.org/rfc/rfc2387.txt">RFC 2387</a>-compliant encoded data. */
+public final class Multipart implements Part {
+
+  /** Multipart MIME types. */
+  public enum Type {
+    /**
+     * The "mixed" subtype of "multipart" is intended for use when the body parts are independent
+     * and need to be bundled in a particular order.  Any "multipart" subtypes that an
+     * implementation does not recognize must be treated as being of subtype "mixed".
+     */
+    MIXED("mixed"),
+    /**
+     * The "multipart/alternative" type is syntactically identical to "multipart/mixed", but the
+     * semantics are different.  In particular, each of the body parts is an "alternative" version
+     * of the same information.
+     */
+    ALTERNATIVE("alternative"),
+    /**
+     * This type is syntactically identical to "multipart/mixed", but the semantics are different.
+     * In particular, in a digest, the default {@code Content-Type} value for a body part is
+     * changed from "text/plain" to "message/rfc822".
+     */
+    DIGEST("digest"),
+    /**
+     * This type is syntactically identical to "multipart/mixed", but the semantics are different.
+     * In particular, in a parallel entity, the order of body parts is not significant.
+     */
+    PARALLEL("parallel"),
+    /**
+     * The media-type multipart/form-data follows the rules of all multipart MIME data streams as
+     * outlined in RFC 2046.  In forms, there are a series of fields to be supplied by the user who
+     * fills out the form.  Each field has a name. Within a given form, the names are unique.
+     */
+    FORM("form-data");
+
+    final String contentType;
+
+    private Type(String contentType) {
+      this.contentType = contentType;
+    }
+  }
+
+  /** Fluent API to build {@link Multipart} instances. */
+  public static class Builder {
+    private final String boundary;
+    private final List<Part> parts = new ArrayList<Part>();
+    private Type type = Type.MIXED;
+
+    public Builder() {
+      this(UUID.randomUUID().toString());
+    }
+
+    public Builder(String boundary) {
+      this.boundary = boundary;
+    }
+
+    /** Set the MIME type. */
+    public Builder type(Type type) {
+      isNotNull(type, "Type must not be null.");
+      this.type = type;
+      return this;
+    }
+
+    /** Add a part to the body. */
+    public Builder addPart(Part part) {
+      isNotNull(part, "Part must not be null.");
+      parts.add(part);
+      return this;
+    }
+
+    /** Assemble the specified parts into a {@link Multipart}. */
+    public Multipart build() {
+      if (parts.isEmpty()) {
+        throw new IllegalStateException("Multipart body must have at least one part.");
+      }
+      return new Multipart(type, parts, boundary);
+    }
+  }
+
+  private final List<Part> parts;
+  private final Map<String, String> headers;
+  private final String boundary;
+
+  private Multipart(Type type, List<Part> parts, String boundary) {
+    isNotNull(type, "Multipart type must not be null.");
+
+    this.parts = parts;
+    this.headers = Collections.singletonMap(
+        "Content-Type", "multipart/" + type.contentType + "; boundary=" + boundary);
+    this.boundary = boundary;
+  }
+
+  @Override public Map<String, String> getHeaders() {
+    return headers;
+  }
+
+  @Override public void writeBodyTo(OutputStream stream) throws IOException {
+    byte[] boundary = this.boundary.getBytes("UTF-8");
+    boolean first = true;
+    for (Part part : parts) {
+      writeBoundary(stream, boundary, first, false);
+      writePart(stream, part);
+      first = false;
+    }
+    writeBoundary(stream, boundary, false, true);
+  }
+
+  private static void writeBoundary(OutputStream out, byte[] boundary, boolean first, boolean last)
+      throws IOException {
+    if (!first) {
+      out.write('\r');
+      out.write('\n');
+    }
+    out.write('-');
+    out.write('-');
+    out.write(boundary);
+    if (last) {
+      out.write('-');
+      out.write('-');
+    } else {
+      out.write('\r');
+      out.write('\n');
+    }
+  }
+
+  private static void writePart(OutputStream out, Part part) throws IOException {
+    Map<String, String> headers = part.getHeaders();
+    if (headers != null) {
+      for (Map.Entry<String, String> header : headers.entrySet()) {
+        out.write(header.getKey().getBytes("UTF-8"));
+        out.write(':');
+        out.write(' ');
+        out.write(header.getValue().getBytes("UTF-8"));
+        out.write('\r');
+        out.write('\n');
+      }
+    }
+    out.write('\r');
+    out.write('\n');
+    part.writeBodyTo(out);
+  }
+}
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/Part.java b/okhttp/src/main/java/com/squareup/okhttp/Part.java
new file mode 100644
index 0000000..6225fe4
--- /dev/null
+++ b/okhttp/src/main/java/com/squareup/okhttp/Part.java
@@ -0,0 +1,260 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.OutputStream;
+import java.io.UnsupportedEncodingException;
+import java.util.LinkedHashMap;
+import java.util.Map;
+
+import static com.squareup.okhttp.Utils.copyStream;
+import static com.squareup.okhttp.Utils.isNotEmpty;
+import static com.squareup.okhttp.Utils.isNotNull;
+import static com.squareup.okhttp.Utils.isNotZero;
+import static com.squareup.okhttp.Utils.isNull;
+
+/** HTTP request data with associated headers. */
+public interface Part {
+  /** HTTP headers. */
+  Map<String, String> getHeaders();
+
+  /**
+   * Write request data to the specified stream. For best performance use a
+   * {@link java.io.BufferedOutputStream BufferedOutputStream}.
+   */
+  void writeBodyTo(OutputStream stream) throws IOException;
+
+  /** Fluent API to build {@link Part} instances. */
+  public class Builder {
+    private static final int BUFFER_SIZE = 4096;
+
+    private String headerType;
+    int headerLength;
+    private String headerLanguage;
+    private String headerEncoding;
+    private String headerDisposition;
+    private File bodyFile;
+    private InputStream bodyStream;
+    private byte[] bodyBytes;
+    private Multipart bodyMultipart;
+    private boolean hasBody = false;
+
+    private void checkSetBody() {
+      if (hasBody) {
+        throw new IllegalStateException("Only one body per part.");
+      }
+      hasBody = true;
+    }
+
+    /** Set the {@code Content-Type} header value. */
+    public Builder contentType(String type) {
+      isNotEmpty(type, "Type must not be empty.");
+      isNull(headerType, "Type header already set.");
+      isNull(bodyMultipart, "Type cannot be set with multipart body.");
+      headerType = type;
+      return this;
+    }
+
+    /** Set the {@code Content-Length} header value. */
+    public Builder contentLength(int length) {
+      if (length <= 0) {
+        throw new IllegalStateException("Length must be greater than zero.");
+      }
+      isNotZero(headerLength, "Length header already set.");
+      headerLength = length;
+      return this;
+    }
+
+    /** Set the {@code Content-Language} header value. */
+    public Builder contentLanguage(String language) {
+      isNotEmpty(language, "Language must not be empty.");
+      isNull(headerLanguage, "Language header already set.");
+      headerLanguage = language;
+      return this;
+    }
+
+    /** Set the {@code Content-Transfer-Encoding} header value. */
+    public Builder contentEncoding(String encoding) {
+      isNotEmpty(encoding, "Encoding must not be empty.");
+      isNull(headerEncoding, "Encoding header already set.");
+      headerEncoding = encoding;
+      return this;
+    }
+
+    /** Set the {@code Content-Disposition} header value. */
+    public Builder contentDisposition(String disposition) {
+      isNotEmpty(disposition, "Disposition must not be empty.");
+      isNull(headerDisposition, "Disposition header already set.");
+      headerDisposition = disposition;
+      return this;
+    }
+
+    /** Use the specified file as the body. */
+    public Builder body(File body) {
+      isNotNull(body, "File body must not be null.");
+      checkSetBody();
+      bodyFile = body;
+      return this;
+    }
+
+    /** Use the specified stream as the body. */
+    public Builder body(InputStream body) {
+      isNotNull(body, "Stream body must not be null.");
+      checkSetBody();
+      bodyStream = body;
+      return this;
+    }
+
+    /** Use the specified string as the body. */
+    public Builder body(String body) {
+      isNotNull(body, "String body must not be null.");
+      checkSetBody();
+      byte[] bytes;
+      try {
+        bytes = body.getBytes("UTF-8");
+      } catch (UnsupportedEncodingException e) {
+        throw new IllegalArgumentException("Unable to convert input to UTF-8: " + body, e);
+      }
+      bodyBytes = bytes;
+      headerLength = bytes.length;
+      return this;
+    }
+
+    /** Use the specified bytes as the body. */
+    public Builder body(byte[] body) {
+      isNotNull(body, "Byte array body must not be null.");
+      checkSetBody();
+      bodyBytes = body;
+      headerLength = body.length;
+      return this;
+    }
+
+    /** Use the specified {@link Multipart} as the body. */
+    public Builder body(Multipart body) {
+      isNotNull(body, "Multipart body must not be null.");
+      if (headerType != null) {
+        throw new IllegalStateException(
+            "Content type must not be explicitly set for multipart body.");
+      }
+      checkSetBody();
+      headerType = null;
+      bodyMultipart = body;
+      return this;
+    }
+
+    /** Assemble the specified headers and body into a {@link Part}. */
+    public Part build() {
+      Map<String, String> headers = new LinkedHashMap<String, String>();
+      if (headerDisposition != null) {
+        headers.put("Content-Disposition", headerDisposition);
+      }
+      if (headerType != null) {
+        headers.put("Content-Type", headerType);
+      }
+      if (headerLength != 0) {
+        headers.put("Content-Length", Integer.toString(headerLength));
+      }
+      if (headerLanguage != null) {
+        headers.put("Content-Language", headerLanguage);
+      }
+      if (headerEncoding != null) {
+        headers.put("Content-Transfer-Encoding", headerEncoding);
+      }
+
+      if (bodyBytes != null) {
+        return new BytesPart(headers, bodyBytes);
+      }
+      if (bodyStream != null) {
+        return new StreamPart(headers, bodyStream);
+      }
+      if (bodyFile != null) {
+        return new FilePart(headers, bodyFile);
+      }
+      if (bodyMultipart != null) {
+        headers.putAll(bodyMultipart.getHeaders());
+        return new PartPart(headers, bodyMultipart);
+      }
+      throw new IllegalStateException("Part required body to be set.");
+    }
+
+    private abstract static class PartImpl implements Part {
+      private final Map<String, String> headers;
+
+      protected PartImpl(Map<String, String> headers) {
+        this.headers = headers;
+      }
+
+      @Override public Map<String, String> getHeaders() {
+        return headers;
+      }
+    }
+
+    private static final class PartPart extends PartImpl {
+      private final Part body;
+
+      protected PartPart(Map<String, String> headers, Part body) {
+        super(headers);
+        this.body = body;
+      }
+
+      @Override public void writeBodyTo(OutputStream stream) throws IOException {
+        body.writeBodyTo(stream);
+      }
+    }
+
+    static final class BytesPart extends PartImpl {
+      private final byte[] contents;
+
+      BytesPart(Map<String, String> headers, byte[] contents) {
+        super(headers);
+        this.contents = contents;
+      }
+
+      @Override public void writeBodyTo(OutputStream out) throws IOException {
+        out.write(contents);
+      }
+    }
+
+    private static final class StreamPart extends PartImpl {
+      private final InputStream in;
+      private final byte[] buffer = new byte[BUFFER_SIZE];
+
+      private StreamPart(Map<String, String> headers, InputStream in) {
+        super(headers);
+        this.in = in;
+      }
+
+      @Override public void writeBodyTo(OutputStream out) throws IOException {
+        copyStream(in, out, buffer);
+      }
+    }
+
+    private static final class FilePart extends PartImpl {
+      private final File file;
+      private final byte[] buffer = new byte[BUFFER_SIZE];
+
+      private FilePart(Map<String, String> headers, File file) {
+        super(headers);
+        this.file = file;
+      }
+
+      @Override public void writeBodyTo(OutputStream out) throws IOException {
+        InputStream in = null;
+        try {
+          in = new FileInputStream(file);
+          copyStream(in, out, buffer);
+        } finally {
+          if (in != null) {
+            try {
+              in.close();
+            } catch (IOException ignored) {
+            }
+          }
+        }
+      }
+    }
+  }
+}
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/Utils.java b/okhttp/src/main/java/com/squareup/okhttp/Utils.java
new file mode 100644
index 0000000..548f6a0
--- /dev/null
+++ b/okhttp/src/main/java/com/squareup/okhttp/Utils.java
@@ -0,0 +1,44 @@
+// Copyright 2013 Square, Inc.
+package com.squareup.okhttp;
+
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.OutputStream;
+
+final class Utils {
+  private Utils() {
+    // No instances.
+  }
+
+  static void copyStream(InputStream in, OutputStream out, byte[] buffer) throws IOException {
+    int count;
+    while ((count = in.read(buffer)) != -1) {
+      out.write(buffer, 0, count);
+    }
+  }
+
+  static void isNotNull(Object obj, String message) {
+    if (obj == null) {
+      throw new IllegalStateException(message);
+    }
+  }
+
+  static void isNull(Object obj, String message) {
+    if (obj != null) {
+      throw new IllegalStateException(message);
+    }
+  }
+
+  static void isNotEmpty(String thing, String message) {
+    isNotNull(thing, message);
+    if ("".equals(thing.trim())) {
+      throw new IllegalStateException(message);
+    }
+  }
+
+  static void isNotZero(int value, String message) {
+    if (value != 0) {
+      throw new IllegalStateException(message);
+    }
+  }
+}
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 1b043e7..71a507a 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,45 @@
 Change Log
 ==========
 
+## Version 2.0.0-RC2
+
+_2014-06-11_
+
+This update fixes problems in 2.0.0-RC1. Read the 2.0.0-RC1 changes for
+advice on upgrading from 1.x to 2.x.
+
+ *  Fix: Don't leak connections! There was a regression in 2.0.0-RC2 where
+    connections were neither closed nor pooled.
+ *  Fix: Revert builder-style return types from OkHttpClient's timeout methods
+    for binary compatibility with OkHttp 1.x.
+ *  Fix: Don't skip client stream 1 on SPDY/3.1. This fixes SPDY connectivity to
+    `https://google.com`, which doesn't follow the SPDY/3.1 spec!
+ *  Fix: Always configure NPN headers. This fixes connectivity to
+    `https://facebook.com` when SPDY and HTTP/2 are both disabled. Otherwise an
+    unexpected NPN response is received and OkHttp crashes.
+ *  Fix: Write continuation frames when HPACK data is larger than 16383 bytes.
+ *  Fix: Don't drop uncaught exceptions thrown in async calls.
+ *  Fix: Throw an exception eagerly when a request body is not legal. Previously
+    we ignored the problem at request-building time, only to crash later with a
+    `NullPointerException`.
+ *  Fix: Include a backwards-compatible `OkHttp-Response-Source` header with
+    `OkUrlFactory `responses.
+ *  Fix: Don't include a default User-Agent header in requests made with the Call
+    API. Requests made with OkUrlFactory will continue to have a default user
+    agent.
+ *  New: Guava-like API to create headers:
+
+    ```
+    Headers headers = Headers.of(name1, value1, name2, value2, ...).
+    ```
+
+ *  New: Make the content-type header optional for request bodies.
+ *  New: `Response.isSuccessful()` is a convenient API to check response codes.
+ *  New: The response body can now be read outside of the callback. Response
+    bodies must always be closed, otherwise they will leak connections!
+ *  New: APIs to create multipart request bodies (`MultipartBuilder`) and form
+    encoding bodies (`FormEncodingBuilder`).
+
 ## Version 2.0.0-RC1
 
 _2014-05-23_
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 33d04ad..8421749 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 63ea9e6..d098fd9 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index af0ba2e..2a8195e 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6a110c2..243cee4 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 41e6b6a..0acb5e5 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index b02b3b9..167d031 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8b99441..45aa158 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index f04ca20..b6d97ce 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.0.0-SNAPSHOT</version>
+  <version>2.0.0-RC2</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.0.0-RC2</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0015f7c..9608519 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 089d81b..04817b4 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 62d1240..aeaaf86 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 93657e2..1bcf4fe 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 70188c7..83f79ec 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0-RC2</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 8421749..33d04ad 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index d098fd9..63ea9e6 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 2a8195e..af0ba2e 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 243cee4..6a110c2 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 0acb5e5..41e6b6a 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 167d031..b02b3b9 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 45aa158..8b99441 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index b6d97ce..f04ca20 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.0.0-RC2</version>
+  <version>2.0.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.0.0-RC2</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 9608519..0015f7c 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 04817b4..089d81b 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index aeaaf86..62d1240 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 1bcf4fe..93657e2 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 83f79ec..70188c7 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-RC2</version>
+    <version>2.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 67cbfe7..e641556 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,22 @@
 Change Log
 ==========
 
+## Version 2.0.0
+
+This release commits to a stable 2.0 API. Read the 2.0.0-RC1 changes for advice
+on upgrading from 1.x to 2.x.
+
+_2014-06-21_
+
+ *  **API Change**: Use `IOException` in `Callback.onFailure()`. This is
+    a source-incompatible change, and is different from OkHttp 2.0.0-RC2 which
+    used `Throwable`.
+ *  Fix: Fixed a caching bug where we weren't storing rewritten request headers
+    like `Accept-Encoding`.
+ *  Fix: Fixed bugs in handling the SPDY window size. This was stalling certain
+    large downloads
+ *  Update the language level to Java 7. (OkHttp requires Android 2.3+ or Java 7+.)
+
 ## Version 2.0.0-RC2
 
 _2014-06-11_
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 33d04ad..19b6e12 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 63ea9e6..4efbf63 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index af0ba2e..56d35b5 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6a110c2..6a34ce1 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 41e6b6a..473cb6c 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index b02b3b9..ace80b6 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8b99441..f25df3a 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index dda3062..5c76111 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.0.0-SNAPSHOT</version>
+  <version>2.0.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.0.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0015f7c..5ced0f1 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 089d81b..4d6685c 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 62d1240..35f8869 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 93657e2..259f337 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 70188c7..e8e055e 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 33d04ad..0a48fbd 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 63ea9e6..1feb9d9 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index af0ba2e..a442c7a 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6a110c2..e1c5f44 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 41e6b6a..7c3a601 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index b02b3b9..dc743a9 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8b99441..c98e5db 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index dda3062..8ef3e97 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.0.0-SNAPSHOT</version>
+  <version>2.0.1-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0015f7c..0af4e32 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 089d81b..c257c16 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 62d1240..7a41400 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 93657e2..484f9d2 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 70188c7..b9f3db6 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.0-SNAPSHOT</version>
+    <version>2.0.1-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
index 038f69f..260f099 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
@@ -1691,6 +1691,39 @@
     }
   }
 
+  /** https://code.google.com/p/android/issues/detail?id=74026 */
+  @Test public void authenticateWithGetAndTransparentGzip() throws Exception {
+    MockResponse pleaseAuthenticate = new MockResponse().setResponseCode(401)
+        .addHeader("WWW-Authenticate: Basic realm=\"protected area\"")
+        .setBody("Please authenticate.");
+    // fail auth three times...
+    server.enqueue(pleaseAuthenticate);
+    server.enqueue(pleaseAuthenticate);
+    server.enqueue(pleaseAuthenticate);
+    // ...then succeed the fourth time
+    MockResponse successfulResponse = new MockResponse()
+        .addHeader("Content-Encoding", "gzip")
+        .setBody(gzip("Successful auth!"));
+    server.enqueue(successfulResponse);
+    server.play();
+
+    Authenticator.setDefault(new RecordingAuthenticator());
+    connection = client.open(server.getUrl("/"));
+    assertEquals("Successful auth!", readAscii(connection.getInputStream(), Integer.MAX_VALUE));
+
+    // no authorization header for the first request...
+    RecordedRequest request = server.takeRequest();
+    assertContainsNoneMatching(request.getHeaders(), "Authorization: Basic .*");
+
+    // ...but the three requests that follow requests include an authorization header
+    for (int i = 0; i < 3; i++) {
+      request = server.takeRequest();
+      assertEquals("GET / HTTP/1.1", request.getRequestLine());
+      assertContains(request.getHeaders(),
+          "Authorization: Basic " + RecordingAuthenticator.BASE_64_CREDENTIALS);
+    }
+  }
+
   /** https://github.com/square/okhttp/issues/342 */
   @Test public void authenticateRealmUppercase() throws Exception {
     server.enqueue(new MockResponse().setResponseCode(401)
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index e641556..c9e4a7e 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,99 @@
 Change Log
 ==========
 
+## VERSION 2.1.0-RC1
+
+_2014-11-04_
+
+ *  **OkHttp now caches private responses**. We've changed from a shared cache
+    to a private cache, and will now store responses that use an `Authorization`
+    header. This means OkHttp's cache shouldn't be used on middleboxes that sit
+    between user agents and the origin server.
+
+ *  **TLS configuration updated.** OkHttp now explicitly enables TLSv1.2,
+    TLSv1.1 and TLSv1.0 where they are supported. It will continue to perform
+    only one fallback, to SSLv3. Applications can now configure this with the
+    `ConnectionConfiguration` class.
+
+    To disable TLS fallback:
+
+    ```
+    client.setConnectionConfigurations(Arrays.asList(
+        ConnectionConfiguration.MODERN_TLS, ConnectionConfiguration.CLEARTEXT));
+    ```
+
+    To disable cleartext connections, permitting `https` URLs only:
+
+    ```
+    client.setConnectionConfigurations(Arrays.asList(
+        ConnectionConfiguration.MODERN_TLS, ConnectionConfiguration.COMPATIBLE_TLS));
+    ```
+
+ *  **New cipher suites.** Please confirm that your webservers are reachable
+    with this limited set of cipher suites.
+
+    ```
+                                             Android
+    Name                                     Version
+
+    TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256  5.0
+    TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256    5.0
+    TLS_DHE_RSA_WITH_AES_128_GCM_SHA256      5.0
+    TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA     4.0
+    TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA     4.0
+    TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA       4.0
+    TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA       4.0
+    TLS_ECDHE_ECDSA_WITH_RC4_128_SHA         4.0
+    TLS_ECDHE_RSA_WITH_RC4_128_SHA           4.0
+    TLS_DHE_RSA_WITH_AES_128_CBC_SHA         2.3
+    TLS_DHE_DSS_WITH_AES_128_CBC_SHA         2.3
+    TLS_DHE_RSA_WITH_AES_256_CBC_SHA         2.3
+    TLS_RSA_WITH_AES_128_GCM_SHA256          5.0
+    TLS_RSA_WITH_AES_128_CBC_SHA             2.3
+    TLS_RSA_WITH_AES_256_CBC_SHA             2.3
+    SSL_RSA_WITH_3DES_EDE_CBC_SHA            2.3  (Deprecated in 5.0)
+    SSL_RSA_WITH_RC4_128_SHA                 2.3
+    SSL_RSA_WITH_RC4_128_MD5                 2.3  (Deprecated in 5.0)
+    ```
+
+ *  **Okio updated to 1.0.1.**
+
+    ```
+    <dependency>
+      <groupId>com.squareup.okio</groupId>
+      <artifactId>okio</artifactId>
+      <version>1.0.1</version>
+    </dependency>
+    ```
+
+ *  **New APIs to permit easy certificate pinning.** Be warned, certificate
+    pinning is dangerous and could prevent your application from trusting your
+    server!
+
+ *  **Cache improvements.** This release fixes some severe cache problems
+    including a bug where the cache could be corrupted upon certain access
+    patterns. We also fixed a bug where the cache was being cleared due to a
+    corrupted journal. We've added APIs to configure a request's `Cache-Control`
+    headers, and to manually clear the cache.
+
+ *  **Request cancellation fixes.** This update fixes a bug where synchronous
+    requests couldn't be canceled by tag. This update avoids crashing when
+    `onResponse()` throws an `IOException`. That failure will now be logged
+    instead of notifying the thread's uncaught exception handler. We've added a
+    new API, `Call.isCanceled()` to check if a call has been canceled.
+
+ *  New: Update `MultipartBuilder` to support content length.
+ *  New: Make it possible to mock `OkHttpClient` and `Call`.
+ *  New: Update to h2-14 and hpack-9.
+ *  New: OkHttp includes a user-agent by default, like `okhttp/2.1.0-RC1`.
+ *  Fix: Handle response code `308 Permanent Redirect`.
+ *  Fix: Don't skip the callback if a call is canceled.
+ *  Fix: Permit hostnames with underscores.
+ *  Fix: Permit overriding the content-type in `OkApacheClient`.
+ *  Fix: Use the socket factory for direct connections.
+ *  Fix: Honor `OkUrlFactory` APIs that disable redirects.
+ *  Fix: Don't crash on concurrent modification of `SPDY` SPDY settings.
+
 ## Version 2.0.0
 
 This release commits to a stable 2.0 API. Read the 2.0.0-RC1 changes for advice
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 0a48fbd..241b43e 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 1feb9d9..72a971e 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index a442c7a..dddd30f 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index a5b8d5a..5a16478 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-hpacktests/pom.xml b/okhttp-hpacktests/pom.xml
index 0e88490..30864ec 100644
--- a/okhttp-hpacktests/pom.xml
+++ b/okhttp-hpacktests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-hpacktests</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 7c3a601..0ddd332 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index dc743a9..e358904 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index e9bd2e4..62f9312 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 392779f..5680235 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.0.1-SNAPSHOT</version>
+  <version>2.1.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0af4e32..0075719 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index c257c16..78ac79d 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 7a41400..75831b6 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 484f9d2..ef08092 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index b9f3db6..44fa83b 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.0.1-SNAPSHOT</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java
index 0f832f4..4ebbb7e 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java
@@ -1484,7 +1484,7 @@
 
     RecordedRequest recordedRequest = server.takeRequest();
     assertTrue(recordedRequest.getHeader("User-Agent")
-        .matches("okhttp/\\d\\.\\d\\.\\d(-SNAPSHOT)?"));
+        .matches("okhttp/\\d\\.\\d\\.\\d(-SNAPSHOT|-RC\\d+)?"));
   }
 
   @Test public void setFollowRedirectsFalse() throws Exception {
/Fim/
diff --git a/pom.xml b/pom.xml
index 5680235..0afab9e 100644
--- a/pom.xml
+++ b/pom.xml
@@ -21,7 +21,6 @@
   <modules>
     <module>okhttp</module>
     <module>okhttp-apache</module>
-    <module>okhttp-hpacktests</module>
     <module>okhttp-tests</module>
     <module>okhttp-urlconnection</module>
     <module>okcurl</module>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 241b43e..a312e10 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 72a971e..360b5f9 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index dddd30f..c399a68 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 5a16478..a96d806 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 0ddd332..a04c5f1 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index e358904..ba069ac 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 62f9312..f32b62f 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 0afab9e..bed1ddc 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.1.0-SNAPSHOT</version>
+  <version>2.1.0-RC1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.1.0-RC1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0075719..1a12b9d 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 78ac79d..edaaae1 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 75831b6..67e549e 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index ef08092..e59a480 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 44fa83b..f72b50f 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-SNAPSHOT</version>
+    <version>2.1.0-RC1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index a312e10..241b43e 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 360b5f9..72a971e 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index c399a68..dddd30f 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index a96d806..5a16478 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index a04c5f1..0ddd332 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index ba069ac..e358904 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index f32b62f..62f9312 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index bed1ddc..0afab9e 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.1.0-RC1</version>
+  <version>2.1.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.1.0-RC1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 1a12b9d..0075719 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index edaaae1..78ac79d 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 67e549e..75831b6 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index e59a480..ef08092 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index f72b50f..44fa83b 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.1.0-RC1</version>
+    <version>2.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 2693c05..068af99 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,14 @@
 Change Log
 ==========
 
+## VERSION 2.1.0
+
+_2014-11-11_
+
+ *  New: Typesafe APIs for interacting with cipher suites and TLS versions.
+ *  Fix: Don't crash when mixing authorization challenges with upload retries.
+
+
 ## VERSION 2.1.0-RC1
 
 _2014-11-04_
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/ConnectionPoolTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/ConnectionPoolTest.java
index 04b9c15..6dff916 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/ConnectionPoolTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/ConnectionPoolTest.java
@@ -26,6 +26,7 @@
 import java.net.Proxy;
 import java.util.Arrays;
 import java.util.List;
+import java.util.concurrent.Executor;
 import javax.net.SocketFactory;
 import javax.net.ssl.SSLContext;
 import org.junit.After;
@@ -53,6 +54,7 @@
   private InetSocketAddress httpSocketAddress;
 
   private ConnectionPool pool;
+  private FakeExecutor cleanupExecutor;
   private Connection httpA;
   private Connection httpB;
   private Connection httpC;
@@ -96,6 +98,9 @@
     Route spdyRoute = new Route(spdyAddress, Proxy.NO_PROXY, spdySocketAddress,
         ConnectionSpec.MODERN_TLS);
     pool = new ConnectionPool(poolSize, KEEP_ALIVE_DURATION_MS);
+    // Disable the automatic execution of the cleanup.
+    cleanupExecutor = new FakeExecutor();
+    pool.replaceCleanupExecutorForTests(cleanupExecutor);
     httpA = new Connection(pool, httpRoute);
     httpA.connect(200, 200, 200, null);
     httpB = new Connection(pool, httpRoute);
@@ -160,10 +165,31 @@
     assertNull(recycledConnection);
   }
 
+  @Test public void getDoesNotScheduleCleanup() {
+    Connection connection = pool.get(httpAddress);
+    assertNull(connection);
+    cleanupExecutor.assertExecutionScheduled(false);
+  }
+
+  @Test public void recycleSchedulesCleanup() {
+    cleanupExecutor.assertExecutionScheduled(false);
+    pool.recycle(httpA);
+    cleanupExecutor.assertExecutionScheduled(true);
+  }
+
+  @Test public void shareSchedulesCleanup() {
+    cleanupExecutor.assertExecutionScheduled(false);
+    pool.share(spdyA);
+    cleanupExecutor.assertExecutionScheduled(true);
+  }
+
   @Test public void poolPrefersMostRecentlyRecycled() throws Exception {
     pool.recycle(httpA);
     pool.recycle(httpB);
     pool.recycle(httpC);
+    assertPooled(pool, httpC, httpB, httpA);
+
+    pool.performCleanup();
     assertPooled(pool, httpC, httpB);
   }
 
@@ -179,10 +205,18 @@
     assertPooled(pool);
   }
 
-  @Test public void idleConnectionNotReturned() throws Exception {
+  @Test public void expiredConnectionNotReturned() throws Exception {
     pool.recycle(httpA);
+
+    // Allow enough time to pass so that the connection is now expired.
     Thread.sleep(KEEP_ALIVE_DURATION_MS * 2);
+
+    // The connection is held, but will not be returned.
     assertNull(pool.get(httpAddress));
+    assertPooled(pool, httpA);
+
+    // The connection must be cleaned up.
+    pool.performCleanup();
     assertPooled(pool);
   }
 
@@ -191,21 +225,35 @@
     pool.recycle(httpB);
     pool.recycle(httpC);
     pool.recycle(httpD);
+    assertPooled(pool, httpD, httpC, httpB, httpA);
+
+    pool.performCleanup();
     assertPooled(pool, httpD, httpC);
   }
 
   @Test public void expiredConnectionsAreEvicted() throws Exception {
     pool.recycle(httpA);
     pool.recycle(httpB);
+
+    // Allow enough time to pass so that the connections are now expired.
     Thread.sleep(2 * KEEP_ALIVE_DURATION_MS);
-    pool.get(spdyAddress); // Force the cleanup callable to run.
+    assertPooled(pool, httpB, httpA);
+
+    // The connections must be cleaned up.
+    pool.performCleanup();
     assertPooled(pool);
   }
 
   @Test public void nonAliveConnectionNotReturned() throws Exception {
     pool.recycle(httpA);
+
+    // Close the connection. It is an ex-connection. It has ceased to be.
     httpA.getSocket().close();
+    assertPooled(pool, httpA);
     assertNull(pool.get(httpAddress));
+
+    // The connection must be cleaned up.
+    pool.performCleanup();
     assertPooled(pool);
   }
 
@@ -233,6 +281,10 @@
     httpA.getSocket().shutdownInput();
     pool.recycle(httpA); // Should close httpA.
     assertTrue(httpA.getSocket().isClosed());
+
+    // The pool should remain empty, and there is no need to schedule a cleanup.
+    assertPooled(pool);
+    cleanupExecutor.assertExecutionScheduled(false);
   }
 
   @Test public void shareHttpConnectionFails() throws Exception {
@@ -241,32 +293,43 @@
       fail();
     } catch (IllegalArgumentException expected) {
     }
+    // The pool should remain empty, and there is no need to schedule a cleanup.
     assertPooled(pool);
+    cleanupExecutor.assertExecutionScheduled(false);
   }
 
   @Test public void recycleSpdyConnectionDoesNothing() throws Exception {
     pool.recycle(spdyA);
+    // The pool should remain empty, and there is no need to schedule the cleanup.
     assertPooled(pool);
+    cleanupExecutor.assertExecutionScheduled(false);
   }
 
   @Test public void validateIdleSpdyConnectionTimeout() throws Exception {
     pool.share(spdyA);
-    Thread.sleep((int) (KEEP_ALIVE_DURATION_MS * 0.7));
-    assertNull(pool.get(httpAddress));
+    assertPooled(pool, spdyA); // Connection should be in the pool.
+
+    Thread.sleep((long) (KEEP_ALIVE_DURATION_MS * 0.7));
+    pool.performCleanup();
     assertPooled(pool, spdyA); // Connection should still be in the pool.
-    Thread.sleep((int) (KEEP_ALIVE_DURATION_MS * 0.4));
-    assertNull(pool.get(httpAddress));
-    assertPooled(pool);
+
+    Thread.sleep((long) (KEEP_ALIVE_DURATION_MS * 0.4));
+    pool.performCleanup();
+    assertPooled(pool); // Connection should have been removed.
   }
 
   @Test public void validateIdleHttpConnectionTimeout() throws Exception {
     pool.recycle(httpA);
-    Thread.sleep((int) (KEEP_ALIVE_DURATION_MS * 0.7));
-    assertNull(pool.get(spdyAddress));
+    assertPooled(pool, httpA); // Connection should be in the pool.
+    cleanupExecutor.assertExecutionScheduled(true);
+
+    Thread.sleep((long) (KEEP_ALIVE_DURATION_MS * 0.7));
+    pool.performCleanup();
     assertPooled(pool, httpA); // Connection should still be in the pool.
-    Thread.sleep((int) (KEEP_ALIVE_DURATION_MS * 0.4));
-    assertNull(pool.get(spdyAddress));
-    assertPooled(pool);
+
+    Thread.sleep((long) (KEEP_ALIVE_DURATION_MS * 0.4));
+    pool.performCleanup();
+    assertPooled(pool); // Connection should have been removed.
   }
 
   @Test public void maxConnections() throws IOException, InterruptedException {
@@ -285,21 +348,33 @@
     assertEquals(2, pool.getHttpConnectionCount());
     assertEquals(0, pool.getMultiplexedConnectionCount());
 
-    // http C should be added and http A should be removed.
+    // http C should be added
     pool.recycle(httpC);
-    Thread.sleep(50);
+    assertEquals(3, pool.getConnectionCount());
+    assertEquals(3, pool.getHttpConnectionCount());
+    assertEquals(0, pool.getSpdyConnectionCount());
+
+    pool.performCleanup();
+
+    // http A should be removed by cleanup.
     assertEquals(2, pool.getConnectionCount());
     assertEquals(2, pool.getHttpConnectionCount());
     assertEquals(0, pool.getMultiplexedConnectionCount());
 
-    // spdy A should be added and http B should be removed.
+    // spdy A should be added
     pool.share(spdyA);
-    Thread.sleep(50);
+    assertEquals(3, pool.getConnectionCount());
+    assertEquals(2, pool.getHttpConnectionCount());
+    assertEquals(1, pool.getSpdyConnectionCount());
+
+    pool.performCleanup();
+
+    // http B should be removed by cleanup.
     assertEquals(2, pool.getConnectionCount());
     assertEquals(1, pool.getHttpConnectionCount());
     assertEquals(1, pool.getMultiplexedConnectionCount());
 
-    // http C should be removed from the pool.
+    // http C should be returned.
     Connection recycledHttpConnection = pool.get(httpAddress);
     recycledHttpConnection.setOwner(owner);
     assertNotNull(recycledHttpConnection);
@@ -308,7 +383,7 @@
     assertEquals(0, pool.getHttpConnectionCount());
     assertEquals(1, pool.getMultiplexedConnectionCount());
 
-    // spdy A will be returned and kept in the pool.
+    // spdy A will be returned but also kept in the pool.
     Connection sharedSpdyConnection = pool.get(spdyAddress);
     assertNotNull(sharedSpdyConnection);
     assertEquals(spdyA, sharedSpdyConnection);
@@ -316,9 +391,8 @@
     assertEquals(0, pool.getHttpConnectionCount());
     assertEquals(1, pool.getMultiplexedConnectionCount());
 
-    // Nothing should change.
+    // http C should be added to the pool
     pool.recycle(httpC);
-    Thread.sleep(50);
     assertEquals(2, pool.getConnectionCount());
     assertEquals(1, pool.getHttpConnectionCount());
     assertEquals(1, pool.getMultiplexedConnectionCount());
@@ -331,7 +405,7 @@
     assertEquals(0, pool.getHttpConnectionCount());
     assertEquals(1, pool.getMultiplexedConnectionCount());
 
-    // spdy A will be returned and kept in the pool. Pool shouldn't change.
+    // spdy A will be returned but also kept in the pool.
     sharedSpdyConnection = pool.get(spdyAddress);
     assertEquals(spdyA, sharedSpdyConnection);
     assertNotNull(sharedSpdyConnection);
@@ -341,51 +415,52 @@
 
     // http D should be added to the pool.
     pool.recycle(httpD);
-    Thread.sleep(50);
     assertEquals(2, pool.getConnectionCount());
     assertEquals(1, pool.getHttpConnectionCount());
     assertEquals(1, pool.getMultiplexedConnectionCount());
 
-    // http E should be added to the pool. spdy A should be removed from the pool.
+    // http E should be added to the pool.
     pool.recycle(httpE);
-    Thread.sleep(50);
+    assertEquals(3, pool.getConnectionCount());
+    assertEquals(2, pool.getHttpConnectionCount());
+    assertEquals(1, pool.getSpdyConnectionCount());
+
+    pool.performCleanup();
+
+    // spdy A should be removed from the pool by cleanup.
     assertEquals(2, pool.getConnectionCount());
     assertEquals(2, pool.getHttpConnectionCount());
     assertEquals(0, pool.getMultiplexedConnectionCount());
   }
 
-  @Test public void connectionCleanup() throws IOException, InterruptedException {
+  @Test public void connectionCleanup() throws Exception {
     ConnectionPool pool = new ConnectionPool(10, KEEP_ALIVE_DURATION_MS);
 
     // Add 3 connections to the pool.
     pool.recycle(httpA);
     pool.recycle(httpB);
     pool.share(spdyA);
-    assertEquals(3, pool.getConnectionCount());
-    assertEquals(2, pool.getHttpConnectionCount());
-    assertEquals(1, pool.getMultiplexedConnectionCount());
 
     // Kill http A.
     Util.closeQuietly(httpA.getSocket());
 
-    // Force pool to run a clean up.
-    assertNotNull(pool.get(spdyAddress));
-    Thread.sleep(50);
+    assertEquals(3, pool.getConnectionCount());
+    assertEquals(2, pool.getHttpConnectionCount());
+    assertEquals(1, pool.getSpdyConnectionCount());
 
+    // Http A should be removed.
+    pool.performCleanup();
+    assertPooled(pool, spdyA, httpB);
     assertEquals(2, pool.getConnectionCount());
     assertEquals(1, pool.getHttpConnectionCount());
     assertEquals(1, pool.getMultiplexedConnectionCount());
 
-    Thread.sleep(KEEP_ALIVE_DURATION_MS);
-    // Force pool to run a clean up.
-    assertNull(pool.get(httpAddress));
-    assertNull(pool.get(spdyAddress));
+    // Now let enough time pass for the connections to expire.
+    Thread.sleep(2 * KEEP_ALIVE_DURATION_MS);
 
-    Thread.sleep(50);
-
+    // All remaining connections should be removed.
+    pool.performCleanup();
     assertEquals(0, pool.getConnectionCount());
-    assertEquals(0, pool.getHttpConnectionCount());
-    assertEquals(0, pool.getMultiplexedConnectionCount());
   }
 
   @Test public void evictAllConnections() throws Exception {
@@ -421,7 +496,57 @@
     }
   }
 
+  @Test public void cleanupRunnableStopsEventually() throws Exception {
+    pool.recycle(httpA);
+    pool.share(spdyA);
+    assertPooled(pool, spdyA, httpA);
+
+    // The cleanup should terminate once the pool is empty again.
+    cleanupExecutor.fakeExecute();
+    assertPooled(pool);
+
+    cleanupExecutor.assertExecutionScheduled(false);
+
+    // Adding a new connection should cause the cleanup to start up again.
+    pool.recycle(httpB);
+
+    cleanupExecutor.assertExecutionScheduled(true);
+
+    // The cleanup should terminate once the pool is empty again.
+    cleanupExecutor.fakeExecute();
+    assertPooled(pool);
+  }
+
   private void assertPooled(ConnectionPool pool, Connection... connections) throws Exception {
     assertEquals(Arrays.asList(connections), pool.getConnections());
   }
+
+  /**
+   * An executor that does not actually execute anything by default. See
+   * {@link #fakeExecute()}.
+   */
+  private static class FakeExecutor implements Executor {
+
+    private Runnable runnable;
+    
+    @Override
+    public void execute(Runnable runnable) {
+      // This is a bonus assertion for the invariant: At no time should two runnables be scheduled.
+      assertNull(this.runnable);
+      this.runnable = runnable;
+    }
+
+    public void assertExecutionScheduled(boolean expected) {
+      assertEquals(expected, runnable != null);
+    }
+
+    /**
+     * Executes the runnable.
+     */
+    public void fakeExecute() {
+      Runnable toRun = this.runnable;
+      this.runnable = null;
+      toRun.run();
+    }
+  }
 }
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/ConnectionPool.java b/okhttp/src/main/java/com/squareup/okhttp/ConnectionPool.java
index 5a09b2a..438b945 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/ConnectionPool.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/ConnectionPool.java
@@ -23,7 +23,7 @@
 import java.util.LinkedList;
 import java.util.List;
 import java.util.ListIterator;
-import java.util.concurrent.ExecutorService;
+import java.util.concurrent.Executor;
 import java.util.concurrent.LinkedBlockingQueue;
 import java.util.concurrent.ThreadPoolExecutor;
 import java.util.concurrent.TimeUnit;
@@ -78,40 +78,51 @@
 
   private final LinkedList<Connection> connections = new LinkedList<>();
 
-  /** We use a single background thread to cleanup expired connections. */
-  private final ExecutorService executorService = new ThreadPoolExecutor(0, 1,
-      60L, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>(),
-      Util.threadFactory("OkHttp ConnectionPool", true));
+  /**
+   * A background thread is used to cleanup expired connections. There will be, at most, a single
+   * thread running per connection pool.
+   *
+   * <p>A {@link ThreadPoolExecutor} is used and not a
+   * {@link java.util.concurrent.ScheduledThreadPoolExecutor}; ScheduledThreadPoolExecutors do not
+   * shrink. This executor shrinks the thread pool after a period of inactivity, and starts threads
+   * as needed. Delays are instead handled by the {@link #connectionsCleanupRunnable}. It is
+   * important that the {@link #connectionsCleanupRunnable} stops eventually, otherwise it will pin
+   * the thread, and thus the connection pool, in memory.
+   */
+  private Executor executor = new ThreadPoolExecutor(
+      0 /* corePoolSize */, 1 /* maximumPoolSize */, 60L /* keepAliveTime */, TimeUnit.SECONDS,
+      new LinkedBlockingQueue<Runnable>(), Util.threadFactory("OkHttp ConnectionPool", true));
+
+  /** {@code true} if the pool is actively draining, {@code false} if it is currently empty. */
+  private boolean draining;
+
   private final Runnable connectionsCleanupRunnable = new Runnable() {
+    // An executing connectionsCleanupRunnable keeps a reference to the enclosing ConnectionPool,
+    // preventing the ConnectionPool from being garbage collected before all held connections have
+    // been explicitly closed. If this was not the case any open connections in the pool would
+    // trigger StrictMode violations in Android when they were garbage collected. http://b/18369687
     @Override public void run() {
-      List<Connection> expiredConnections = new ArrayList<>(MAX_CONNECTIONS_TO_CLEANUP);
-      int idleConnectionCount = 0;
-      synchronized (ConnectionPool.this) {
-        for (ListIterator<Connection> i = connections.listIterator(connections.size());
-            i.hasPrevious(); ) {
-          Connection connection = i.previous();
-          if (!connection.isAlive() || connection.isExpired(keepAliveDurationNs)) {
-            i.remove();
-            expiredConnections.add(connection);
-            if (expiredConnections.size() == MAX_CONNECTIONS_TO_CLEANUP) break;
-          } else if (connection.isIdle()) {
-            idleConnectionCount++;
+      while (true) {
+        performCleanup();
+
+        // See whether this runnable should continue executing.
+        synchronized(ConnectionPool.this) {
+          if (connections.size() == 0) {
+            draining = false;
+            return;
           }
         }
 
-        for (ListIterator<Connection> i = connections.listIterator(connections.size());
-            i.hasPrevious() && idleConnectionCount > maxIdleConnections; ) {
-          Connection connection = i.previous();
-          if (connection.isIdle()) {
-            expiredConnections.add(connection);
-            i.remove();
-            --idleConnectionCount;
-          }
+        // Pause to avoid checking the pool too regularly, which would drain the battery on mobile
+        // devices.
+        try {
+          // Use the keep alive duration as a rough indicator of a good check interval.
+          long keepAliveDurationMillis = keepAliveDurationNs / (1000 * 1000);
+          Thread.sleep(keepAliveDurationMillis);
+        } catch (InterruptedException e) {
+          // Ignored.
         }
       }
-      for (int i = 0, size = expiredConnections.size(); i < size; i++) {
-        Util.closeQuietly(expiredConnections.get(i).getSocket());
-      }
     }
   };
 
@@ -120,32 +131,6 @@
     this.keepAliveDurationNs = keepAliveDurationMs * 1000 * 1000;
   }
 
-  /**
-   * Returns a snapshot of the connections in this pool, ordered from newest to
-   * oldest. Waits for the cleanup callable to run if it is currently scheduled.
-   */
-  List<Connection> getConnections() {
-    waitForCleanupCallableToRun();
-    synchronized (this) {
-      return new ArrayList<>(connections);
-    }
-  }
-
-  /**
-   * Blocks until the executor service has processed all currently enqueued
-   * jobs.
-   */
-  private void waitForCleanupCallableToRun() {
-    try {
-      executorService.submit(new Runnable() {
-        @Override public void run() {
-        }
-      }).get();
-    } catch (Exception e) {
-      throw new AssertionError();
-    }
-  }
-
   public static ConnectionPool getDefault() {
     return systemDefault;
   }
@@ -203,9 +188,9 @@
 
     if (foundConnection != null && foundConnection.isSpdy()) {
       connections.addFirst(foundConnection); // Add it back after iteration.
+      scheduleCleanupAsRequired();
     }
 
-    executorService.execute(connectionsCleanupRunnable);
     return foundConnection;
   }
 
@@ -242,9 +227,8 @@
       connections.addFirst(connection);
       connection.incrementRecycleCount();
       connection.resetIdleStartTime();
+      scheduleCleanupAsRequired();
     }
-
-    executorService.execute(connectionsCleanupRunnable);
   }
 
   /**
@@ -253,10 +237,10 @@
    */
   void share(Connection connection) {
     if (!connection.isSpdy()) throw new IllegalArgumentException();
-    executorService.execute(connectionsCleanupRunnable);
     if (connection.isAlive()) {
       synchronized (this) {
         connections.addFirst(connection);
+        scheduleCleanupAsRequired();
       }
     }
   }
@@ -273,4 +257,68 @@
       Util.closeQuietly(connections.get(i).getSocket());
     }
   }
+
+  // Callers must synchronize on "this".
+  private void scheduleCleanupAsRequired() {
+    if (!draining) {
+      // A new connection has potentially been offered up to an empty / drained pool.
+      // Start the clean-up immediately.
+      draining = true;
+      executor.execute(connectionsCleanupRunnable);
+    }
+  }
+
+  /** Performs a single round of pool cleanup. */
+  // VisibleForTesting
+  void performCleanup() {
+    List<Connection>expiredConnections = new ArrayList<>(MAX_CONNECTIONS_TO_CLEANUP);
+    int idleConnectionCount = 0;
+    synchronized (this) {
+      for (ListIterator<Connection> i = connections.listIterator(connections.size());
+          i.hasPrevious(); ) {
+        Connection connection = i.previous();
+        if (!connection.isAlive() || connection.isExpired(keepAliveDurationNs)) {
+          i.remove();
+          expiredConnections.add(connection);
+          if (expiredConnections.size() == MAX_CONNECTIONS_TO_CLEANUP) {
+            break;
+          }
+        } else if (connection.isIdle()) {
+          idleConnectionCount++;
+        }
+      }
+
+      for (ListIterator<Connection> i = connections.listIterator(connections.size());
+          i.hasPrevious() && idleConnectionCount > maxIdleConnections; ) {
+        Connection connection = i.previous();
+        if (connection.isIdle()) {
+          expiredConnections.add(connection);
+          i.remove();
+          --idleConnectionCount;
+        }
+      }
+    }
+
+    for (Connection expiredConnection : expiredConnections) {
+      Util.closeQuietly(expiredConnection.getSocket());
+    }
+  }
+
+  /**
+   * Replace the default {@link Executor} with a different one. Only use in tests.
+   */
+  // VisibleForTesting
+  void replaceCleanupExecutorForTests(Executor cleanupExecutor) {
+    this.executor = cleanupExecutor;
+  }
+
+  /**
+   * Returns a snapshot of the connections in this pool, ordered from newest to
+   * oldest. Only use in tests.
+   */
+  List<Connection> getConnections() {
+    synchronized (this) {
+      return new ArrayList<>(connections);
+    }
+  }
 }
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 068af99..756d35d 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,48 @@
 Change Log
 ==========
 
+## VERSION 2.2.0
+
+_2014-12-30_
+
+ *  **`RequestBody.contentLength()` now throws `IOException`.**
+    This is a source-incompatible change. If you have code that calls
+    `RequestBody.contentLength()`, your compile will break with this
+    update. The change is binary-compatible, however: code compiled
+    for OkHttp 2.0 and 2.1 will continue work with this update.
+
+ *  **`COMPATIBLE_TLS` no longer supports SSLv3.** In response to the
+    [POODLE](http://googleonlinesecurity.blogspot.ca/2014/10/this-poodle-bites-exploiting-ssl-30.html)
+    vulnerability, OkHttp no longer offers SSLv3 when negotiation an
+    HTTPS connection. If you continue to need to connect to webservers
+    running SSLv3, you must manually configure your own `ConnectionSpec`.
+
+ *  **OkHttp now offers interceptors.** Interceptors are a powerful mechanism
+    that can monitor, rewrite, and retry calls. The [project
+    wiki](https://github.com/square/okhttp/wiki/Interceptors) has a full
+    introduction to this new API.
+
+ *  New: APIs to iterate and selectively clear the response cache.
+ *  New: Support for SOCKS proxies.
+ *  New: Support for `TLS_FALLBACK_SCSV`.
+ *  New: Update HTTP/2 support to to `h2-16` and `hpack-10`.
+ *  New: APIs to prevent retrying non-idempotent requests.
+ *  Fix: Drop NPN support. Going forward we support ALPN only.
+ *  Fix: The hostname verifier is now strict. This is consistent with the hostname
+    verifier in modern browsers.
+ *  Fix: Improve `CONNECT` handling for misbehaving HTTP proxies.
+ *  Fix: Don't retry requests that failed due to timeouts.
+ *  Fix: Cache 302s and 308s that include appropriate response headers.
+ *  Fix: Improve pooling of connections that use proxy selectors.
+ *  Fix: Don't leak connections when using ALPN on the desktop.
+ *  Fix: Update Jetty ALPN to `7.1.2.v20141202` (Java 7) and 8.1.2.v20141202 (Java 8).
+    This fixes a bug in resumed TLS sessions where the wrong protocol could be
+    selected.
+ *  Fix: Don't crash in SPDY and HTTP/2 when disconnecting before connecting.
+ *  Fix: Avoid a reverse DNS-lookup for a numeric proxy address
+ *  Fix: Resurrect http/2 frame logging.
+ *  Fix: Limit to 20 authorization attempts.
+
 ## VERSION 2.1.0
 
 _2014-11-11_
/Fim/
diff --git a/pom.xml b/pom.xml
index 03ae12c..2a444d1 100644
--- a/pom.xml
+++ b/pom.xml
@@ -34,7 +34,7 @@
 
     <!-- Compilation -->
     <java.version>1.7</java.version>
-    <okio.version>1.1.0</okio.version>
+    <okio.version>1.2.0</okio.version>
     <!-- ALPN library targeted to Java 7 -->
     <alpn.jdk7.version>7.1.2.v20141202</alpn.jdk7.version>
     <!-- ALPN library targeted to Java 8 update 25. -->
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index ae3a70a..5e0001f 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 892151e..5a17b43 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 205e9e2..05c6518 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 91413f2..5551fad 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index e4ac7ec..02331fc 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 3c27625..82c862b 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 86bfe6f..8e0c830 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 2a444d1..b7078df 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.2.0-SNAPSHOT</version>
+  <version>2.2.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.2.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 13a6d22..4da2579 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 6aa64c3..3aaf38e 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index c161b02..d88ca52 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 6f67160..e0162f6 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index db0b1d8..7ce8685 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0-SNAPSHOT</version>
+    <version>2.2.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 5e0001f..4fde956 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 5a17b43..b710a1e 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 05c6518..0479834 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 5551fad..4031304 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 02331fc..face99d 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 82c862b..790f596 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8e0c830..b723221 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index b7078df..bfc0d9c 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.2.0</version>
+  <version>2.3.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -53,7 +53,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.2.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 4da2579..2be2bab 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 3aaf38e..1cc1b6a 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d88ca52..6991fa9 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index e0162f6..3ebf058 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 7ce8685..e3dc358 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.2.0</version>
+    <version>2.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/website/index.html b/website/index.html
index b6287c2..57c412f 100644
--- a/website/index.html
+++ b/website/index.html
@@ -48,7 +48,7 @@
 
             <p>OkHttp is an HTTP client thats efficient by default:</p>
             <ul>
-                <li>SPDY support allows all requests to the same host to share a socket.</li>
+                <li>HTTP/2 and SPDY support allows all requests to the same host to share a socket.</li>
                 <li>Connection pooling reduces request latency (if SPDY isnt available).</li>
                 <li>Transparent GZIP shrinks download sizes.</li>
                 <li>Response caching avoids the network completely for repeat requests.</li>
@@ -58,7 +58,7 @@
                 common connection problems. If your service has multiple IP addresses OkHttp will
                 attempt alternate addresses if the first connect fails. This is necessary for IPv4+IPv6
                 and for services hosted in redundant data centers. OkHttp initiates new connections
-                with modern TLS features (SNI, ALPN), and falls back to SSLv3 if the handshake
+                with modern TLS features (SNI, ALPN), and falls back to TLS 1.0 if the handshake
                 fails.</p>
 
             <p>Using OkHttp is easy. Its 2.0 API is designed with fluent builders and
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 71a5041..820c4fc 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,7 +1,64 @@
 Change Log
 ==========
 
-## VERSION 2.2.0
+## Version 2.3.0
+
+_2015-03-16_
+
+ *  **HTTP/2 support.** We've done interop testing and haven't seen any
+    problems. HTTP/2 support has been a big effort and we're particularly
+    thankful to Adrian Cole who has helped us to reach this milestone.
+
+ *  **RC4 cipher suites are no longer supported by default.** To connect to
+    old, obsolete servers relying on these cipher suites, you must create a
+    custom `ConnectionSpec`.
+
+ *  **Beta WebSockets support.**. The `okhttp-ws` subproject offers a new
+    websockets client. Please try it out! When it's ready we intend to include
+    it with the core OkHttp library.
+
+ *  **Okio updated to 1.3.0.**
+
+    ```
+    <dependency>
+      <groupId>com.squareup.okio</groupId>
+      <artifactId>okio</artifactId>
+      <version>1.3.0</version>
+    </dependency>
+    ```
+
+ *  **Fix: improve parallelism of async requests.** OkHttp's Dispatcher had a
+    misconfigured `ExecutorService` that limited the number of worker threads.
+    If you're using `Call.enqueue()` this update should significantly improve
+    request concurrency.
+
+ *  **Fix: Lazily initialize the response cache.** This avoids strict mode
+    warnings when initializing OkHttp on Androids main thread.
+
+ *  **Fix: Disable ALPN on Android 4.4.** That release of the feature was
+    unstable and prone to native crashes in the underlying OpenSSL code.
+ *  Fix: Don't send both `If-None-Match` and `If-Modified-Since` cache headers
+    when both are applicable.
+ *  Fix: Fail early when a port is out of range.
+ *  Fix: Offer `Content-Length` headers for multipart request bodies.
+ *  Fix: Throw `UnknownServiceException` if a cleartext connection is attempted
+    when explicitly forbidden.
+ *  Fix: Throw a `SSLPeerUnverifiedException` when host verification fails.
+ *  Fix: MockWebServer explicitly closes sockets. (On some Android releases,
+    closing the input stream and output stream of a socket is not sufficient.
+ *  Fix: Buffer outgoing HTTP/2 frames to limit how many outgoing frames are
+    created.
+ *  Fix: Avoid crashing when cache writing fails due to a full disk.
+ *  Fix: Improve caching of private responses.
+ *  Fix: Update cache-by-default response codes.
+ *  Fix: Reused `Request.Builder` instances no longer hold stale URL fields.
+ *  New: ConnectionSpec can now be configured to use the SSL socket's default
+    cipher suites. To use, set the cipher suites to `null`.
+ *  New: Support `DELETE` with a request body.
+ *  New: `Headers.of(Map)` creates headers from a Map.
+
+
+## Version 2.2.0
 
 _2014-12-30_
 
@@ -43,7 +100,7 @@
  *  Fix: Resurrect http/2 frame logging.
  *  Fix: Limit to 20 authorization attempts.
 
-## VERSION 2.1.0
+## Version 2.1.0
 
 _2014-11-11_
 
@@ -51,7 +108,7 @@
  *  Fix: Don't crash when mixing authorization challenges with upload retries.
 
 
-## VERSION 2.1.0-RC1
+## Version 2.1.0-RC1
 
 _2014-11-04_
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 4fde956..904e9e5 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 2ffd96d..a193e8f 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 0479834..094a619 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index f00d51a..a290413 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 4031304..8fb7c3f 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index face99d..e9309c6 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 790f596..2a432ba 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 29f464e..ee43fb9 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index b0a77f5..ee59125 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index b723221..23d7d35 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 4c75ae7..014973a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.3.0-SNAPSHOT</version>
+  <version>2.3.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -60,7 +60,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.3.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 2be2bab..47c6751 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 31ec4d4..4510f46 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 6991fa9..5cc3930 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 3ebf058..872a2a4 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index e3dc358..6cc64e5 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0-SNAPSHOT</version>
+    <version>2.3.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 904e9e5..3a5fccd 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index a193e8f..86d2503 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 094a619..467c170 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index a290413..74f15fc 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 8fb7c3f..2eafbad 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index e9309c6..e3a9966 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 2a432ba..932a072 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index ee43fb9..424f4a5 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index ee59125..ae34464 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 23d7d35..1cd007c 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 014973a..60c4f01 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.3.0</version>
+  <version>2.4.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -60,7 +60,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.3.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 47c6751..59f51d3 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 4510f46..299b065 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 5cc3930..83b45a9 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 872a2a4..e3cb146 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 6cc64e5..9771c9e 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.3.0</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp-apache/src/main/java/com/squareup/okhttp/apache/OkApacheClient.java b/okhttp-apache/src/main/java/com/squareup/okhttp/apache/OkApacheClient.java
index d307a33..3a9174a 100644
--- a/okhttp-apache/src/main/java/com/squareup/okhttp/apache/OkApacheClient.java
+++ b/okhttp-apache/src/main/java/com/squareup/okhttp/apache/OkApacheClient.java
@@ -67,6 +67,8 @@
         if (encoding != null) {
           builder.header(encoding.getName(), encoding.getValue());
         }
+      } else {
+        body = RequestBody.create(null, new byte[0]);
       }
     }
     builder.method(method, body);
/Fim/
diff --git a/okhttp-apache/src/test/java/com/squareup/okhttp/apache/OkApacheClientTest.java b/okhttp-apache/src/test/java/com/squareup/okhttp/apache/OkApacheClientTest.java
index fd66fda..105f22f 100644
--- a/okhttp-apache/src/test/java/com/squareup/okhttp/apache/OkApacheClientTest.java
+++ b/okhttp-apache/src/test/java/com/squareup/okhttp/apache/OkApacheClientTest.java
@@ -16,6 +16,7 @@
 import org.apache.http.HttpResponse;
 import org.apache.http.client.methods.HttpGet;
 import org.apache.http.client.methods.HttpPost;
+import org.apache.http.client.methods.HttpPut;
 import org.apache.http.entity.ByteArrayEntity;
 import org.apache.http.entity.InputStreamEntity;
 import org.apache.http.entity.StringEntity;
@@ -113,6 +114,24 @@
     assertEquals("Hello, world!", request.getBody().readUtf8());
     assertEquals(request.getHeader("Content-Length"), "13");
   }
+  @Test public void postEmptyEntity() throws Exception {
+    server.enqueue(new MockResponse());
+    final HttpPost post = new HttpPost(server.getUrl("/").toURI());
+    client.execute(post);
+    
+    RecordedRequest request = server.takeRequest();
+    assertEquals(0, request.getBodySize());
+    assertNotNull(request.getBody());
+  }
+  @Test public void putEmptyEntity() throws Exception {
+    server.enqueue(new MockResponse());
+    final HttpPut put = new HttpPut(server.getUrl("/").toURI());
+    client.execute(put);
+    
+    RecordedRequest request = server.takeRequest();
+    assertEquals(0, request.getBodySize());
+    assertNotNull(request.getBody());
+  }
 
   @Test public void postOverrideContentType() throws Exception {
     server.enqueue(new MockResponse());
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 3a5fccd..38ce1f6 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 3603a84..b1183fa 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index d167ce1..a453a06 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 3bf11e9..431d46e 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6bc872b..db1073e 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index ad016c8..f5ee733 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index bcf1268..e0264b1 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index a093827..0e7619a 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index af4ea7e..e0dc160 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index ae34464..99b1fbf 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 1cd007c..2bd2d83 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 42598a7..34b9ad2 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.4.0-SNAPSHOT</version>
+  <version>2.4.0-RC1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -61,7 +61,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.4.0-RC1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 59f51d3..24a061e 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 299b065..ec5831c 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 83b45a9..8e26be6 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index e3cb146..6861f50 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 9771c9e..1722458 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0-RC1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 38ce1f6..3a5fccd 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index b1183fa..3603a84 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index a453a06..d167ce1 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 431d46e..3bf11e9 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index db1073e..6bc872b 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index f5ee733..ad016c8 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index e0264b1..bcf1268 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 0e7619a..a093827 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index e0dc160..af4ea7e 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 99b1fbf..ae34464 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 2bd2d83..1cd007c 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 34b9ad2..42598a7 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.4.0-RC1</version>
+  <version>2.4.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -61,7 +61,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.4.0-RC1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 24a061e..59f51d3 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index ec5831c..299b065 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 8e26be6..83b45a9 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 6861f50..e3cb146 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 1722458..9771c9e 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-RC1</version>
+    <version>2.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 820c4fc..b695525 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,81 @@
 Change Log
 ==========
 
+## Version 2.4.0-RC1
+
+_2015-05-16_
+
+ *  **New HttpUrl API.** It's like `java.net.URL` but good.
+
+ *  **We've improved connect failure recovery.** We now differentiate between
+    setup, connecting, and connected and implement appropriate recovery rules
+    for each. This changes `Address` to no longer use `ConnectionSpec`. (This is
+    an incompatible API change).
+
+ *  **`FormEncodingBuilder` now uses `%20` instead of `+` for encoded spaces.**
+    Both are permitted-by-spec, but `%20` requires fewer special cases.
+
+ *  **Okio has been updated to 1.4.0.**
+     ```
+     <dependency>
+       <groupId>com.squareup.okio</groupId>
+       <artifactId>okio</artifactId>
+       <version>1.4.0</version>
+     </dependency>
+     ```
+
+ *  **`Request.Builder` no longer accepts null if a request body is required.**
+    Passing null will now fail for request methods that require a body. Instead
+    use an empty body such as this one:
+
+    ```
+        RequestBody.create(null, new byte[0]);
+    ```
+
+ * **`CertificatePinner` now supports wildcard hostnames.** As always with
+   certificate pinning, you must be very careful to avoid [bricking][brick]
+   your app. You'll need to pin both the top-level domain and the `*.` domain
+   for full coverage.
+
+    ```
+     client.setCertificatePinner(new CertificatePinner.Builder()
+         .add("publicobject.com",   "sha1/DmxUShsZuNiqPQsX2Oi9uv2sCnw=")
+         .add("*.publicobject.com", "sha1/DmxUShsZuNiqPQsX2Oi9uv2sCnw=")
+         .add("publicobject.com",   "sha1/SXxoaOSEzPC6BgGmxAt/EAcsajw=")
+         .add("*.publicobject.com", "sha1/SXxoaOSEzPC6BgGmxAt/EAcsajw=")
+         .add("publicobject.com",   "sha1/blhOM3W9V/bVQhsWAcLYwPU6n24=")
+         .add("*.publicobject.com", "sha1/blhOM3W9V/bVQhsWAcLYwPU6n24=")
+         .add("publicobject.com",   "sha1/T5x9IXmcrQ7YuQxXnxoCmeeQ84c=")
+         .add("*.publicobject.com", "sha1/T5x9IXmcrQ7YuQxXnxoCmeeQ84c=")
+         .build());
+    ```
+
+ *  **Interceptors lists are now deep-copied by `OkHttpClient.clone()`.**
+    Previously clones shared interceptors, which made it difficult to customize
+    the interceptors on a request-by-request basis.
+
+ *  New: `Headers.toMultimap()`.
+ *  New: `RequestBody.create(MediaType, ByteString)`.
+ *  New: `ConnectionSpec.isCompatible(SSLSocket)`.
+ *  New: `Dispatcher.getQueuedCallCount()` and
+    `Dispatcher.getRunningCallCount()`. These can be useful in diagnostics.
+ *  Fix: OkHttp no longer shares timeouts between pooled connections. This was
+    causing some applications to crash when connections were reused.
+ *  Fix: `OkApacheClient` now allows an empty `PUT` and `POST`.
+ *  Fix: Websockets no longer rebuffer socket streams.
+ *  Fix: Websockets are now better at handling close frames.
+ *  Fix: Content type matching is now case insensitive.
+ *  Fix: `Vary` headers are not lost with `android.net.http.HttpResponseCache`.
+ *  Fix: HTTP/2 wasn't enforcing stream timeouts when writing the underlying
+    connection. Now it is.
+ *  Fix: Never return null on `call.proceed()`. This was a bug in call
+    cancelation.
+ *  Fix: When a network interceptor mutates a request, that change is now
+    reflected in `Response.networkResponse()`.
+ *  Fix: Badly-behaving caches now throw a checked exception instead of a
+    `NullPointerException`.
+ *  Fix: Better handling of uncaught exceptions in MockWebServer with HTTP/2.
+
 ## Version 2.3.0
 
 _2015-03-16_
@@ -543,3 +618,4 @@
 
 Initial release.
 
+ [brick]: (https://noncombatant.org/2015/05/01/about-http-public-key-pinning/)
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/WebPlatformUrlTestData.java b/okhttp-tests/src/test/java/com/squareup/okhttp/WebPlatformUrlTestData.java
index 08bc9e3..2ea3693 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/WebPlatformUrlTestData.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/WebPlatformUrlTestData.java
@@ -29,8 +29,9 @@
  * attempts to be compatible.
  *
  * <p>Each line of the urltestdata.text file specifies a test. Lines look like this: <pre>   {@code
+ *
  *   http://example\t.\norg http://example.org/foo/bar s:http h:example.org p:/
- * }
+ * }</pre>
  */
 public final class WebPlatformUrlTestData {
   String input;
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/HttpUrl.java b/okhttp/src/main/java/com/squareup/okhttp/HttpUrl.java
index 709372d..795bd75 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/HttpUrl.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/HttpUrl.java
@@ -182,7 +182,7 @@
  * Java includes both {@link URL java.net.URL} and {@link URI java.net.URI}. We offer a new URL
  * model to address problems that the others don't.
  *
- * <h3>Different URLs should be different</h3>
+ * <h4>Different URLs should be different</h4>
  * Although they have different content, {@code java.net.URL} considers the following two URLs
  * equal, and the {@link Object#equals equals()} method between them returns true:
  * <ul>
@@ -195,7 +195,7 @@
  * require a DNS lookup, and incorrect because unequal URLs may be equal because of how they are
  * hosted.
  *
- * <h3>Equal URLs should be equal</h3>
+ * <h4>Equal URLs should be equal</h4>
  * These two URLs are semantically identical, but {@code java.net.URI} disagrees:
  * <ul>
  *   <li>http://host:80/
@@ -225,21 +225,21 @@
  *    /etc/passwd
  * }</pre>
  *
- * <h3>If it works on the web, it should work in your application</h3>
+ * <h4>If it works on the web, it should work in your application</h4>
  * The {@code java.net.URI} class is strict around what URLs it accepts. It rejects URLs like
  * "http://example.com/abc|def" because the '|' character is unsupported. This class is more
  * forgiving: it will automatically percent-encode the '|', yielding "http://example.com/abc%7Cdef".
  * This kind behavior is consistent with web browsers. {@code HttpUrl} prefers consistency with
  * major web browsers over consistency with obsolete specifications.
  *
- * <h3>Paths and Queries should decompose</h3>
+ * <h4>Paths and Queries should decompose</h4>
  * Neither of the built-in URL models offer direct access to path segments or query parameters.
  * Manually using {@code StringBuilder} to assemble these components is cumbersome: do '+'
  * characters get silently replaced with spaces? If a query parameter contains a '&amp;', does that
  * get escaped? By offering methods to read and write individual query parameters directly,
  * application developers are saved from the hassles of encoding and decoding.
  *
- * <h3>Plus a modern API</h3>
+ * <h4>Plus a modern API</h4>
  * The URL (JDK1.0) and URI (Java 1.4) classes predate builders and instead use telescoping
  * constructors. For example, there's no API to compose a URI with a custom port without also
  * providing a query and fragment.
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index b695525..0fe03ab 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,19 @@
 Change Log
 ==========
 
+## Version 2.4.0
+
+_2015-05-22_
+
+ *  **Forbid response bodies on HTTP 204 and 205 responses.** Webservers that
+    return such malformed responses will now trigger a `ProtocolException` in
+    the client.
+
+ *  **WebSocketListener has incompatible changes.** The `onOpen()` method is now
+    called on the reader thread, so implementations must return before further
+    websocket messages will be delivered. The `onFailure()` method now includes
+    an HTTP response if one was returned.
+
 ## Version 2.4.0-RC1
 
 _2015-05-16_
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 3a5fccd..74838ce 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 3603a84..6565fe1 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index d167ce1..bc617fe 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 3bf11e9..3973de8 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6bc872b..991e017 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index ad016c8..e346e82 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index bcf1268..85eb343 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index a093827..1612d5f 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index af4ea7e..4a1917b 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index ae34464..760a4a5 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 1cd007c..436b85a 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 42598a7..ed711ea 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.4.0-SNAPSHOT</version>
+  <version>2.4.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -61,7 +61,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.4.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 59f51d3..51c287e 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 299b065..49d060d 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 83b45a9..26a7ef6 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index e3cb146..56b5be0 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 9771c9e..7d6476c 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0-SNAPSHOT</version>
+    <version>2.4.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 74838ce..a56c411 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 6565fe1..a2f5b2c 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index bc617fe..70cab20 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 3973de8..5453b95 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 991e017..7072283 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index e346e82..a82d9b9 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 85eb343..ae31be7 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 1612d5f..7b7ee3f 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 4a1917b..870b99c 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 760a4a5..80561c1 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 436b85a..8d8b524 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index ed711ea..1e84f88 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.4.0</version>
+  <version>2.5.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -61,7 +61,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.4.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 51c287e..1703c30 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 49d060d..c1c1339 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 26a7ef6..e2be70e 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 56b5be0..a609292 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 7d6476c..6432b40 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.4.0</version>
+    <version>2.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/HttpOverSpdyTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/HttpOverSpdyTest.java
index ab8f3c9..be9fca2 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/HttpOverSpdyTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/HttpOverSpdyTest.java
@@ -32,6 +32,7 @@
 import java.net.Authenticator;
 import java.net.CookieManager;
 import java.net.HttpURLConnection;
+import java.net.SocketTimeoutException;
 import java.net.URL;
 import java.util.Arrays;
 import java.util.Collections;
@@ -307,8 +308,8 @@
     try {
       readAscii(connection.getInputStream(), Integer.MAX_VALUE);
       fail("Should have timed out!");
-    } catch (IOException e){
-      assertEquals("timeout", e.getMessage());
+    } catch (SocketTimeoutException expected) {
+      assertEquals("timeout", expected.getMessage());
     }
   }
 
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
index bf22e15..bb9a261 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/URLConnectionTest.java
@@ -57,6 +57,7 @@
 import java.net.ServerSocket;
 import java.net.Socket;
 import java.net.SocketAddress;
+import java.net.SocketTimeoutException;
 import java.net.URI;
 import java.net.URL;
 import java.net.URLConnection;
@@ -2202,7 +2203,7 @@
     try {
       in.read(); // if Content-Length was accurate, this would return -1 immediately
       fail();
-    } catch (IOException expected) {
+    } catch (SocketTimeoutException expected) {
     }
   }
 
@@ -2238,7 +2239,7 @@
       byte[] data = new byte[16 * 1024 * 1024]; // 16 MiB.
       out.write(data);
       fail();
-    } catch (IOException expected) {
+    } catch (SocketTimeoutException expected) {
     }
   }
 
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/internal/spdy/SpdyStream.java b/okhttp/src/main/java/com/squareup/okhttp/internal/spdy/SpdyStream.java
index 05ce57a..1c1f76f 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/internal/spdy/SpdyStream.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/internal/spdy/SpdyStream.java
@@ -19,6 +19,7 @@
 import java.io.EOFException;
 import java.io.IOException;
 import java.io.InterruptedIOException;
+import java.net.SocketTimeoutException;
 import java.util.ArrayList;
 import java.util.List;
 import okio.AsyncTimeout;
@@ -596,12 +597,21 @@
    * notify the waiting thread.
    */
   class SpdyTimeout extends AsyncTimeout {
+
     @Override protected void timedOut() {
       closeLater(ErrorCode.CANCEL);
     }
 
-    public void exitAndThrowIfTimedOut() throws InterruptedIOException {
-      if (exit()) throw new InterruptedIOException("timeout");
+    @Override protected IOException newTimeoutException(IOException cause) {
+      SocketTimeoutException socketTimeoutException = new SocketTimeoutException("timeout");
+      if (cause != null) {
+        socketTimeoutException.initCause(cause);
+      }
+      return socketTimeoutException;
+    }
+
+    public void exitAndThrowIfTimedOut() throws IOException {
+      if (exit()) throw newTimeoutException(null /* cause */);
     }
   }
 }
/Fim/
diff --git a/pom.xml b/pom.xml
index 1e84f88..c4629bb 100644
--- a/pom.xml
+++ b/pom.xml
@@ -42,7 +42,7 @@
 
     <!-- Compilation -->
     <java.version>1.7</java.version>
-    <okio.version>1.4.0</okio.version>
+    <okio.version>1.5.0-SNAPSHOT</okio.version>
     <!-- ALPN library targeted to Java 7 -->
     <alpn.jdk7.version>7.1.2.v20141202</alpn.jdk7.version>
     <!-- ALPN library targeted to Java 8 update 25. -->
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index a9cd519..154c90d 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,44 @@
 Change Log
 ==========
 
+## Version 2.5.0
+
+_2015-08-25_
+
+ *  **OkHttp now rejects request headers that contain invalid characters.** This
+    includes potential security problems (newline characters) as well as simple
+    non-ASCII characters (including international characters and emoji).
+
+ *  **Call canceling is more reliable.**  We had a bug where a socket being
+     connected wasn't being closed when the application used `Call.cancel()`.
+
+ *  **Changing a HttpUrls scheme now tracks the default port.** We had a bug
+    where changing a URL from `http` to `https` would leave it on port 80.
+
+ *  **Okio has been updated to 1.6.0.**
+     ```
+     <dependency>
+       <groupId>com.squareup.okio</groupId>
+       <artifactId>okio</artifactId>
+       <version>1.6.0</version>
+     </dependency>
+     ```
+
+ *  New: `Cache.initialize()`. Call this on a background thread to eagerly
+    initialize the response cache.
+ *  New: Fold `MockWebServerRule` into `MockWebServer`. This makes it easier to
+    write JUnit tests with `MockWebServer`. The `MockWebServer` library now
+    depends on JUnit, though it continues to work with all testing frameworks.
+ *  Fix: Change `MockWebServer` to use the same logic as OkHttp when determining
+    whether an HTTP request permits a body.
+ *  Fix: `HttpUrl` now uses the canonical form for IPv6 addresses.
+ *  Fix: Use `HttpUrl` internally.
+ *  Fix: Recover from Android 4.2.2 EBADF crashes.
+ *  Fix: Don't crash with an `IllegalStateException` if an HTTP/2 or SPDY
+    write fails, leaving the connection in an inconsistent state.
+ *  Fix: Make sure the default user agent is ASCII.
+
+
 ## Version 2.4.0
 
 _2015-05-22_
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index a56c411..177dbcc 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 3d5c842..f5154ec 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 70cab20..2bde9ac 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 5453b95..ad8c7ab 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 7072283..c73b6a7 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 2b19def..5462077 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index ae31be7..7982fce 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 7b7ee3f..f336448 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 870b99c..a34549c 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 80561c1..0777eeb 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8d8b524..d8d51e5 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 8be6c89..7faea29 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.5.0-SNAPSHOT</version>
+  <version>2.5.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -61,7 +61,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.5.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 1703c30..38d4851 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index c1c1339..927e72c 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index e2be70e..0a60564 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index a609292..203a5c4 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 6432b40..d6bc39d 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0-SNAPSHOT</version>
+    <version>2.5.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 177dbcc..d0d2566 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index f5154ec..9ef5211 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 2bde9ac..e80d121 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index ad8c7ab..f514808 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index c73b6a7..74ff837 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 5462077..654b0e3 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 7982fce..2bb1982 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index f336448..be60560 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index a34549c..c7d1778 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 0777eeb..81f8afd 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index d8d51e5..5cd1187 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 7faea29..7219018 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.5.0</version>
+  <version>2.6.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -61,7 +61,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.5.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 38d4851..aebd0eb 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 927e72c..55e2671 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 0a60564..29f1e87 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 203a5c4..3a1aa7d 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index d6bc39d..f223151 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.5.0</version>
+    <version>2.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 154c90d..68c9309 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -5,6 +5,11 @@
 
 _2015-08-25_
 
+ *  **Timeouts now default to 10 seconds.** Previously we defaulted to never
+    timing out, and that was a lousy policy. If some of your requests require
+    more than 10 seconds to complete, youll need to adjust the timeouts
+    manually.
+
  *  **OkHttp now rejects request headers that contain invalid characters.** This
     includes potential security problems (newline characters) as well as simple
     non-ASCII characters (including international characters and emoji).
@@ -29,6 +34,11 @@
  *  New: Fold `MockWebServerRule` into `MockWebServer`. This makes it easier to
     write JUnit tests with `MockWebServer`. The `MockWebServer` library now
     depends on JUnit, though it continues to work with all testing frameworks.
+ *  Fix: `FormEncodingBuilder` is now consistent with browsers in which
+    characters it escapes. Previously we werent percent-encoding commas,
+    parens, and other characters.
+ *  Fix: Relax `FormEncodingBuilder` to support building empty forms.
+ *  Fix: Timeouts throw `SocketTimeoutException`, not `InterruptedIOException`.
  *  Fix: Change `MockWebServer` to use the same logic as OkHttp when determining
     whether an HTTP request permits a body.
  *  Fix: `HttpUrl` now uses the canonical form for IPv6 addresses.
/Fim/
diff --git a/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java b/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java
index a69ddd1..42941a6 100644
--- a/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java
+++ b/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java
@@ -175,6 +175,10 @@
   }
 
   public void setServerSocketFactory(ServerSocketFactory serverSocketFactory) {
+    if (executor != null) {
+      throw new IllegalStateException(
+          "setServerSocketFactory() must be called before start()");
+    }
     this.serverSocketFactory = serverSocketFactory;
   }
 
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java
index 4d14e4d..33bb4c2 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java
@@ -2226,6 +2226,7 @@
 
   /** Confirm that an unacknowledged write times out. */
   @Test public void writeTimeouts() throws IOException {
+    MockWebServer server = new MockWebServer();
     // Sockets on some platforms can have large buffers that mean writes do not block when
     // required. These socket factories explicitly set the buffer sizes on sockets created.
     final int SOCKET_BUFFER_SIZE = 4 * 1024;
@@ -2247,6 +2248,7 @@
       }
     });
 
+    server.start();
     server.enqueue(new MockResponse()
         .throttleBody(1, 1, TimeUnit.SECONDS)); // Prevent the server from reading!
 
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 00ad4c3..59c99b9 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,75 @@
 Change Log
 ==========
 
+## Version 2.6.0
+
+_2015-11-22_
+
+ *  **New Logging Interceptor.** The `logging-interceptor` subproject offers
+    simple request and response logging. It may be configured to log headers and
+    bodies for debugging. It requires this Maven dependency:
+
+     ```
+     <dependency>
+       <groupId>com.squareup.okhttp</groupId>
+       <artifactId>logging-interceptor</artifactId>
+       <version>2.6.0</version>
+     </dependency>
+     ```
+
+    Configure basic logging like this:
+
+    ```
+    HttpLoggingInterceptor loggingInterceptor = new HttpLoggingInterceptor();
+    loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BASIC);
+    client.networkInterceptors().add(loggingInterceptor);
+    ```
+
+    **Warning:** Avoid `Level.HEADERS` and `Level.BODY` in production because
+    they could leak passwords and other authentication credentials to insecure
+    logs.
+
+ *  **WebSocket API now uses `RequestBody` and `ResponseBody` for messages.**
+    This is a backwards-incompatible API change.
+
+ *  **The DNS service is now pluggable.** In some situations this may be useful
+    to manually prioritize specific IP addresses.
+
+ *  Fix: Don't throw when converting an `HttpUrl` to a `java.net.URI`.
+    Previously URLs with special characters like `|` and `[` would break when
+    subjected to URIs overly-strict validation.
+ *  Fix: Don't re-encode `+` as `%20` in encoded URL query strings. OkHttp
+    prefers `%20` when doing its own encoding, but will retain `+` when that is
+    provided.
+ *  Fix: Enforce that callers call `WebSocket.close()` on IO errors. Error
+    handling in WebSockets is significantly improved.
+ *  Fix: Don't use SPDY/3 style header concatenation for HTTP/2 request headers.
+    This could have corrupted requests where multiple headers had the same name,
+    as in cookies.
+ *  Fix: Reject bad characters in the URL hostname. Previously characters like
+    `\0` would cause a late crash when building the request.
+ *  Fix: Allow interceptors to change the request method.
+ *  Fix: Dont use the request's `User-Agent` or `Proxy-Authorization` when
+    connecting to an HTTPS server via an HTTP tunnel. The `Proxy-Authorization`
+    header was being leaked to the origin server.
+ *  Fix: Digits may be used in a URL scheme.
+ *  Fix: Improve connection timeout recovery.
+ *  Fix: Recover from `getsockname` crashes impacting Android releases prior to
+    4.2.2.
+ *  Fix: Drop partial support for HTTP/1.0. Previously OkHttp would send
+    `HTTP/1.0` on connections after seeing a response with `HTTP/1.0`. The fixed
+    behavior is consistent with Firefox and Chrome.
+ *  Fix: Allow a body in `OPTIONS` requests.
+ *  Fix: Don't percent-encode non-ASCII characters in URL fragments.
+ *  Fix: Handle null fragments.
+ *  Fix: Dont crash on interceptors that throw `IOException` before a
+    connection is attempted.
+ *  New: Support [WebDAV][webdav] HTTP methods.
+ *  New: Buffer WebSocket frames for better performance.
+ *  New: Drop support for `TLS_DHE_DSS_WITH_AES_128_CBC_SHA`, our only remaining
+    DSS cipher suite. This is consistent with Firefox and Chrome which have also
+    dropped these cipher suite.
+
 ## Version 2.5.0
 
 _2015-08-25_
@@ -683,4 +752,5 @@
 
 Initial release.
 
- [brick]: (https://noncombatant.org/2015/05/01/about-http-public-key-pinning/)
+ [brick]: https://noncombatant.org/2015/05/01/about-http-public-key-pinning/
+ [webdav]: https://tools.ietf.org/html/rfc4918
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index d0d2566..1f9772d 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 9ef5211..6dabf77 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index e80d121..af62cec 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index f514808..13286d7 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 74ff837..cfdcb7a 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index a86a6d8..6b56d9f 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 654b0e3..899eb8d 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 2bb1982..e268c1f 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index be60560..a77cba8 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index ce0523a..bcb6274 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 81f8afd..895b126 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 65c4994..622f786 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 4e3a4cc..155b826 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.6.0-SNAPSHOT</version>
+  <version>2.6.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.6.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index aebd0eb..9c1f107 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 55e2671..edee108 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 29f1e87..a268f60 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 3a1aa7d..c3bb2f3 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index f223151..75bbd8f 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0-SNAPSHOT</version>
+    <version>2.6.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 1f9772d..a0d8317 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 6dabf77..b009057 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index af62cec..537f0b6 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 13286d7..99ef280 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index cfdcb7a..b007eb5 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 6b56d9f..2392458 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 899eb8d..03b316b 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index e268c1f..2e454f7 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index a77cba8..ab11d1e 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index bcb6274..f9f5d9a 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 895b126..abac825 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 622f786..86b0240 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 155b826..f818253 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.6.0</version>
+  <version>2.7.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.6.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 9c1f107..103979a 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index edee108..ca9d4c4 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index a268f60..a2819cb 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index c3bb2f3..1c8fb86 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 75bbd8f..06799b8 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.6.0</version>
+    <version>2.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 59c99b9..1188e8e 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -9,7 +9,7 @@
     simple request and response logging. It may be configured to log headers and
     bodies for debugging. It requires this Maven dependency:
 
-     ```
+     ```xml
      <dependency>
        <groupId>com.squareup.okhttp</groupId>
        <artifactId>logging-interceptor</artifactId>
@@ -19,7 +19,7 @@
 
     Configure basic logging like this:
 
-    ```
+    ```java
     HttpLoggingInterceptor loggingInterceptor = new HttpLoggingInterceptor();
     loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BASIC);
     client.networkInterceptors().add(loggingInterceptor);
@@ -91,7 +91,7 @@
     where changing a URL from `http` to `https` would leave it on port 80.
 
  *  **Okio has been updated to 1.6.0.**
-     ```
+     ```xml
      <dependency>
        <groupId>com.squareup.okio</groupId>
        <artifactId>okio</artifactId>
@@ -150,7 +150,7 @@
     Both are permitted-by-spec, but `%20` requires fewer special cases.
 
  *  **Okio has been updated to 1.4.0.**
-     ```
+     ```xml
      <dependency>
        <groupId>com.squareup.okio</groupId>
        <artifactId>okio</artifactId>
@@ -162,7 +162,7 @@
     Passing null will now fail for request methods that require a body. Instead
     use an empty body such as this one:
 
-    ```
+    ```java
         RequestBody.create(null, new byte[0]);
     ```
 
@@ -171,7 +171,7 @@
    your app. You'll need to pin both the top-level domain and the `*.` domain
    for full coverage.
 
-    ```
+    ```java
      client.setCertificatePinner(new CertificatePinner.Builder()
          .add("publicobject.com",   "sha1/DmxUShsZuNiqPQsX2Oi9uv2sCnw=")
          .add("*.publicobject.com", "sha1/DmxUShsZuNiqPQsX2Oi9uv2sCnw=")
@@ -228,7 +228,7 @@
 
  *  **Okio updated to 1.3.0.**
 
-    ```
+    ```xml
     <dependency>
       <groupId>com.squareup.okio</groupId>
       <artifactId>okio</artifactId>
@@ -333,14 +333,14 @@
 
     To disable TLS fallback:
 
-    ```
+    ```java
     client.setConnectionSpecs(Arrays.asList(
         ConnectionSpec.MODERN_TLS, ConnectionSpec.CLEARTEXT));
     ```
 
     To disable cleartext connections, permitting `https` URLs only:
 
-    ```
+    ```java
     client.setConnectionSpecs(Arrays.asList(
         ConnectionSpec.MODERN_TLS, ConnectionSpec.COMPATIBLE_TLS));
     ```
@@ -374,7 +374,7 @@
 
  *  **Okio updated to 1.0.1.**
 
-    ```
+    ```xml
     <dependency>
       <groupId>com.squareup.okio</groupId>
       <artifactId>okio</artifactId>
@@ -454,7 +454,7 @@
     agent.
  *  New: Guava-like API to create headers:
 
-    ```
+    ```java
     Headers headers = Headers.of(name1, value1, name2, value2, ...).
     ```
 
@@ -497,7 +497,7 @@
     add the `okhttp-urlconnection` module to your project and use the
     `OkUrlFactory` to create new instances of `HttpURLConnection`:
 
-    ```
+    ```java
     // OkHttp 1.x:
     HttpURLConnection connection = client.open(url);
 
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxy.java b/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxy.java
index e2a5532..854ddaf 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxy.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxy.java
@@ -41,6 +41,8 @@
  * See <a href="https://www.ietf.org/rfc/rfc1928.txt">RFC 1928</a>.
  */
 public final class SocksProxy {
+  public final String HOSTNAME_THAT_ONLY_THE_PROXY_KNOWS = "onlyProxyCanResolveMe.org";
+
   private static final int VERSION_5 = 5;
   private static final int METHOD_NONE = 0xff;
   private static final int METHOD_NO_AUTHENTICATION_REQUIRED = 0;
@@ -156,7 +158,10 @@
       case ADDRESS_TYPE_DOMAIN_NAME:
         int domainNameLength = fromSource.readByte() & 0xff;
         String domainName = fromSource.readUtf8(domainNameLength);
-        toAddress = InetAddress.getByName(domainName);
+        // Resolve HOSTNAME_THAT_ONLY_THE_PROXY_KNOWS to localhost.
+        toAddress = domainName.equalsIgnoreCase(HOSTNAME_THAT_ONLY_THE_PROXY_KNOWS)
+            ? InetAddress.getLoopbackAddress()
+            : InetAddress.getByName(domainName);
         break;
 
       default:
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxyTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxyTest.java
index 377ff83..0d6e9fd 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxyTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/SocksProxyTest.java
@@ -85,4 +85,23 @@
 
     assertEquals(1, socksProxy.connectionCount());
   }
+
+  @Test public void checkRemoteDNSResolve() throws Exception {
+    // This testcase will fail if the target is resolved locally instead of through the proxy.
+    server.enqueue(new MockResponse().setBody("abc"));
+
+    OkHttpClient client = new OkHttpClient()
+        .setProxy(socksProxy.proxy());
+
+    HttpUrl url = server.url("/")
+        .newBuilder()
+        .host(socksProxy.HOSTNAME_THAT_ONLY_THE_PROXY_KNOWS)
+        .build();
+
+    Request request = new Request.Builder().url(url).build();
+    Response response1 = client.newCall(request).execute();
+    assertEquals("abc", response1.body().string());
+
+    assertEquals(1, socksProxy.connectionCount());
+  }
 }
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/Connection.java b/okhttp/src/main/java/com/squareup/okhttp/Connection.java
index fd454a0..262a623 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/Connection.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/Connection.java
@@ -488,7 +488,7 @@
         + ", proxy="
         + route.proxy
         + " hostAddress="
-        + route.inetSocketAddress.getAddress().getHostAddress()
+        + route.inetSocketAddress
         + " cipherSuite="
         + (handshake != null ? handshake.cipherSuite() : "none")
         + " protocol="
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/internal/http/RouteSelector.java b/okhttp/src/main/java/com/squareup/okhttp/internal/http/RouteSelector.java
index f1a4acc..30195c7 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/internal/http/RouteSelector.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/internal/http/RouteSelector.java
@@ -180,11 +180,15 @@
           + "; port is out of range");
     }
 
-    // Try each address for best behavior in mixed IPv4/IPv6 environments.
-    List<InetAddress> addresses = address.getDns().lookup(socketHost);
-    for (int i = 0, size = addresses.size(); i < size; i++) {
-      InetAddress inetAddress = addresses.get(i);
-      inetSocketAddresses.add(new InetSocketAddress(inetAddress, socketPort));
+    if (proxy.type() == Proxy.Type.SOCKS) {
+      inetSocketAddresses.add(InetSocketAddress.createUnresolved(socketHost, socketPort));
+    } else {
+      // Try each address for best behavior in mixed IPv4/IPv6 environments.
+      List<InetAddress> addresses = address.getDns().lookup(socketHost);
+      for (int i = 0, size = addresses.size(); i < size; i++) {
+        InetAddress inetAddress = addresses.get(i);
+        inetSocketAddresses.add(new InetSocketAddress(inetAddress, socketPort));
+      }
     }
 
     nextInetSocketAddressIndex = 0;
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/Request.java b/okhttp/src/main/java/com/squareup/okhttp/Request.java
index 2417c13..e099267 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/Request.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/Request.java
@@ -189,6 +189,9 @@
     /**
      * Adds a header with {@code name} and {@code value}. Prefer this method for
      * multiply-valued headers like "Cookie".
+     *
+     * <p>Note that for some headers including {@code Content-Length} and {@code Content-Encoding},
+     * OkHttp may replace {@code value} with a header derived from the request body.
      */
     public Builder addHeader(String name, String value) {
       headers.add(name, value);
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java
index eeabe9d..34ca42a 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/CallTest.java
@@ -1377,6 +1377,27 @@
     assertEquals("GET /page2 HTTP/1.1", page2.getRequestLine());
   }
 
+  @Test public void propfindRedirectsToPropfind() throws Exception {
+    server.enqueue(new MockResponse()
+        .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
+        .addHeader("Location: /page2")
+        .setBody("This page has moved!"));
+    server.enqueue(new MockResponse().setBody("Page 2"));
+
+    Response response = client.newCall(new Request.Builder()
+        .url(server.url("/page1"))
+        .method("PROPFIND", RequestBody.create(MediaType.parse("text/plain"), "Request Body"))
+        .build()).execute();
+    assertEquals("Page 2", response.body().string());
+
+    RecordedRequest page1 = server.takeRequest();
+    assertEquals("PROPFIND /page1 HTTP/1.1", page1.getRequestLine());
+    assertEquals("Request Body", page1.getBody().readUtf8());
+
+    RecordedRequest page2 = server.takeRequest();
+    assertEquals("PROPFIND /page2 HTTP/1.1", page2.getRequestLine());
+  }
+
   @Test public void redirectsDoNotIncludeTooManyCookies() throws Exception {
     server2.enqueue(new MockResponse().setBody("Page 2"));
     server.enqueue(new MockResponse()
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpEngine.java b/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpEngine.java
index fcb7384..bf2529a 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpEngine.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpEngine.java
@@ -897,6 +897,7 @@
         : client.getProxy();
     int responseCode = userResponse.code();
 
+    final String method = userRequest.method();
     switch (responseCode) {
       case HTTP_PROXY_AUTH:
         if (selectedProxy.type() != Proxy.Type.HTTP) {
@@ -910,7 +911,7 @@
       case HTTP_TEMP_REDIRECT:
         // "If the 307 or 308 status code is received in response to a request other than GET
         // or HEAD, the user agent MUST NOT automatically redirect the request"
-        if (!userRequest.method().equals("GET") && !userRequest.method().equals("HEAD")) {
+        if (!method.equals("GET") && !method.equals("HEAD")) {
             return null;
         }
         // fall-through
@@ -934,8 +935,12 @@
 
         // Redirects don't include a request body.
         Request.Builder requestBuilder = userRequest.newBuilder();
-        if (HttpMethod.permitsRequestBody(userRequest.method())) {
-          requestBuilder.method("GET", null);
+        if (HttpMethod.permitsRequestBody(method)) {
+          if (HttpMethod.redirectsToGet(method)) {
+            requestBuilder.method("GET", null);
+          } else {
+            requestBuilder.method(method, null);
+          }
           requestBuilder.removeHeader("Transfer-Encoding");
           requestBuilder.removeHeader("Content-Length");
           requestBuilder.removeHeader("Content-Type");
/Fim/
diff --git a/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpMethod.java b/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpMethod.java
index 6a9b4f6..b6bf700 100644
--- a/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpMethod.java
+++ b/okhttp/src/main/java/com/squareup/okhttp/internal/http/HttpMethod.java
@@ -41,6 +41,11 @@
         || method.equals("LOCK");     // (WebDAV) body: create lock, without body: refresh lock
   }
 
+  public static boolean redirectsToGet(String method) {
+    // All requests but PROPFIND should redirect to a GET request.
+    return !method.equals("PROPFIND");
+  }
+
   private HttpMethod() {
   }
 }
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 1188e8e..a5b8064 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,24 @@
 Change Log
 ==========
 
+## Version 2.7.0
+
+_2015-12-12_
+
+ *  **Rewritten connection management.** Previously OkHttp's connection pool
+    managed both idle and active connections for HTTP/2, but only idle
+    connections for HTTP/1.x. Wth this update the connection pool manages both
+    idle and active connections for everything. OkHttp now detects and warns on
+    connections that were allocated but never released, and will enforce HTTP/2
+    stream limits. This update also fixes `Call.cancel()` to not do I/O on the
+    calling thread.
+ *  Fix: Don't log gzipped data in the logging interceptor.
+ *  Fix: Don't resolve DNS addresses when connecting through a SOCKS proxy.
+ *  Fix: Drop the synthetic `OkHttp-Selected-Protocol` response header.
+ *  Fix: Support 204 and 205 'No Content' replies in the logging interceptor.
+ *  New: Add `Call.isExecuted()`.
+
+
 ## Version 2.6.0
 
 _2015-11-22_
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index a0d8317..bc23ea8 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index b009057..dd78009 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 537f0b6..86c0bfa 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 99ef280..bc880c9 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index b007eb5..5e9bf23 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 2392458..fe14a95 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 03b316b..e648cec 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 2e454f7..41b6a56 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index ab11d1e..a1f3591 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index f9f5d9a..73afbff 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index abac825..b0b8a42 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 86b0240..fbc68ff 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index f818253..bbc3021 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.7.0-SNAPSHOT</version>
+  <version>2.7.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-2.7.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 103979a..53ef0d9 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index ca9d4c4..a07e4b0 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index a2819cb..e76cb33 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 1c8fb86..c59fef7 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 06799b8..213944c 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0-SNAPSHOT</version>
+    <version>2.7.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index bc23ea8..5c2cd68 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index dd78009..7bd0ed9 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 86c0bfa..be3007d 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index bc880c9..87464a2 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 5e9bf23..b4d1bac 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index fe14a95..16392f2 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index e648cec..a1a53a7 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 41b6a56..44de274 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index a1f3591..93490ee 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 73afbff..be53594 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index b0b8a42..8ee69e4 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index fbc68ff..f09698d 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index bbc3021..d9fd335 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>parent</artifactId>
-  <version>2.7.0</version>
+  <version>3.0.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-2.7.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 53ef0d9..17733b5 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index a07e4b0..a3230dc 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index e76cb33..38c8596 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp</groupId>
     <artifactId>parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index c59fef7..33fcb53 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 213944c..6414f24 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>2.7.0</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index a5b8064..baaa834 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -3,7 +3,7 @@
 
 ## Version 2.7.0
 
-_2015-12-12_
+_2015-12-13_
 
  *  **Rewritten connection management.** Previously OkHttp's connection pool
     managed both idle and active connections for HTTP/2, but only idle
/Fim/
diff --git a/README.md b/README.md
index f10aaeb..52dcc5b 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>okhttp</artifactId>
-  <version>2.6.0</version>
+  <version>2.7.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp:okhttp:2.6.0'
+compile 'com.squareup.okhttp:okhttp:2.7.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>2.6.0</version>
+  <version>2.7.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp:mockwebserver:2.6.0'
+testCompile 'com.squareup.okhttp:mockwebserver:2.7.0'
 ```
 
 
/Fim/
diff --git a/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java b/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java
index 72ee554..b5b4986 100644
--- a/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java
+++ b/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/MockWebServer.java
@@ -541,6 +541,7 @@
               + " and responded: " + response);
         }
 
+        // See warnings associated with these socket policies in SocketPolicy.
         if (response.getSocketPolicy() == SocketPolicy.DISCONNECT_AT_END) {
           socket.close();
           return false;
/Fim/
diff --git a/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/SocketPolicy.java b/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/SocketPolicy.java
index f71f33d..cdbbf72 100644
--- a/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/SocketPolicy.java
+++ b/mockwebserver/src/main/java/com/squareup/okhttp/mockwebserver/SocketPolicy.java
@@ -16,7 +16,19 @@
 
 package com.squareup.okhttp.mockwebserver;
 
-/** What should be done with the incoming socket. */
+/**
+ * What should be done with the incoming socket.
+ *
+ * <p>Be careful when using values like {@link #DISCONNECT_AT_END}, {@link #SHUTDOWN_INPUT_AT_END}
+ * and {@link #SHUTDOWN_OUTPUT_AT_END} that close a socket after a response, and where there are
+ * follow-up requests. The client is unblocked and free to continue as soon as it has received the
+ * entire response body. If and when the client makes a subsequent request using a pooled socket the
+ * server may not have had time to close the socket. The socket will be closed at an indeterminate
+ * point before or during the second request. It may be closed after client has started sending the
+ * request body. If a request body is not retryable then the client may fail the request, making
+ * client behavior non-deterministic. Add delays in the client to improve the chances that the
+ * server has closed the socket before follow up requests are made.
+ */
 public enum SocketPolicy {
 
   /**
@@ -28,6 +40,8 @@
   /**
    * Close the socket after the response. This is the default HTTP/1.0
    * behavior.
+   *
+   * <p>See {@link SocketPolicy} for reasons why this can cause test flakiness and how to avoid it.
    */
   DISCONNECT_AT_END,
 
@@ -62,12 +76,16 @@
   /**
    * Shutdown the socket input after sending the response. For testing bad
    * behavior.
+   *
+   * <p>See {@link SocketPolicy} for reasons why this can cause test flakiness and how to avoid it.
    */
   SHUTDOWN_INPUT_AT_END,
 
   /**
    * Shutdown the socket output after sending the response. For testing bad
    * behavior.
+   *
+   * <p>See {@link SocketPolicy} for reasons why this can cause test flakiness and how to avoid it.
    */
   SHUTDOWN_OUTPUT_AT_END,
 
/Fim/
diff --git a/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java b/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java
index 9c384a5..fc0c7f7 100644
--- a/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java
@@ -417,6 +417,11 @@
     connection1.setReadTimeout(100);
     assertContent("This connection won't pool properly", connection1);
     assertEquals(0, server.takeRequest().getSequenceNumber());
+
+    // Give the server time to enact the socket policy if it's one that could happen after the
+    // client has received the response.
+    Thread.sleep(500);
+
     HttpURLConnection connection2 = client.open(server.url("/b").url());
     connection2.setReadTimeout(100);
     assertContent("This comes after a busted connection", connection2);
@@ -644,6 +649,10 @@
     client.client().setHostnameVerifier(new RecordingHostnameVerifier());
 
     assertContent("abc", client.open(server.url("/").url()));
+
+    // Give the server time to disconnect.
+    Thread.sleep(500);
+
     assertContent("def", client.open(server.url("/").url()));
 
     Set<TlsVersion> tlsVersions =
@@ -1272,6 +1281,9 @@
     // Seed the pool with a bad connection.
     assertContent("a", client.open(server.url("/").url()));
 
+    // Give the server time to disconnect.
+    Thread.sleep(500);
+
     // This connection will need to be recovered. When it is, transparent gzip should still work!
     assertContent("b", client.open(server.url("/").url()));
 
@@ -2667,6 +2679,9 @@
 
     assertContent("A", client.open(server.url("/a").url()));
 
+    // Give the server time to disconnect.
+    Thread.sleep(500);
+
     // If the request body is larger than OkHttp's replay buffer, the failure may still occur.
     byte[] requestBody = new byte[requestSize];
     new Random(0).nextBytes(requestBody);
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 5772aba..3a8aeab 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,15 @@
 Change Log
 ==========
 
+## Version 2.7.1
+
+_2016-01-01_
+
+ *  Fix: Don't do a health check on newly-created connections. This is
+    unnecessary work that could put the client in an inconsistent state if the
+    health check fails.
+
+
 ## Version 2.7.0
 
 _2015-12-13_
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 3a8aeab..7aec7fa 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,104 @@
 Change Log
 ==========
 
+## Version 3.0.0-RC1
+
+_2016-01-02_
+
+OkHttp 3 is a major release focused on API simplicity and consistency. The API
+changes are numerous but most are cosmetic. Applications should be able to
+upgrade from the 2.x API to the 3.x API mechanically and without risk.
+
+Because the release includes breaking API changes, we're changing the project's
+package name from `com.squareup.okhttp` to `okhttp3`. This should make it
+possible for large applications to migrate incrementally. The Maven group ID
+is now `com.squareup.okhttp3`. For an explanation of this strategy, see Jake
+Wharton's post, [Java Interoperability Policy for Major Version
+Updates][major_versions].
+
+This release obsoletes OkHttp 2.x, and all code that uses OkHttp's
+`com.squareup.okhttp` package should upgrade to the `okhttp3` package. Libraries
+that depend on OkHttp should upgrade quickly to prevent applications from being
+stuck on the old version.
+
+ *  **There is no longer a global singleton connection pool.** In OkHttp 2.x,
+    all `OkHttpClient` instances shared a common connection pool by default.
+    In OkHttp 3.x, each new `OkHttpClient` gets its own private connection pool.
+    Applications should avoid creating many connection pools as doing so
+    prevents connection reuse. Each connection pool holds its own set of
+    connections alive so applications that have many pools also risk exhausting
+    memory!
+
+    The best practice in OkHttp 3 is to create a single OkHttpClient instance
+    and share it throughout the application. Requests that needs a customized
+    client should call `OkHttpClient.newBuilder()` on that shared instance.
+    This allows customization without the drawbacks of separate connection
+    pools.
+
+ *  **OkHttpClient is now stateless.** In the 2.x API `OkHttpClient` had getters
+    and setters. Internally each request was forced to make its own complete
+    snapshot of the `OkHttpClient` instance to defend against racy configuration
+    changes. In 3.x, `OkHttpClient` is now stateless and has a builder. Note
+    that this class is not strictly immutable as it has stateful members like
+    the connection pool and cache.
+
+ *  **Get and Set prefixes are now avoided.** With ubiquitous builders
+    throughout OkHttp these accessor prefixes aren't necessary. Previously
+    OkHttp used _get_ and _set_ prefixes sporadically which make the API
+    inconsistent and awkward to explore.
+
+ *  **OkHttpClient now implements the new `Call.Factory` interface.** This
+    interface will make your code easier to test. When you test code that makes
+    HTTP requests, you can use this interface to replace the real `OkHttpClient`
+    with your own mocks or fakes.
+
+    The interface will also let you use OkHttp's API with another HTTP client's
+    implementation. This is useful in sandboxed environments like Google App
+    Engine.
+
+ *  **OkHttp now does cookies.** We've replaced `java.net.CookieHandler` with
+    a new interface, `CookieJar` and added our own `Cookie` model class. This
+    new cookie follows the latest RFC and supports the same cookie attributes
+    as modern web browsers.
+
+ *  **Form and Multipart bodies are now modeled.** We've replaced the opaque
+    `FormEncodingBuilder` with the more powerful `FormBody` and
+    `FormBody.Builder` combo. Similarly we've upgraded `MultipartBuilder` into
+    `MultipartBody`, `MultipartBody.Part`, and `MultipartBody.Builder`.
+
+ *  **The Apache HTTP client and HttpURLConnection APIs are deprecated.** They
+    continue to work as they always have, but we're moving everything to the new
+    OkHttp 3 API. The `okhttp-apache` and `okhttp-urlconnection` modules should
+    be only be used to accelerate a transition to OkHttp's request/response API.
+    These deprecated modules will be dropped in an upcoming OkHttp 3.x release.
+
+ *  **Canceling batches of calls is now the application's responsibility.**
+    The API to cancel calls by tag has been removed and replaced with a more
+    general mechanism. The dispatcher now exposes all in-flight calls via its
+    `runningCalls()` and `queuedCalls()` methods. You can write code to cancel
+    calls by tag, by host, or whatever other criteria is appropriate.
+
+ *  **OkHttp no longer uses the global `java.net.Authenticator` by default.**
+    We've changed our `Authenticator` interface to authenticate web and proxy
+    authentication failures through a single method. An adapter for the old
+    authenticator is available in the `okhttp-urlconnection` module.
+
+ *  Fix: Don't throw `IOException` on `ResponseBody.contentLength()` or `close()`.
+ *  Fix: Never throw converting an `HttpUrl` to a `java.net.URI`. This changes
+    the `uri()` method to handle malformed percent-escapes and characters
+    forbidden by `URI`.
+ *  Fix: When a connect times out, attempt an alternate route. Previously route
+    selection was less efficient when differentiating failures.
+ *  New: `Response.peekBody()` lets you access the response body without
+    consuming it. This may be handy for interceptors!
+ *  New: `HttpUrl.newBuilder()` resolves a link to a builder.
+ *  New: Add the TLS version to the `Handshake`.
+ *  New: Drop `Request.uri()` and `Request#urlString()`. Just use
+    `Request.url().uri()` and `Request.url().toString()`.
+ *  New: Add URL to HTTP response logging.
+ *  New: Make `HttpUrl` the blessed URL method of `Request`.
+
+
 ## Version 2.7.1
 
 _2016-01-01_
@@ -781,3 +879,4 @@
 
  [brick]: https://noncombatant.org/2015/05/01/about-http-public-key-pinning/
  [webdav]: https://tools.ietf.org/html/rfc4918
+ [major_versions]: http://jakewharton.com/java-interoperability-policy-for-major-version-updates/
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 7aec7fa..4c352a1 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -75,8 +75,9 @@
  *  **Canceling batches of calls is now the application's responsibility.**
     The API to cancel calls by tag has been removed and replaced with a more
     general mechanism. The dispatcher now exposes all in-flight calls via its
-    `runningCalls()` and `queuedCalls()` methods. You can write code to cancel
-    calls by tag, by host, or whatever other criteria is appropriate.
+    `runningCalls()` and `queuedCalls()` methods. You can write code that
+    selects calls by tag, host, or whatever, and invokes `Call.cancel()` on the
+    ones that are no longer necessary.
 
  *  **OkHttp no longer uses the global `java.net.Authenticator` by default.**
     We've changed our `Authenticator` interface to authenticate web and proxy
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index a4b9423..d4f4a4a 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
@@ -90,7 +88,7 @@
             <argument>-Xmx512m</argument>
             <commandlineArgs>-Xbootclasspath/p:${bootclasspath}</commandlineArgs>
             <argument>-classpath</argument>
-            <classpath/>
+            <classpath />
             <argument>okhttp3.benchmarks.Benchmark</argument>
           </arguments>
         </configuration>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 3728f68..848822e 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 2fe8935..a0fe79d 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 2766b9e..1998a3d 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index f0b4b68..1090f3b 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index bd4b146..2ac80fa 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 9b4af34..0a6a8c8 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 9197225..c9c35a1 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 9ac0302..497ed09 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index b78e32c..f7bb284 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 85d0347..d882bca 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 194f9da..0871fca 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 6da4ada..68adc3a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -1,8 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
@@ -13,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.0.0-SNAPSHOT</version>
+  <version>3.0.0-RC1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -66,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.0.0-RC1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index dccdc4c..35b8cee 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index dae0407..4e5778f 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index fe89d7a..a9935c7 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 623fad3..2b45254 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 4b85fce..1ecc994 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0-RC1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
@@ -33,8 +31,7 @@
           <shadedArtifactAttached>true</shadedArtifactAttached>
           <shadedClassifierName>shaded</shadedClassifierName>
           <transformers>
-            <transformer
-                implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
+            <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
               <manifestEntries>
                 <Main-Class>okhttp3.sample.SampleServer</Main-Class>
               </manifestEntries>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index d4f4a4a..bd6d7ef 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 848822e..3899b1b 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index a0fe79d..2b9b7ce 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 1998a3d..e34ad97 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 1090f3b..6e9a797 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 2ac80fa..011ed00 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 0a6a8c8..d363749 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index c9c35a1..cb0c017 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 497ed09..a700dff 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index f7bb284..3fc750a 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index d882bca..c28edd0 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 0871fca..01fd820 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 68adc3a..9e04585 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.0.0-RC1</version>
+  <version>3.0.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.0.0-RC1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 35b8cee..0a1e7f6 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 4e5778f..3887585 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index a9935c7..50cfe2a 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 2b45254..d484823 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 1ecc994..071e703 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-RC1</version>
+    <version>3.0.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/README.md b/README.md
index 52dcc5b..53d8d03 100644
--- a/README.md
+++ b/README.md
@@ -9,14 +9,14 @@
 Download [the latest JAR][3] or grab via Maven:
 ```xml
 <dependency>
-  <groupId>com.squareup.okhttp</groupId>
+  <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>2.7.0</version>
+  <version>3.0.0-RC1</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp:okhttp:2.7.0'
+compile 'com.squareup.okhttp3:okhttp:3.0.0-RC1'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -34,15 +34,15 @@
 Download [the latest JAR][4] or grab via Maven:
 ```xml
 <dependency>
-  <groupId>com.squareup.okhttp</groupId>
+  <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>2.7.0</version>
+  <version>3.0.0-RC1</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp:mockwebserver:2.7.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.0.0-RC1'
 ```
 
 
@@ -65,6 +65,6 @@
 
  [1]: http://square.github.io/okhttp
  [2]: https://github.com/square/okhttp/wiki
- [3]: https://search.maven.org/remote_content?g=com.squareup.okhttp&a=okhttp&v=LATEST
- [4]: https://search.maven.org/remote_content?g=com.squareup.okhttp&a=mockwebserver&v=LATEST
+ [3]: https://search.maven.org/remote_content?g=com.squareup.okhttp3&a=okhttp&v=LATEST
+ [4]: https://search.maven.org/remote_content?g=com.squareup.okhttp3&a=mockwebserver&v=LATEST
  [snap]: https://oss.sonatype.org/content/repositories/snapshots/
/Fim/
diff --git a/mockwebserver/README.md b/mockwebserver/README.md
index ba40bf5..dfdc05d 100644
--- a/mockwebserver/README.md
+++ b/mockwebserver/README.md
@@ -143,7 +143,7 @@
 Get MockWebServer via Maven:
 ```xml
 <dependency>
-  <groupId>com.squareup.okhttp</groupId>
+  <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
   <version>(insert latest version)</version>
   <scope>test</scope>
/Fim/
diff --git a/okhttp-logging-interceptor/README.md b/okhttp-logging-interceptor/README.md
index a16bbd2..c72f240 100644
--- a/okhttp-logging-interceptor/README.md
+++ b/okhttp-logging-interceptor/README.md
@@ -33,7 +33,7 @@
 Get via Maven:
 ```xml
 <dependency>
-  <groupId>com.squareup.okhttp</groupId>
+  <groupId>com.squareup.okhttp3</groupId>
   <artifactId>logging-interceptor</artifactId>
   <version>(insert latest version)</version>
 </dependency>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index a700dff..c093648 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -44,7 +44,7 @@
         <groupId>org.apache.maven.plugins</groupId>
         <artifactId>maven-javadoc-plugin</artifactId>
         <configuration>
-          <excludePackageNames>okhttp3.internal.*</excludePackageNames>
+          <excludePackageNames>okhttp3.internal:okhttp3.internal.*</excludePackageNames>
           <links>
             <link>http://square.github.io/okhttp/javadoc/</link>
           </links>
/Fim/
diff --git a/samples/guide/src/main/java/okhttp3/recipes/Authenticate.java b/samples/guide/src/main/java/okhttp3/recipes/Authenticate.java
index a8cec6c..04c8cae 100644
--- a/samples/guide/src/main/java/okhttp3/recipes/Authenticate.java
+++ b/samples/guide/src/main/java/okhttp3/recipes/Authenticate.java
@@ -24,18 +24,22 @@
 import okhttp3.Route;
 
 public final class Authenticate {
-  private final OkHttpClient client = new OkHttpClient.Builder()
-      .authenticator(new Authenticator() {
-        @Override public Request authenticate(Route route, Response response) throws IOException {
-          System.out.println("Authenticating for response: " + response);
-          System.out.println("Challenges: " + response.challenges());
-          String credential = Credentials.basic("jesse", "password1");
-          return response.request().newBuilder()
-              .header("Authorization", credential)
-              .build();
-        }
-      })
-      .build();
+  private final OkHttpClient client;
+
+  public Authenticate() {
+    client = new OkHttpClient.Builder()
+        .authenticator(new Authenticator() {
+          @Override public Request authenticate(Route route, Response response) throws IOException {
+            System.out.println("Authenticating for response: " + response);
+            System.out.println("Challenges: " + response.challenges());
+            String credential = Credentials.basic("jesse", "password1");
+            return response.request().newBuilder()
+                .header("Authorization", credential)
+                .build();
+          }
+        })
+        .build();
+  }
 
   public void run() throws Exception {
     Request request = new Request.Builder()
/Fim/
diff --git a/website/index.html b/website/index.html
index e0c5392..cf5d43c 100644
--- a/website/index.html
+++ b/website/index.html
@@ -4,7 +4,7 @@
     <meta charset="utf-8">
     <title>OkHttp</title>
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
-    <meta name="description" content="An HTTP &amp; SPDY client for Android and Java applications">
+    <meta name="description" content="An HTTP &amp; HTTP/2 client for Android and Java applications">
     <link href="static/bootstrap-combined.min.css" rel="stylesheet">
     <link href="static/app.css" rel="stylesheet">
     <link href="static/app-theme.css" rel="stylesheet">
@@ -33,7 +33,7 @@
       <div class="container">
         <div class="row">
           <div class="span12">
-            <h2>An <strong>HTTP &amp; SPDY</strong> client for Android and Java applications</h2>
+            <h2>An <strong>HTTP &amp; HTTP/2</strong> client for Android and Java applications</h2>
           </div>
         </div>
       </div>
@@ -48,8 +48,8 @@
 
             <p>OkHttp is an HTTP client thats efficient by default:</p>
             <ul>
-                <li>HTTP/2 and SPDY support allows all requests to the same host to share a socket.</li>
-                <li>Connection pooling reduces request latency (if SPDY isnt available).</li>
+                <li>HTTP/2 support allows all requests to the same host to share a socket.</li>
+                <li>Connection pooling reduces request latency (if HTTP/2 isnt available).</li>
                 <li>Transparent GZIP shrinks download sizes.</li>
                 <li>Response caching avoids the network completely for repeat requests.</li>
             </ul>
@@ -61,15 +61,10 @@
                 with modern TLS features (SNI, ALPN), and falls back to TLS 1.0 if the handshake
                 fails.</p>
 
-            <p>Using OkHttp is easy. Its 2.0 API is designed with fluent builders and
+            <p>Using OkHttp is easy. Its request/response API is designed with fluent builders and
                 immutability. It supports both synchronous blocking calls and async calls with
                 callbacks.</p>
 
-            <p>You can try out OkHttp without rewriting your network code. The
-                <code>okhttp-urlconnection</code> module implements the familiar
-                <code>java.net.HttpURLConnection</code> API and the <code>okhttp-apache</code>
-                module implements the Apache <code>HttpClient</code> API.</p>
-
             <p>OkHttp supports Android 2.3 and above. For Java, the minimum requirement is 1.7.</p>
 
             <h3 id="examples">Examples</h3>
@@ -108,7 +103,7 @@
 </pre>
 
             <h3 id="download">Download</h3>
-            <p><a href="https://search.maven.org/remote_content?g=com.squareup.okhttp&a=okhttp&v=LATEST" class="dl version-href">&darr; <span class="version-tag">Latest</span> JAR</a></p>
+            <p><a href="https://search.maven.org/remote_content?g=com.squareup.okhttp3&a=okhttp&v=LATEST" class="dl version-href">&darr; <span class="version-tag">Latest</span> JAR</a></p>
             <p>You'll also need <a href="http://github.com/square/okio">Okio</a>, which OkHttp
                 uses for fast I/O and resizable buffers. Download the
                 <a href="https://search.maven.org/remote_content?g=com.squareup.okio&a=okio&v=LATEST">latest JAR</a>.
@@ -116,13 +111,13 @@
 
             <h4>Maven</h4>
             <pre class="prettyprint">&lt;dependency>
-  &lt;groupId>com.squareup.okhttp&lt;/groupId>
+  &lt;groupId>com.squareup.okhttp3&lt;/groupId>
   &lt;artifactId>okhttp&lt;/artifactId>
   &lt;version><span class="version pln"><em>(insert latest version)</em></span>&lt;/version>
 &lt;/dependency></pre>
 
             <h4>Gradle</h4>
-            <pre class="prettyprint">compile 'com.squareup.okhttp:okhttp:<span class="version pln"><em>(insert latest version)</em></span>'</pre>
+            <pre class="prettyprint">compile 'com.squareup.okhttp3:okhttp:<span class="version pln"><em>(insert latest version)</em></span>'</pre>
 
             <h3 id="contributing">Contributing</h3>
             <p>If you would like to contribute code you can do so through GitHub by forking the repository and sending a pull request.</p>
@@ -130,7 +125,7 @@
             <p>Before your code can be accepted into the project you must also sign the <a href="http://squ.re/sign-the-cla">Individual Contributor License Agreement (CLA)</a>.</p>
 
             <h3 id="license">License</h3>
-            <pre>Copyright 2014 Square, Inc.
+            <pre>Copyright 2016 Square, Inc.
 
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
@@ -197,7 +192,7 @@
 
         // Look up the latest version of the library.
         $.fn.artifactVersion({
-          'groupId': 'com.squareup.okhttp',
+          'groupId': 'com.squareup.okhttp3',
           'artifactId': 'okhttp'
         }, function(version, url) {
           $('.version').text(version);
/Fim/
diff --git a/website/index.html b/website/index.html
index cf5d43c..ff9ec47 100644
--- a/website/index.html
+++ b/website/index.html
@@ -150,7 +150,7 @@
               </ul>
               <ul class="nav nav-pills nav-stacked secondary">
                 <li><a href="https://github.com/square/okhttp/wiki">Wiki</a></li>
-                <li><a href="2.x/okhttp/">Javadoc</a></li>
+                <li><a href="3.x/okhttp/">Javadoc</a></li>
                 <li><a href="http://stackoverflow.com/questions/tagged/okhttp?sort=active">StackOverflow</a></li>
               </ul>
             </div>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 4c352a1..f152a8a 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -109,6 +109,14 @@
     health check fails.
 
 
+## Version 2.7.2
+
+_2016-01-07_
+
+ *  Fix: Don't eagerly release stream allocations on cache hits. We might still
+    need them to handle redirects.
+
+
 ## Version 2.7.0
 
 _2015-12-13_
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index bd6d7ef..c62ee5f 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 3899b1b..b3da346 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 2b9b7ce..dd5eba1 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index e34ad97..9b24edb 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 3355b9d..936306f 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 7d0c8a9..8e883df 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index d363749..72c2409 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index cb0c017..1a73a33 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 13937e5..ecbc5d8 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 3fc750a..9b69080 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 6d6de13..0cd6bb5 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 5c463b9..f2b7b1b 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/pom.xml b/pom.xml
index 169f14a..5c899cf 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.0.0-SNAPSHOT</version>
+  <version>3.0.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -67,7 +67,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.0.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0a1e7f6..64cb6f1 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 3887585..b90706e 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 50cfe2a..4806dc0 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index d484823..1d27c08 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 071e703..8431ee7 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0-SNAPSHOT</version>
+    <version>3.0.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index c62ee5f..6a4459e 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index b3da346..c87dbc2 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index dd5eba1..9acb228 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 9b24edb..0344a33 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 936306f..927b83a 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 8e883df..72b2fca 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 72c2409..a11bef1 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 1a73a33..59383f4 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index ecbc5d8..f1b31f5 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 9b69080..926b4be 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 0cd6bb5..aa52f2d 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index f2b7b1b..a0d4829 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <packaging>bundle</packaging>
/Fim/
diff --git a/pom.xml b/pom.xml
index 5c899cf..90994b9 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.0.0</version>
+  <version>3.1.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -67,7 +67,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.0.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 64cb6f1..63b8c43 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index b90706e..c81ea17 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 4806dc0..784ff1d 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 1d27c08..f5b0e7f 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 8431ee7..1acef5f 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.0</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 889d80f..c3e14e5 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,26 @@
 Change Log
 ==========
 
+## Version 3.0.0
+
+_2016-01-13_
+
+This release commits to a stable 3.0 API. Read the 3.0.0-RC1 changes for advice
+on upgrading from 2.x to 3.x.
+
+ *  **The `Callback` interface now takes a `Call`**. This makes it easier to
+    check if the call was canceled from within the callback. When migrating
+    async calls to this new API, `Call` is now the first parameter for both
+    `onResponse()` and `onFailure()`.
+ *  Fix: handle multiple cookies in `JavaNetCookieJar` on Android.
+ *  Fix: improve the default HTTP message in MockWebServer responses.
+ *  Fix: don't leak file handles when a conditional GET throws.
+ *  Fix: Use charset specified by the request body content type in OkHttp's
+    logging interceptor.
+ *  Fix: Don't eagerly release pools on cache hits.
+ *  New: Make OkHttp OSGi ready.
+ *  New: Add already-implemented interfaces Closeable and Flushable to the cache.
+
 ## Version 3.0.0-RC1
 
 _2016-01-02_
/Fim/
diff --git a/README.md b/README.md
index b7fc9ee..5657193 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.0.0-RC1</version>
+  <version>3.0.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.0.0-RC1'
+compile 'com.squareup.okhttp3:okhttp:3.0.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.0.0-RC1</version>
+  <version>3.0.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.0.0-RC1'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.0.0'
 ```
 
 
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index c3e14e5..7229b70 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,14 @@
 Change Log
 ==========
 
+## Version 3.0.1
+
+_2016-01-14_
+
+ *  Rollback OSGi support. This was causing library jars to include more classes
+    than expected, which interfered with Gradle builds.
+
+
 ## Version 3.0.0
 
 _2016-01-13_
/Fim/
diff --git a/README.md b/README.md
index 5657193..c84574c 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.0.0</version>
+  <version>3.0.1</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.0.0'
+compile 'com.squareup.okhttp3:okhttp:3.0.1'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.0.0</version>
+  <version>3.0.1</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.0.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.0.1'
 ```
 
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 6a4459e..05819a6 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index c87dbc2..547a97b 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 9acb228..9441e10 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 0344a33..d09d4bf 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index dcf813e..8b8d041 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 789f036..2e88bb4 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index a11bef1..9e43286 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 59383f4..53a93ec 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 5004d5f..8e11262 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 926b4be..e712931 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 3841ecc..32245d2 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8629395..8bfc98a 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 772e8a4..738ccfc 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.1.0-SNAPSHOT</version>
+  <version>3.0.1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.0.1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 63b8c43..8a4b0ee 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index c81ea17..54165cc 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 784ff1d..f751315 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index f5b0e7f..cfc008b 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 1acef5f..d52d32b 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.0.1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 05819a6..6a4459e 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 547a97b..c87dbc2 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 9441e10..9acb228 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index d09d4bf..0344a33 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 8b8d041..dcf813e 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 2e88bb4..789f036 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 9e43286..a11bef1 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 53a93ec..59383f4 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 8e11262..5004d5f 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index e712931..926b4be 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 32245d2..3841ecc 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8bfc98a..8629395 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 738ccfc..772e8a4 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.0.1</version>
+  <version>3.1.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.0.1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 8a4b0ee..63b8c43 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 54165cc..c81ea17 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index f751315..784ff1d 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index cfc008b..f5b0e7f 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index d52d32b..1acef5f 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.0.1</version>
+    <version>3.1.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CookieTest.java b/okhttp-tests/src/test/java/okhttp3/CookieTest.java
index bffa4c7..9ab2117 100644
--- a/okhttp-tests/src/test/java/okhttp3/CookieTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CookieTest.java
@@ -17,8 +17,10 @@
 
 import java.text.ParseException;
 import java.text.SimpleDateFormat;
+import java.util.Arrays;
 import java.util.Date;
 import java.util.List;
+import java.util.Objects;
 import okhttp3.internal.Util;
 import okhttp3.internal.http.HttpDate;
 import org.junit.Test;
@@ -459,6 +461,32 @@
     assertEquals(true, cookie.httpOnly());
   }
 
+  @Test public void equalsAndHashCode() throws Exception {
+    List<String> cookieStrings = Arrays.asList(
+        "a=b; Path=/c; Domain=example.com; Max-Age=5; Secure; HttpOnly",
+        "a= ; Path=/c; Domain=example.com; Max-Age=5; Secure; HttpOnly",
+        "a=b;          Domain=example.com; Max-Age=5; Secure; HttpOnly",
+        "a=b; Path=/c;                     Max-Age=5; Secure; HttpOnly",
+        "a=b; Path=/c; Domain=example.com;            Secure; HttpOnly",
+        "a=b; Path=/c; Domain=example.com; Max-Age=5;         HttpOnly",
+        "a=b; Path=/c; Domain=example.com; Max-Age=5; Secure;         "
+    );
+    for (String stringA : cookieStrings) {
+      Cookie cookieA = Cookie.parse(0, url, stringA);
+      for (String stringB : cookieStrings) {
+        Cookie cookieB = Cookie.parse(0, url, stringB);
+        if (Objects.equals(stringA, stringB)) {
+          assertEquals(cookieA.hashCode(), cookieB.hashCode());
+          assertEquals(cookieA, cookieB);
+        } else {
+          assertFalse(cookieA.hashCode() == cookieB.hashCode());
+          assertFalse(cookieA.equals(cookieB));
+        }
+      }
+      assertFalse(cookieA.equals(null));
+    }
+  }
+
   private Date date(String s) throws ParseException {
     SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ");
     format.setTimeZone(Util.UTC);
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Cookie.java b/okhttp/src/main/java/okhttp3/Cookie.java
index 12c4584..74e341d 100644
--- a/okhttp/src/main/java/okhttp3/Cookie.java
+++ b/okhttp/src/main/java/okhttp3/Cookie.java
@@ -559,4 +559,32 @@
 
     return result.toString();
   }
+
+  @Override public boolean equals(Object other) {
+    if (!(other instanceof Cookie)) return false;
+    Cookie that = (Cookie) other;
+    return that.name.equals(name)
+        && that.value.equals(value)
+        && that.domain.equals(domain)
+        && that.path.equals(path)
+        && that.expiresAt == expiresAt
+        && that.secure == secure
+        && that.httpOnly == httpOnly
+        && that.persistent == persistent
+        && that.hostOnly == hostOnly;
+  }
+
+  @Override public int hashCode() {
+    int hash = 17;
+    hash = 31 * hash + name.hashCode();
+    hash = 31 * hash + value.hashCode();
+    hash = 31 * hash + domain.hashCode();
+    hash = 31 * hash + path.hashCode();
+    hash = 31 * hash + (int) (expiresAt ^ (expiresAt >>> 32));
+    hash = 31 * hash + (secure ? 0 : 1);
+    hash = 31 * hash + (httpOnly ? 0 : 1);
+    hash = 31 * hash + (persistent ? 0 : 1);
+    hash = 31 * hash + (hostOnly ? 0 : 1);
+    return hash;
+  }
 }
/Fim/
diff --git a/mockwebserver/src/test/java/okhttp3/mockwebserver/MockWebServerTest.java b/mockwebserver/src/test/java/okhttp3/mockwebserver/MockWebServerTest.java
index b178622..9a1b0da 100644
--- a/mockwebserver/src/test/java/okhttp3/mockwebserver/MockWebServerTest.java
+++ b/mockwebserver/src/test/java/okhttp3/mockwebserver/MockWebServerTest.java
@@ -349,7 +349,7 @@
     assertTrue(server.getPort() > 0);
   }
 
-  @Test public void hostNameImplicitlyStarts() throws IOException {
+  @Test public void hostnameImplicitlyStarts() throws IOException {
     assertNotNull(server.getHostName());
   }
 
/Fim/
diff --git a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpURLConnectionImpl.java b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpURLConnectionImpl.java
index aa90bae..7bf248f 100644
--- a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpURLConnectionImpl.java
+++ b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpURLConnectionImpl.java
@@ -272,16 +272,16 @@
 
   @Override public final Permission getPermission() throws IOException {
     URL url = getURL();
-    String hostName = url.getHost();
+    String hostname = url.getHost();
     int hostPort = url.getPort() != -1
         ? url.getPort()
         : HttpUrl.defaultPort(url.getProtocol());
     if (usingProxy()) {
       InetSocketAddress proxyAddress = (InetSocketAddress) client.proxy().address();
-      hostName = proxyAddress.getHostName();
+      hostname = proxyAddress.getHostName();
       hostPort = proxyAddress.getPort();
     }
-    return new SocketPermission(hostName + ":" + hostPort, "connect, resolve");
+    return new SocketPermission(hostname + ":" + hostPort, "connect, resolve");
   }
 
   @Override public final String getRequestProperty(String field) {
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Cache.java b/okhttp/src/main/java/okhttp3/Cache.java
index 3717417..7e0b243 100644
--- a/okhttp/src/main/java/okhttp3/Cache.java
+++ b/okhttp/src/main/java/okhttp3/Cache.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3;
 
 import java.io.Closeable;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Handshake.java b/okhttp/src/main/java/okhttp3/Handshake.java
index 0221482..56e1fd4 100644
--- a/okhttp/src/main/java/okhttp3/Handshake.java
+++ b/okhttp/src/main/java/okhttp3/Handshake.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3;
 
 import java.security.Principal;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/ConnectionSpecSelector.java b/okhttp/src/main/java/okhttp3/internal/ConnectionSpecSelector.java
index 3123eec..1393910 100644
--- a/okhttp/src/main/java/okhttp3/internal/ConnectionSpecSelector.java
+++ b/okhttp/src/main/java/okhttp3/internal/ConnectionSpecSelector.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal;
 
 import java.io.IOException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/DiskLruCache.java b/okhttp/src/main/java/okhttp3/internal/DiskLruCache.java
index 34f993a..25e12ee 100644
--- a/okhttp/src/main/java/okhttp3/internal/DiskLruCache.java
+++ b/okhttp/src/main/java/okhttp3/internal/DiskLruCache.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal;
 
 import java.io.Closeable;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/FaultHidingSink.java b/okhttp/src/main/java/okhttp3/internal/FaultHidingSink.java
index ef8430c..e77f6bb 100644
--- a/okhttp/src/main/java/okhttp3/internal/FaultHidingSink.java
+++ b/okhttp/src/main/java/okhttp3/internal/FaultHidingSink.java
@@ -1,3 +1,18 @@
+/*
+ * Copyright (C) 2015 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
 package okhttp3.internal;
 
 import java.io.IOException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/NamedRunnable.java b/okhttp/src/main/java/okhttp3/internal/NamedRunnable.java
index 601ab2e..b5a4103 100644
--- a/okhttp/src/main/java/okhttp3/internal/NamedRunnable.java
+++ b/okhttp/src/main/java/okhttp3/internal/NamedRunnable.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal;
 
 /**
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/framed/FrameReader.java b/okhttp/src/main/java/okhttp3/internal/framed/FrameReader.java
index cfcfac0..741a568 100644
--- a/okhttp/src/main/java/okhttp3/internal/framed/FrameReader.java
+++ b/okhttp/src/main/java/okhttp3/internal/framed/FrameReader.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.framed;
 
 import java.io.Closeable;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/framed/FrameWriter.java b/okhttp/src/main/java/okhttp3/internal/framed/FrameWriter.java
index ca1a7e4..5e8c7eb 100644
--- a/okhttp/src/main/java/okhttp3/internal/framed/FrameWriter.java
+++ b/okhttp/src/main/java/okhttp3/internal/framed/FrameWriter.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.framed;
 
 import java.io.Closeable;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/framed/FramedConnection.java b/okhttp/src/main/java/okhttp3/internal/framed/FramedConnection.java
index 26d511f..0cfcba7 100644
--- a/okhttp/src/main/java/okhttp3/internal/framed/FramedConnection.java
+++ b/okhttp/src/main/java/okhttp3/internal/framed/FramedConnection.java
@@ -82,7 +82,7 @@
    */
   private final Listener listener;
   private final Map<Integer, FramedStream> streams = new HashMap<>();
-  private final String hostName;
+  private final String hostname;
   private int lastGoodStreamId;
   private int nextStreamId;
   private boolean shutdown;
@@ -148,14 +148,14 @@
       okHttpSettings.set(Settings.INITIAL_WINDOW_SIZE, 0, OKHTTP_CLIENT_WINDOW_SIZE);
     }
 
-    hostName = builder.hostName;
+    hostname = builder.hostname;
 
     if (protocol == Protocol.HTTP_2) {
       variant = new Http2();
       // Like newSingleThreadExecutor, except lazy creates the thread.
       pushExecutor = new ThreadPoolExecutor(0, 1, 60, TimeUnit.SECONDS,
           new LinkedBlockingQueue<Runnable>(),
-          Util.threadFactory(String.format("OkHttp %s Push Observer", hostName), true));
+          Util.threadFactory(String.format("OkHttp %s Push Observer", hostname), true));
       // 1 less than SPDY http://tools.ietf.org/html/draft-ietf-httpbis-http2-17#section-6.9.2
       peerSettings.set(Settings.INITIAL_WINDOW_SIZE, 0, 65535);
       peerSettings.set(Settings.MAX_FRAME_SIZE, 0, Http2.INITIAL_MAX_FRAME_SIZE);
@@ -342,7 +342,7 @@
   }
 
   void writeSynResetLater(final int streamId, final ErrorCode errorCode) {
-    executor.submit(new NamedRunnable("OkHttp %s stream %d", hostName, streamId) {
+    executor.submit(new NamedRunnable("OkHttp %s stream %d", hostname, streamId) {
       @Override public void execute() {
         try {
           writeSynReset(streamId, errorCode);
@@ -357,7 +357,7 @@
   }
 
   void writeWindowUpdateLater(final int streamId, final long unacknowledgedBytesRead) {
-    executor.execute(new NamedRunnable("OkHttp Window Update %s stream %d", hostName, streamId) {
+    executor.execute(new NamedRunnable("OkHttp Window Update %s stream %d", hostname, streamId) {
       @Override public void execute() {
         try {
           frameWriter.windowUpdate(streamId, unacknowledgedBytesRead);
@@ -390,7 +390,7 @@
   private void writePingLater(
       final boolean reply, final int payload1, final int payload2, final Ping ping) {
     executor.execute(new NamedRunnable("OkHttp %s ping %08x%08x",
-        hostName, payload1, payload2) {
+        hostname, payload1, payload2) {
       @Override public void execute() {
         try {
           writePing(reply, payload1, payload2, ping);
@@ -528,7 +528,7 @@
 
   public static class Builder {
     private Socket socket;
-    private String hostName;
+    private String hostname;
     private BufferedSource source;
     private BufferedSink sink;
     private Listener listener = Listener.REFUSE_INCOMING_STREAMS;
@@ -550,9 +550,9 @@
     }
 
     public Builder socket(
-        Socket socket, String hostName, BufferedSource source, BufferedSink sink) {
+        Socket socket, String hostname, BufferedSource source, BufferedSink sink) {
       this.socket = socket;
-      this.hostName = hostName;
+      this.hostname = hostname;
       this.source = source;
       this.sink = sink;
       return this;
@@ -586,7 +586,7 @@
     final FrameReader frameReader;
 
     private Reader(FrameReader frameReader) {
-      super("OkHttp %s", hostName);
+      super("OkHttp %s", hostname);
       this.frameReader = frameReader;
     }
 
@@ -663,12 +663,12 @@
               inFinished, headerBlock);
           lastGoodStreamId = streamId;
           streams.put(streamId, newStream);
-          executor.execute(new NamedRunnable("OkHttp %s stream %d", hostName, streamId) {
+          executor.execute(new NamedRunnable("OkHttp %s stream %d", hostname, streamId) {
             @Override public void execute() {
               try {
                 listener.onStream(newStream);
               } catch (IOException e) {
-                logger.log(Level.INFO, "FramedConnection.Listener failure for " + hostName, e);
+                logger.log(Level.INFO, "FramedConnection.Listener failure for " + hostname, e);
                 try {
                   newStream.close(ErrorCode.PROTOCOL_ERROR);
                 } catch (IOException ignored) {
@@ -724,7 +724,7 @@
             streamsToNotify = streams.values().toArray(new FramedStream[streams.size()]);
           }
         }
-        executor.execute(new NamedRunnable("OkHttp %s settings", hostName) {
+        executor.execute(new NamedRunnable("OkHttp %s settings", hostname) {
           @Override public void execute() {
             listener.onSettings(FramedConnection.this);
           }
@@ -740,7 +740,7 @@
     }
 
     private void ackSettingsLater(final Settings peerSettings) {
-      executor.execute(new NamedRunnable("OkHttp %s ACK Settings", hostName) {
+      executor.execute(new NamedRunnable("OkHttp %s ACK Settings", hostname) {
         @Override public void execute() {
           try {
             frameWriter.ackSettings(peerSettings);
@@ -834,7 +834,7 @@
       }
       currentPushRequests.add(streamId);
     }
-    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Request[%s]", hostName, streamId) {
+    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Request[%s]", hostname, streamId) {
       @Override public void execute() {
         boolean cancel = pushObserver.onRequest(streamId, requestHeaders);
         try {
@@ -852,7 +852,7 @@
 
   private void pushHeadersLater(final int streamId, final List<Header> requestHeaders,
       final boolean inFinished) {
-    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Headers[%s]", hostName, streamId) {
+    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Headers[%s]", hostname, streamId) {
       @Override public void execute() {
         boolean cancel = pushObserver.onHeaders(streamId, requestHeaders, inFinished);
         try {
@@ -878,7 +878,7 @@
     source.require(byteCount); // Eagerly read the frame before firing client thread.
     source.read(buffer, byteCount);
     if (buffer.size() != byteCount) throw new IOException(buffer.size() + " != " + byteCount);
-    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Data[%s]", hostName, streamId) {
+    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Data[%s]", hostname, streamId) {
       @Override public void execute() {
         try {
           boolean cancel = pushObserver.onData(streamId, buffer, byteCount, inFinished);
@@ -895,7 +895,7 @@
   }
 
   private void pushResetLater(final int streamId, final ErrorCode errorCode) {
-    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Reset[%s]", hostName, streamId) {
+    pushExecutor.execute(new NamedRunnable("OkHttp %s Push Reset[%s]", hostname, streamId) {
       @Override public void execute() {
         pushObserver.onReset(streamId, errorCode);
         synchronized (FramedConnection.this) {
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/framed/FramedStream.java b/okhttp/src/main/java/okhttp3/internal/framed/FramedStream.java
index 857a99c..c94a844 100644
--- a/okhttp/src/main/java/okhttp3/internal/framed/FramedStream.java
+++ b/okhttp/src/main/java/okhttp3/internal/framed/FramedStream.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.framed;
 
 import java.io.EOFException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/framed/Header.java b/okhttp/src/main/java/okhttp3/internal/framed/Header.java
index 38ac6a6..953671e 100644
--- a/okhttp/src/main/java/okhttp3/internal/framed/Header.java
+++ b/okhttp/src/main/java/okhttp3/internal/framed/Header.java
@@ -1,3 +1,18 @@
+/*
+ * Copyright (C) 2014 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
 package okhttp3.internal.framed;
 
 import okio.ByteString;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/CacheStrategy.java b/okhttp/src/main/java/okhttp3/internal/http/CacheStrategy.java
index a2f513d..940bd68 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/CacheStrategy.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/CacheStrategy.java
@@ -1,3 +1,18 @@
+/*
+ * Copyright (C) 2013 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
 package okhttp3.internal.http;
 
 import java.util.Date;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/HeaderParser.java b/okhttp/src/main/java/okhttp3/internal/http/HeaderParser.java
index 6cb3232..1e27c98 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/HeaderParser.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/HeaderParser.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.http;
 
 public final class HeaderParser {
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/Http1xStream.java b/okhttp/src/main/java/okhttp3/internal/http/Http1xStream.java
index 39ff4d4..3207887 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/Http1xStream.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/Http1xStream.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.http;
 
 import java.io.EOFException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/Http2xStream.java b/okhttp/src/main/java/okhttp3/internal/http/Http2xStream.java
index 2f91dab..83cddc3 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/Http2xStream.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/Http2xStream.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.http;
 
 import java.io.IOException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/HttpDate.java b/okhttp/src/main/java/okhttp3/internal/http/HttpDate.java
index b411a17..2991dd7 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/HttpDate.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/HttpDate.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.http;
 
 import java.text.DateFormat;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/HttpEngine.java b/okhttp/src/main/java/okhttp3/internal/http/HttpEngine.java
index 621d2d8..a4de543 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/HttpEngine.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/HttpEngine.java
@@ -14,7 +14,6 @@
  *  See the License for the specific language governing permissions and
  *  limitations under the License.
  */
-
 package okhttp3.internal.http;
 
 import java.io.IOException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/HttpStream.java b/okhttp/src/main/java/okhttp3/internal/http/HttpStream.java
index d5fc94c..34c4713 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/HttpStream.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/HttpStream.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.http;
 
 import java.io.IOException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/RequestLine.java b/okhttp/src/main/java/okhttp3/internal/http/RequestLine.java
index ff2bc55..c70a869 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/RequestLine.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/RequestLine.java
@@ -1,3 +1,18 @@
+/*
+ * Copyright (C) 2013 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
 package okhttp3.internal.http;
 
 import java.net.HttpURLConnection;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/RetryableSink.java b/okhttp/src/main/java/okhttp3/internal/http/RetryableSink.java
index 8fb13a8..c0010d1 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/RetryableSink.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/RetryableSink.java
@@ -13,7 +13,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package okhttp3.internal.http;
 
 import java.io.IOException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/StatusLine.java b/okhttp/src/main/java/okhttp3/internal/http/StatusLine.java
index ccc642b..f3591a6 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/StatusLine.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/StatusLine.java
@@ -1,3 +1,18 @@
+/*
+ * Copyright (C) 2013 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
 package okhttp3.internal.http;
 
 import java.io.IOException;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/CertificateAuthorityCouncil.java b/okhttp/src/main/java/okhttp3/internal/tls/CertificateAuthorityCouncil.java
index 4891f9a..3eaefef 100644
--- a/okhttp/src/main/java/okhttp3/internal/tls/CertificateAuthorityCouncil.java
+++ b/okhttp/src/main/java/okhttp3/internal/tls/CertificateAuthorityCouncil.java
@@ -16,6 +16,7 @@
  */
 package okhttp3.internal.tls;
 
+import java.security.GeneralSecurityException;
 import java.security.PublicKey;
 import java.security.cert.Certificate;
 import java.security.cert.X509Certificate;
@@ -78,7 +79,7 @@
       // certificate to the end of the chain, unless it's already present. (That would happen if the
       // first certificate in the chain is itself a self-signed and trusted CA certificate.)
       X509Certificate caCert = findByIssuerAndSignature(toVerify);
-      if (caCert != null) {
+      if (caCert != null && verifySignature(toVerify, caCert)) {
         if (result.size() > 1 || !toVerify.equals(caCert)) {
           result.add(caCert);
         }
@@ -88,8 +89,9 @@
       // Search for the certificate in the chain that signed this certificate. This is typically the
       // next element in the chain, but it could be any element.
       for (Iterator<Certificate> i = queue.iterator(); i.hasNext(); ) {
-        Certificate signingCert = i.next();
-        if (toVerify.getIssuerDN().equals(((X509Certificate) signingCert).getSubjectDN())) {
+        X509Certificate signingCert = (X509Certificate) i.next();
+        if (toVerify.getIssuerDN().equals(signingCert.getSubjectDN())
+            && verifySignature(toVerify, signingCert)) {
           i.remove();
           result.add(signingCert);
           continue followIssuerChain;
@@ -100,6 +102,16 @@
     }
   }
 
+  /** Returns true if {@code toVerify} was signed by {@code signingCert}'s public key. */
+  private boolean verifySignature(X509Certificate toVerify, X509Certificate signingCert) {
+    try {
+      toVerify.verify(signingCert.getPublicKey());
+      return true;
+    } catch (GeneralSecurityException verifyFailed) {
+      return false;
+    }
+  }
+
   /** Returns the trusted CA certificate that signed {@code cert}. */
   private X509Certificate findByIssuerAndSignature(X509Certificate cert) {
     X500Principal issuer = cert.getIssuerX500Principal();
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/DistinguishedNameParser.java b/okhttp/src/main/java/okhttp3/internal/tls/DistinguishedNameParser.java
index ceecd9c..616bca5 100644
--- a/okhttp/src/main/java/okhttp3/internal/tls/DistinguishedNameParser.java
+++ b/okhttp/src/main/java/okhttp3/internal/tls/DistinguishedNameParser.java
@@ -14,7 +14,6 @@
  *  See the License for the specific language governing permissions and
  *  limitations under the License.
  */
-
 package okhttp3.internal.tls;
 
 import javax.security.auth.x500.X500Principal;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/OkHostnameVerifier.java b/okhttp/src/main/java/okhttp3/internal/tls/OkHostnameVerifier.java
index e6ad9b8..a85df78 100644
--- a/okhttp/src/main/java/okhttp3/internal/tls/OkHostnameVerifier.java
+++ b/okhttp/src/main/java/okhttp3/internal/tls/OkHostnameVerifier.java
@@ -14,7 +14,6 @@
  *  See the License for the specific language governing permissions and
  *  limitations under the License.
  */
-
 package okhttp3.internal.tls;
 
 import java.security.cert.Certificate;
@@ -57,7 +56,7 @@
   public boolean verify(String host, X509Certificate certificate) {
     return verifyAsIpAddress(host)
         ? verifyIpAddress(host, certificate)
-        : verifyHostName(host, certificate);
+        : verifyHostname(host, certificate);
   }
 
   /** Returns true if {@code certificate} matches {@code ipAddress}. */
@@ -71,14 +70,14 @@
     return false;
   }
 
-  /** Returns true if {@code certificate} matches {@code hostName}. */
-  private boolean verifyHostName(String hostName, X509Certificate certificate) {
-    hostName = hostName.toLowerCase(Locale.US);
+  /** Returns true if {@code certificate} matches {@code hostname}. */
+  private boolean verifyHostname(String hostname, X509Certificate certificate) {
+    hostname = hostname.toLowerCase(Locale.US);
     boolean hasDns = false;
     List<String> altNames = getSubjectAltNames(certificate, ALT_DNS_NAME);
     for (int i = 0, size = altNames.size(); i < size; i++) {
       hasDns = true;
-      if (verifyHostName(hostName, altNames.get(i))) {
+      if (verifyHostname(hostname, altNames.get(i))) {
         return true;
       }
     }
@@ -88,7 +87,7 @@
       // RFC 2818 advises using the most specific name for matching.
       String cn = new DistinguishedNameParser(principal).findMostSpecific("cn");
       if (cn != null) {
-        return verifyHostName(hostName, cn);
+        return verifyHostname(hostname, cn);
       }
     }
 
@@ -134,17 +133,17 @@
   }
 
   /**
-   * Returns {@code true} iff {@code hostName} matches the domain name {@code pattern}.
+   * Returns {@code true} iff {@code hostname} matches the domain name {@code pattern}.
    *
-   * @param hostName lower-case host name.
+   * @param hostname lower-case host name.
    * @param pattern domain name pattern from certificate. May be a wildcard pattern such as {@code
    * *.android.com}.
    */
-  private boolean verifyHostName(String hostName, String pattern) {
+  private boolean verifyHostname(String hostname, String pattern) {
     // Basic sanity checks
     // Check length == 0 instead of .isEmpty() to support Java 5.
-    if ((hostName == null) || (hostName.length() == 0) || (hostName.startsWith("."))
-        || (hostName.endsWith(".."))) {
+    if ((hostname == null) || (hostname.length() == 0) || (hostname.startsWith("."))
+        || (hostname.endsWith(".."))) {
       // Invalid domain name
       return false;
     }
@@ -154,29 +153,29 @@
       return false;
     }
 
-    // Normalize hostName and pattern by turning them into absolute domain names if they are not
+    // Normalize hostname and pattern by turning them into absolute domain names if they are not
     // yet absolute. This is needed because server certificates do not normally contain absolute
-    // names or patterns, but they should be treated as absolute. At the same time, any hostName
+    // names or patterns, but they should be treated as absolute. At the same time, any hostname
     // presented to this method should also be treated as absolute for the purposes of matching
     // to the server certificate.
     //   www.android.com  matches www.android.com
     //   www.android.com  matches www.android.com.
     //   www.android.com. matches www.android.com.
     //   www.android.com. matches www.android.com
-    if (!hostName.endsWith(".")) {
-      hostName += '.';
+    if (!hostname.endsWith(".")) {
+      hostname += '.';
     }
     if (!pattern.endsWith(".")) {
       pattern += '.';
     }
-    // hostName and pattern are now absolute domain names.
+    // hostname and pattern are now absolute domain names.
 
     pattern = pattern.toLowerCase(Locale.US);
-    // hostName and pattern are now in lower case -- domain names are case-insensitive.
+    // hostname and pattern are now in lower case -- domain names are case-insensitive.
 
     if (!pattern.contains("*")) {
-      // Not a wildcard pattern -- hostName and pattern must match exactly.
-      return hostName.equals(pattern);
+      // Not a wildcard pattern -- hostname and pattern must match exactly.
+      return hostname.equals(pattern);
     }
     // Wildcard pattern
 
@@ -196,11 +195,11 @@
       return false;
     }
 
-    // Optimization: check whether hostName is too short to match the pattern. hostName must be at
+    // Optimization: check whether hostname is too short to match the pattern. hostName must be at
     // least as long as the pattern because asterisk must match the whole left-most label and
-    // hostName starts with a non-empty label. Thus, asterisk has to match one or more characters.
-    if (hostName.length() < pattern.length()) {
-      // hostName too short to match the pattern.
+    // hostname starts with a non-empty label. Thus, asterisk has to match one or more characters.
+    if (hostname.length() < pattern.length()) {
+      // hostname too short to match the pattern.
       return false;
     }
 
@@ -209,22 +208,22 @@
       return false;
     }
 
-    // hostName must end with the region of pattern following the asterisk.
+    // hostname must end with the region of pattern following the asterisk.
     String suffix = pattern.substring(1);
-    if (!hostName.endsWith(suffix)) {
-      // hostName does not end with the suffix
+    if (!hostname.endsWith(suffix)) {
+      // hostname does not end with the suffix
       return false;
     }
 
     // Check that asterisk did not match across domain name labels.
-    int suffixStartIndexInHostName = hostName.length() - suffix.length();
-    if ((suffixStartIndexInHostName > 0)
-        && (hostName.lastIndexOf('.', suffixStartIndexInHostName - 1) != -1)) {
+    int suffixStartIndexInHostname = hostname.length() - suffix.length();
+    if ((suffixStartIndexInHostname > 0)
+        && (hostname.lastIndexOf('.', suffixStartIndexInHostname - 1) != -1)) {
       // Asterisk is matching across domain name labels -- not permitted.
       return false;
     }
 
-    // hostName matches pattern
+    // hostname matches pattern
     return true;
   }
 }
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 7229b70..be2b8c9 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,29 @@
 Change Log
 ==========
 
+## Version 3.1.0
+
+_2016-02-06_
+
+ *  New: WebSockets now defer some writes. This should improve performance for
+    some applications.
+ *  New: Override `equals()` and `hashCode()` in our new cookie class. This
+    class now defines equality by value rather than by reference.
+ *  New: Handle 408 responses by retrying the request. This allows servers to
+    direct clients to retry rather than failing permanently.
+ *  New: Expose the framed protocol in `Connection`. Previously this would
+    return the application-layer protocol (HTTP/1.1 or HTTP/1.0); now it always
+    returns the wire-layer protocol (HTTP/2, SPDY/3.1, or HTTP/1.1).
+ *  Fix: Permit the trusted CA root to be pinned by `CertificatePinner`.
+ *  Fix: Silently ignore unknown HTTP/2 settings. Previously this would cause
+    the entire connection to fail.
+ *  Fix: Dont crash on unexpected charsets in the logging interceptor.
+ *  Fix: `OkHttpClient` is now non-final for the benefit of mocking frameworks.
+    Mocking sophisticated classes like `OkHttpClient` is fragile and you
+    shouldnt do it. But if thats how you want to live your life we wont stand
+    in your way!
+
+
 ## Version 3.0.1
 
 _2016-01-14_
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 6a4459e..0b46ec6 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index c87dbc2..51fcaed 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 9acb228..90c8dd1 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 0344a33..d52fb0f 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index dcf813e..065277e 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 789f036..b42cdb5 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index a11bef1..00a4841 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 59383f4..ae6c793 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 5004d5f..0f994a2 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 926b4be..e73f805 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 3841ecc..875cda7 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 8629395..4ad9cb6 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 772e8a4..5033aa9 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.1.0-SNAPSHOT</version>
+  <version>3.1.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.1.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 63b8c43..279bc09 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index c81ea17..4cd3365 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 784ff1d..50ccde5 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index f5b0e7f..731d8ee 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 1acef5f..00d583e 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0-SNAPSHOT</version>
+    <version>3.1.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 0b46ec6..cf29f7b 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 51fcaed..379b323 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 90c8dd1..0b6f0d6 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index d52fb0f..066fb72 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 065277e..6235935 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index b42cdb5..17e074e 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 00a4841..c1e13b7 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index ae6c793..20f5183 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 0f994a2..322dab6 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index e73f805..cb2972a 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 875cda7..5f9655b 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 4ad9cb6..dc8dad8 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 5033aa9..7eb918a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.1.0</version>
+  <version>3.2.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.1.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 279bc09..80c803d 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 4cd3365..b2d38e5 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 50ccde5..d6f08bc 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 731d8ee..d255e16 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 00d583e..c32ea5c 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.0</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index be2b8c9..66ab8ca 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -151,6 +151,13 @@
  *  New: Make `HttpUrl` the blessed URL method of `Request`.
 
 
+## Version 2.7.3
+
+_2016-02-06_
+
+ *  Fix: Permit the trusted CA root to be pinned by `CertificatePinner`.
+
+
 ## Version 2.7.2
 
 _2016-01-07_
/Fim/
diff --git a/README.md b/README.md
index c84574c..9c72e6c 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.0.1</version>
+  <version>3.1.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.0.1'
+compile 'com.squareup.okhttp3:okhttp:3.1.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.0.1</version>
+  <version>3.1.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.0.1'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.1.0'
 ```
 
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index cf29f7b..ed77d5c 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 379b323..296b9be 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 0b6f0d6..5154c16 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 066fb72..4761207 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6235935..122ce2d 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 17e074e..429323b 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index c1e13b7..5b55ea6 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 20f5183..17be111 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 322dab6..01c9666 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index cb2972a..2f4f64a 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 5f9655b..88953e5 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index dc8dad8..4ddc9bc 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 7eb918a..d9feea1 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.2.0-SNAPSHOT</version>
+  <version>3.1.1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.1.1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 80c803d..052003a 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index b2d38e5..15f9229 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d6f08bc..19c399c 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index d255e16..d62382a 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index c32ea5c..44a6b74 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index ed77d5c..cf29f7b 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 296b9be..379b323 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 5154c16..0b6f0d6 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 4761207..066fb72 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 122ce2d..6235935 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 429323b..17e074e 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 5b55ea6..c1e13b7 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 17be111..20f5183 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 01c9666..322dab6 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 2f4f64a..cb2972a 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 88953e5..5f9655b 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 4ddc9bc..dc8dad8 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index d9feea1..7eb918a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.1.1</version>
+  <version>3.2.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.1.1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 052003a..80c803d 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 15f9229..b2d38e5 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 19c399c..d6f08bc 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index d62382a..d255e16 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 44a6b74..c32ea5c 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.1</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 66ab8ca..e614c28 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -151,6 +151,16 @@
  *  New: Make `HttpUrl` the blessed URL method of `Request`.
 
 
+## Version 2.7.4
+
+_2016-02-07_
+
+ *  Fix: Don't crash when finding the trust manager if the Play Services (GMS)
+    security provider is installed.
+ *  Fix: The previous release introduced a performance regression on Android,
+    caused by looking up CA certificates. This is now fixed.
+
+
 ## Version 2.7.3
 
 _2016-02-06_
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index e614c28..291bcc8 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,16 @@
 Change Log
 ==========
 
+## Version 3.1.1
+
+_2016-02-07_
+
+ *  Fix: Don't crash when finding the trust manager if the Play Services (GMS)
+    security provider is installed.
+ *  Fix: The previous release introduced a performance regression on Android,
+    caused by looking up CA certificates. This is now fixed.
+
+
 ## Version 3.1.0
 
 _2016-02-06_
/Fim/
diff --git a/README.md b/README.md
index 9c72e6c..e54b4c6 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.1.0</version>
+  <version>3.1.1</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.1.0'
+compile 'com.squareup.okhttp3:okhttp:3.1.1'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.1.0</version>
+  <version>3.1.1</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.1.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.1.1'
 ```
 
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index cf29f7b..254331e 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 379b323..c2b80d3 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 0b6f0d6..028c1f6 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 066fb72..984dea5 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6235935..e49134e 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 17e074e..2ca7b6d 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index c1e13b7..ca7217b 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 20f5183..facb674 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 322dab6..6a68625 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index cb2972a..a7d7c60 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 5f9655b..ac5f187 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index dc8dad8..a4fcffe 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 7eb918a..67105a7 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.2.0-SNAPSHOT</version>
+  <version>3.1.2</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.1.2</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 80c803d..9ad873b 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index b2d38e5..05d625d 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d6f08bc..0f625cd 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index d255e16..ee78290 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index c32ea5c..9405c48 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.1.2</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 254331e..cf29f7b 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index c2b80d3..379b323 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 028c1f6..0b6f0d6 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 984dea5..066fb72 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index e49134e..6235935 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 2ca7b6d..17e074e 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index ca7217b..c1e13b7 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index facb674..20f5183 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 6a68625..322dab6 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index a7d7c60..cb2972a 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index ac5f187..5f9655b 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a4fcffe..dc8dad8 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 67105a7..7eb918a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.1.2</version>
+  <version>3.2.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.1.2</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 9ad873b..80c803d 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 05d625d..b2d38e5 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 0f625cd..d6f08bc 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index ee78290..d255e16 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 9405c48..c32ea5c 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.1.2</version>
+    <version>3.2.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 291bcc8..b7d52c8 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,19 @@
 Change Log
 ==========
 
+## Version 3.1.2
+
+_2016-02-10_
+
+ *  Fix: Dont crash when finding the trust manager on Robolectric. We attempted
+    to detect the host platform and got confused because Robolectric looks like
+    Android but isnt!
+ *  Fix: Change `CertificatePinner` to skip sanitizing the certificate chain
+    when no certificates were pinned. This avoids an SSL failure in insecure
+    trust everyone configurations, such as when talking to a development
+    HTTPS server that has a self-signed certificate.
+
+
 ## Version 3.1.1
 
 _2016-02-07_
/Fim/
diff --git a/README.md b/README.md
index e54b4c6..09a3831 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.1.1</version>
+  <version>3.1.2</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.1.1'
+compile 'com.squareup.okhttp3:okhttp:3.1.2'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.1.1</version>
+  <version>3.1.2</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.1.1'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.1.2'
 ```
 
 
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/HttpUrlTest.java b/okhttp-tests/src/test/java/okhttp3/HttpUrlTest.java
index a67dc38..e72c78d 100644
--- a/okhttp-tests/src/test/java/okhttp3/HttpUrlTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/HttpUrlTest.java
@@ -801,6 +801,64 @@
     assertEquals(3, HttpUrl.parse("http://host/a/b/c").pathSize());
   }
 
+  @Test public void addPathSegments() throws Exception {
+    HttpUrl base = HttpUrl.parse("http://host/a/b/c");
+
+    // Add a string with zero slashes: resulting URL gains one slash.
+    assertEquals("/a/b/c/", base.newBuilder().addPathSegments("").build().encodedPath());
+    assertEquals("/a/b/c/d", base.newBuilder().addPathSegments("d").build().encodedPath());
+
+    // Add a string with one slash: resulting URL gains two slashes.
+    assertEquals("/a/b/c//", base.newBuilder().addPathSegments("/").build().encodedPath());
+    assertEquals("/a/b/c/d/", base.newBuilder().addPathSegments("d/").build().encodedPath());
+    assertEquals("/a/b/c//d", base.newBuilder().addPathSegments("/d").build().encodedPath());
+
+    // Add a string with two slashes: resulting URL gains three slashes.
+    assertEquals("/a/b/c///", base.newBuilder().addPathSegments("//").build().encodedPath());
+    assertEquals("/a/b/c//d/", base.newBuilder().addPathSegments("/d/").build().encodedPath());
+    assertEquals("/a/b/c/d//", base.newBuilder().addPathSegments("d//").build().encodedPath());
+    assertEquals("/a/b/c///d", base.newBuilder().addPathSegments("//d").build().encodedPath());
+    assertEquals("/a/b/c/d/e/f", base.newBuilder().addPathSegments("d/e/f").build().encodedPath());
+  }
+
+  @Test public void addPathSegmentsOntoTrailingSlash() throws Exception {
+    HttpUrl base = HttpUrl.parse("http://host/a/b/c/");
+
+    // Add a string with zero slashes: resulting URL gains zero slashes.
+    assertEquals("/a/b/c/", base.newBuilder().addPathSegments("").build().encodedPath());
+    assertEquals("/a/b/c/d", base.newBuilder().addPathSegments("d").build().encodedPath());
+
+    // Add a string with one slash: resulting URL gains one slash.
+    assertEquals("/a/b/c//", base.newBuilder().addPathSegments("/").build().encodedPath());
+    assertEquals("/a/b/c/d/", base.newBuilder().addPathSegments("d/").build().encodedPath());
+    assertEquals("/a/b/c//d", base.newBuilder().addPathSegments("/d").build().encodedPath());
+
+    // Add a string with two slashes: resulting URL gains two slashes.
+    assertEquals("/a/b/c///", base.newBuilder().addPathSegments("//").build().encodedPath());
+    assertEquals("/a/b/c//d/", base.newBuilder().addPathSegments("/d/").build().encodedPath());
+    assertEquals("/a/b/c/d//", base.newBuilder().addPathSegments("d//").build().encodedPath());
+    assertEquals("/a/b/c///d", base.newBuilder().addPathSegments("//d").build().encodedPath());
+    assertEquals("/a/b/c/d/e/f", base.newBuilder().addPathSegments("d/e/f").build().encodedPath());
+  }
+
+  @Test public void addPathSegmentsWithBackslash() throws Exception {
+    HttpUrl base = HttpUrl.parse("http://host/");
+    assertEquals("/d/e", base.newBuilder().addPathSegments("d\\e").build().encodedPath());
+    assertEquals("/d/e", base.newBuilder().addEncodedPathSegments("d\\e").build().encodedPath());
+  }
+
+  @Test public void addPathSegmentsWithEmptyPaths() throws Exception {
+    HttpUrl base = HttpUrl.parse("http://host/a/b/c");
+    assertEquals("/a/b/c//d/e///f",
+        base.newBuilder().addPathSegments("/d/e///f").build().encodedPath());
+  }
+
+  @Test public void addEncodedPathSegments() throws Exception {
+    HttpUrl base = HttpUrl.parse("http://host/a/b/c");
+    assertEquals("/a/b/c/d/e/%20/",
+        base.newBuilder().addEncodedPathSegments("d/e/%20/\n").build().encodedPath());
+  }
+
   @Test public void addPathSegmentDotDoesNothing() throws Exception {
     HttpUrl base = HttpUrl.parse("http://host/a/b/c");
     assertEquals("/a/b/c", base.newBuilder().addPathSegment(".").build().encodedPath());
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/HttpUrl.java b/okhttp/src/main/java/okhttp3/HttpUrl.java
index 59cbdd4..e5dedd7 100644
--- a/okhttp/src/main/java/okhttp3/HttpUrl.java
+++ b/okhttp/src/main/java/okhttp3/HttpUrl.java
@@ -772,6 +772,15 @@
       return this;
     }
 
+    /**
+     * Adds a set of path segments separated by a slash (either {@code \} or {@code /}). If
+     * {@code pathSegments} starts with a slash, the resulting URL will have empty path segment.
+     */
+    public Builder addPathSegments(String pathSegments) {
+      if (pathSegments == null) throw new IllegalArgumentException("pathSegments == null");
+      return addPathSegments(pathSegments, false);
+    }
+
     public Builder addEncodedPathSegment(String encodedPathSegment) {
       if (encodedPathSegment == null) {
         throw new IllegalArgumentException("encodedPathSegment == null");
@@ -780,6 +789,29 @@
       return this;
     }
 
+    /**
+     * Adds a set of encoded path segments separated by a slash (either {@code \} or {@code /}). If
+     * {@code encodedPathSegments} starts with a slash, the resulting URL will have empty path
+     * segment.
+     */
+    public Builder addEncodedPathSegments(String encodedPathSegments) {
+      if (encodedPathSegments == null) {
+        throw new IllegalArgumentException("encodedPathSegments == null");
+      }
+      return addPathSegments(encodedPathSegments, true);
+    }
+
+    private Builder addPathSegments(String pathSegments, boolean alreadyEncoded) {
+      int offset = 0;
+      do {
+        int segmentEnd = delimiterOffset(pathSegments, offset, pathSegments.length(), "/\\");
+        boolean addTrailingSlash = segmentEnd < pathSegments.length();
+        push(pathSegments, offset, segmentEnd, addTrailingSlash, alreadyEncoded);
+        offset = segmentEnd + 1;
+      } while (offset <= pathSegments.length());
+      return this;
+    }
+
     public Builder setPathSegment(int index, String pathSegment) {
       if (pathSegment == null) throw new IllegalArgumentException("pathSegment == null");
       String canonicalPathSegment = canonicalize(
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index b7d52c8..df62fae 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,19 @@
 Change Log
 ==========
 
+## Version 3.2.0
+
+_2016-02-25_
+
+ *  Fix: Change the certificate pinner to always build full chains. This
+    prevents a potential crash when using certificate pinning with the Google
+    Play Services security provider.
+ *  Fix: Make IPv6 request lines consistent with Firefox and Chrome.
+ *  Fix: Recover gracefully when trimming the response cache fails.
+ *  New: Add multiple path segments using a single string in `HttpUrl.Builder`.
+ *  New: Support SHA-256 pins in certificate pinner.
+
+
 ## Version 3.1.2
 
 _2016-02-10_
/Fim/
diff --git a/README.md b/README.md
index 09a3831..b6b059d 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.1.2</version>
+  <version>3.2.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.1.2'
+compile 'com.squareup.okhttp3:okhttp:3.2.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.1.2</version>
+  <version>3.2.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.1.2'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.2.0'
 ```
 
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index cf29f7b..cb989fe 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 379b323..aa6611d 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 0b6f0d6..c22d0db 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 066fb72..e772840 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 6235935..8b28bcd 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 17e074e..a9dc370 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index c1e13b7..154a9c6 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 20f5183..1c029c5 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 322dab6..a60b155 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index cb2972a..c678fdb 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 5f9655b..bf44359 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index dc8dad8..5b8aa86 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 90500ef..8112419 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.2.0-SNAPSHOT</version>
+  <version>3.2.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.2.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 80c803d..382822e 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index b2d38e5..e175327 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d6f08bc..bb8522e 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index d255e16..61e3308 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index c32ea5c..a8acc63 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0-SNAPSHOT</version>
+    <version>3.2.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index cb989fe..2dab72f 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index aa6611d..0d858e5 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index c22d0db..63b1cc8 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index e772840..9f6f647 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 8b28bcd..68fcf1a 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index a9dc370..a837c6c 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 154a9c6..7b6ad7c 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 1c029c5..d9f8596 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index a60b155..2c95ffc 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index c678fdb..783385c 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index bf44359..e6dbdb5 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 5b8aa86..0db4e1a 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 8112419..52c283e 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.2.0</version>
+  <version>3.3.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -64,7 +64,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.2.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 382822e..0daef2b 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index e175327..cb49750 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index bb8522e..4c484cb 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 61e3308..1e40e2e 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index a8acc63..f9e5101 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.2.0</version>
+    <version>3.3.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index df62fae..960d7d2 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -187,6 +187,15 @@
  *  New: Make `HttpUrl` the blessed URL method of `Request`.
 
 
+## Version 2.7.5
+
+_2016-02-25_
+
+ *  Fix: Change the certificate pinner to always build full chains. This
+    prevents a potential crash when using certificate pinning with the Google
+    Play Services security provider.
+
+
 ## Version 2.7.4
 
 _2016-02-07_
/Fim/
diff --git a/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java b/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java
index 5e738b3..532b80c 100644
--- a/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java
+++ b/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java
@@ -15,6 +15,7 @@
  */
 package okhttp3.logging;
 
+import java.io.EOFException;
 import java.io.IOException;
 import java.nio.charset.Charset;
 import java.nio.charset.UnsupportedCharsetException;
@@ -192,10 +193,14 @@
         }
 
         logger.log("");
-        logger.log(buffer.readString(charset));
-
-        logger.log("--> END " + request.method()
-            + " (" + requestBody.contentLength() + "-byte body)");
+        if (isPlaintext(buffer)) {
+          logger.log(buffer.readString(charset));
+          logger.log("--> END " + request.method()
+              + " (" + requestBody.contentLength() + "-byte body)");
+        } else {
+          logger.log("--> END " + request.method() + " (binary "
+              + requestBody.contentLength() + "-byte body omitted)");
+        }
       }
     }
 
@@ -239,6 +244,12 @@
           }
         }
 
+        if (!isPlaintext(buffer)) {
+          logger.log("");
+          logger.log("<-- END HTTP (binary " + buffer.size() + "-byte body omitted)");
+          return response;
+        }
+
         if (contentLength != 0) {
           logger.log("");
           logger.log(buffer.clone().readString(charset));
@@ -251,6 +262,29 @@
     return response;
   }
 
+  /**
+   * Returns true if the body in question probably contains human readable text. Uses a small sample
+   * of code points to detect unicode control characters commonly used in binary file signatures.
+   */
+  static boolean isPlaintext(Buffer buffer) throws EOFException {
+    try {
+      Buffer prefix = new Buffer();
+      long byteCount = buffer.size() < 64 ? buffer.size() : 64;
+      buffer.copyTo(prefix, 0, byteCount);
+      for (int i = 0; i < 16; i++) {
+        if (prefix.exhausted()) {
+          break;
+        }
+        if (Character.isISOControl(prefix.readUtf8CodePoint())) {
+          return false;
+        }
+      }
+      return true;
+    } catch (EOFException e) {
+      return false; // Truncated UTF-8 sequence.
+    }
+  }
+
   private boolean bodyEncoded(Headers headers) {
     String contentEncoding = headers.get("Content-Encoding");
     return contentEncoding != null && !contentEncoding.equalsIgnoreCase("identity");
/Fim/
diff --git a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
index 88630b5..3159ad2 100644
--- a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
+++ b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
@@ -37,6 +37,7 @@
 import org.junit.Test;
 
 import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertSame;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assert.fail;
@@ -638,6 +639,60 @@
         .assertNoMoreLogs();
   }
 
+  @Test public void isPlaintext() throws IOException {
+    assertTrue(HttpLoggingInterceptor.isPlaintext(new Buffer()));
+    assertTrue(HttpLoggingInterceptor.isPlaintext(new Buffer().writeUtf8("abc")));
+    assertTrue(HttpLoggingInterceptor.isPlaintext(new Buffer().writeByte(0x80)));
+    assertFalse(HttpLoggingInterceptor.isPlaintext(new Buffer().writeByte(0x00)));
+    assertFalse(HttpLoggingInterceptor.isPlaintext(new Buffer().writeByte(0xc0)));
+  }
+
+  @Test public void responseBodyIsBinary() throws IOException {
+    setLevel(Level.BODY);
+    Buffer buffer = new Buffer();
+    buffer.writeUtf8CodePoint(0x89);
+    buffer.writeUtf8CodePoint(0x50);
+    buffer.writeUtf8CodePoint(0x4e);
+    buffer.writeUtf8CodePoint(0x47);
+    buffer.writeUtf8CodePoint(0x0d);
+    buffer.writeUtf8CodePoint(0x0a);
+    buffer.writeUtf8CodePoint(0x1a);
+    buffer.writeUtf8CodePoint(0x0a);
+    server.enqueue(new MockResponse()
+        .setBody(buffer)
+        .setHeader("Content-Type", "image/png; charset=utf-8"));
+    Response response = client.newCall(request().build()).execute();
+    response.body().close();
+
+    applicationLogs
+        .assertLogEqual("--> GET " + url + " http/1.1")
+        .assertLogEqual("--> END GET")
+        .assertLogMatch("<-- 200 OK " + url + " \\(\\d+ms\\)")
+        .assertLogEqual("Content-Length: 9")
+        .assertLogEqual("Content-Type: image/png; charset=utf-8")
+        .assertLogMatch("OkHttp-Sent-Millis: \\d+")
+        .assertLogMatch("OkHttp-Received-Millis: \\d+")
+        .assertLogEqual("")
+        .assertLogEqual("<-- END HTTP (binary 9-byte body omitted)")
+        .assertNoMoreLogs();
+
+    networkLogs
+        .assertLogEqual("--> GET " + url + " http/1.1")
+        .assertLogEqual("Host: " + host)
+        .assertLogEqual("Connection: Keep-Alive")
+        .assertLogEqual("Accept-Encoding: gzip")
+        .assertLogMatch("User-Agent: okhttp/.+")
+        .assertLogEqual("--> END GET")
+        .assertLogMatch("<-- 200 OK " + url + " \\(\\d+ms\\)")
+        .assertLogEqual("Content-Length: 9")
+        .assertLogEqual("Content-Type: image/png; charset=utf-8")
+        .assertLogMatch("OkHttp-Sent-Millis: \\d+")
+        .assertLogMatch("OkHttp-Received-Millis: \\d+")
+        .assertLogEqual("")
+        .assertLogEqual("<-- END HTTP (binary 9-byte body omitted)")
+        .assertNoMoreLogs();
+  }
+
   private Request.Builder request() {
     return new Request.Builder().url(url);
   }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CookieTest.java b/okhttp-tests/src/test/java/okhttp3/CookieTest.java
index 9ab2117..bee549d 100644
--- a/okhttp-tests/src/test/java/okhttp3/CookieTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CookieTest.java
@@ -399,7 +399,7 @@
     try {
       new Cookie.Builder().hostOnlyDomain(null);
       fail();
-    } catch (IllegalArgumentException expected) {
+    } catch (NullPointerException expected) {
     }
     try {
       new Cookie.Builder().hostOnlyDomain("a/b");
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/RequestTest.java b/okhttp-tests/src/test/java/okhttp3/RequestTest.java
index 0ef87d6..4668f60 100644
--- a/okhttp-tests/src/test/java/okhttp3/RequestTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/RequestTest.java
@@ -174,8 +174,31 @@
     }
   }
 
+  @Test public void headerForbidsNullArguments() throws Exception {
+    Request.Builder builder = new Request.Builder();
+    try {
+      builder.header(null, "Value");
+      fail();
+    } catch (NullPointerException expected) {
+    }
+    try {
+      builder.addHeader(null, "Value");
+      fail();
+    } catch (NullPointerException expected) {
+    }
+    try {
+      builder.header("Name", null);
+      fail();
+    } catch (NullPointerException expected) {
+    }
+    try {
+      builder.addHeader("Name", null);
+      fail();
+    } catch (NullPointerException expected) {
+    }
+  }
+
   @Test public void headerForbidsControlCharacters() throws Exception {
-    assertForbiddenHeader(null);
     assertForbiddenHeader("\u0000");
     assertForbiddenHeader("\r");
     assertForbiddenHeader("\n");
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Address.java b/okhttp/src/main/java/okhttp3/Address.java
index cec1542..4fd9776 100644
--- a/okhttp/src/main/java/okhttp3/Address.java
+++ b/okhttp/src/main/java/okhttp3/Address.java
@@ -57,24 +57,24 @@
         .port(uriPort)
         .build();
 
-    if (dns == null) throw new IllegalArgumentException("dns == null");
+    if (dns == null) throw new NullPointerException("dns == null");
     this.dns = dns;
 
-    if (socketFactory == null) throw new IllegalArgumentException("socketFactory == null");
+    if (socketFactory == null) throw new NullPointerException("socketFactory == null");
     this.socketFactory = socketFactory;
 
     if (proxyAuthenticator == null) {
-      throw new IllegalArgumentException("proxyAuthenticator == null");
+      throw new NullPointerException("proxyAuthenticator == null");
     }
     this.proxyAuthenticator = proxyAuthenticator;
 
-    if (protocols == null) throw new IllegalArgumentException("protocols == null");
+    if (protocols == null) throw new NullPointerException("protocols == null");
     this.protocols = Util.immutableList(protocols);
 
-    if (connectionSpecs == null) throw new IllegalArgumentException("connectionSpecs == null");
+    if (connectionSpecs == null) throw new NullPointerException("connectionSpecs == null");
     this.connectionSpecs = Util.immutableList(connectionSpecs);
 
-    if (proxySelector == null) throw new IllegalArgumentException("proxySelector == null");
+    if (proxySelector == null) throw new NullPointerException("proxySelector == null");
     this.proxySelector = proxySelector;
 
     this.proxy = proxy;
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/CertificatePinner.java b/okhttp/src/main/java/okhttp3/CertificatePinner.java
index f7a1367..d55e5ee 100644
--- a/okhttp/src/main/java/okhttp3/CertificatePinner.java
+++ b/okhttp/src/main/java/okhttp3/CertificatePinner.java
@@ -312,7 +312,7 @@
      * Info, base64-encoded and prefixed with either {@code sha256/} or {@code sha1/}.
      */
     public Builder add(String pattern, String... pins) {
-      if (pattern == null) throw new IllegalArgumentException("pattern == null");
+      if (pattern == null) throw new NullPointerException("pattern == null");
 
       for (String pin : pins) {
         this.pins.add(new Pin(pattern, pin));
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Cookie.java b/okhttp/src/main/java/okhttp3/Cookie.java
index 74e341d..29a4bf8 100644
--- a/okhttp/src/main/java/okhttp3/Cookie.java
+++ b/okhttp/src/main/java/okhttp3/Cookie.java
@@ -75,9 +75,9 @@
   }
 
   private Cookie(Builder builder) {
-    if (builder.name == null) throw new IllegalArgumentException("builder.name == null");
-    if (builder.value == null) throw new IllegalArgumentException("builder.value == null");
-    if (builder.domain == null) throw new IllegalArgumentException("builder.domain == null");
+    if (builder.name == null) throw new NullPointerException("builder.name == null");
+    if (builder.value == null) throw new NullPointerException("builder.value == null");
+    if (builder.domain == null) throw new NullPointerException("builder.domain == null");
 
     this.name = builder.name;
     this.value = builder.value;
@@ -498,7 +498,7 @@
     }
 
     private Builder domain(String domain, boolean hostOnly) {
-      if (domain == null) throw new IllegalArgumentException("domain == null");
+      if (domain == null) throw new NullPointerException("domain == null");
       String canonicalDomain = Util.domainToAscii(domain);
       if (canonicalDomain == null) {
         throw new IllegalArgumentException("unexpected domain: " + domain);
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Handshake.java b/okhttp/src/main/java/okhttp3/Handshake.java
index 56e1fd4..d2c08be 100644
--- a/okhttp/src/main/java/okhttp3/Handshake.java
+++ b/okhttp/src/main/java/okhttp3/Handshake.java
@@ -74,7 +74,7 @@
 
   public static Handshake get(TlsVersion tlsVersion, CipherSuite cipherSuite,
       List<Certificate> peerCertificates, List<Certificate> localCertificates) {
-    if (cipherSuite == null) throw new IllegalArgumentException("cipherSuite == null");
+    if (cipherSuite == null) throw new NullPointerException("cipherSuite == null");
     return new Handshake(tlsVersion, cipherSuite, Util.immutableList(peerCertificates),
         Util.immutableList(localCertificates));
   }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Headers.java b/okhttp/src/main/java/okhttp3/Headers.java
index 6f72d0c..992569a 100644
--- a/okhttp/src/main/java/okhttp3/Headers.java
+++ b/okhttp/src/main/java/okhttp3/Headers.java
@@ -148,7 +148,8 @@
    * arguments, and they must alternate between header names and values.
    */
   public static Headers of(String... namesAndValues) {
-    if (namesAndValues == null || namesAndValues.length % 2 != 0) {
+    if (namesAndValues == null) throw new NullPointerException("namesAndValues == null");
+    if (namesAndValues.length % 2 != 0) {
       throw new IllegalArgumentException("Expected alternating header names and values");
     }
 
@@ -175,9 +176,7 @@
    * Returns headers for the header names and values in the {@link Map}.
    */
   public static Headers of(Map<String, String> headers) {
-    if (headers == null) {
-      throw new IllegalArgumentException("Expected map with header names and values");
-    }
+    if (headers == null) throw new NullPointerException("headers == null");
 
     // Make a defensive copy and clean it up.
     String[] namesAndValues = new String[headers.size() * 2];
@@ -267,7 +266,7 @@
     }
 
     private void checkNameAndValue(String name, String value) {
-      if (name == null) throw new IllegalArgumentException("name == null");
+      if (name == null) throw new NullPointerException("name == null");
       if (name.isEmpty()) throw new IllegalArgumentException("name is empty");
       for (int i = 0, length = name.length(); i < length; i++) {
         char c = name.charAt(i);
@@ -276,7 +275,7 @@
               "Unexpected char %#04x at %d in header name: %s", (int) c, i, name));
         }
       }
-      if (value == null) throw new IllegalArgumentException("value == null");
+      if (value == null) throw new NullPointerException("value == null");
       for (int i = 0, length = value.length(); i < length; i++) {
         char c = value.charAt(i);
         if (c <= '\u001f' || c >= '\u007f') {
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/HttpUrl.java b/okhttp/src/main/java/okhttp3/HttpUrl.java
index d7c0c35..45effb8 100644
--- a/okhttp/src/main/java/okhttp3/HttpUrl.java
+++ b/okhttp/src/main/java/okhttp3/HttpUrl.java
@@ -707,7 +707,7 @@
 
     public Builder scheme(String scheme) {
       if (scheme == null) {
-        throw new IllegalArgumentException("scheme == null");
+        throw new NullPointerException("scheme == null");
       } else if (scheme.equalsIgnoreCase("http")) {
         this.scheme = "http";
       } else if (scheme.equalsIgnoreCase("https")) {
@@ -719,26 +719,26 @@
     }
 
     public Builder username(String username) {
-      if (username == null) throw new IllegalArgumentException("username == null");
+      if (username == null) throw new NullPointerException("username == null");
       this.encodedUsername = canonicalize(username, USERNAME_ENCODE_SET, false, false, false, true);
       return this;
     }
 
     public Builder encodedUsername(String encodedUsername) {
-      if (encodedUsername == null) throw new IllegalArgumentException("encodedUsername == null");
+      if (encodedUsername == null) throw new NullPointerException("encodedUsername == null");
       this.encodedUsername = canonicalize(
           encodedUsername, USERNAME_ENCODE_SET, true, false, false, true);
       return this;
     }
 
     public Builder password(String password) {
-      if (password == null) throw new IllegalArgumentException("password == null");
+      if (password == null) throw new NullPointerException("password == null");
       this.encodedPassword = canonicalize(password, PASSWORD_ENCODE_SET, false, false, false, true);
       return this;
     }
 
     public Builder encodedPassword(String encodedPassword) {
-      if (encodedPassword == null) throw new IllegalArgumentException("encodedPassword == null");
+      if (encodedPassword == null) throw new NullPointerException("encodedPassword == null");
       this.encodedPassword = canonicalize(
           encodedPassword, PASSWORD_ENCODE_SET, true, false, false, true);
       return this;
@@ -749,7 +749,7 @@
      * address.
      */
     public Builder host(String host) {
-      if (host == null) throw new IllegalArgumentException("host == null");
+      if (host == null) throw new NullPointerException("host == null");
       String encoded = canonicalizeHost(host, 0, host.length());
       if (encoded == null) throw new IllegalArgumentException("unexpected host: " + host);
       this.host = encoded;
@@ -767,7 +767,7 @@
     }
 
     public Builder addPathSegment(String pathSegment) {
-      if (pathSegment == null) throw new IllegalArgumentException("pathSegment == null");
+      if (pathSegment == null) throw new NullPointerException("pathSegment == null");
       push(pathSegment, 0, pathSegment.length(), false, false);
       return this;
     }
@@ -777,13 +777,13 @@
      * {@code pathSegments} starts with a slash, the resulting URL will have empty path segment.
      */
     public Builder addPathSegments(String pathSegments) {
-      if (pathSegments == null) throw new IllegalArgumentException("pathSegments == null");
+      if (pathSegments == null) throw new NullPointerException("pathSegments == null");
       return addPathSegments(pathSegments, false);
     }
 
     public Builder addEncodedPathSegment(String encodedPathSegment) {
       if (encodedPathSegment == null) {
-        throw new IllegalArgumentException("encodedPathSegment == null");
+        throw new NullPointerException("encodedPathSegment == null");
       }
       push(encodedPathSegment, 0, encodedPathSegment.length(), false, true);
       return this;
@@ -796,7 +796,7 @@
      */
     public Builder addEncodedPathSegments(String encodedPathSegments) {
       if (encodedPathSegments == null) {
-        throw new IllegalArgumentException("encodedPathSegments == null");
+        throw new NullPointerException("encodedPathSegments == null");
       }
       return addPathSegments(encodedPathSegments, true);
     }
@@ -813,7 +813,7 @@
     }
 
     public Builder setPathSegment(int index, String pathSegment) {
-      if (pathSegment == null) throw new IllegalArgumentException("pathSegment == null");
+      if (pathSegment == null) throw new NullPointerException("pathSegment == null");
       String canonicalPathSegment = canonicalize(
           pathSegment, 0, pathSegment.length(), PATH_SEGMENT_ENCODE_SET, false, false, false, true);
       if (isDot(canonicalPathSegment) || isDotDot(canonicalPathSegment)) {
@@ -825,7 +825,7 @@
 
     public Builder setEncodedPathSegment(int index, String encodedPathSegment) {
       if (encodedPathSegment == null) {
-        throw new IllegalArgumentException("encodedPathSegment == null");
+        throw new NullPointerException("encodedPathSegment == null");
       }
       String canonicalPathSegment = canonicalize(encodedPathSegment,
           0, encodedPathSegment.length(), PATH_SEGMENT_ENCODE_SET, true, false, false, true);
@@ -845,7 +845,7 @@
     }
 
     public Builder encodedPath(String encodedPath) {
-      if (encodedPath == null) throw new IllegalArgumentException("encodedPath == null");
+      if (encodedPath == null) throw new NullPointerException("encodedPath == null");
       if (!encodedPath.startsWith("/")) {
         throw new IllegalArgumentException("unexpected encodedPath: " + encodedPath);
       }
@@ -871,7 +871,7 @@
 
     /** Encodes the query parameter using UTF-8 and adds it to this URL's query string. */
     public Builder addQueryParameter(String name, String value) {
-      if (name == null) throw new IllegalArgumentException("name == null");
+      if (name == null) throw new NullPointerException("name == null");
       if (encodedQueryNamesAndValues == null) encodedQueryNamesAndValues = new ArrayList<>();
       encodedQueryNamesAndValues.add(
           canonicalize(name, QUERY_COMPONENT_ENCODE_SET, false, false, true, true));
@@ -883,7 +883,7 @@
 
     /** Adds the pre-encoded query parameter to this URL's query string. */
     public Builder addEncodedQueryParameter(String encodedName, String encodedValue) {
-      if (encodedName == null) throw new IllegalArgumentException("encodedName == null");
+      if (encodedName == null) throw new NullPointerException("encodedName == null");
       if (encodedQueryNamesAndValues == null) encodedQueryNamesAndValues = new ArrayList<>();
       encodedQueryNamesAndValues.add(
           canonicalize(encodedName, QUERY_COMPONENT_ENCODE_SET, true, false, true, true));
@@ -906,7 +906,7 @@
     }
 
     public Builder removeAllQueryParameters(String name) {
-      if (name == null) throw new IllegalArgumentException("name == null");
+      if (name == null) throw new NullPointerException("name == null");
       if (encodedQueryNamesAndValues == null) return this;
       String nameToRemove = canonicalize(
           name, QUERY_COMPONENT_ENCODE_SET, false, false, true, true);
@@ -915,7 +915,7 @@
     }
 
     public Builder removeAllEncodedQueryParameters(String encodedName) {
-      if (encodedName == null) throw new IllegalArgumentException("encodedName == null");
+      if (encodedName == null) throw new NullPointerException("encodedName == null");
       if (encodedQueryNamesAndValues == null) return this;
       removeAllCanonicalQueryParameters(
           canonicalize(encodedName, QUERY_COMPONENT_ENCODE_SET, true, false, true, true));
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/OkHttpClient.java b/okhttp/src/main/java/okhttp3/OkHttpClient.java
index 4d5cbce..3930c75 100644
--- a/okhttp/src/main/java/okhttp3/OkHttpClient.java
+++ b/okhttp/src/main/java/okhttp3/OkHttpClient.java
@@ -410,7 +410,7 @@
      */
     public Builder connectTimeout(long timeout, TimeUnit unit) {
       if (timeout < 0) throw new IllegalArgumentException("timeout < 0");
-      if (unit == null) throw new IllegalArgumentException("unit == null");
+      if (unit == null) throw new NullPointerException("unit == null");
       long millis = unit.toMillis(timeout);
       if (millis > Integer.MAX_VALUE) throw new IllegalArgumentException("Timeout too large.");
       if (millis == 0 && timeout > 0) throw new IllegalArgumentException("Timeout too small.");
@@ -424,7 +424,7 @@
      */
     public Builder readTimeout(long timeout, TimeUnit unit) {
       if (timeout < 0) throw new IllegalArgumentException("timeout < 0");
-      if (unit == null) throw new IllegalArgumentException("unit == null");
+      if (unit == null) throw new NullPointerException("unit == null");
       long millis = unit.toMillis(timeout);
       if (millis > Integer.MAX_VALUE) throw new IllegalArgumentException("Timeout too large.");
       if (millis == 0 && timeout > 0) throw new IllegalArgumentException("Timeout too small.");
@@ -438,7 +438,7 @@
      */
     public Builder writeTimeout(long timeout, TimeUnit unit) {
       if (timeout < 0) throw new IllegalArgumentException("timeout < 0");
-      if (unit == null) throw new IllegalArgumentException("unit == null");
+      if (unit == null) throw new NullPointerException("unit == null");
       long millis = unit.toMillis(timeout);
       if (millis > Integer.MAX_VALUE) throw new IllegalArgumentException("Timeout too large.");
       if (millis == 0 && timeout > 0) throw new IllegalArgumentException("Timeout too small.");
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Request.java b/okhttp/src/main/java/okhttp3/Request.java
index 2daa0ab..194e855 100644
--- a/okhttp/src/main/java/okhttp3/Request.java
+++ b/okhttp/src/main/java/okhttp3/Request.java
@@ -118,7 +118,7 @@
     }
 
     public Builder url(HttpUrl url) {
-      if (url == null) throw new IllegalArgumentException("url == null");
+      if (url == null) throw new NullPointerException("url == null");
       this.url = url;
       return this;
     }
@@ -130,7 +130,7 @@
      * exception by calling {@link HttpUrl#parse}; it returns null for invalid URLs.
      */
     public Builder url(String url) {
-      if (url == null) throw new IllegalArgumentException("url == null");
+      if (url == null) throw new NullPointerException("url == null");
 
       // Silently replace websocket URLs with HTTP URLs.
       if (url.regionMatches(true, 0, "ws:", 0, 3)) {
@@ -151,7 +151,7 @@
      * https}.
      */
     public Builder url(URL url) {
-      if (url == null) throw new IllegalArgumentException("url == null");
+      if (url == null) throw new NullPointerException("url == null");
       HttpUrl parsed = HttpUrl.get(url);
       if (parsed == null) throw new IllegalArgumentException("unexpected url: " + url);
       return url(parsed);
@@ -229,9 +229,8 @@
     }
 
     public Builder method(String method, RequestBody body) {
-      if (method == null || method.length() == 0) {
-        throw new IllegalArgumentException("method == null || method.length() == 0");
-      }
+      if (method == null) throw new NullPointerException("method == null");
+      if (method.length() == 0) throw new IllegalArgumentException("method.length() == 0");
       if (body != null && !HttpMethod.permitsRequestBody(method)) {
         throw new IllegalArgumentException("method " + method + " must not have a request body.");
       }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/OkHttpClient.java b/okhttp/src/main/java/okhttp3/OkHttpClient.java
index 8df00c5..b23e6a2 100644
--- a/okhttp/src/main/java/okhttp3/OkHttpClient.java
+++ b/okhttp/src/main/java/okhttp3/OkHttpClient.java
@@ -65,10 +65,16 @@
   private static final List<Protocol> DEFAULT_PROTOCOLS = Util.immutableList(
       Protocol.HTTP_2, Protocol.SPDY_3, Protocol.HTTP_1_1);
 
-  private static final List<ConnectionSpec> DEFAULT_CONNECTION_SPECS = Util.immutableList(
-      ConnectionSpec.MODERN_TLS, ConnectionSpec.COMPATIBLE_TLS, ConnectionSpec.CLEARTEXT);
+  private static final List<ConnectionSpec> DEFAULT_CONNECTION_SPECS;
 
   static {
+    List<ConnectionSpec> connSpecs = new ArrayList<>(Arrays.asList(ConnectionSpec.MODERN_TLS,
+        ConnectionSpec.COMPATIBLE_TLS));
+    if (Platform.get().isCleartextTrafficPermitted()) {
+      connSpecs.add(ConnectionSpec.CLEARTEXT);
+    }
+    DEFAULT_CONNECTION_SPECS = Util.immutableList(connSpecs);
+
     Internal.instance = new Internal() {
       @Override public void addLenient(Headers.Builder builder, String line) {
         builder.addLenient(line);
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/Platform.java b/okhttp/src/main/java/okhttp3/internal/Platform.java
index 423a6aa..370662e 100644
--- a/okhttp/src/main/java/okhttp3/internal/Platform.java
+++ b/okhttp/src/main/java/okhttp3/internal/Platform.java
@@ -67,6 +67,10 @@
  *
  * <p>Supported on Android 2.3+ and OpenJDK 7+. There are no public APIs to recover the trust
  * manager that was used to create an {@link SSLSocketFactory}.
+ *
+ * <h3>Android Cleartext Permit Detection</h3>
+ *
+ * <p>Supported on Android 6.0+ via {@code NetworkSecurityPolicy}.
  */
 public class Platform {
   private static final Platform PLATFORM = findPlatform();
@@ -128,6 +132,10 @@
     System.out.println(message);
   }
 
+  public boolean isCleartextTrafficPermitted() {
+    return true;
+  }
+
   public static List<String> alpnProtocolNames(List<Protocol> protocols) {
     List<String> names = new ArrayList<>(protocols.size());
     for (int i = 0, size = protocols.size(); i < size; i++) {
@@ -298,6 +306,25 @@
         } while (i < newline);
       }
     }
+
+    @Override public boolean isCleartextTrafficPermitted() {
+      try {
+        Class<?> networkPolicyClass = Class.forName("android.security.NetworkSecurityPolicy");
+        Method getInstanceMethod = networkPolicyClass.getMethod("getInstance");
+        Object networkSecurityPolicy = getInstanceMethod.invoke(null);
+        Method isCleartextTrafficPermittedMethod = networkPolicyClass
+            .getMethod("isCleartextTrafficPermitted");
+        boolean cleartextPermitted = (boolean) isCleartextTrafficPermittedMethod
+            .invoke(networkSecurityPolicy);
+        return cleartextPermitted;
+      } catch (ClassNotFoundException e) {
+        return super.isCleartextTrafficPermitted();
+      } catch (NoSuchMethodException | IllegalAccessException | IllegalArgumentException
+          | InvocationTargetException e) {
+        throw new AssertionError();
+      }
+    }
+
   }
 
   /**
/Fim/
diff --git a/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java b/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java
index a88cef1..e843d1b 100644
--- a/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java
+++ b/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java
@@ -207,7 +207,13 @@
     }
 
     long startNs = System.nanoTime();
-    Response response = chain.proceed(request);
+    Response response;
+    try {
+      response = chain.proceed(request);
+    } catch (Exception e) {
+      logger.log("<-- HTTP FAILED: " + e);
+      throw e;
+    }
     long tookMs = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs);
 
     ResponseBody responseBody = response.body();
/Fim/
diff --git a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
index 429aa12..ad507a9 100644
--- a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
+++ b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
@@ -16,9 +16,12 @@
 package okhttp3.logging;
 
 import java.io.IOException;
+import java.net.InetAddress;
+import java.net.UnknownHostException;
 import java.util.ArrayList;
 import java.util.List;
 import java.util.regex.Pattern;
+import okhttp3.Dns;
 import okhttp3.HttpUrl;
 import okhttp3.MediaType;
 import okhttp3.OkHttpClient;
@@ -641,6 +644,29 @@
         .assertNoMoreLogs();
   }
 
+  @Test public void connectFail() throws IOException {
+    setLevel(Level.BASIC);
+    client = new OkHttpClient.Builder()
+        .dns(new Dns() {
+          @Override public List<InetAddress> lookup(String hostname) throws UnknownHostException {
+            throw new UnknownHostException("reason");
+          }
+        })
+        .addInterceptor(applicationInterceptor)
+        .build();
+
+    try {
+      client.newCall(request().build()).execute();
+      fail();
+    } catch (UnknownHostException expected) {
+    }
+
+    applicationLogs
+        .assertLogEqual("--> GET " + url + " http/1.1")
+        .assertLogEqual("<-- HTTP FAILED: java.net.UnknownHostException: reason")
+        .assertNoMoreLogs();
+  }
+
   private Request.Builder request() {
     return new Request.Builder().url(url);
   }
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 960d7d2..54d1bf7 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,55 @@
 Change Log
 ==========
 
+## Version 3.3.0
+
+_2016-05-24_
+
+ *  New: `Response.sentRequestAtMillis()` and `receivedResponseAtMillis()`
+    methods track the system's local time when network calls are made. These
+    replace the `OkHttp-Sent-Millis` and `OkHttp-Sent-Millis` headers that were
+    present in earlier versions of OkHttp.
+ *  New: Accept user-provided trust managers in `OkHttpClient.Builder`. This
+    allows OkHttp to satisfy its TLS requirements directly. Otherwise OkHttp
+    will use reflection to extract the `TrustManager` from the
+    `SSLSocketFactory`.
+ *  New: Support prerelease Java 9. This gets ALPN from the platform rather than
+    relying on the alpn-boot bootclasspath override.
+ *  New: `HttpLoggingInterceptor` now logs connection failures.
+ *  New: Upgrade to Okio 1.8.0.
+
+     ```xml
+     <dependency>
+       <groupId>com.squareup.okio</groupId>
+       <artifactId>okio</artifactId>
+       <version>1.8.0</version>
+     </dependency>
+     ```
+
+ *  Fix: Gracefully recover from a failure to rebuild the cache journal.
+ *  Fix: Don't corrupt cache entries when a cache entry is evicted while it is
+    being updated.
+ *  Fix: Make logging more consistent throughout OkHttp.
+ *  Fix: Log plaintext bodies only. This uses simple heuristics to differentiate
+    text from other data.
+ *  Fix: Recover from `REFUSED_STREAM` errors in HTTP/2. This should improve
+    interoperability with Nginx 1.10.0, which [refuses][nginx_959] streams
+    created before HTTP/2 settings have been acknowledged.
+ *  Fix: Improve recovery from failed routes.
+ *  Fix: Accommodate tunneling proxies that close the connection after an auth
+    challenge.
+ *  Fix: Use the proxy authenticator when authenticating HTTP proxies. This
+    regression was introduced in OkHttp 3.0.
+ *  Fix: Fail fast if network interceptors transform the response body such that
+    closing it doesn't also close the underlying stream. We had a bug where
+    OkHttp would attempt to reuse a connection but couldn't because it was still
+    held by a prior request.
+ *  Fix: Ensure network interceptors always have access to the underlying
+    connection.
+ *  Fix: Use `X509TrustManagerExtensions` on Android 17+.
+ *  Fix: Unblock waiting dispatchers on MockWebServer shutdown.
+
+
 ## Version 3.2.0
 
 _2016-02-25_
@@ -1002,3 +1051,4 @@
  [brick]: https://noncombatant.org/2015/05/01/about-http-public-key-pinning/
  [webdav]: https://tools.ietf.org/html/rfc4918
  [major_versions]: http://jakewharton.com/java-interoperability-policy-for-major-version-updates/
+ [nginx_959]: https://trac.nginx.org/nginx/ticket/959
/Fim/
diff --git a/README.md b/README.md
index b6b059d..9598745 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.2.0</version>
+  <version>3.3.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.2.0'
+compile 'com.squareup.okhttp3:okhttp:3.3.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.2.0</version>
+  <version>3.3.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.2.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.3.0'
 ```
 
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 2dab72f..f72febe 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 0d858e5..20f269e 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 63b1cc8..76da432 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 9f6f647..58dee5e 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 68fcf1a..d50158a 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index a837c6c..894d962 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 7b6ad7c..0246756 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 137a079..b174f72 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 2c95ffc..8be2f3e 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 783385c..74c3721 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index e6dbdb5..cddc1a0 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 0db4e1a..878e557 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 5a8273b..ea0a3f8 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.3.0-SNAPSHOT</version>
+  <version>3.3.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -67,7 +67,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.3.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 0daef2b..4af2454 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index d6ccee4..e8b173d 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index b34647c..f0d7d6b 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 1327dea..c196e9c 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index f9e5101..5700d69 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.3.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index f72febe..f97dc33 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 20f269e..555e19d 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 76da432..a12f1f4 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 58dee5e..6d26b36 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index d50158a..8ae2bc8 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 894d962..6a451bf 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 0246756..943f53a 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index b174f72..5585632 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 8be2f3e..3aaa66d 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index 74c3721..cef5759 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index cddc1a0..7cbfab9 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 878e557..a26e988 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index ea0a3f8..52054e9 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.3.0</version>
+  <version>3.4.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -67,7 +67,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.3.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 4af2454..a40fe5b 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index e8b173d..5690993 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index f0d7d6b..de77532 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index c196e9c..5bb5efe 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 5700d69..dc446c5 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.0</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/src/main/java/okhttp3/benchmarks/ApacheHttpClient.java b/benchmarks/src/main/java/okhttp3/benchmarks/ApacheHttpClient.java
index 2f97519..a5c632f 100644
--- a/benchmarks/src/main/java/okhttp3/benchmarks/ApacheHttpClient.java
+++ b/benchmarks/src/main/java/okhttp3/benchmarks/ApacheHttpClient.java
@@ -19,9 +19,8 @@
 import java.io.InputStream;
 import java.util.concurrent.TimeUnit;
 import java.util.zip.GZIPInputStream;
-import javax.net.ssl.SSLContext;
 import okhttp3.HttpUrl;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 import org.apache.http.Header;
 import org.apache.http.HttpResponse;
 import org.apache.http.client.HttpClient;
@@ -42,9 +41,9 @@
     super.prepare(benchmark);
     ClientConnectionManager connectionManager = new PoolingClientConnectionManager();
     if (benchmark.tls) {
-      SSLContext sslContext = SslContextBuilder.localhost();
+      SslClient sslClient = SslClient.localhost();
       connectionManager.getSchemeRegistry().register(
-          new Scheme("https", 443, new SSLSocketFactory(sslContext)));
+          new Scheme("https", 443, new SSLSocketFactory(sslClient.sslContext)));
     }
     client = new DefaultHttpClient(connectionManager);
   }
/Fim/
diff --git a/benchmarks/src/main/java/okhttp3/benchmarks/Benchmark.java b/benchmarks/src/main/java/okhttp3/benchmarks/Benchmark.java
index d69530f..8d4d043 100644
--- a/benchmarks/src/main/java/okhttp3/benchmarks/Benchmark.java
+++ b/benchmarks/src/main/java/okhttp3/benchmarks/Benchmark.java
@@ -26,10 +26,9 @@
 import java.util.concurrent.TimeUnit;
 import java.util.logging.Level;
 import java.util.logging.Logger;
-import javax.net.ssl.SSLContext;
 import okhttp3.HttpUrl;
 import okhttp3.Protocol;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.Dispatcher;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
@@ -161,8 +160,8 @@
     MockWebServer server = new MockWebServer();
 
     if (tls) {
-      SSLContext sslContext = SslContextBuilder.localhost();
-      server.useHttps(sslContext.getSocketFactory(), false);
+      SslClient sslClient = SslClient.localhost();
+      server.useHttps(sslClient.socketFactory, false);
       server.setProtocols(protocols);
     }
 
/Fim/
diff --git a/benchmarks/src/main/java/okhttp3/benchmarks/NettyHttpClient.java b/benchmarks/src/main/java/okhttp3/benchmarks/NettyHttpClient.java
index 8caa046..01e6f6e 100644
--- a/benchmarks/src/main/java/okhttp3/benchmarks/NettyHttpClient.java
+++ b/benchmarks/src/main/java/okhttp3/benchmarks/NettyHttpClient.java
@@ -42,10 +42,9 @@
 import java.util.ArrayDeque;
 import java.util.Deque;
 import java.util.concurrent.TimeUnit;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLEngine;
 import okhttp3.HttpUrl;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 
 /** Netty isn't an HTTP client, but it's almost one. */
 class NettyHttpClient implements HttpClient {
@@ -69,8 +68,8 @@
         ChannelPipeline pipeline = channel.pipeline();
 
         if (benchmark.tls) {
-          SSLContext sslContext = SslContextBuilder.localhost();
-          SSLEngine engine = sslContext.createSSLEngine();
+          SslClient sslClient = SslClient.localhost();
+          SSLEngine engine = sslClient.sslContext.createSSLEngine();
           engine.setUseClientMode(true);
           pipeline.addLast("ssl", new SslHandler(engine));
         }
/Fim/
diff --git a/benchmarks/src/main/java/okhttp3/benchmarks/OkHttp.java b/benchmarks/src/main/java/okhttp3/benchmarks/OkHttp.java
index 05eb504..7c90e5e 100644
--- a/benchmarks/src/main/java/okhttp3/benchmarks/OkHttp.java
+++ b/benchmarks/src/main/java/okhttp3/benchmarks/OkHttp.java
@@ -18,7 +18,6 @@
 import java.io.IOException;
 import java.util.concurrent.TimeUnit;
 import javax.net.ssl.HostnameVerifier;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSession;
 import javax.net.ssl.SSLSocketFactory;
 import okhttp3.Call;
@@ -26,7 +25,7 @@
 import okhttp3.OkHttpClient;
 import okhttp3.Request;
 import okhttp3.ResponseBody;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 
 class OkHttp extends SynchronousHttpClient {
   private static final boolean VERBOSE = false;
@@ -40,15 +39,15 @@
         .build();
 
     if (benchmark.tls) {
-      SSLContext sslContext = SslContextBuilder.localhost();
-      SSLSocketFactory socketFactory = sslContext.getSocketFactory();
+      SslClient sslClient = SslClient.localhost();
+      SSLSocketFactory socketFactory = sslClient.socketFactory;
       HostnameVerifier hostnameVerifier = new HostnameVerifier() {
         @Override public boolean verify(String s, SSLSession session) {
           return true;
         }
       };
       client = new OkHttpClient.Builder()
-          .sslSocketFactory(socketFactory)
+          .sslSocketFactory(socketFactory, sslClient.trustManager)
           .hostnameVerifier(hostnameVerifier)
           .build();
     }
/Fim/
diff --git a/benchmarks/src/main/java/okhttp3/benchmarks/OkHttpAsync.java b/benchmarks/src/main/java/okhttp3/benchmarks/OkHttpAsync.java
index 09bd3a7..57cb75c 100644
--- a/benchmarks/src/main/java/okhttp3/benchmarks/OkHttpAsync.java
+++ b/benchmarks/src/main/java/okhttp3/benchmarks/OkHttpAsync.java
@@ -21,7 +21,6 @@
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.atomic.AtomicInteger;
 import javax.net.ssl.HostnameVerifier;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSession;
 import javax.net.ssl.SSLSocketFactory;
 import okhttp3.Call;
@@ -32,7 +31,7 @@
 import okhttp3.Request;
 import okhttp3.Response;
 import okhttp3.ResponseBody;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 
 class OkHttpAsync implements HttpClient {
   private static final boolean VERBOSE = false;
@@ -55,15 +54,15 @@
         .build();
 
     if (benchmark.tls) {
-      SSLContext sslContext = SslContextBuilder.localhost();
-      SSLSocketFactory socketFactory = sslContext.getSocketFactory();
+      SslClient sslClient = SslClient.localhost();
+      SSLSocketFactory socketFactory = sslClient.socketFactory;
       HostnameVerifier hostnameVerifier = new HostnameVerifier() {
         @Override public boolean verify(String s, SSLSession session) {
           return true;
         }
       };
       client = client.newBuilder()
-          .sslSocketFactory(socketFactory)
+          .sslSocketFactory(socketFactory, sslClient.trustManager)
           .hostnameVerifier(hostnameVerifier)
           .build();
     }
/Fim/
diff --git a/benchmarks/src/main/java/okhttp3/benchmarks/UrlConnection.java b/benchmarks/src/main/java/okhttp3/benchmarks/UrlConnection.java
index f5c02ce..f75d160 100644
--- a/benchmarks/src/main/java/okhttp3/benchmarks/UrlConnection.java
+++ b/benchmarks/src/main/java/okhttp3/benchmarks/UrlConnection.java
@@ -22,11 +22,10 @@
 import java.util.zip.GZIPInputStream;
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.HttpsURLConnection;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSession;
 import javax.net.ssl.SSLSocketFactory;
 import okhttp3.HttpUrl;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 
 class UrlConnection extends SynchronousHttpClient {
   private static final boolean VERBOSE = false;
@@ -34,8 +33,8 @@
   @Override public void prepare(Benchmark benchmark) {
     super.prepare(benchmark);
     if (benchmark.tls) {
-      SSLContext sslContext = SslContextBuilder.localhost();
-      SSLSocketFactory socketFactory = sslContext.getSocketFactory();
+      SslClient sslClient = SslClient.localhost();
+      SSLSocketFactory socketFactory = sslClient.socketFactory;
       HostnameVerifier hostnameVerifier = new HostnameVerifier() {
         @Override public boolean verify(String s, SSLSession session) {
           return true;
/Fim/
/Fim/
diff --git a/mockwebserver/src/main/java/okhttp3/internal/framed/FramedServer.java b/mockwebserver/src/main/java/okhttp3/internal/framed/FramedServer.java
index 4ac8159..2a555be 100644
--- a/mockwebserver/src/main/java/okhttp3/internal/framed/FramedServer.java
+++ b/mockwebserver/src/main/java/okhttp3/internal/framed/FramedServer.java
@@ -29,8 +29,8 @@
 import javax.net.ssl.SSLSocketFactory;
 import okhttp3.Protocol;
 import okhttp3.internal.Platform;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.Util;
+import okhttp3.internal.tls.SslClient;
 import okio.BufferedSink;
 import okio.Okio;
 import okio.Source;
@@ -184,7 +184,7 @@
     }
 
     FramedServer server = new FramedServer(new File(args[0]),
-        SslContextBuilder.localhost().getSocketFactory());
+        SslClient.localhost().sslContext.getSocketFactory());
     server.run();
   }
 }
/Fim/
diff --git a/mockwebserver/src/main/java/okhttp3/internal/HeldCertificate.java b/mockwebserver/src/main/java/okhttp3/internal/tls/HeldCertificate.java
similarity index 99%
rename from mockwebserver/src/main/java/okhttp3/internal/HeldCertificate.java
rename to mockwebserver/src/main/java/okhttp3/internal/tls/HeldCertificate.java
index d6c45bd..a7fe81f 100644
--- a/mockwebserver/src/main/java/okhttp3/internal/HeldCertificate.java
+++ b/mockwebserver/src/main/java/okhttp3/internal/tls/HeldCertificate.java
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package okhttp3.internal;
+package okhttp3.internal.tls;
 
 import java.math.BigInteger;
 import java.security.GeneralSecurityException;
/Fim/
diff --git a/mockwebserver/src/main/java/okhttp3/internal/tls/SslClient.java b/mockwebserver/src/main/java/okhttp3/internal/tls/SslClient.java
new file mode 100644
index 0000000..7cc061b
--- /dev/null
+++ b/mockwebserver/src/main/java/okhttp3/internal/tls/SslClient.java
@@ -0,0 +1,163 @@
+/*
+ * Copyright (C) 2012 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3.internal.tls;
+
+import java.io.IOException;
+import java.io.InputStream;
+import java.net.InetAddress;
+import java.net.UnknownHostException;
+import java.security.GeneralSecurityException;
+import java.security.KeyPair;
+import java.security.KeyStore;
+import java.security.SecureRandom;
+import java.security.cert.Certificate;
+import java.security.cert.X509Certificate;
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.List;
+import javax.net.ssl.KeyManagerFactory;
+import javax.net.ssl.SSLContext;
+import javax.net.ssl.SSLSocketFactory;
+import javax.net.ssl.TrustManager;
+import javax.net.ssl.TrustManagerFactory;
+import javax.net.ssl.X509TrustManager;
+
+/**
+ * Combines an SSL socket factory and trust manager, a pairing enough for OkHttp or MockWebServer to
+ * create a secure connection.
+ */
+public final class SslClient {
+  private static SslClient localhost; // Lazily initialized.
+
+  public final SSLContext sslContext;
+  public final SSLSocketFactory socketFactory;
+  public final X509TrustManager trustManager;
+
+  private SslClient(SSLContext sslContext, X509TrustManager trustManager) {
+    this.sslContext = sslContext;
+    this.socketFactory = sslContext.getSocketFactory();
+    this.trustManager = trustManager;
+  }
+
+  /** Returns an SSL client for this host's localhost address. */
+  public static synchronized SslClient localhost() {
+    if (localhost != null) return localhost;
+
+    try {
+      // Generate a self-signed cert for the server to serve and the client to trust.
+      HeldCertificate heldCertificate = new HeldCertificate.Builder()
+          .serialNumber("1")
+          .commonName(InetAddress.getByName("localhost").getHostName())
+          .build();
+
+      localhost = new Builder()
+          .certificateChain(heldCertificate.keyPair, heldCertificate.certificate)
+          .addTrustedCertificate(heldCertificate.certificate)
+          .build();
+
+      return localhost;
+    } catch (GeneralSecurityException | UnknownHostException e) {
+      throw new RuntimeException(e);
+    }
+  }
+
+  public static class Builder {
+    private final List<X509Certificate> chainCertificates = new ArrayList<>();
+    private final List<X509Certificate> certificates = new ArrayList<>();
+    private KeyPair keyPair;
+
+    /**
+     * Configure the certificate chain to use when serving HTTPS responses. The first certificate is
+     * the server's certificate, further certificates are included in the handshake so the client
+     * can build a trusted path to a CA certificate.
+     */
+    public Builder certificateChain(HeldCertificate serverCert, HeldCertificate... chain) {
+      X509Certificate[] certificates = new X509Certificate[chain.length];
+      for (int i = 0; i < chain.length; i++) {
+        certificates[i] = chain[i].certificate;
+      }
+      return certificateChain(serverCert.keyPair, serverCert.certificate, certificates);
+    }
+
+    public SslClient.Builder certificateChain(KeyPair keyPair, X509Certificate keyCert,
+        X509Certificate... certificates) {
+      this.keyPair = keyPair;
+      this.chainCertificates.add(keyCert);
+      this.chainCertificates.addAll(Arrays.asList(certificates));
+      this.certificates.addAll(Arrays.asList(certificates));
+      return this;
+    }
+
+    /**
+     * Add a certificate authority that this client trusts. Servers that provide certificate chains
+     * signed by these roots (or their intermediates) will be accepted.
+     */
+    public Builder addTrustedCertificate(X509Certificate certificate) {
+      this.certificates.add(certificate);
+      return this;
+    }
+
+    public SslClient build() {
+      try {
+        // Put the certificate in a key store.
+        char[] password = "password".toCharArray();
+        KeyStore keyStore = newEmptyKeyStore(password);
+
+        if (keyPair != null) {
+          Certificate[] certificates = chainCertificates.toArray(
+              new Certificate[chainCertificates.size()]);
+          keyStore.setKeyEntry("private", keyPair.getPrivate(), password, certificates);
+        }
+
+        for (int i = 0; i < certificates.size(); i++) {
+          keyStore.setCertificateEntry("cert_" + i, certificates.get(i));
+        }
+
+        // Wrap it up in an SSL context.
+        KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(
+            KeyManagerFactory.getDefaultAlgorithm());
+        keyManagerFactory.init(keyStore, password);
+        TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(
+            TrustManagerFactory.getDefaultAlgorithm());
+        trustManagerFactory.init(keyStore);
+        TrustManager[] trustManagers = trustManagerFactory.getTrustManagers();
+
+        if (trustManagers.length != 1 || !(trustManagers[0] instanceof X509TrustManager)) {
+          throw new IllegalStateException("Unexpected default trust managers:"
+              + Arrays.toString(trustManagers));
+        }
+
+        SSLContext sslContext = SSLContext.getInstance("TLS");
+        sslContext.init(keyManagerFactory.getKeyManagers(), trustManagers, new SecureRandom());
+
+        return new SslClient(sslContext, (X509TrustManager) trustManagers[0]);
+      } catch (GeneralSecurityException gse) {
+        throw new AssertionError(gse);
+      }
+    }
+
+    private KeyStore newEmptyKeyStore(char[] password) throws GeneralSecurityException {
+      try {
+        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());
+        InputStream in = null; // By convention, 'null' creates an empty key store.
+        keyStore.load(in, password);
+        return keyStore;
+      } catch (IOException e) {
+        throw new AssertionError(e);
+      }
+    }
+  }
+}
/Fim/
diff --git a/okcurl/src/main/java/okhttp3/curl/Main.java b/okcurl/src/main/java/okhttp3/curl/Main.java
index 15e4f03..aa8f487 100644
--- a/okcurl/src/main/java/okhttp3/curl/Main.java
+++ b/okcurl/src/main/java/okhttp3/curl/Main.java
@@ -23,7 +23,6 @@
 import io.airlift.airline.SingleCommand;
 import java.io.IOException;
 import java.io.InputStream;
-import java.security.cert.CertificateException;
 import java.security.cert.X509Certificate;
 import java.util.List;
 import java.util.Properties;
@@ -179,7 +178,9 @@
       builder.readTimeout(readTimeout, SECONDS);
     }
     if (allowInsecure) {
-      builder.sslSocketFactory(createInsecureSslSocketFactory());
+      X509TrustManager trustManager = createInsecureTrustManager();
+      SSLSocketFactory sslSocketFactory = createInsecureSslSocketFactory(trustManager);
+      builder.sslSocketFactory(sslSocketFactory, trustManager);
       builder.hostnameVerifier(createInsecureHostnameVerifier());
     }
     return builder.build();
@@ -240,23 +241,24 @@
     client.connectionPool().evictAll(); // Close any persistent connections.
   }
 
-  private static SSLSocketFactory createInsecureSslSocketFactory() {
+  private static X509TrustManager createInsecureTrustManager() {
+    return new X509TrustManager() {
+      @Override public void checkClientTrusted(X509Certificate[] chain, String authType) {
+      }
+
+      @Override public void checkServerTrusted(X509Certificate[] chain, String authType) {
+      }
+
+      @Override public X509Certificate[] getAcceptedIssuers() {
+        return new X509Certificate[0];
+      }
+    };
+  }
+
+  private static SSLSocketFactory createInsecureSslSocketFactory(TrustManager trustManager) {
     try {
       SSLContext context = SSLContext.getInstance("TLS");
-      TrustManager permissive = new X509TrustManager() {
-        @Override public void checkClientTrusted(X509Certificate[] chain, String authType)
-            throws CertificateException {
-        }
-
-        @Override public void checkServerTrusted(X509Certificate[] chain, String authType)
-            throws CertificateException {
-        }
-
-        @Override public X509Certificate[] getAcceptedIssuers() {
-          return new X509Certificate[0];
-        }
-      };
-      context.init(null, new TrustManager[] {permissive}, null);
+      context.init(null, new TrustManager[] {trustManager}, null);
       return context.getSocketFactory();
     } catch (Exception e) {
       throw new AssertionError(e);
/Fim/
diff --git a/okhttp-android-support/src/test/java/okhttp3/internal/huc/CacheAdapterTest.java b/okhttp-android-support/src/test/java/okhttp3/internal/huc/CacheAdapterTest.java
index 81aeaf2..e24c726 100644
--- a/okhttp-android-support/src/test/java/okhttp3/internal/huc/CacheAdapterTest.java
+++ b/okhttp-android-support/src/test/java/okhttp3/internal/huc/CacheAdapterTest.java
@@ -29,16 +29,15 @@
 import java.util.Map;
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.HttpsURLConnection;
-import javax.net.ssl.SSLContext;
 import okhttp3.AbstractResponseCache;
 import okhttp3.OkHttpClient;
 import okhttp3.OkUrlFactory;
+import okhttp3.RecordingHostnameVerifier;
 import okhttp3.internal.Internal;
 import okhttp3.internal.InternalCache;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
-import okhttp3.RecordingHostnameVerifier;
 import okio.Buffer;
 import org.junit.After;
 import org.junit.Before;
@@ -59,7 +58,7 @@
  * </ul>
  */
 public class CacheAdapterTest {
-  private SSLContext sslContext = SslContextBuilder.localhost();
+  private SslClient sslClient = SslClient.localhost();
   private HostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
   private MockWebServer server;
   private OkHttpClient client;
@@ -116,7 +115,7 @@
     };
     setInternalCache(new CacheAdapter(responseCache));
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build();
 
@@ -234,7 +233,7 @@
     };
     setInternalCache(new CacheAdapter(responseCache));
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build();
 
@@ -262,7 +261,7 @@
   }
 
   private URL configureHttpsServer(MockResponse mockResponse) throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false /* tunnelProxy */);
+    server.useHttps(sslClient.socketFactory, false /* tunnelProxy */);
     server.enqueue(mockResponse);
     server.start();
     return server.url("/").url();
/Fim/
diff --git a/okhttp-android-support/src/test/java/okhttp3/internal/huc/ResponseCacheTest.java b/okhttp-android-support/src/test/java/okhttp3/internal/huc/ResponseCacheTest.java
index a73ca54..a533b91 100644
--- a/okhttp-android-support/src/test/java/okhttp3/internal/huc/ResponseCacheTest.java
+++ b/okhttp-android-support/src/test/java/okhttp3/internal/huc/ResponseCacheTest.java
@@ -54,21 +54,20 @@
 import java.util.concurrent.atomic.AtomicReference;
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.HttpsURLConnection;
-import javax.net.ssl.SSLContext;
 import okhttp3.AbstractResponseCache;
 import okhttp3.AndroidInternal;
 import okhttp3.AndroidShimResponseCache;
 import okhttp3.Headers;
 import okhttp3.OkHttpClient;
 import okhttp3.OkUrlFactory;
+import okhttp3.RecordingHostnameVerifier;
 import okhttp3.internal.Internal;
 import okhttp3.internal.InternalCache;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okhttp3.mockwebserver.RecordedRequest;
 import okhttp3.mockwebserver.SocketPolicy;
-import okhttp3.RecordingHostnameVerifier;
 import okio.Buffer;
 import okio.BufferedSink;
 import okio.GzipSink;
@@ -96,7 +95,7 @@
   @Rule public MockWebServer server2 = new MockWebServer();
 
   private HostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
-  private SSLContext sslContext = SslContextBuilder.localhost();
+  private SslClient sslClient = SslClient.localhost();
   private ResponseCache cache;
   private CookieManager cookieManager;
   private OkUrlFactory urlFactory;
@@ -267,14 +266,14 @@
   }
 
   @Test public void secureResponseCaching() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
         .setBody("ABC"));
 
     HttpsURLConnection c1 = (HttpsURLConnection) openConnection(server.url("/").url());
-    c1.setSSLSocketFactory(sslContext.getSocketFactory());
+    c1.setSSLSocketFactory(sslClient.socketFactory);
     c1.setHostnameVerifier(hostnameVerifier);
     assertEquals("ABC", readAscii(c1));
 
@@ -286,7 +285,7 @@
     Principal localPrincipal = c1.getLocalPrincipal();
 
     HttpsURLConnection c2 = (HttpsURLConnection) openConnection(server.url("/").url()); // cached!
-    c2.setSSLSocketFactory(sslContext.getSocketFactory());
+    c2.setSSLSocketFactory(sslClient.socketFactory);
     c2.setHostnameVerifier(hostnameVerifier);
     assertEquals("ABC", readAscii(c2));
 
@@ -345,7 +344,7 @@
   }
 
   @Test public void secureResponseCachingAndRedirects() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
@@ -359,7 +358,7 @@
         .setBody("DEF"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
 
@@ -383,7 +382,7 @@
    * https://github.com/square/okhttp/issues/214
    */
   @Test public void secureResponseCachingAndProtocolRedirects() throws IOException {
-    server2.useHttps(sslContext.getSocketFactory(), false);
+    server2.useHttps(sslClient.socketFactory, false);
     server2.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
@@ -398,7 +397,7 @@
         .addHeader("Location: " + server2.url("/").url()));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
 
@@ -1461,7 +1460,7 @@
   }
 
   @Test public void varyAndHttps() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()
         .addHeader("Cache-Control: max-age=60")
         .addHeader("Vary: Accept-Language")
@@ -1470,7 +1469,7 @@
         .setBody("B"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
 
@@ -1981,20 +1980,20 @@
   }
 
   @Test public void cacheReturnsInsecureResponseForSecureRequest() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("ABC"));
     server.enqueue(new MockResponse().setBody("DEF"));
 
     AndroidInternal.setResponseCache(urlFactory, new InsecureResponseCache(cache));
 
     HttpsURLConnection connection1 = (HttpsURLConnection) openConnection(server.url("/").url());
-    connection1.setSSLSocketFactory(sslContext.getSocketFactory());
+    connection1.setSSLSocketFactory(sslClient.socketFactory);
     connection1.setHostnameVerifier(hostnameVerifier);
     assertEquals("ABC", readAscii(connection1));
 
     // Not cached!
     HttpsURLConnection connection2 = (HttpsURLConnection) openConnection(server.url("/").url());
-    connection2.setSSLSocketFactory(sslContext.getSocketFactory());
+    connection2.setSSLSocketFactory(sslClient.socketFactory);
     connection2.setHostnameVerifier(hostnameVerifier);
     assertEquals("DEF", readAscii(connection2));
   }
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 5585632..fd07ff9 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -1,6 +1,8 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0"
+    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CacheTest.java b/okhttp-tests/src/test/java/okhttp3/CacheTest.java
index 418f7bd..33565e3 100644
--- a/okhttp-tests/src/test/java/okhttp3/CacheTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CacheTest.java
@@ -37,12 +37,11 @@
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.atomic.AtomicReference;
 import javax.net.ssl.HostnameVerifier;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSession;
 import okhttp3.internal.Internal;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.Util;
 import okhttp3.internal.io.InMemoryFileSystem;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okhttp3.mockwebserver.RecordedRequest;
@@ -75,7 +74,7 @@
   @Rule public MockWebServer server2 = new MockWebServer();
   @Rule public InMemoryFileSystem fileSystem = new InMemoryFileSystem();
 
-  private final SSLContext sslContext = SslContextBuilder.localhost();
+  private final SslClient sslClient = SslClient.localhost();
   private OkHttpClient client;
   private Cache cache;
   private final CookieManager cookieManager = new CookieManager();
@@ -256,14 +255,14 @@
   }
 
   @Test public void secureResponseCaching() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
         .setBody("ABC"));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(NULL_HOSTNAME_VERIFIER)
         .build();
 
@@ -352,7 +351,7 @@
   }
 
   @Test public void secureResponseCachingAndRedirects() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
@@ -366,7 +365,7 @@
         .setBody("DEF"));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(NULL_HOSTNAME_VERIFIER)
         .build();
 
@@ -392,7 +391,7 @@
    * https://github.com/square/okhttp/issues/214
    */
   @Test public void secureResponseCachingAndProtocolRedirects() throws IOException {
-    server2.useHttps(sslContext.getSocketFactory(), false);
+    server2.useHttps(sslClient.socketFactory, false);
     server2.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
@@ -407,7 +406,7 @@
         .addHeader("Location: " + server2.url("/")));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(NULL_HOSTNAME_VERIFIER)
         .build();
 
@@ -1681,7 +1680,7 @@
   }
 
   @Test public void varyAndHttps() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()
         .addHeader("Cache-Control: max-age=60")
         .addHeader("Vary: Accept-Language")
@@ -1690,7 +1689,7 @@
         .setBody("B"));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(NULL_HOSTNAME_VERIFIER)
         .build();
 
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CallTest.java b/okhttp-tests/src/test/java/okhttp3/CallTest.java
index 18ede83..c2470c9 100644
--- a/okhttp-tests/src/test/java/okhttp3/CallTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CallTest.java
@@ -47,7 +47,6 @@
 import java.util.concurrent.atomic.AtomicReference;
 import java.util.logging.Logger;
 import javax.net.ServerSocketFactory;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLHandshakeException;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import javax.net.ssl.SSLProtocolException;
@@ -56,11 +55,11 @@
 import okhttp3.internal.DoubleInetAddressDns;
 import okhttp3.internal.RecordingOkAuthenticator;
 import okhttp3.internal.SingleInetAddressDns;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.Util;
 import okhttp3.internal.Version;
 import okhttp3.internal.http.RecordingProxySelector;
 import okhttp3.internal.io.InMemoryFileSystem;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.Dispatcher;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
@@ -94,7 +93,7 @@
   @Rule public final MockWebServer server2 = new MockWebServer();
   @Rule public final InMemoryFileSystem fileSystem = new InMemoryFileSystem();
 
-  private SSLContext sslContext = SslContextBuilder.localhost();
+  private SslClient sslClient = SslClient.localhost();
   private OkHttpClient client = defaultClient();
   private RecordingCallback callback = new RecordingCallback();
   private TestLogHandler logHandler = new TestLogHandler();
@@ -964,14 +963,14 @@
   }
 
   @Test public void recoverFromTlsHandshakeFailure() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
     server.enqueue(new MockResponse().setBody("abc"));
 
     client = client.newBuilder()
         .hostnameVerifier(new RecordingHostnameVerifier())
         .dns(new SingleInetAddressDns())
-        .sslSocketFactory(suppressTlsFallbackClientSocketFactory())
+        .sslSocketFactory(suppressTlsFallbackClientSocketFactory(), sslClient.trustManager)
         .build();
 
     executeSynchronously("/").assertBody("abc");
@@ -980,19 +979,19 @@
   @Test public void recoverFromTlsHandshakeFailure_tlsFallbackScsvEnabled() throws Exception {
     final String tlsFallbackScsv = "TLS_FALLBACK_SCSV";
     List<String> supportedCiphers =
-        Arrays.asList(sslContext.getSocketFactory().getSupportedCipherSuites());
+        Arrays.asList(sslClient.socketFactory.getSupportedCipherSuites());
     if (!supportedCiphers.contains(tlsFallbackScsv)) {
       // This only works if the client socket supports TLS_FALLBACK_SCSV.
       return;
     }
 
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
 
     RecordingSSLSocketFactory clientSocketFactory =
-        new RecordingSSLSocketFactory(sslContext.getSocketFactory());
+        new RecordingSSLSocketFactory(sslClient.socketFactory);
     client = client.newBuilder()
-        .sslSocketFactory(clientSocketFactory)
+        .sslSocketFactory(clientSocketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .dns(new SingleInetAddressDns())
         .build();
@@ -1012,13 +1011,13 @@
   }
 
   @Test public void recoverFromTlsHandshakeFailure_Async() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
     server.enqueue(new MockResponse().setBody("abc"));
 
     client = client.newBuilder()
         .hostnameVerifier(new RecordingHostnameVerifier())
-        .sslSocketFactory(suppressTlsFallbackClientSocketFactory())
+        .sslSocketFactory(suppressTlsFallbackClientSocketFactory(), sslClient.trustManager)
         .build();
 
     Request request = new Request.Builder()
@@ -1034,10 +1033,10 @@
         .connectionSpecs(Arrays.asList(ConnectionSpec.MODERN_TLS, ConnectionSpec.CLEARTEXT))
         .hostnameVerifier(new RecordingHostnameVerifier())
         .dns(new SingleInetAddressDns())
-        .sslSocketFactory(suppressTlsFallbackClientSocketFactory())
+        .sslSocketFactory(suppressTlsFallbackClientSocketFactory(), sslClient.trustManager)
         .build();
 
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
 
     Request request = new Request.Builder().url(server.url("/")).build();
@@ -2206,7 +2205,7 @@
 
   /** Test which headers are sent unencrypted to the HTTP proxy. */
   @Test public void proxyConnectOmitsApplicationHeaders() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.UPGRADE_TO_SSL_AT_END)
         .clearHeaders());
@@ -2215,7 +2214,7 @@
 
     RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .proxy(server.toProxyAddress())
         .hostnameVerifier(hostnameVerifier)
         .build();
@@ -2243,7 +2242,7 @@
 
   /** Respond to a proxy authorization challenge. */
   @Test public void proxyAuthenticateOnConnect() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.enqueue(new MockResponse()
         .setResponseCode(407)
         .addHeader("Proxy-Authenticate: Basic realm=\"localhost\""));
@@ -2254,7 +2253,7 @@
         .setBody("response body"));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .proxy(server.toProxyAddress())
         .proxyAuthenticator(new RecordingOkAuthenticator("password"))
         .hostnameVerifier(new RecordingHostnameVerifier())
@@ -2312,7 +2311,7 @@
    * a TLS tunnel. https://github.com/square/okhttp/issues/2426
    */
   @Test public void proxyAuthenticateOnConnectWithConnectionClose() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.setProtocols(Collections.singletonList(Protocol.HTTP_1_1));
     server.enqueue(new MockResponse()
         .setResponseCode(407)
@@ -2325,7 +2324,7 @@
         .setBody("response body"));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .proxy(server.toProxyAddress())
         .proxyAuthenticator(new RecordingOkAuthenticator("password"))
         .hostnameVerifier(new RecordingHostnameVerifier())
@@ -2348,7 +2347,7 @@
   }
 
   @Test public void tooManyProxyAuthFailuresWithConnectionClose() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.setProtocols(Collections.singletonList(Protocol.HTTP_1_1));
     for (int i = 0; i < 21; i++) {
       server.enqueue(new MockResponse()
@@ -2358,7 +2357,7 @@
     }
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .proxy(server.toProxyAddress())
         .proxyAuthenticator(new RecordingOkAuthenticator("password"))
         .hostnameVerifier(new RecordingHostnameVerifier())
@@ -2380,7 +2379,7 @@
    * credentials. Worse, that approach leaks proxy credentials to the origin server.
    */
   @Test public void noProactiveProxyAuthorization() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.UPGRADE_TO_SSL_AT_END)
         .clearHeaders());
@@ -2388,7 +2387,7 @@
         .setBody("response body"));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .proxy(server.toProxyAddress())
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build();
@@ -2536,7 +2535,7 @@
   /** https://github.com/square/okhttp/issues/2344 */
   @Test public void ipv6HostHasSquareBraces() throws Exception {
     // Use a proxy to fake IPv6 connectivity, even if localhost doesn't have IPv6.
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.setProtocols(Collections.singletonList(Protocol.HTTP_1_1));
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.UPGRADE_TO_SSL_AT_END)
@@ -2545,7 +2544,7 @@
         .setBody("response body"));
 
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .proxy(server.toProxyAddress())
         .build();
@@ -2658,10 +2657,10 @@
 
   private void enableTls() {
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build();
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
   }
 
   private Buffer gzip(String data) throws IOException {
@@ -2710,6 +2709,6 @@
    * for details.
    */
   private FallbackTestClientSocketFactory suppressTlsFallbackClientSocketFactory() {
-    return new FallbackTestClientSocketFactory(sslContext.getSocketFactory());
+    return new FallbackTestClientSocketFactory(sslClient.socketFactory);
   }
 }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java b/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java
index 8bfcb8c..261c99f 100644
--- a/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java
@@ -21,7 +21,7 @@
 import java.util.ArrayList;
 import java.util.List;
 import javax.net.ssl.SSLPeerUnverifiedException;
-import okhttp3.internal.HeldCertificate;
+import okhttp3.internal.tls.HeldCertificate;
 import okhttp3.internal.tls.CertificateChainCleaner;
 import org.junit.Test;
 
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CertificatePinnerTest.java b/okhttp-tests/src/test/java/okhttp3/CertificatePinnerTest.java
index 9442dda..54a51b5 100644
--- a/okhttp-tests/src/test/java/okhttp3/CertificatePinnerTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CertificatePinnerTest.java
@@ -21,7 +21,7 @@
 import java.util.List;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import okhttp3.CertificatePinner.Pin;
-import okhttp3.internal.HeldCertificate;
+import okhttp3.internal.tls.HeldCertificate;
 import org.junit.Test;
 
 import static org.junit.Assert.assertEquals;
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/ConnectionReuseTest.java b/okhttp-tests/src/test/java/okhttp3/ConnectionReuseTest.java
index 2dc6bd9..5d45f0b 100644
--- a/okhttp-tests/src/test/java/okhttp3/ConnectionReuseTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/ConnectionReuseTest.java
@@ -21,7 +21,7 @@
 import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLException;
 import javax.net.ssl.SSLSocketFactory;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okhttp3.mockwebserver.SocketPolicy;
@@ -39,7 +39,7 @@
   @Rule public final TestRule timeout = new Timeout(30_000);
   @Rule public final MockWebServer server = new MockWebServer();
 
-  private SSLContext sslContext = SslContextBuilder.localhost();
+  private SslClient sslClient = SslClient.localhost();
   private OkHttpClient client = defaultClient();
 
   @Test public void connectionsAreReused() throws Exception {
@@ -335,11 +335,11 @@
 
   private void enableHttpsAndAlpn(Protocol... protocols) {
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .protocols(Arrays.asList(protocols))
         .build();
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.setProtocols(client.protocols());
   }
 
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/DelegatingSSLSocket.java b/okhttp-tests/src/test/java/okhttp3/DelegatingSSLSocket.java
index f075593..fc863c2 100644
--- a/okhttp-tests/src/test/java/okhttp3/DelegatingSSLSocket.java
+++ b/okhttp-tests/src/test/java/okhttp3/DelegatingSSLSocket.java
@@ -18,10 +18,14 @@
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
+import java.lang.reflect.InvocationTargetException;
 import java.net.InetAddress;
+import java.net.Socket;
 import java.net.SocketAddress;
 import java.net.SocketException;
+import java.net.SocketOption;
 import java.nio.channels.SocketChannel;
+import java.util.Set;
 import javax.net.ssl.HandshakeCompletedListener;
 import javax.net.ssl.SSLParameters;
 import javax.net.ssl.SSLSession;
@@ -280,4 +284,55 @@
   @Override public void setPerformancePreferences(int connectionTime, int latency, int bandwidth) {
     delegate.setPerformancePreferences(connectionTime, latency, bandwidth);
   }
+
+  // Java 9 methods.
+
+  public SSLSession getHandshakeSession() {
+    try {
+      return (SSLSession) SSLSocket.class.getMethod("getHandshakeSession").invoke(delegate);
+    } catch (IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
+      throw new AssertionError();
+    }
+  }
+
+  public String getApplicationProtocol() {
+    try {
+      return (String) SSLSocket.class.getMethod("getApplicationProtocol").invoke(delegate);
+    } catch (IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
+      throw new AssertionError();
+    }
+  }
+
+  public String getHandshakeApplicationProtocol() {
+    try {
+      return (String) SSLSocket.class.getMethod("getHandshakeApplicationProtocol").invoke(delegate);
+    } catch (IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
+      throw new AssertionError();
+    }
+  }
+
+  public <T> Socket setOption(SocketOption<T> name, T value) throws IOException {
+    try {
+      SSLSocket.class.getMethod("setOption", SocketOption.class, Object.class).invoke(delegate, name, value);
+      return this;
+    } catch (IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
+      throw new AssertionError();
+    }
+  }
+
+  public <T> T getOption(SocketOption<T> name) throws IOException {
+    try {
+      return (T) SSLSocket.class.getMethod("getOption", SocketOption.class).invoke(delegate, name);
+    } catch (IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
+      throw new AssertionError();
+    }
+  }
+
+  public Set<SocketOption<?>> supportedOptions() {
+    try {
+      return (Set<SocketOption<?>>) SSLSocket.class.getMethod("supportedOptions").invoke(delegate);
+    } catch (IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
+      throw new AssertionError();
+    }
+  }
 }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
index 2c3c8bd..cdfc26a 100644
--- a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
@@ -34,7 +34,7 @@
 import java.net.URL;
 import java.net.URLConnection;
 import java.net.UnknownHostException;
-import java.security.SecureRandom;
+import java.security.KeyStore;
 import java.security.cert.CertificateException;
 import java.security.cert.X509Certificate;
 import java.util.ArrayList;
@@ -56,16 +56,16 @@
 import javax.net.ssl.SSLHandshakeException;
 import javax.net.ssl.SSLSocketFactory;
 import javax.net.ssl.TrustManager;
+import javax.net.ssl.TrustManagerFactory;
 import javax.net.ssl.X509TrustManager;
 import okhttp3.internal.DoubleInetAddressDns;
 import okhttp3.internal.Internal;
-import okhttp3.internal.Platform;
 import okhttp3.internal.RecordingAuthenticator;
 import okhttp3.internal.RecordingOkAuthenticator;
 import okhttp3.internal.SingleInetAddressDns;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.Util;
 import okhttp3.internal.Version;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okhttp3.mockwebserver.RecordedRequest;
@@ -101,6 +101,7 @@
 import static org.junit.Assert.assertNull;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assert.fail;
+import static org.junit.Assume.assumeTrue;
 
 /** Android's URLConnectionTest. */
 public final class URLConnectionTest {
@@ -108,7 +109,7 @@
   @Rule public final MockWebServer server2 = new MockWebServer();
   @Rule public final TemporaryFolder tempDir = new TemporaryFolder();
 
-  private SSLContext sslContext = SslContextBuilder.localhost();
+  private SslClient sslClient = SslClient.localhost();
   private OkUrlFactory urlFactory;
   private HttpURLConnection connection;
   private Cache cache;
@@ -519,11 +520,11 @@
   }
 
   @Test public void connectViaHttps() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("this response comes via HTTPS"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
     connection = urlFactory.open(server.url("/foo").url());
@@ -535,11 +536,11 @@
   }
 
   @Test public void inspectHandshakeThroughoutRequestLifecycle() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse());
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
 
@@ -567,16 +568,16 @@
   }
 
   @Test public void connectViaHttpsReusingConnections() throws IOException, InterruptedException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("this response comes via HTTPS"));
     server.enqueue(new MockResponse().setBody("another response via HTTPS"));
 
     // The pool will only reuse sockets if the SSL socket factories are the same.
-    SSLSocketFactory clientSocketFactory = sslContext.getSocketFactory();
+    SSLSocketFactory clientSocketFactory = sslClient.socketFactory;
     RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(clientSocketFactory)
+        .sslSocketFactory(clientSocketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
     connection = urlFactory.open(server.url("/").url());
@@ -590,13 +591,13 @@
   }
 
   @Test public void connectViaHttpsReusingConnectionsDifferentFactories() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("this response comes via HTTPS"));
     server.enqueue(new MockResponse().setBody("another response via HTTPS"));
 
     // install a custom SSL socket factory so the server can be authorized
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
     HttpURLConnection connection1 = urlFactory.open(server.url("/").url());
@@ -605,8 +606,14 @@
     SSLContext sslContext2 = SSLContext.getInstance("TLS");
     sslContext2.init(null, null, null);
     SSLSocketFactory sslSocketFactory2 = sslContext2.getSocketFactory();
+
+    TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(
+        TrustManagerFactory.getDefaultAlgorithm());
+    trustManagerFactory.init((KeyStore) null);
+    X509TrustManager trustManager = (X509TrustManager) trustManagerFactory.getTrustManagers()[0];
+
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslSocketFactory2)
+        .sslSocketFactory(sslSocketFactory2, trustManager)
         .build());
     HttpURLConnection connection2 = urlFactory.open(server.url("/").url());
     try {
@@ -619,13 +626,13 @@
   // TODO(jwilson): tests below this marker need to be migrated to OkHttp's request/response API.
 
   @Test public void connectViaHttpsWithSSLFallback() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setSocketPolicy(FAIL_HANDSHAKE));
     server.enqueue(new MockResponse().setBody("this response comes via SSL"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .hostnameVerifier(new RecordingHostnameVerifier())
-        .sslSocketFactory(suppressTlsFallbackClientSocketFactory())
+        .sslSocketFactory(suppressTlsFallbackClientSocketFactory(), sslClient.trustManager)
         .build());
     connection = urlFactory.open(server.url("/foo").url());
 
@@ -640,14 +647,14 @@
   }
 
   @Test public void connectViaHttpsWithSSLFallbackFailuresRecorded() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setSocketPolicy(FAIL_HANDSHAKE));
     server.enqueue(new MockResponse().setSocketPolicy(FAIL_HANDSHAKE));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .dns(new SingleInetAddressDns())
         .hostnameVerifier(new RecordingHostnameVerifier())
-        .sslSocketFactory(suppressTlsFallbackClientSocketFactory())
+        .sslSocketFactory(suppressTlsFallbackClientSocketFactory(), sslClient.trustManager)
         .build());
     connection = urlFactory.open(server.url("/foo").url());
 
@@ -666,7 +673,7 @@
    * https://github.com/square/okhttp/issues/515
    */
   @Test public void sslFallbackNotUsedWhenRecycledConnectionFails() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()
         .setBody("abc")
         .setSocketPolicy(DISCONNECT_AT_END));
@@ -674,7 +681,7 @@
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .hostnameVerifier(new RecordingHostnameVerifier())
-        .sslSocketFactory(suppressTlsFallbackClientSocketFactory())
+        .sslSocketFactory(suppressTlsFallbackClientSocketFactory(), sslClient.trustManager)
         .build());
 
     assertContent("abc", urlFactory.open(server.url("/").url()));
@@ -700,7 +707,7 @@
    * http://code.google.com/p/android/issues/detail?id=13178
    */
   @Test public void connectViaHttpsToUntrustedServer() throws IOException, InterruptedException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse()); // unused
 
     connection = urlFactory.open(server.url("/foo").url());
@@ -782,9 +789,9 @@
     };
 
     if (useHttps) {
-      server.useHttps(sslContext.getSocketFactory(), false);
+      server.useHttps(sslClient.socketFactory, false);
       urlFactory.setClient(urlFactory.client().newBuilder()
-          .sslSocketFactory(sslContext.getSocketFactory())
+          .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
           .hostnameVerifier(new RecordingHostnameVerifier())
           .build());
     }
@@ -862,12 +869,12 @@
   }
 
   private void testConnectViaDirectProxyToHttps(ProxyConfig proxyConfig) throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("this response comes via HTTPS"));
 
     URL url = server.url("/foo").url();
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
     connection = proxyConfig.connect(server, urlFactory, url);
@@ -901,14 +908,14 @@
   private void testConnectViaHttpProxyToHttps(ProxyConfig proxyConfig) throws Exception {
     RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
 
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.enqueue(
         new MockResponse().setSocketPolicy(UPGRADE_TO_SSL_AT_END).clearHeaders());
     server.enqueue(new MockResponse().setBody("this response comes via a secure proxy"));
 
     URL url = new URL("https://android.com/foo");
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
     connection = proxyConfig.connect(server, urlFactory, url);
@@ -930,7 +937,7 @@
   @Test public void connectViaHttpProxyToHttpsUsingBadProxyAndHttpResponseCache() throws Exception {
     initResponseCache();
 
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     // The inclusion of a body in the response to a CONNECT is key to reproducing b/6754912.
     MockResponse badProxyResponse = new MockResponse()
         .setSocketPolicy(UPGRADE_TO_SSL_AT_END)
@@ -942,7 +949,7 @@
     // failure to fail permanently.
     urlFactory.setClient(urlFactory.client().newBuilder()
         .dns(new SingleInetAddressDns())
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .connectionSpecs(Util.immutableList(ConnectionSpec.MODERN_TLS))
         .hostnameVerifier(new RecordingHostnameVerifier())
         .proxy(server.toProxyAddress())
@@ -969,14 +976,14 @@
       throws IOException, InterruptedException {
     RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
 
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.enqueue(
         new MockResponse().setSocketPolicy(UPGRADE_TO_SSL_AT_END).clearHeaders());
     server.enqueue(new MockResponse().setBody("encrypted response from the origin server"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .proxy(server.toProxyAddress())
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
 
@@ -1001,7 +1008,7 @@
 
   @Test public void proxyAuthenticateOnConnect() throws Exception {
     Authenticator.setDefault(new RecordingAuthenticator());
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.enqueue(new MockResponse().setResponseCode(407)
         .addHeader("Proxy-Authenticate: Basic realm=\"localhost\""));
     server.enqueue(
@@ -1011,7 +1018,7 @@
     urlFactory.setClient(urlFactory.client().newBuilder()
         .proxyAuthenticator(new JavaNetAuthenticator())
         .proxy(server.toProxyAddress())
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
 
@@ -1036,14 +1043,14 @@
   // Don't disconnect after building a tunnel with CONNECT
   // http://code.google.com/p/android/issues/detail?id=37221
   @Test public void proxyWithConnectionClose() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), true);
+    server.useHttps(sslClient.socketFactory, true);
     server.enqueue(
         new MockResponse().setSocketPolicy(UPGRADE_TO_SSL_AT_END).clearHeaders());
     server.enqueue(new MockResponse().setBody("this response comes via a proxy"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .proxy(server.toProxyAddress())
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
 
@@ -1055,7 +1062,7 @@
   }
 
   @Test public void proxyWithConnectionReuse() throws IOException {
-    SSLSocketFactory socketFactory = sslContext.getSocketFactory();
+    SSLSocketFactory socketFactory = sslClient.socketFactory;
     RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
 
     server.useHttps(socketFactory, true);
@@ -1066,7 +1073,7 @@
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .proxy(server.toProxyAddress())
-        .sslSocketFactory(socketFactory)
+        .sslSocketFactory(socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
     URL url = new URL("https://android.com/foo");
@@ -1304,11 +1311,11 @@
   private void testClientConfiguredGzipContentEncodingAndConnectionReuse(TransferKind transferKind,
       boolean tls) throws Exception {
     if (tls) {
-      SSLSocketFactory socketFactory = sslContext.getSocketFactory();
+      SSLSocketFactory socketFactory = sslClient.socketFactory;
       RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
       server.useHttps(socketFactory, false);
       urlFactory.setClient(urlFactory.client().newBuilder()
-          .sslSocketFactory(socketFactory)
+          .sslSocketFactory(socketFactory, sslClient.trustManager)
           .hostnameVerifier(hostnameVerifier)
           .build());
     }
@@ -1744,11 +1751,11 @@
    * http://code.google.com/p/android/issues/detail?id=12860
    */
   private void testSecureStreamingPost(StreamingMode streamingMode) throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("Success!"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
     connection = urlFactory.open(server.url("/").url());
@@ -1929,14 +1936,14 @@
   }
 
   @Test public void redirectedOnHttps() throws IOException, InterruptedException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
         .addHeader("Location: /foo")
         .setBody("This page has moved!"));
     server.enqueue(new MockResponse().setBody("This is the new location!"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
     connection = urlFactory.open(server.url("/").url());
@@ -1951,14 +1958,14 @@
   }
 
   @Test public void notRedirectedFromHttpsToHttp() throws IOException, InterruptedException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
         .addHeader("Location: http://anyhost/foo")
         .setBody("This page has moved!"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .followSslRedirects(false)
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build());
     connection = urlFactory.open(server.url("/").url());
@@ -1980,13 +1987,13 @@
   @Test public void redirectedFromHttpsToHttpFollowingProtocolRedirects() throws Exception {
     server2.enqueue(new MockResponse().setBody("This is insecure HTTP!"));
 
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
         .addHeader("Location: " + server2.url("/").url())
         .setBody("This page has moved!"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .followSslRedirects(true)
         .build());
@@ -2000,7 +2007,7 @@
   }
 
   @Test public void redirectedFromHttpToHttpsFollowingProtocolRedirects() throws Exception {
-    server2.useHttps(sslContext.getSocketFactory(), false);
+    server2.useHttps(sslClient.socketFactory, false);
     server2.enqueue(new MockResponse().setBody("This is secure HTTPS!"));
 
     server.enqueue(new MockResponse().setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
@@ -2008,7 +2015,7 @@
         .setBody("This page has moved!"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .followSslRedirects(true)
         .build());
@@ -2027,11 +2034,11 @@
 
   private void redirectToAnotherOriginServer(boolean https) throws Exception {
     if (https) {
-      server.useHttps(sslContext.getSocketFactory(), false);
-      server2.useHttps(sslContext.getSocketFactory(), false);
+      server.useHttps(sslClient.socketFactory, false);
+      server2.useHttps(sslClient.socketFactory, false);
       server2.setProtocolNegotiationEnabled(false);
       urlFactory.setClient(urlFactory.client().newBuilder()
-          .sslSocketFactory(sslContext.getSocketFactory())
+          .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
           .hostnameVerifier(new RecordingHostnameVerifier())
           .build());
     }
@@ -2309,15 +2316,15 @@
 
   @Test public void httpsWithCustomTrustManager() throws Exception {
     RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
-    RecordingTrustManager trustManager = new RecordingTrustManager(sslContext);
-    SSLContext sc = SSLContext.getInstance("TLS");
-    sc.init(null, new TrustManager[] {trustManager}, new SecureRandom());
+    RecordingTrustManager trustManager = new RecordingTrustManager(sslClient.trustManager);
+    SSLContext sslContext = SSLContext.getInstance("TLS");
+    sslContext.init(null, new TrustManager[] { trustManager }, null);
 
     urlFactory.setClient(urlFactory.client().newBuilder()
         .hostnameVerifier(hostnameVerifier)
-        .sslSocketFactory(sc.getSocketFactory())
+        .sslSocketFactory(sslContext.getSocketFactory(), trustManager)
         .build());
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("ABC"));
     server.enqueue(new MockResponse().setBody("DEF"));
     server.enqueue(new MockResponse().setBody("GHI"));
@@ -3451,6 +3458,18 @@
     testInstanceFollowsRedirects("https://www.google.com/");
   }
 
+  @Test public void setSslSocketFactoryFailsOnJdk9() throws Exception {
+    assumeTrue(getPlatform().equals("jdk9"));
+
+    URL url = server.url("/").url();
+    HttpsURLConnection connection = (HttpsURLConnection) urlFactory.open(url);
+    try {
+      connection.setSSLSocketFactory(sslClient.socketFactory);
+      fail();
+    } catch (UnsupportedOperationException expected) {
+    }
+  }
+
   private void testInstanceFollowsRedirects(String spec) throws Exception {
     URL url = new URL(spec);
     HttpURLConnection urlConnection = urlFactory.open(url);
@@ -3589,8 +3608,8 @@
     private final List<String> calls = new ArrayList<String>();
     private final X509TrustManager delegate;
 
-    public RecordingTrustManager(SSLContext sslContext) {
-      this.delegate = Platform.get().trustManager(sslContext.getSocketFactory());
+    public RecordingTrustManager(X509TrustManager delegate) {
+      this.delegate = delegate;
     }
 
     public X509Certificate[] getAcceptedIssuers() {
@@ -3622,11 +3641,11 @@
    */
   private void enableProtocol(Protocol protocol) {
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .protocols(Arrays.asList(protocol, Protocol.HTTP_1_1))
         .build());
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.setProtocolNegotiationEnabled(true);
     server.setProtocols(urlFactory.client().protocols());
   }
@@ -3637,6 +3656,10 @@
    * for details.
    */
   private FallbackTestClientSocketFactory suppressTlsFallbackClientSocketFactory() {
-    return new FallbackTestClientSocketFactory(sslContext.getSocketFactory());
+    return new FallbackTestClientSocketFactory(sslClient.socketFactory);
+  }
+
+  private String getPlatform() {
+    return System.getProperty("okhttp.platform", "platform");
   }
 }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/internal/ConnectionSpecSelectorTest.java b/okhttp-tests/src/test/java/okhttp3/internal/ConnectionSpecSelectorTest.java
index b6aa534..96c6585 100644
--- a/okhttp-tests/src/test/java/okhttp3/internal/ConnectionSpecSelectorTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/internal/ConnectionSpecSelectorTest.java
@@ -20,11 +20,11 @@
 import java.util.Arrays;
 import java.util.LinkedHashSet;
 import java.util.Set;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLHandshakeException;
 import javax.net.ssl.SSLSocket;
 import okhttp3.ConnectionSpec;
 import okhttp3.TlsVersion;
+import okhttp3.internal.tls.SslClient;
 import org.junit.Test;
 
 import static org.junit.Assert.assertEquals;
@@ -39,7 +39,7 @@
   public static final SSLHandshakeException RETRYABLE_EXCEPTION = new SSLHandshakeException(
       "Simulated handshake exception");
 
-  private SSLContext sslContext = SslContextBuilder.localhost();
+  private SslClient sslClient = SslClient.localhost();
 
   @Test
   public void nonRetryableIOException() throws Exception {
@@ -120,7 +120,7 @@
   }
 
   private SSLSocket createSocketWithEnabledProtocols(TlsVersion... tlsVersions) throws IOException {
-    SSLSocket socket = (SSLSocket) sslContext.getSocketFactory().createSocket();
+    SSLSocket socket = (SSLSocket) sslClient.socketFactory.createSocket();
     socket.setEnabledProtocols(javaNames(tlsVersions));
     return socket;
   }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/internal/framed/HttpOverSpdyTest.java b/okhttp-tests/src/test/java/okhttp3/internal/framed/HttpOverSpdyTest.java
index c189d6b..23923d9 100644
--- a/okhttp-tests/src/test/java/okhttp3/internal/framed/HttpOverSpdyTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/internal/framed/HttpOverSpdyTest.java
@@ -25,7 +25,6 @@
 import java.util.concurrent.ExecutorService;
 import java.util.concurrent.Executors;
 import javax.net.ssl.HostnameVerifier;
-import javax.net.ssl.SSLContext;
 import okhttp3.Cache;
 import okhttp3.Call;
 import okhttp3.Cookie;
@@ -41,8 +40,8 @@
 import okhttp3.internal.DoubleInetAddressDns;
 import okhttp3.internal.RecordingOkAuthenticator;
 import okhttp3.internal.SingleInetAddressDns;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.Util;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okhttp3.mockwebserver.RecordedRequest;
@@ -74,7 +73,7 @@
   private final Protocol protocol;
   protected String hostHeader = ":host";
 
-  protected SSLContext sslContext = SslContextBuilder.localhost();
+  protected SslClient sslClient = SslClient.localhost();
   protected HostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
   protected OkHttpClient client;
   protected Cache cache;
@@ -84,12 +83,12 @@
   }
 
   @Before public void setUp() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     cache = new Cache(tempDir.getRoot(), Integer.MAX_VALUE);
     client = new OkHttpClient.Builder()
         .protocols(Arrays.asList(protocol, Protocol.HTTP_1_1))
         .dns(new SingleInetAddressDns())
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build();
   }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/internal/http/RouteSelectorTest.java b/okhttp-tests/src/test/java/okhttp3/internal/http/RouteSelectorTest.java
index 7f0b470..b1e3fca 100644
--- a/okhttp-tests/src/test/java/okhttp3/internal/http/RouteSelectorTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/internal/http/RouteSelectorTest.java
@@ -30,7 +30,6 @@
 import javax.net.SocketFactory;
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.HttpsURLConnection;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSocketFactory;
 import okhttp3.Address;
 import okhttp3.Authenticator;
@@ -39,8 +38,8 @@
 import okhttp3.Protocol;
 import okhttp3.Route;
 import okhttp3.internal.RouteDatabase;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.Util;
+import okhttp3.internal.tls.SslClient;
 import org.junit.Before;
 import org.junit.Test;
 
@@ -68,8 +67,8 @@
   private int uriPort = 1003;
 
   private SocketFactory socketFactory;
-  private final SSLContext sslContext = SslContextBuilder.localhost();
-  private final SSLSocketFactory sslSocketFactory = sslContext.getSocketFactory();
+  private final SslClient sslClient = SslClient.localhost();
+  private final SSLSocketFactory sslSocketFactory = sslClient.socketFactory;
   private HostnameVerifier hostnameVerifier;
 
   private final Authenticator authenticator = Authenticator.NONE;
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java b/okhttp-tests/src/test/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java
index 8c50399..4b59edb 100644
--- a/okhttp-tests/src/test/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java
@@ -15,7 +15,6 @@
  */
 package okhttp3.internal.tls;
 
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLHandshakeException;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import okhttp3.Call;
@@ -24,8 +23,6 @@
 import okhttp3.RecordingHostnameVerifier;
 import okhttp3.Request;
 import okhttp3.Response;
-import okhttp3.internal.HeldCertificate;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okhttp3.mockwebserver.SocketPolicy;
@@ -60,19 +57,19 @@
     CertificatePinner certificatePinner = new CertificatePinner.Builder()
         .add(server.getHostName(), CertificatePinner.pin(rootCa.certificate))
         .build();
-    SSLContext clientContext = new SslContextBuilder()
+    SslClient sslClient = new SslClient.Builder()
         .addTrustedCertificate(rootCa.certificate)
         .build();
     OkHttpClient client = new OkHttpClient.Builder()
-        .sslSocketFactory(clientContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .certificatePinner(certificatePinner)
         .build();
 
-    SSLContext serverSslContext = new SslContextBuilder()
+    SslClient serverSslClient = new SslClient.Builder()
         .certificateChain(certificate, intermediateCa)
         .build();
-    server.useHttps(serverSslContext.getSocketFactory(), false);
+    server.useHttps(serverSslClient.socketFactory, false);
 
     // The request should complete successfully.
     server.enqueue(new MockResponse()
@@ -116,19 +113,19 @@
     CertificatePinner certificatePinner = new CertificatePinner.Builder()
         .add(server.getHostName(), CertificatePinner.pin(intermediateCa.certificate))
         .build();
-    SSLContext clientContext = new SslContextBuilder()
+    SslClient contextBuilder = new SslClient.Builder()
         .addTrustedCertificate(rootCa.certificate)
         .build();
     OkHttpClient client = new OkHttpClient.Builder()
-        .sslSocketFactory(clientContext.getSocketFactory())
+        .sslSocketFactory(contextBuilder.socketFactory, contextBuilder.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .certificatePinner(certificatePinner)
         .build();
 
-    SSLContext serverSslContext = new SslContextBuilder()
-        .certificateChain(certificate, intermediateCa)
+    SslClient serverSslContext = new SslClient.Builder()
+        .certificateChain(certificate.keyPair, certificate.certificate, intermediateCa.certificate)
         .build();
-    server.useHttps(serverSslContext.getSocketFactory(), false);
+    server.useHttps(serverSslContext.socketFactory, false);
 
     // The request should complete successfully.
     server.enqueue(new MockResponse()
@@ -176,11 +173,11 @@
     CertificatePinner certificatePinner = new CertificatePinner.Builder()
         .add(server.getHostName(), CertificatePinner.pin(goodCertificate.certificate))
         .build();
-    SSLContext clientContext = new SslContextBuilder()
+    SslClient clientContextBuilder = new SslClient.Builder()
         .addTrustedCertificate(rootCa.certificate)
         .build();
     OkHttpClient client = new OkHttpClient.Builder()
-        .sslSocketFactory(clientContext.getSocketFactory())
+        .sslSocketFactory(clientContextBuilder.socketFactory, clientContextBuilder.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .certificatePinner(certificatePinner)
         .build();
@@ -200,10 +197,10 @@
         .issuedBy(compromisedIntermediateCa)
         .commonName(server.getHostName())
         .build();
-    SSLContext serverSslContext = new SslContextBuilder()
-        .certificateChain(rogueCertificate, compromisedIntermediateCa, goodCertificate, rootCa)
+    SslClient serverSslContext = new SslClient.Builder()
+        .certificateChain(rogueCertificate.keyPair, rogueCertificate.certificate, compromisedIntermediateCa.certificate, goodCertificate.certificate, rootCa.certificate)
         .build();
-    server.useHttps(serverSslContext.getSocketFactory(), false);
+    server.useHttps(serverSslContext.socketFactory, false);
     server.enqueue(new MockResponse()
         .setBody("abc")
         .addHeader("Content-Type: text/plain"));
@@ -249,12 +246,12 @@
     CertificatePinner certificatePinner = new CertificatePinner.Builder()
         .add(server.getHostName(), CertificatePinner.pin(goodIntermediateCa.certificate))
         .build();
-    SSLContext clientContext = new SslContextBuilder()
+    SslClient clientContextBuilder = new SslClient.Builder()
         .addTrustedCertificate(rootCa.certificate)
         .addTrustedCertificate(compromisedRootCa.certificate)
         .build();
     OkHttpClient client = new OkHttpClient.Builder()
-        .sslSocketFactory(clientContext.getSocketFactory())
+        .sslSocketFactory(clientContextBuilder.socketFactory, clientContextBuilder.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .certificatePinner(certificatePinner)
         .build();
@@ -274,11 +271,11 @@
         .issuedBy(compromisedIntermediateCa)
         .commonName(server.getHostName())
         .build();
-    SSLContext serverSslContext = new SslContextBuilder()
+    SslClient serverSslContext = new SslClient.Builder()
         .certificateChain(
-            rogueCertificate, goodIntermediateCa, compromisedIntermediateCa, compromisedRootCa)
+            rogueCertificate.keyPair, rogueCertificate.certificate, goodIntermediateCa.certificate, compromisedIntermediateCa.certificate, compromisedRootCa.certificate)
         .build();
-    server.useHttps(serverSslContext.getSocketFactory(), false);
+    server.useHttps(serverSslContext.socketFactory, false);
     server.enqueue(new MockResponse()
         .setBody("abc")
         .addHeader("Content-Type: text/plain"));
/Fim/
diff --git a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpsURLConnectionImpl.java b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpsURLConnectionImpl.java
index 1bf1fa6..05e2635 100644
--- a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpsURLConnectionImpl.java
+++ b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/HttpsURLConnectionImpl.java
@@ -63,6 +63,7 @@
   }
 
   @Override public void setSSLSocketFactory(SSLSocketFactory sslSocketFactory) {
+    // This fails in JDK 9 because OkHttp is unable to extract the trust manager.
     delegate.client = delegate.client.newBuilder()
         .sslSocketFactory(sslSocketFactory)
         .build();
/Fim/
diff --git a/okhttp-urlconnection/src/test/java/okhttp3/OkUrlFactoryTest.java b/okhttp-urlconnection/src/test/java/okhttp3/OkUrlFactoryTest.java
index 39f6066..985e545 100644
--- a/okhttp-urlconnection/src/test/java/okhttp3/OkUrlFactoryTest.java
+++ b/okhttp-urlconnection/src/test/java/okhttp3/OkUrlFactoryTest.java
@@ -11,11 +11,10 @@
 import java.util.TimeZone;
 import java.util.concurrent.TimeUnit;
 import javax.net.ssl.HttpsURLConnection;
-import javax.net.ssl.SSLContext;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.URLFilter;
 import okhttp3.internal.http.OkHeaders;
 import okhttp3.internal.io.InMemoryFileSystem;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okio.BufferedSource;
@@ -184,10 +183,10 @@
         .setBody("Blocked!"));
     final URL blockedURL = cleartextServer.url("/").url();
 
-    SSLContext context = SslContextBuilder.localhost();
-    server.useHttps(context.getSocketFactory(), false);
+    SslClient contextBuilder = SslClient.localhost();
+    server.useHttps(contextBuilder.socketFactory, false);
     factory.setClient(factory.client().newBuilder()
-        .sslSocketFactory(context.getSocketFactory())
+        .sslSocketFactory(contextBuilder.socketFactory, contextBuilder.trustManager)
         .followSslRedirects(true)
         .build());
     factory.setUrlFilter(new URLFilter() {
/Fim/
diff --git a/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java b/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java
index a5b1107..693af67 100644
--- a/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java
+++ b/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java
@@ -40,12 +40,11 @@
 import java.util.concurrent.TimeUnit;
 import javax.net.ssl.HostnameVerifier;
 import javax.net.ssl.HttpsURLConnection;
-import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSession;
 import okhttp3.internal.Internal;
-import okhttp3.internal.SslContextBuilder;
 import okhttp3.internal.Util;
 import okhttp3.internal.io.InMemoryFileSystem;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
 import okhttp3.mockwebserver.RecordedRequest;
@@ -66,6 +65,7 @@
 import static org.junit.Assert.assertSame;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assert.fail;
+import static org.junit.Assume.assumeFalse;
 
 /** Test caching with {@link OkUrlFactory}. */
 public final class UrlConnectionCacheTest {
@@ -79,7 +79,7 @@
   @Rule public MockWebServer server2 = new MockWebServer();
   @Rule public InMemoryFileSystem fileSystem = new InMemoryFileSystem();
 
-  private final SSLContext sslContext = SslContextBuilder.localhost();
+  private final SslClient sslClient = SslClient.localhost();
   private OkUrlFactory urlFactory = new OkUrlFactory(new OkHttpClient());
   private Cache cache;
   private final CookieManager cookieManager = new CookieManager();
@@ -257,13 +257,15 @@
   }
 
   @Test public void secureResponseCaching() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    assumeFalse(getPlatform().equals("jdk9"));
+
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
         .setBody("ABC"));
 
     HttpsURLConnection c1 = (HttpsURLConnection) urlFactory.open(server.url("/").url());
-    c1.setSSLSocketFactory(sslContext.getSocketFactory());
+    c1.setSSLSocketFactory(sslClient.socketFactory);
     c1.setHostnameVerifier(NULL_HOSTNAME_VERIFIER);
     assertEquals("ABC", readAscii(c1));
 
@@ -275,7 +277,7 @@
     Principal localPrincipal = c1.getLocalPrincipal();
 
     HttpsURLConnection c2 = (HttpsURLConnection) urlFactory.open(server.url("/").url()); // cached!
-    c2.setSSLSocketFactory(sslContext.getSocketFactory());
+    c2.setSSLSocketFactory(sslClient.socketFactory);
     c2.setHostnameVerifier(NULL_HOSTNAME_VERIFIER);
     assertEquals("ABC", readAscii(c2));
 
@@ -335,7 +337,7 @@
   }
 
   @Test public void secureResponseCachingAndRedirects() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
         .setResponseCode(HttpURLConnection.HTTP_MOVED_PERM)
@@ -346,7 +348,7 @@
     server.enqueue(new MockResponse().setBody("DEF"));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(NULL_HOSTNAME_VERIFIER)
         .build());
 
@@ -372,7 +374,7 @@
    * https://github.com/square/okhttp/issues/214
    */
   @Test public void secureResponseCachingAndProtocolRedirects() throws IOException {
-    server2.useHttps(sslContext.getSocketFactory(), false);
+    server2.useHttps(sslClient.socketFactory, false);
     server2.enqueue(new MockResponse().addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
         .setBody("ABC"));
@@ -384,7 +386,7 @@
         .addHeader("Location: " + server2.url("/").url()));
 
     urlFactory.setClient(urlFactory.client().newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(NULL_HOSTNAME_VERIFIER)
         .build());
 
@@ -1400,7 +1402,9 @@
   }
 
   @Test public void varyAndHttps() throws Exception {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    assumeFalse(getPlatform().equals("jdk9"));
+
+    server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().addHeader("Cache-Control: max-age=60")
         .addHeader("Vary: Accept-Language")
         .setBody("A"));
@@ -1408,13 +1412,13 @@
 
     URL url = server.url("/").url();
     HttpsURLConnection connection1 = (HttpsURLConnection) urlFactory.open(url);
-    connection1.setSSLSocketFactory(sslContext.getSocketFactory());
+    connection1.setSSLSocketFactory(sslClient.socketFactory);
     connection1.setHostnameVerifier(NULL_HOSTNAME_VERIFIER);
     connection1.addRequestProperty("Accept-Language", "en-US");
     assertEquals("A", readAscii(connection1));
 
     HttpsURLConnection connection2 = (HttpsURLConnection) urlFactory.open(url);
-    connection2.setSSLSocketFactory(sslContext.getSocketFactory());
+    connection2.setSSLSocketFactory(sslClient.socketFactory);
     connection2.setHostnameVerifier(NULL_HOSTNAME_VERIFIER);
     connection2.addRequestProperty("Accept-Language", "en-US");
     assertEquals("A", readAscii(connection2));
@@ -1834,4 +1838,8 @@
     sink.close();
     return result;
   }
+
+  private String getPlatform() {
+    return System.getProperty("okhttp.platform", "platform");
+  }
 }
/Fim/
diff --git a/okhttp-ws-tests/src/test/java/okhttp3/ws/WebSocketCallTest.java b/okhttp-ws-tests/src/test/java/okhttp3/ws/WebSocketCallTest.java
index 2e66dec..06dd4a2 100644
--- a/okhttp-ws-tests/src/test/java/okhttp3/ws/WebSocketCallTest.java
+++ b/okhttp-ws-tests/src/test/java/okhttp3/ws/WebSocketCallTest.java
@@ -21,16 +21,15 @@
 import java.util.concurrent.CountDownLatch;
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.atomic.AtomicReference;
-import javax.net.ssl.SSLContext;
 import okhttp3.OkHttpClient;
+import okhttp3.RecordingHostnameVerifier;
 import okhttp3.Request;
 import okhttp3.RequestBody;
 import okhttp3.Response;
 import okhttp3.ResponseBody;
-import okhttp3.internal.SslContextBuilder;
+import okhttp3.internal.tls.SslClient;
 import okhttp3.mockwebserver.MockResponse;
 import okhttp3.mockwebserver.MockWebServer;
-import okhttp3.RecordingHostnameVerifier;
 import okio.Buffer;
 import org.junit.After;
 import org.junit.Rule;
@@ -41,7 +40,7 @@
 public final class WebSocketCallTest {
   @Rule public final MockWebServer server = new MockWebServer();
 
-  private final SSLContext sslContext = SslContextBuilder.localhost();
+  private final SslClient sslClient = SslClient.localhost();
   private final WebSocketRecorder listener = new WebSocketRecorder();
   private final Random random = new Random(0);
   private OkHttpClient client = new OkHttpClient();
@@ -185,9 +184,9 @@
   }
 
   @Test public void wssScheme() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build();
 
@@ -195,9 +194,9 @@
   }
 
   @Test public void httpsScheme() throws IOException {
-    server.useHttps(sslContext.getSocketFactory(), false);
+    server.useHttps(sslClient.socketFactory, false);
     client = client.newBuilder()
-        .sslSocketFactory(sslContext.getSocketFactory())
+        .sslSocketFactory(sslClient.socketFactory, sslClient.trustManager)
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build();
 
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/Jdk9Platform.java b/okhttp/src/main/java/okhttp3/internal/Jdk9Platform.java
index 94677eb..1cd04f9 100644
--- a/okhttp/src/main/java/okhttp3/internal/Jdk9Platform.java
+++ b/okhttp/src/main/java/okhttp3/internal/Jdk9Platform.java
@@ -20,6 +20,8 @@
 import java.util.List;
 import javax.net.ssl.SSLParameters;
 import javax.net.ssl.SSLSocket;
+import javax.net.ssl.SSLSocketFactory;
+import javax.net.ssl.X509TrustManager;
 import okhttp3.Protocol;
 
 /**
@@ -36,14 +38,14 @@
 
   @Override
   public void configureTlsExtensions(SSLSocket sslSocket, String hostname,
-                                     List<Protocol> protocols) {
+      List<Protocol> protocols) {
     try {
       SSLParameters sslParameters = sslSocket.getSSLParameters();
 
       List<String> names = alpnProtocolNames(protocols);
 
       setProtocolMethod.invoke(sslParameters,
-          new Object[]{names.toArray(new String[names.size()])});
+          new Object[] {names.toArray(new String[names.size()])});
 
       sslSocket.setSSLParameters(sslParameters);
     } catch (IllegalAccessException | InvocationTargetException e) {
@@ -68,6 +70,15 @@
     }
   }
 
+  @Override public X509TrustManager trustManager(SSLSocketFactory sslSocketFactory) {
+    // Not supported due to access checks on JDK 9+:
+    // java.lang.reflect.InaccessibleObjectException: Unable to make member of class
+    // sun.security.ssl.SSLSocketFactoryImpl accessible:  module java.base does not export
+    // sun.security.ssl to unnamed module @xxx
+    throw new UnsupportedOperationException(
+        "clientBuilder.sslSocketFactory(SSLSocketFactory) not supported on JDK 9+");
+  }
+
   public static Jdk9Platform buildIfSupported() {
     // Find JDK 9 new methods
     try {
/Fim/
diff --git a/pom.xml b/pom.xml
index 52054e9..4be0178 100644
--- a/pom.xml
+++ b/pom.xml
@@ -304,7 +304,7 @@
     <profile>
       <id>jdk9</id>
       <activation>
-        <jdk>1.9</jdk>
+        <jdk>9</jdk>
       </activation>
       <properties>
         <okhttp.platform>jdk9</okhttp.platform>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 54d1bf7..0db6c27 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,18 @@
 Change Log
 ==========
 
+## Version 3.3.1
+
+_2016-05-28_
+
+ *  Fix: The plaintext check in HttpLoggingInterceptor incorrectly classified
+    newline characters as control characters. This is fixed.
+ *  Fix: Don't crash reading non-ASCII characters in HTTP/2 headers or in cached
+    HTTP headers.
+ *  Fix: Retain the response body when an attempt to open a web socket returns a
+    non-101 response code.
+
+
 ## Version 3.3.0
 
 _2016-05-24_
/Fim/
diff --git a/README.md b/README.md
index 9598745..2e40ffd 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.3.0</version>
+  <version>3.3.1</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.3.0'
+compile 'com.squareup.okhttp3:okhttp:3.3.1'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.3.0</version>
+  <version>3.3.1</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.3.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.3.1'
 ```
 
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index f97dc33..500c20d 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 555e19d..354f15a 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index a12f1f4..fe81b59 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 6d26b36..c01f217 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 8ae2bc8..e4ba3a1 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 6a451bf..f53a38d 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 943f53a..5755d04 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index fd07ff9..851137a 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -1,14 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 3aaa66d..042e6c4 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index cef5759..c7688db 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 7cbfab9..3fc9bef 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a26e988..ac72922 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 4be0178..d0c4b4e 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.4.0-SNAPSHOT</version>
+  <version>3.3.1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -67,7 +67,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.3.1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index a40fe5b..1c31fa3 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 5690993..603e351 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index de77532..9eb140c 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 5bb5efe..1514cb6 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index dc446c5..bcfa15d 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.3.1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 500c20d..f97dc33 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 354f15a..555e19d 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index fe81b59..a12f1f4 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index c01f217..6d26b36 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index e4ba3a1..8ae2bc8 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index f53a38d..6a451bf 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 5755d04..943f53a 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 851137a..5585632 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 042e6c4..3aaa66d 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index c7688db..cef5759 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 3fc9bef..7cbfab9 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index ac72922..a26e988 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index d0c4b4e..4be0178 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.3.1</version>
+  <version>3.4.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -67,7 +67,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.3.1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 1c31fa3..a40fe5b 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 603e351..5690993 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 9eb140c..de77532 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 1514cb6..5bb5efe 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index bcfa15d..dc446c5 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.3.1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/AndroidPlatform.java b/okhttp/src/main/java/okhttp3/internal/AndroidPlatform.java
index 65e9702..c0096c6 100644
--- a/okhttp/src/main/java/okhttp3/internal/AndroidPlatform.java
+++ b/okhttp/src/main/java/okhttp3/internal/AndroidPlatform.java
@@ -17,15 +17,20 @@
 
 import android.util.Log;
 import java.io.IOException;
+import java.lang.reflect.Constructor;
 import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
 import java.net.InetSocketAddress;
 import java.net.Socket;
+import java.security.cert.Certificate;
+import java.security.cert.X509Certificate;
 import java.util.List;
+import javax.net.ssl.SSLPeerUnverifiedException;
 import javax.net.ssl.SSLSocket;
 import javax.net.ssl.SSLSocketFactory;
 import javax.net.ssl.X509TrustManager;
 import okhttp3.Protocol;
+import okhttp3.internal.tls.CertificateChainCleaner;
 
 /** Android 2.3 or better. */
 class AndroidPlatform extends Platform {
@@ -144,6 +149,19 @@
     }
   }
 
+  public CertificateChainCleaner buildCertificateChainCleaner(X509TrustManager trustManager) {
+    try {
+      Class<?> extensionsClass = Class.forName("android.net.http.X509TrustManagerExtensions");
+      Constructor<?> constructor = extensionsClass.getConstructor(X509TrustManager.class);
+      Object extensions = constructor.newInstance(trustManager);
+      Method checkServerTrusted = extensionsClass.getMethod(
+          "checkServerTrusted", X509Certificate[].class, String.class, String.class);
+      return new AndroidCertificateChainCleaner(extensions, checkServerTrusted);
+    } catch (Exception e) {
+      return super.buildCertificateChainCleaner(trustManager);
+    }
+  }
+
   public static Platform buildIfSupported() {
     // Attempt to find Android 2.3+ APIs.
     try {
@@ -179,4 +197,35 @@
 
     return null;
   }
+
+  /**
+   * X509TrustManagerExtensions was added to Android in API 17 (Android 4.2, released in late 2012).
+   * This is the best way to get a clean chain on Android because it uses the same code as the TLS
+   * handshake.
+   */
+  static final class AndroidCertificateChainCleaner extends CertificateChainCleaner {
+    private final Object x509TrustManagerExtensions;
+    private final Method checkServerTrusted;
+
+    AndroidCertificateChainCleaner(Object x509TrustManagerExtensions, Method checkServerTrusted) {
+      this.x509TrustManagerExtensions = x509TrustManagerExtensions;
+      this.checkServerTrusted = checkServerTrusted;
+    }
+
+    @SuppressWarnings({"unchecked", "SuspiciousToArrayCall"}) // Reflection on List<Certificate>.
+    @Override public List<Certificate> clean(List<Certificate> chain, String hostname)
+        throws SSLPeerUnverifiedException {
+      try {
+        X509Certificate[] certificates = chain.toArray(new X509Certificate[chain.size()]);
+        return (List<Certificate>) checkServerTrusted.invoke(
+            x509TrustManagerExtensions, certificates, "RSA", hostname);
+      } catch (InvocationTargetException e) {
+        SSLPeerUnverifiedException exception = new SSLPeerUnverifiedException(e.getMessage());
+        exception.initCause(e);
+        throw exception;
+      } catch (IllegalAccessException e) {
+        throw new AssertionError(e);
+      }
+    }
+  }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/Platform.java b/okhttp/src/main/java/okhttp3/internal/Platform.java
index 34da83c..1245b63 100644
--- a/okhttp/src/main/java/okhttp3/internal/Platform.java
+++ b/okhttp/src/main/java/okhttp3/internal/Platform.java
@@ -29,6 +29,9 @@
 import javax.net.ssl.X509TrustManager;
 import okhttp3.OkHttpClient;
 import okhttp3.Protocol;
+import okhttp3.internal.tls.BasicCertificateChainCleaner;
+import okhttp3.internal.tls.CertificateChainCleaner;
+import okhttp3.internal.tls.TrustRootIndex;
 import okio.Buffer;
 
 /**
@@ -140,6 +143,10 @@
     return names;
   }
 
+  public CertificateChainCleaner buildCertificateChainCleaner(X509TrustManager trustManager) {
+    return new BasicCertificateChainCleaner(TrustRootIndex.get(trustManager));
+  }
+
   /** Attempt to match the host runtime to a capable Platform implementation. */
   private static Platform findPlatform() {
     Platform android = AndroidPlatform.buildIfSupported();
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/BasicCertificateChainCleaner.java b/okhttp/src/main/java/okhttp3/internal/tls/BasicCertificateChainCleaner.java
new file mode 100644
index 0000000..be8cab0
--- /dev/null
+++ b/okhttp/src/main/java/okhttp3/internal/tls/BasicCertificateChainCleaner.java
@@ -0,0 +1,114 @@
+/*
+ * Copyright (C) 2016 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3.internal.tls;
+
+import java.security.GeneralSecurityException;
+import java.security.cert.Certificate;
+import java.security.cert.X509Certificate;
+import java.util.ArrayDeque;
+import java.util.ArrayList;
+import java.util.Deque;
+import java.util.Iterator;
+import java.util.List;
+import javax.net.ssl.SSLPeerUnverifiedException;
+
+/**
+ * A certificate chain cleaner that uses a set of trusted root certificates to build the trusted
+ * chain. This class duplicates the clean chain building performed during the TLS handshake. We
+ * prefer other mechanisms where they exist, such as with
+ * {@link okhttp3.internal.AndroidPlatform.AndroidCertificateChainCleaner}.
+ *
+ * <p>This class includes code from <a href="https://conscrypt.org/">Conscrypt's</a> {@code
+ * TrustManagerImpl} and {@code TrustedCertificateIndex}.
+ */
+public final class BasicCertificateChainCleaner extends CertificateChainCleaner {
+  /** The maximum number of signers in a chain. We use 9 for consistency with OpenSSL. */
+  private static final int MAX_SIGNERS = 9;
+
+  private final TrustRootIndex trustRootIndex;
+
+  public BasicCertificateChainCleaner(TrustRootIndex trustRootIndex) {
+    this.trustRootIndex = trustRootIndex;
+  }
+
+  /**
+   * Returns a cleaned chain for {@code chain}.
+   *
+   * <p>This method throws if the complete chain to a trusted CA certificate cannot be constructed.
+   * This is unexpected unless the trust root index in this class has a different trust manager than
+   * what was used to establish {@code chain}.
+   */
+  @Override public List<Certificate> clean(List<Certificate> chain, String hostname)
+      throws SSLPeerUnverifiedException {
+    Deque<Certificate> queue = new ArrayDeque<>(chain);
+    List<Certificate> result = new ArrayList<>();
+    result.add(queue.removeFirst());
+    boolean foundTrustedCertificate = false;
+
+    followIssuerChain:
+    for (int c = 0; c < MAX_SIGNERS; c++) {
+      X509Certificate toVerify = (X509Certificate) result.get(result.size() - 1);
+
+      // If this cert has been signed by a trusted cert, use that. Add the trusted certificate to
+      // the end of the chain unless it's already present. (That would happen if the first
+      // certificate in the chain is itself a self-signed and trusted CA certificate.)
+      X509Certificate trustedCert = trustRootIndex.findByIssuerAndSignature(toVerify);
+      if (trustedCert != null) {
+        if (result.size() > 1 || !toVerify.equals(trustedCert)) {
+          result.add(trustedCert);
+        }
+        if (verifySignature(trustedCert, trustedCert)) {
+          return result; // The self-signed cert is a root CA. We're done.
+        }
+        foundTrustedCertificate = true;
+        continue;
+      }
+
+      // Search for the certificate in the chain that signed this certificate. This is typically
+      // the next element in the chain, but it could be any element.
+      for (Iterator<Certificate> i = queue.iterator(); i.hasNext(); ) {
+        X509Certificate signingCert = (X509Certificate) i.next();
+        if (verifySignature(toVerify, signingCert)) {
+          i.remove();
+          result.add(signingCert);
+          continue followIssuerChain;
+        }
+      }
+
+      // We've reached the end of the chain. If any cert in the chain is trusted, we're done.
+      if (foundTrustedCertificate) {
+        return result;
+      }
+
+      // The last link isn't trusted. Fail.
+      throw new SSLPeerUnverifiedException(
+          "Failed to find a trusted cert that signed " + toVerify);
+    }
+
+    throw new SSLPeerUnverifiedException("Certificate chain too long: " + result);
+  }
+
+  /** Returns true if {@code toVerify} was signed by {@code signingCert}'s public key. */
+  private boolean verifySignature(X509Certificate toVerify, X509Certificate signingCert) {
+    if (!toVerify.getIssuerDN().equals(signingCert.getSubjectDN())) return false;
+    try {
+      toVerify.verify(signingCert.getPublicKey());
+      return true;
+    } catch (GeneralSecurityException verifyFailed) {
+      return false;
+    }
+  }
+}
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/CertificateChainCleaner.java b/okhttp/src/main/java/okhttp3/internal/tls/CertificateChainCleaner.java
index 672e486..9b7c2e2 100644
--- a/okhttp/src/main/java/okhttp3/internal/tls/CertificateChainCleaner.java
+++ b/okhttp/src/main/java/okhttp3/internal/tls/CertificateChainCleaner.java
@@ -16,19 +16,12 @@
  */
 package okhttp3.internal.tls;
 
-import java.lang.reflect.Constructor;
-import java.lang.reflect.InvocationTargetException;
-import java.lang.reflect.Method;
-import java.security.GeneralSecurityException;
 import java.security.cert.Certificate;
 import java.security.cert.X509Certificate;
-import java.util.ArrayDeque;
-import java.util.ArrayList;
-import java.util.Deque;
-import java.util.Iterator;
 import java.util.List;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import javax.net.ssl.X509TrustManager;
+import okhttp3.internal.Platform;
 
 /**
  * Computes the effective certificate chain from the raw array returned by Java's built in TLS APIs.
@@ -45,137 +38,10 @@
       throws SSLPeerUnverifiedException;
 
   public static CertificateChainCleaner get(X509TrustManager trustManager) {
-    try {
-      Class<?> extensionsClass = Class.forName("android.net.http.X509TrustManagerExtensions");
-      Constructor<?> constructor = extensionsClass.getConstructor(X509TrustManager.class);
-      Object extensions = constructor.newInstance(trustManager);
-      Method checkServerTrusted = extensionsClass.getMethod(
-          "checkServerTrusted", X509Certificate[].class, String.class, String.class);
-      return new AndroidCertificateChainCleaner(extensions, checkServerTrusted);
-    } catch (Exception e) {
-      return new BasicCertificateChainCleaner(TrustRootIndex.get(trustManager));
-    }
+    return Platform.get().buildCertificateChainCleaner(trustManager);
   }
 
   public static CertificateChainCleaner get(X509Certificate... caCerts) {
     return new BasicCertificateChainCleaner(TrustRootIndex.get(caCerts));
   }
-
-  /**
-   * A certificate chain cleaner that uses a set of trusted root certificates to build the trusted
-   * chain. This class duplicates the clean chain building performed during the TLS handshake. We
-   * prefer other mechanisms where they exist, such as with {@link AndroidCertificateChainCleaner}.
-   *
-   * <p>This class includes code from <a href="https://conscrypt.org/">Conscrypt's</a> {@code
-   * TrustManagerImpl} and {@code TrustedCertificateIndex}.
-   */
-  static final class BasicCertificateChainCleaner extends CertificateChainCleaner {
-    /** The maximum number of signers in a chain. We use 9 for consistency with OpenSSL. */
-    private static final int MAX_SIGNERS = 9;
-
-    private final TrustRootIndex trustRootIndex;
-
-    public BasicCertificateChainCleaner(TrustRootIndex trustRootIndex) {
-      this.trustRootIndex = trustRootIndex;
-    }
-
-    /**
-     * Returns a cleaned chain for {@code chain}.
-     *
-     * <p>This method throws if the complete chain to a trusted CA certificate cannot be
-     * constructed. This is unexpected unless the trust root index in this class has a different
-     * trust manager than what was used to establish {@code chain}.
-     */
-    @Override public List<Certificate> clean(List<Certificate> chain, String hostname)
-        throws SSLPeerUnverifiedException {
-      Deque<Certificate> queue = new ArrayDeque<>(chain);
-      List<Certificate> result = new ArrayList<>();
-      result.add(queue.removeFirst());
-      boolean foundTrustedCertificate = false;
-
-      followIssuerChain:
-      for (int c = 0; c < MAX_SIGNERS; c++) {
-        X509Certificate toVerify = (X509Certificate) result.get(result.size() - 1);
-
-        // If this cert has been signed by a trusted cert, use that. Add the trusted certificate to
-        // the end of the chain unless it's already present. (That would happen if the first
-        // certificate in the chain is itself a self-signed and trusted CA certificate.)
-        X509Certificate trustedCert = trustRootIndex.findByIssuerAndSignature(toVerify);
-        if (trustedCert != null) {
-          if (result.size() > 1 || !toVerify.equals(trustedCert)) {
-            result.add(trustedCert);
-          }
-          if (verifySignature(trustedCert, trustedCert)) {
-            return result; // The self-signed cert is a root CA. We're done.
-          }
-          foundTrustedCertificate = true;
-          continue;
-        }
-
-        // Search for the certificate in the chain that signed this certificate. This is typically
-        // the next element in the chain, but it could be any element.
-        for (Iterator<Certificate> i = queue.iterator(); i.hasNext(); ) {
-          X509Certificate signingCert = (X509Certificate) i.next();
-          if (verifySignature(toVerify, signingCert)) {
-            i.remove();
-            result.add(signingCert);
-            continue followIssuerChain;
-          }
-        }
-
-        // We've reached the end of the chain. If any cert in the chain is trusted, we're done.
-        if (foundTrustedCertificate) {
-          return result;
-        }
-
-        // The last link isn't trusted. Fail.
-        throw new SSLPeerUnverifiedException(
-            "Failed to find a trusted cert that signed " + toVerify);
-      }
-
-      throw new SSLPeerUnverifiedException("Certificate chain too long: " + result);
-    }
-
-    /** Returns true if {@code toVerify} was signed by {@code signingCert}'s public key. */
-    private boolean verifySignature(X509Certificate toVerify, X509Certificate signingCert) {
-      if (!toVerify.getIssuerDN().equals(signingCert.getSubjectDN())) return false;
-      try {
-        toVerify.verify(signingCert.getPublicKey());
-        return true;
-      } catch (GeneralSecurityException verifyFailed) {
-        return false;
-      }
-    }
-  }
-
-  /**
-   * X509TrustManagerExtensions was added to Android in API 17 (Android 4.2, released in late 2012).
-   * This is the best way to get a clean chain on Android because it uses the same code as the TLS
-   * handshake.
-   */
-  static final class AndroidCertificateChainCleaner extends CertificateChainCleaner {
-    private final Object x509TrustManagerExtensions;
-    private final Method checkServerTrusted;
-
-    AndroidCertificateChainCleaner(Object x509TrustManagerExtensions, Method checkServerTrusted) {
-      this.x509TrustManagerExtensions = x509TrustManagerExtensions;
-      this.checkServerTrusted = checkServerTrusted;
-    }
-
-    @SuppressWarnings({"unchecked", "SuspiciousToArrayCall"}) // Reflection on List<Certificate>.
-    @Override public List<Certificate> clean(List<Certificate> chain, String hostname)
-        throws SSLPeerUnverifiedException {
-      try {
-        X509Certificate[] certificates = chain.toArray(new X509Certificate[chain.size()]);
-        return (List<Certificate>) checkServerTrusted.invoke(
-            x509TrustManagerExtensions, certificates, "RSA", hostname);
-      } catch (InvocationTargetException e) {
-        SSLPeerUnverifiedException exception = new SSLPeerUnverifiedException(e.getMessage());
-        exception.initCause(e);
-        throw exception;
-      } catch (IllegalAccessException e) {
-        throw new AssertionError(e);
-      }
-    }
-  }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java b/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java
index fcc7468..8b5439b 100644
--- a/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java
+++ b/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java
@@ -29,7 +29,7 @@
 
 public abstract class TrustRootIndex {
   /** Returns the trusted CA certificate that signed {@code cert}. */
-  abstract X509Certificate findByIssuerAndSignature(X509Certificate cert);
+  public abstract X509Certificate findByIssuerAndSignature(X509Certificate cert);
 
   public static TrustRootIndex get(X509TrustManager trustManager) {
     try {
@@ -55,7 +55,7 @@
    *
    * <p>This class uses APIs added to Android in API 14 (Android 4.0, released October 2011). This
    * class shouldn't be used in Android API 17 or better because those releases are better served by
-   * {@link CertificateChainCleaner.AndroidCertificateChainCleaner}.
+   * {@link okhttp3.internal.AndroidPlatform.AndroidCertificateChainCleaner}.
    */
   static final class AndroidTrustRootIndex extends TrustRootIndex {
     private final X509TrustManager trustManager;
/Fim/
diff --git a/okhttp-android-support/src/main/java/okhttp3/internal/huc/JavaApiConverter.java b/okhttp-android-support/src/main/java/okhttp3/internal/huc/JavaApiConverter.java
index be50211..752786d 100644
--- a/okhttp-android-support/src/main/java/okhttp3/internal/huc/JavaApiConverter.java
+++ b/okhttp-android-support/src/main/java/okhttp3/internal/huc/JavaApiConverter.java
@@ -859,18 +859,6 @@
     @Override public SSLSocketFactory getSSLSocketFactory() {
       throw throwRequestSslAccessException();
     }
-
-    @Override public long getContentLengthLong() {
-      return delegate.getContentLengthLong();
-    }
-
-    @Override public void setFixedLengthStreamingMode(long contentLength) {
-      delegate.setFixedLengthStreamingMode(contentLength);
-    }
-
-    @Override public long getHeaderFieldLong(String field, long defaultValue) {
-      return delegate.getHeaderFieldLong(field, defaultValue);
-    }
   }
 
   private static RuntimeException throwRequestModificationException() {
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 3aaa66d..05f62a3 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -14,6 +14,12 @@
 
   <dependencies>
     <dependency>
+      <groupId>org.codehaus.mojo</groupId>
+      <artifactId>animal-sniffer-annotations</artifactId>
+      <version>${animal.sniffer.version}</version>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
       <groupId>${project.groupId}</groupId>
       <artifactId>okhttp</artifactId>
       <version>${project.version}</version>
/Fim/
diff --git a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/DelegatingHttpsURLConnection.java b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/DelegatingHttpsURLConnection.java
index 86f4aa7..9dd7cfd 100644
--- a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/DelegatingHttpsURLConnection.java
+++ b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/DelegatingHttpsURLConnection.java
@@ -32,6 +32,7 @@
 import javax.net.ssl.SSLPeerUnverifiedException;
 import javax.net.ssl.SSLSocketFactory;
 import okhttp3.Handshake;
+import org.codehaus.mojo.animal_sniffer.IgnoreJRERequirement;
 
 /**
  * Implement an HTTPS connection by delegating to an HTTP connection for everything but the
@@ -146,6 +147,11 @@
     return delegate.getContentLength();
   }
 
+  @IgnoreJRERequirement // Should only be invoked on Java 7+.
+  @Override public long getContentLengthLong() {
+    return delegate.getContentLengthLong();
+  }
+
   @Override public String getContentType() {
     return delegate.getContentType();
   }
@@ -190,6 +196,11 @@
     return delegate.getHeaderField(key);
   }
 
+  @IgnoreJRERequirement // Should only be invoked on Java 7+.
+  @Override public long getHeaderFieldLong(String field, long defaultValue) {
+    return delegate.getHeaderFieldLong(field, defaultValue);
+  }
+
   @Override public long getHeaderFieldDate(String field, long defaultValue) {
     return delegate.getHeaderFieldDate(field, defaultValue);
   }
@@ -250,6 +261,11 @@
     delegate.setDoOutput(newValue);
   }
 
+  @IgnoreJRERequirement // Should only be invoked on Java 7+.
+  @Override public void setFixedLengthStreamingMode(long contentLength) {
+    delegate.setFixedLengthStreamingMode(contentLength);
+  }
+
   @Override public void setIfModifiedSince(long newValue) {
     delegate.setIfModifiedSince(newValue);
   }
/Fim/
diff --git a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java
index feefe57..0057174 100644
--- a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java
+++ b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java
@@ -68,15 +68,4 @@
     return delegate.client.sslSocketFactory();
   }
 
-  @Override public long getContentLengthLong() {
-    return delegate.getContentLengthLong();
-  }
-
-  @Override public void setFixedLengthStreamingMode(long contentLength) {
-    delegate.setFixedLengthStreamingMode(contentLength);
-  }
-
-  @Override public long getHeaderFieldLong(String field, long defaultValue) {
-    return delegate.getHeaderFieldLong(field, defaultValue);
-  }
 }
/Fim/
diff --git a/pom.xml b/pom.xml
index baf03e8..e7d44fb 100644
--- a/pom.xml
+++ b/pom.xml
@@ -47,6 +47,7 @@
     <!-- ALPN library targeted to Java 7 -->
     <alpn.jdk7.version>7.1.2.v20141202</alpn.jdk7.version>
     <android.version>4.1.1.4</android.version>
+    <animal.sniffer.version>1.11</animal.sniffer.version>
     <apache.http.version>4.2.2</apache.http.version>
     <bouncycastle.version>1.50</bouncycastle.version>
     <guava.version>16.0</guava.version>
@@ -214,7 +215,7 @@
       <plugin>
         <groupId>org.codehaus.mojo</groupId>
         <artifactId>animal-sniffer-maven-plugin</artifactId>
-        <version>1.11</version>
+        <version>${animal.sniffer.version}</version>
         <executions>
           <execution>
             <phase>test</phase>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 44e754f..73bfc35 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,58 @@
 Change Log
 ==========
 
+## Version 3.4.0-RC1
+
+_2016-07-02_
+
+ *  **Weve rewritten HttpURLConnection and HttpsURLConnection.** Previously we
+    shared a single HTTP engine between two frontend APIs: `HttpURLConnection`
+    and `Call`. With this release weve rearranged things so that the
+    `HttpURLConnection` frontend now delegates to the `Call` APIs internally.
+    This has enabled substantial simplifications and optimizations in the OkHttp
+    core for both frontends.
+
+    For most HTTP requests the consequences of this change will be negligible.
+    If your application uses `HttpURLConnection.connect()`,
+    `setFixedLengthStreamingMode()`, or `setChunkedStreamingMode()`, OkHttp will
+    now use a async dispatcher thread to establish the HTTP connection.
+
+    We dont expect this change to have any behavior or performance
+    consequences. Regardless, please exercise your `OkUrlFactory` and
+    `HttpURLConnection` code when applying this update.
+
+ *  **Cipher suites may now have arbitrary names.** Previously `CipherSuite` was
+    a Java enum and it was impossible to define new cipher suites without first
+    upgrading OkHttp. With this change it is now a regular Java class with
+    enum-like constants. Application code that uses enum methods on cipher
+    suites (`ordinal()`, `name()`, etc.) will break with this change.
+
+ *  Fix: `CertificatePinner` now matches canonicalized hostnames. Previously
+    this was case sensitive. This change should also make it easier to configure
+    certificate pinning for internationalized domain names.
+ *  Fix: Dont crash on non-ASCII `ETag` headers. Previously OkHttp would reject
+    these headers when validating a cached response.
+ *  Fix: Dont allow remote peer to arbitrarily size the HPACK decoder dynamic
+    table.
+ *  Fix: Honor per-host configuration in Androids network security config.
+    Previously disabling cleartext for any host would disable cleartext for all
+    hosts. Note that this setting is only available on Android 24+.
+ *  New: HPACK compression is now dynamic. This should improve performance when
+    transmitting request headers over HTTP/2.
+ *  New: `Dispatcher.setIdleCallback()` can be used to signal when there are no
+    calls in flight. This is useful for [testing with
+    Espresso][okhttp_idling_resource].
+ *  New: Upgrade to Okio 1.9.0.
+
+     ```xml
+     <dependency>
+       <groupId>com.squareup.okio</groupId>
+       <artifactId>okio</artifactId>
+       <version>1.9.0</version>
+     </dependency>
+     ```
+
+
 ## Version 3.3.1
 
 _2016-05-28_
@@ -1064,3 +1116,4 @@
  [webdav]: https://tools.ietf.org/html/rfc4918
  [major_versions]: http://jakewharton.com/java-interoperability-policy-for-major-version-updates/
  [nginx_959]: https://trac.nginx.org/nginx/ticket/959
+ [okhttp_idling_resource]: https://github.com/JakeWharton/okhttp-idling-resource
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index f97dc33..9a280cb 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 555e19d..93e03f7 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index a12f1f4..4e712ad 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 6d26b36..a33733d 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 8ae2bc8..f65a79a 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 6a451bf..6ab2c78 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 943f53a..ba4f799 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 5585632..6c5a1f6 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 05f62a3..f9c19d7 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index cef5759..aab51a9 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 7cbfab9..ef27a4f 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a26e988..57e6173 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 8cbf639..402c198 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.4.0-SNAPSHOT</version>
+  <version>3.4.0-RC1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -66,7 +66,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.4.0-RC1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index a40fe5b..54d5c39 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 5690993..1bbf898 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index de77532..d509320 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 5bb5efe..559e541 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index dc446c5..33b62b7 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0-RC1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 9a280cb..f97dc33 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 93e03f7..555e19d 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 4e712ad..a12f1f4 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index a33733d..6d26b36 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index f65a79a..8ae2bc8 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 6ab2c78..6a451bf 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index ba4f799..943f53a 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 6c5a1f6..5585632 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index f9c19d7..05f62a3 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index aab51a9..cef5759 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index ef27a4f..7cbfab9 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 57e6173..a26e988 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 402c198..8cbf639 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.4.0-RC1</version>
+  <version>3.4.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -66,7 +66,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.4.0-RC1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 54d5c39..a40fe5b 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 1bbf898..5690993 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d509320..de77532 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 559e541..5bb5efe 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 33b62b7..dc446c5 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-RC1</version>
+    <version>3.4.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index f97dc33..6d35207 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 555e19d..d930772 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index a12f1f4..5bc3d20 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 6d26b36..ea5c7fe 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 8ae2bc8..a7686f3 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 6a451bf..60135ba 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 943f53a..4601530 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 5585632..44a7d65 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 05f62a3..e2885ea 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index cef5759..b64519a 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 7cbfab9..91bf914 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a26e988..a3dd794 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 8cbf639..18b0bb1 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.4.0-SNAPSHOT</version>
+  <version>3.4.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -66,7 +66,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.4.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index a40fe5b..a933b3e 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 5690993..0e86a48 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index de77532..2bd865e 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 5bb5efe..b19ae38 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index dc446c5..cd161b8 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0-SNAPSHOT</version>
+    <version>3.4.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 6d35207..0065b25 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index d930772..754d604 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 5bc3d20..edc8684 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index ea5c7fe..1485393 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index a7686f3..ed13f59 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 60135ba..5f9d786 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 4601530..18f83cc 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 44a7d65..7202df8 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index e2885ea..bde0490 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp-ws-tests/pom.xml b/okhttp-ws-tests/pom.xml
index b64519a..d8a43e0 100644
--- a/okhttp-ws-tests/pom.xml
+++ b/okhttp-ws-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws-tests</artifactId>
/Fim/
diff --git a/okhttp-ws/pom.xml b/okhttp-ws/pom.xml
index 91bf914..649b117 100644
--- a/okhttp-ws/pom.xml
+++ b/okhttp-ws/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-ws</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a3dd794..2e07de0 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 18b0bb1..efcb446 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.4.0</version>
+  <version>3.5.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -66,7 +66,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.4.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index a933b3e..8b91ca2 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 0e86a48..ba8e54e 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 2bd865e..c1c21d6 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index b19ae38..c3330e4 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index cd161b8..ca52ac4 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.4.0</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 73bfc35..c5a6fc0 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,16 @@
 Change Log
 ==========
 
+## Version 3.4.0
+
+_2016-07-08_
+
+ *  New: Support dynamic table size changes to HPACK Encoder.
+ *  Fix: Use `TreeMap` in `Headers.toMultimap()`. This makes string lookups on
+    the returned map case-insensitive.
+ *  Fix: Don't share the OkHttpClient's `Dispatcher` in `HttpURLConnection`.
+
+
 ## Version 3.4.0-RC1
 
 _2016-07-02_
/Fim/
diff --git a/README.md b/README.md
index 2e40ffd..188ca83 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.3.1</version>
+  <version>3.4.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.3.1'
+compile 'com.squareup.okhttp3:okhttp:3.4.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.3.1</version>
+  <version>3.4.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.3.1'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.4.0'
 ```
 
 
/Fim/
diff --git a/okhttp-hpacktests/pom.xml b/okhttp-hpacktests/pom.xml
index 7e8fb57..12bc4e4 100644
--- a/okhttp-hpacktests/pom.xml
+++ b/okhttp-hpacktests/pom.xml
@@ -8,7 +8,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.3.0-SNAPSHOT</version>
+    <version>3.5.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-hpacktests</artifactId>
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/ConnectionSpec.java b/okhttp/src/main/java/okhttp3/ConnectionSpec.java
index 6049e32..3b9d447 100644
--- a/okhttp/src/main/java/okhttp3/ConnectionSpec.java
+++ b/okhttp/src/main/java/okhttp3/ConnectionSpec.java
@@ -20,8 +20,8 @@
 import javax.net.ssl.SSLSocket;
 
 import static okhttp3.internal.Util.concat;
-import static okhttp3.internal.Util.contains;
 import static okhttp3.internal.Util.immutableList;
+import static okhttp3.internal.Util.indexOf;
 import static okhttp3.internal.Util.intersect;
 
 /**
@@ -153,7 +153,7 @@
 
     // In accordance with https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00
     // the SCSV cipher is added to signal that a protocol fallback has taken place.
-    if (isFallback && contains(sslSocket.getSupportedCipherSuites(), "TLS_FALLBACK_SCSV")) {
+    if (isFallback && indexOf(sslSocket.getSupportedCipherSuites(), "TLS_FALLBACK_SCSV") != -1) {
       cipherSuitesIntersection = concat(cipherSuitesIntersection, "TLS_FALLBACK_SCSV");
     }
 
@@ -202,7 +202,7 @@
       return false;
     }
     for (String toFind : a) {
-      if (contains(b, toFind)) {
+      if (indexOf(b, toFind) != -1) {
         return true;
       }
     }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/Util.java b/okhttp/src/main/java/okhttp3/internal/Util.java
index a80f482..3bd2d16 100644
--- a/okhttp/src/main/java/okhttp3/internal/Util.java
+++ b/okhttp/src/main/java/okhttp3/internal/Util.java
@@ -314,8 +314,11 @@
         && e.getMessage().contains("getsockname failed");
   }
 
-  public static boolean contains(String[] array, String value) {
-    return Arrays.asList(array).contains(value);
+  public static <T> int indexOf(T[] array, T value) {
+    for (int i = 0, size = array.length; i < size; i++) {
+      if (equal(array[i], value)) return i;
+    }
+    return -1;
   }
 
   public static String[] concat(String[] array, String value) {
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http2/Hpack.java b/okhttp/src/main/java/okhttp3/internal/http2/Hpack.java
index 1c52d70..3ee89bb 100644
--- a/okhttp/src/main/java/okhttp3/internal/http2/Hpack.java
+++ b/okhttp/src/main/java/okhttp3/internal/http2/Hpack.java
@@ -22,6 +22,7 @@
 import java.util.LinkedHashMap;
 import java.util.List;
 import java.util.Map;
+import okhttp3.internal.Util;
 import okio.Buffer;
 import okio.BufferedSource;
 import okio.ByteString;
@@ -359,7 +360,6 @@
   }
 
   static final class Writer {
-    private static final byte SEPARATED_TOKEN = ':';
     private static final int SETTINGS_HEADER_TABLE_SIZE = 4096;
 
     /**
@@ -370,7 +370,6 @@
     private static final int SETTINGS_HEADER_TABLE_SIZE_LIMIT = 16384;
 
     private final Buffer out;
-    private final Map<ByteString, Integer> headerStringToDynamicIndex = new LinkedHashMap<>();
 
     /**
      * In the scenario where the dynamic table size changes multiple times between transmission of
@@ -399,18 +398,8 @@
       this.out = out;
     }
 
-    ByteString getHeaderString(Header entry) {
-      byte[] ret = new byte[entry.name.size() + 1 + entry.value.size()];
-      System.arraycopy(entry.name.toByteArray(), 0, ret, 0, entry.name.size());
-      ret[entry.name.size()] = SEPARATED_TOKEN;
-      System.arraycopy(entry.value.toByteArray(), 0, ret, entry.name.size() + 1,
-          entry.value.size());
-      return ByteString.of(ret);
-    }
-
     private void clearDynamicTable() {
       Arrays.fill(dynamicTable, null);
-      headerStringToDynamicIndex.clear();
       nextHeaderIndex = dynamicTable.length - 1;
       headerCount = 0;
       dynamicTableByteCount = 0;
@@ -429,9 +418,7 @@
         }
         System.arraycopy(dynamicTable, nextHeaderIndex + 1, dynamicTable,
             nextHeaderIndex + 1 + entriesToEvict, headerCount);
-        for (Map.Entry<ByteString, Integer> p : headerStringToDynamicIndex.entrySet()) {
-          p.setValue(p.getValue() + entriesToEvict);
-        }
+        Arrays.fill(dynamicTable, nextHeaderIndex + 1, nextHeaderIndex + 1 + entriesToEvict, null);
         nextHeaderIndex += entriesToEvict;
       }
       return entriesToEvict;
@@ -453,15 +440,11 @@
       if (headerCount + 1 > dynamicTable.length) { // Need to grow the dynamic table.
         Header[] doubled = new Header[dynamicTable.length * 2];
         System.arraycopy(dynamicTable, 0, doubled, dynamicTable.length, dynamicTable.length);
-        for (Map.Entry<ByteString, Integer> p : headerStringToDynamicIndex.entrySet()) {
-          p.setValue(p.getValue() + dynamicTable.length);
-        }
         nextHeaderIndex = dynamicTable.length - 1;
         dynamicTable = doubled;
       }
       int index = nextHeaderIndex--;
       dynamicTable[index] = entry;
-      headerStringToDynamicIndex.put(getHeaderString(entry), index);
       headerCount++;
       dynamicTableByteCount += delta;
     }
@@ -489,11 +472,10 @@
           writeInt(staticIndex + 1, PREFIX_4_BITS, 0);
           writeByteString(value);
         } else {
-          ByteString headerString = getHeaderString(header);
-          Integer dynamicIndex = headerStringToDynamicIndex.get(headerString);
-          if (dynamicIndex != null) {
+          int dynamicIndex = Util.indexOf(dynamicTable, header);
+          if (dynamicIndex != -1) {
             // Indexed Header.
-            writeInt(dynamicTable.length - dynamicIndex + STATIC_HEADER_TABLE.length, PREFIX_7_BITS,
+            writeInt(dynamicIndex - nextHeaderIndex + STATIC_HEADER_TABLE.length, PREFIX_7_BITS,
                 0x80);
           } else {
             // Literal Header Field with Incremental Indexing - New Name
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index c5a6fc0..520be94 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,16 @@
 Change Log
 ==========
 
+## Version 3.4.1
+
+_2016-07-10_
+
+ *  **Fix an major bug in encoding HTTP headers.** In 3.4.0 and 3.4.0-RC1 OkHttp
+    had an off-by-one bug in our HPACK encoder. This bug could have caused the
+    wrong headers to be emitted after a sequence of HTTP/2 requests! Everyone
+    who is using OkHttp 3.4.0 or 3.4.0-RC1 should upgrade for this bug fix.
+
+
 ## Version 3.4.0
 
 _2016-07-08_
/Fim/
diff --git a/README.md b/README.md
index 9191328..ffb46f8 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.4.0</version>
+  <version>3.4.1</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.4.0'
+compile 'com.squareup.okhttp3:okhttp:3.4.1'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.4.0</version>
+  <version>3.4.1</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.4.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.4.1'
 ```
 
 
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/ResponseBody.java b/okhttp/src/main/java/okhttp3/ResponseBody.java
index acc383b..c0d3309 100644
--- a/okhttp/src/main/java/okhttp3/ResponseBody.java
+++ b/okhttp/src/main/java/okhttp3/ResponseBody.java
@@ -116,6 +116,13 @@
 
   public abstract BufferedSource source();
 
+  /**
+   * Returns the response as a byte array.
+   *
+   * <p>This method loads entire response body into memory. If the response body is very large this
+   * may trigger an {@link OutOfMemoryError}. Prefer to stream the response body if this is a
+   * possibility for your response.
+   */
   public final byte[] bytes() throws IOException {
     long contentLength = contentLength();
     if (contentLength > Integer.MAX_VALUE) {
@@ -148,7 +155,11 @@
   /**
    * Returns the response as a string decoded with the charset of the Content-Type header. If that
    * header is either absent or lacks a charset, this will attempt to decode the response body as
-   * UTF-8.
+   * UTF-8. Closes {@link ResponseBody} automatically.
+   *
+   * <p>This method loads entire response body into memory. If the response body is very large this
+   * may trigger an {@link OutOfMemoryError}. Prefer to stream the response body if this is a
+   * possibility for your response.
    */
   public final String string() throws IOException {
     return new String(bytes(), charset().name());
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/OkHttpClient.java b/okhttp/src/main/java/okhttp3/OkHttpClient.java
index 6b9ad46..7e26bcd 100644
--- a/okhttp/src/main/java/okhttp3/OkHttpClient.java
+++ b/okhttp/src/main/java/okhttp3/OkHttpClient.java
@@ -712,7 +712,7 @@
       return this;
     }
 
-    /** Configure this client to follow redirects. If unset, redirects be followed. */
+    /** Configure this client to follow redirects. If unset, redirects will be followed. */
     public Builder followRedirects(boolean followRedirects) {
       this.followRedirects = followRedirects;
       return this;
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CallTest.java b/okhttp-tests/src/test/java/okhttp3/CallTest.java
index 3769707..bbc2a59 100644
--- a/okhttp-tests/src/test/java/okhttp3/CallTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CallTest.java
@@ -34,7 +34,9 @@
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collections;
+import java.util.LinkedHashSet;
 import java.util.List;
+import java.util.Set;
 import java.util.concurrent.BlockingQueue;
 import java.util.concurrent.Callable;
 import java.util.concurrent.CountDownLatch;
@@ -605,8 +607,15 @@
     Call cloned = call.clone();
     cloned.enqueue(callback);
 
-    callback.await(request.url()).assertBody("abc");
-    callback.await(request.url()).assertBody("def");
+    RecordedResponse firstResponse = callback.await(request.url()).assertSuccessful();
+    RecordedResponse secondResponse = callback.await(request.url()).assertSuccessful();
+
+    Set<String> bodies = new LinkedHashSet<>();
+    bodies.add(firstResponse.getBody());
+    bodies.add(secondResponse.getBody());
+
+    assertTrue(bodies.contains("abc"));
+    assertTrue(bodies.contains("def"));
   }
 
   @Test public void get_Async() throws Exception {
@@ -2286,8 +2295,8 @@
   }
 
   /**
-   * OkHttp has a bug where a `Connection: close` response header is not honored when establishing
-   * a TLS tunnel. https://github.com/square/okhttp/issues/2426
+   * OkHttp has a bug where a `Connection: close` response header is not honored when establishing a
+   * TLS tunnel. https://github.com/square/okhttp/issues/2426
    */
   @Test public void proxyAuthenticateOnConnectWithConnectionClose() throws Exception {
     server.useHttps(sslClient.socketFactory, true);
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/RecordedResponse.java b/okhttp-tests/src/test/java/okhttp3/RecordedResponse.java
index ae7afa9..feaab57 100644
--- a/okhttp-tests/src/test/java/okhttp3/RecordedResponse.java
+++ b/okhttp-tests/src/test/java/okhttp3/RecordedResponse.java
@@ -173,4 +173,8 @@
   private String format(long time) {
     return new SimpleDateFormat("HH:mm:ss.SSS").format(new Date(time));
   }
+
+  public String getBody() {
+    return body;
+  }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/connection/RealConnection.java b/okhttp/src/main/java/okhttp3/internal/connection/RealConnection.java
index 3652cba..42d9103 100644
--- a/okhttp/src/main/java/okhttp3/internal/connection/RealConnection.java
+++ b/okhttp/src/main/java/okhttp3/internal/connection/RealConnection.java
@@ -186,7 +186,9 @@
     try {
       Platform.get().connectSocket(rawSocket, route.socketAddress(), connectTimeout);
     } catch (ConnectException e) {
-      throw new ConnectException("Failed to connect to " + route.socketAddress());
+      ConnectException ce = new ConnectException("Failed to connect to " + route.socketAddress());
+      ce.initCause(e);
+      throw ce;
     }
     source = Okio.buffer(Okio.source(rawSocket));
     sink = Okio.buffer(Okio.sink(rawSocket));
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java b/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java
index d3e0cb8..64d7411 100644
--- a/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CertificateChainCleanerTest.java
@@ -21,6 +21,9 @@
 import java.util.ArrayList;
 import java.util.List;
 import javax.net.ssl.SSLPeerUnverifiedException;
+import javax.net.ssl.SSLSocketFactory;
+import javax.net.ssl.X509TrustManager;
+import okhttp3.internal.platform.Platform;
 import okhttp3.internal.tls.CertificateChainCleaner;
 import okhttp3.internal.tls.HeldCertificate;
 import org.junit.Test;
@@ -29,6 +32,27 @@
 import static org.junit.Assert.fail;
 
 public final class CertificateChainCleanerTest {
+  @Test public void equalsFromCertificate() throws Exception {
+    HeldCertificate rootA = new HeldCertificate.Builder()
+        .serialNumber("1")
+        .build();
+    HeldCertificate rootB = new HeldCertificate.Builder()
+        .serialNumber("2")
+        .build();
+    assertEquals(
+        CertificateChainCleaner.get(rootA.certificate, rootB.certificate),
+        CertificateChainCleaner.get(rootB.certificate, rootA.certificate));
+  }
+
+  @Test public void equalsFromTrustManager() throws Exception {
+    Platform platform = Platform.get();
+    X509TrustManager x509TrustManager = platform.trustManager(
+        (SSLSocketFactory) SSLSocketFactory.getDefault());
+    assertEquals(
+        CertificateChainCleaner.get(x509TrustManager),
+        CertificateChainCleaner.get(x509TrustManager));
+  }
+
   @Test public void normalizeSingleSelfSignedCertificate() throws Exception {
     HeldCertificate root = new HeldCertificate.Builder()
         .serialNumber("1")
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/OkHttpClientTest.java b/okhttp-tests/src/test/java/okhttp3/OkHttpClientTest.java
index e369a4d..3cf5d90 100644
--- a/okhttp-tests/src/test/java/okhttp3/OkHttpClientTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/OkHttpClientTest.java
@@ -120,4 +120,10 @@
     } catch (IllegalArgumentException expected) {
     }
   }
+
+  @Test public void certificatePinnerEquality() {
+    OkHttpClient clientA = TestUtil.defaultClient();
+    OkHttpClient clientB = TestUtil.defaultClient();
+    assertEquals(clientA.certificatePinner(), clientB.certificatePinner());
+  }
 }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
index 6a205c8..a883500 100644
--- a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
@@ -20,6 +20,7 @@
 import java.io.OutputStream;
 import java.net.Authenticator;
 import java.net.ConnectException;
+import java.net.CookieManager;
 import java.net.HttpRetryException;
 import java.net.HttpURLConnection;
 import java.net.InetAddress;
@@ -593,7 +594,15 @@
     assertNotNull(httpsConnection.getCipherSuite());
   }
 
-  @Test public void connectViaHttpsReusingConnections() throws IOException, InterruptedException {
+  @Test public void connectViaHttpsReusingConnections() throws Exception {
+    connectViaHttpsReusingConnections(false);
+  }
+
+  @Test public void connectViaHttpsReusingConnectionsAfterRebuildingClient() throws Exception {
+    connectViaHttpsReusingConnections(true);
+  }
+
+  private void connectViaHttpsReusingConnections(boolean rebuildClient) throws Exception {
     server.useHttps(sslClient.socketFactory, false);
     server.enqueue(new MockResponse().setBody("this response comes via HTTPS"));
     server.enqueue(new MockResponse().setBody("another response via HTTPS"));
@@ -602,13 +611,29 @@
     SSLSocketFactory clientSocketFactory = sslClient.socketFactory;
     RecordingHostnameVerifier hostnameVerifier = new RecordingHostnameVerifier();
 
-    urlFactory.setClient(urlFactory.client().newBuilder()
+    CookieJar cookieJar = new JavaNetCookieJar(new CookieManager());
+    ConnectionPool connectionPool = new ConnectionPool();
+
+    urlFactory.setClient(new OkHttpClient.Builder()
+        .cache(cache)
+        .connectionPool(connectionPool)
+        .cookieJar(cookieJar)
         .sslSocketFactory(clientSocketFactory, sslClient.trustManager)
         .hostnameVerifier(hostnameVerifier)
         .build());
     connection = urlFactory.open(server.url("/").url());
     assertContent("this response comes via HTTPS", connection);
 
+    if (rebuildClient) {
+      urlFactory.setClient(new OkHttpClient.Builder()
+          .cache(cache)
+          .connectionPool(connectionPool)
+          .cookieJar(cookieJar)
+          .sslSocketFactory(clientSocketFactory, sslClient.trustManager)
+          .hostnameVerifier(hostnameVerifier)
+          .build());
+    }
+
     connection = urlFactory.open(server.url("/").url());
     assertContent("another response via HTTPS", connection);
 
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/CertificatePinner.java b/okhttp/src/main/java/okhttp3/CertificatePinner.java
index 2695a55..8687e02 100644
--- a/okhttp/src/main/java/okhttp3/CertificatePinner.java
+++ b/okhttp/src/main/java/okhttp3/CertificatePinner.java
@@ -20,12 +20,16 @@
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collections;
+import java.util.LinkedHashSet;
 import java.util.List;
+import java.util.Set;
 import javax.net.ssl.SSLPeerUnverifiedException;
 import okhttp3.internal.Util;
 import okhttp3.internal.tls.CertificateChainCleaner;
 import okio.ByteString;
 
+import static okhttp3.internal.Util.equal;
+
 /**
  * Constrains which certificates are trusted. Pinning certificates defends against attacks on
  * certificate authorities. It also prevents connections through man-in-the-middle certificate
@@ -124,14 +128,27 @@
 public final class CertificatePinner {
   public static final CertificatePinner DEFAULT = new Builder().build();
 
-  private final List<Pin> pins;
+  private final Set<Pin> pins;
   private final CertificateChainCleaner certificateChainCleaner;
 
-  private CertificatePinner(List<Pin> pins, CertificateChainCleaner certificateChainCleaner) {
+  private CertificatePinner(Set<Pin> pins, CertificateChainCleaner certificateChainCleaner) {
     this.pins = pins;
     this.certificateChainCleaner = certificateChainCleaner;
   }
 
+  @Override public boolean equals(Object other) {
+    if (other == this) return true;
+    return other instanceof CertificatePinner
+        && (equal(certificateChainCleaner, ((CertificatePinner) other).certificateChainCleaner)
+        && pins.equals(((CertificatePinner) other).pins));
+  }
+
+  @Override public int hashCode() {
+    int result = certificateChainCleaner != null ? certificateChainCleaner.hashCode() : 0;
+    result = 31 * result + pins.hashCode();
+    return result;
+  }
+
   /**
    * Confirms that at least one of the certificates pinned for {@code hostname} is in {@code
    * peerCertificates}. Does nothing if there are no certificates pinned for {@code hostname}.
@@ -210,9 +227,9 @@
 
   /** Returns a certificate pinner that uses {@code certificateChainCleaner}. */
   CertificatePinner withCertificateChainCleaner(CertificateChainCleaner certificateChainCleaner) {
-    return this.certificateChainCleaner != certificateChainCleaner
-        ? new CertificatePinner(pins, certificateChainCleaner)
-        : this;
+    return equal(this.certificateChainCleaner, certificateChainCleaner)
+        ? this
+        : new CertificatePinner(pins, certificateChainCleaner);
   }
 
   /**
@@ -319,7 +336,7 @@
     }
 
     public CertificatePinner build() {
-      return new CertificatePinner(Util.immutableList(pins), null);
+      return new CertificatePinner(new LinkedHashSet<>(pins), null);
     }
   }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/platform/AndroidPlatform.java b/okhttp/src/main/java/okhttp3/internal/platform/AndroidPlatform.java
index fc646ea..c2cce4b 100644
--- a/okhttp/src/main/java/okhttp3/internal/platform/AndroidPlatform.java
+++ b/okhttp/src/main/java/okhttp3/internal/platform/AndroidPlatform.java
@@ -239,6 +239,14 @@
         throw new AssertionError(e);
       }
     }
+
+    @Override public boolean equals(Object other) {
+      return other instanceof AndroidCertificateChainCleaner; // All instances are equivalent.
+    }
+
+    @Override public int hashCode() {
+      return 0;
+    }
   }
 
   /**
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/BasicCertificateChainCleaner.java b/okhttp/src/main/java/okhttp3/internal/tls/BasicCertificateChainCleaner.java
index cd9ac03..8a8c1d1 100644
--- a/okhttp/src/main/java/okhttp3/internal/tls/BasicCertificateChainCleaner.java
+++ b/okhttp/src/main/java/okhttp3/internal/tls/BasicCertificateChainCleaner.java
@@ -111,4 +111,14 @@
       return false;
     }
   }
+
+  @Override public int hashCode() {
+    return trustRootIndex.hashCode();
+  }
+
+  @Override public boolean equals(Object other) {
+    if (other == this) return true;
+    return other instanceof BasicCertificateChainCleaner
+        && ((BasicCertificateChainCleaner) other).trustRootIndex.equals(trustRootIndex);
+  }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java b/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java
index 8b5439b..e42ad1b 100644
--- a/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java
+++ b/okhttp/src/main/java/okhttp3/internal/tls/TrustRootIndex.java
@@ -20,10 +20,10 @@
 import java.security.PublicKey;
 import java.security.cert.TrustAnchor;
 import java.security.cert.X509Certificate;
-import java.util.ArrayList;
 import java.util.LinkedHashMap;
-import java.util.List;
+import java.util.LinkedHashSet;
 import java.util.Map;
+import java.util.Set;
 import javax.net.ssl.X509TrustManager;
 import javax.security.auth.x500.X500Principal;
 
@@ -79,19 +79,37 @@
         return null;
       }
     }
+
+    @Override
+    public boolean equals(Object obj) {
+      if (obj == this) {
+        return true;
+      }
+      if (!(obj instanceof AndroidTrustRootIndex)) {
+        return false;
+      }
+      AndroidTrustRootIndex that = (AndroidTrustRootIndex) obj;
+      return trustManager.equals(that.trustManager)
+              && findByIssuerAndSignatureMethod.equals(that.findByIssuerAndSignatureMethod);
+    }
+
+    @Override
+    public int hashCode() {
+      return trustManager.hashCode() + 31 * findByIssuerAndSignatureMethod.hashCode();
+    }
   }
 
   /** A simple index that of trusted root certificates that have been loaded into memory. */
   static final class BasicTrustRootIndex extends TrustRootIndex {
-    private final Map<X500Principal, List<X509Certificate>> subjectToCaCerts;
+    private final Map<X500Principal, Set<X509Certificate>> subjectToCaCerts;
 
     public BasicTrustRootIndex(X509Certificate... caCerts) {
       subjectToCaCerts = new LinkedHashMap<>();
       for (X509Certificate caCert : caCerts) {
         X500Principal subject = caCert.getSubjectX500Principal();
-        List<X509Certificate> subjectCaCerts = subjectToCaCerts.get(subject);
+        Set<X509Certificate> subjectCaCerts = subjectToCaCerts.get(subject);
         if (subjectCaCerts == null) {
-          subjectCaCerts = new ArrayList<>(1);
+          subjectCaCerts = new LinkedHashSet<>(1);
           subjectToCaCerts.put(subject, subjectCaCerts);
         }
         subjectCaCerts.add(caCert);
@@ -100,7 +118,7 @@
 
     @Override public X509Certificate findByIssuerAndSignature(X509Certificate cert) {
       X500Principal issuer = cert.getIssuerX500Principal();
-      List<X509Certificate> subjectCaCerts = subjectToCaCerts.get(issuer);
+      Set<X509Certificate> subjectCaCerts = subjectToCaCerts.get(issuer);
       if (subjectCaCerts == null) return null;
 
       for (X509Certificate caCert : subjectCaCerts) {
@@ -114,5 +132,15 @@
 
       return null;
     }
+
+    @Override public boolean equals(Object other) {
+      if (other == this) return true;
+      return other instanceof BasicTrustRootIndex
+          && ((BasicTrustRootIndex) other).subjectToCaCerts.equals(subjectToCaCerts);
+    }
+
+    @Override public int hashCode() {
+      return subjectToCaCerts.hashCode();
+    }
   }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Response.java b/okhttp/src/main/java/okhttp3/Response.java
index b11eae6..5b42375 100644
--- a/okhttp/src/main/java/okhttp3/Response.java
+++ b/okhttp/src/main/java/okhttp3/Response.java
@@ -165,7 +165,12 @@
   }
 
   /**
-   * Never {@code null}, must be closed after consumption, can be consumed only once.
+   * Returns a non-null value if this response was passed to {@link Callback#onResponse} or returned
+   * from {@link Call#execute()}. Response bodies must be {@linkplain ResponseBody closed} and may
+   * be consumed only once.
+   *
+   * <p>This always returns null on responses returned from {@link #cacheResponse}, {@link
+   * #networkResponse}, and {@link #priorResponse()}.
    */
   public ResponseBody body() {
     return body;
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/HeadersTest.java b/okhttp-tests/src/test/java/okhttp3/HeadersTest.java
index d906aff..d37479c 100644
--- a/okhttp-tests/src/test/java/okhttp3/HeadersTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/HeadersTest.java
@@ -22,6 +22,7 @@
 import java.util.List;
 import java.util.Map;
 import okhttp3.internal.Internal;
+import okhttp3.internal.http.HttpHeaders;
 import okhttp3.internal.http2.Header;
 import okhttp3.internal.http2.Http2Codec;
 import org.junit.Test;
@@ -339,4 +340,97 @@
         .build();
     assertEquals("A: a\nB: bb\n", headers.toString());
   }
+
+  /** See https://github.com/square/okhttp/issues/2780. */
+  @Test public void testDigestChallenges() {
+    // Strict RFC 2617 header.
+    Headers headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest realm=\"myrealm\", nonce=\"fjalskdflwejrlaskdfjlaskdjflaks"
+            + "jdflkasdf\", qop=\"auth\", stale=\"FALSE\"")
+        .build();
+    List<Challenge> challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(1, challenges.size());
+    assertEquals("Digest", challenges.get(0).scheme());
+    assertEquals("myrealm", challenges.get(0).realm());
+
+    // Not strict RFC 2617 header.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest qop=\"auth\", realm=\"myrealm\", nonce=\"fjalskdflwejrlask"
+            + "dfjlaskdjflaksjdflkasdf\", stale=\"FALSE\"")
+        .build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(1, challenges.size());
+    assertEquals("Digest", challenges.get(0).scheme());
+    assertEquals("myrealm", challenges.get(0).realm());
+
+    // Not strict RFC 2617 header #2.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest qop=\"auth\", nonce=\"fjalskdflwejrlaskdfjlaskdjflaksjdflk"
+            + "asdf\", realm=\"myrealm\", stale=\"FALSE\"")
+        .build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(1, challenges.size());
+    assertEquals("Digest", challenges.get(0).scheme());
+    assertEquals("myrealm", challenges.get(0).realm());
+
+    // Wrong header.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest qop=\"auth\", underrealm=\"myrealm\", nonce=\"fjalskdflwej"
+            + "rlaskdfjlaskdjflaksjdflkasdf\", stale=\"FALSE\"")
+        .build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(0, challenges.size());
+
+    // Not strict RFC 2617 header with some spaces.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest qop=\"auth\",    realm=\"myrealm\", nonce=\"fjalskdflwejrl"
+            + "askdfjlaskdjflaksjdflkasdf\", stale=\"FALSE\"")
+        .build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(1, challenges.size());
+    assertEquals("Digest", challenges.get(0).scheme());
+    assertEquals("myrealm", challenges.get(0).realm());
+
+    // Strict RFC 2617 header with some spaces.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest    realm=\"myrealm\", nonce=\"fjalskdflwejrlaskdfjlaskdjfl"
+            + "aksjdflkasdf\", qop=\"auth\", stale=\"FALSE\"")
+        .build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(1, challenges.size());
+    assertEquals("Digest", challenges.get(0).scheme());
+    assertEquals("myrealm", challenges.get(0).realm());
+
+    // Not strict RFC 2617 camelcased.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "DiGeSt qop=\"auth\", rEaLm=\"myrealm\", nonce=\"fjalskdflwejrlask"
+            + "dfjlaskdjflaksjdflkasdf\", stale=\"FALSE\"")
+        .build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(1, challenges.size());
+    assertEquals("DiGeSt", challenges.get(0).scheme());
+    assertEquals("myrealm", challenges.get(0).realm());
+
+    // Strict RFC 2617 camelcased.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "DIgEsT rEaLm=\"myrealm\", nonce=\"fjalskdflwejrlaskdfjlaskdjflaks"
+            + "jdflkasdf\", qop=\"auth\", stale=\"FALSE\"")
+        .build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(1, challenges.size());
+    assertEquals("DIgEsT", challenges.get(0).scheme());
+    assertEquals("myrealm", challenges.get(0).realm());
+
+    // Unquoted.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest realm=myrealm").build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(0, challenges.size());
+
+    // Scheme only.
+    headers = new Headers.Builder()
+        .add("WWW-Authenticate", "Digest").build();
+    challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
+    assertEquals(0, challenges.size());
+  }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java b/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java
index 6c68bf9..0ce0d07 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java
@@ -20,6 +20,8 @@
 import java.util.List;
 import java.util.Set;
 import java.util.TreeSet;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
 import okhttp3.Challenge;
 import okhttp3.Cookie;
 import okhttp3.CookieJar;
@@ -35,6 +37,11 @@
 
 /** Headers and utilities for internal use by OkHttp. */
 public final class HttpHeaders {
+  private static final String TOKEN = "([^ \"=]*)";
+  private static final String QUOTED_STRING = "\"([^\"]*)\"";
+  private static final Pattern PARAMETER
+      = Pattern.compile(" +" + TOKEN + "=(:?" + QUOTED_STRING + "|" + TOKEN + ") *(:?,|$)");
+
   private HttpHeaders() {
   }
 
@@ -135,47 +142,35 @@
     return result.build();
   }
 
-  /** Parse RFC 2617 challenges. This API is only interested in the scheme name and realm. */
+  /**
+   * Parse RFC 2617 challenges, also wrong ordered ones.
+   * This API is only interested in the scheme name and realm.
+   */
   public static List<Challenge> parseChallenges(Headers responseHeaders, String challengeHeader) {
     // auth-scheme = token
     // auth-param  = token "=" ( token | quoted-string )
     // challenge   = auth-scheme 1*SP 1#auth-param
     // realm       = "realm" "=" realm-value
     // realm-value = quoted-string
-    List<Challenge> result = new ArrayList<>();
-    for (int i = 0, size = responseHeaders.size(); i < size; i++) {
-      if (!challengeHeader.equalsIgnoreCase(responseHeaders.name(i))) {
-        continue;
-      }
-      String value = responseHeaders.value(i);
-      int pos = 0;
-      while (pos < value.length()) {
-        int tokenStart = pos;
-        pos = skipUntil(value, pos, " ");
+    List<Challenge> challenges = new ArrayList<>();
+    List<String> authenticationHeaders = responseHeaders.values(challengeHeader);
+    for (String header : authenticationHeaders) {
+      int index = header.indexOf(' ');
+      if (index == -1) continue;
 
-        String scheme = value.substring(tokenStart, pos).trim();
-        pos = skipWhitespace(value, pos);
-
-        // TODO: This currently only handles schemes with a 'realm' parameter;
-        //       It needs to be fixed to handle any scheme and any parameters
-        //       http://code.google.com/p/android/issues/detail?id=11140
-
-        if (!value.regionMatches(true, pos, "realm=\"", 0, "realm=\"".length())) {
-          break; // Unexpected challenge parameter; give up!
+      Matcher matcher = PARAMETER.matcher(header);
+      for (int i = index; matcher.find(i); i = matcher.end()) {
+        if (header.regionMatches(true, matcher.start(1), "realm", 0, 5)) {
+          String scheme = header.substring(0, index);
+          String realm = matcher.group(3);
+          if (realm != null) {
+            challenges.add(new Challenge(scheme, realm));
+            break;
+          }
         }
-
-        pos += "realm=\"".length();
-        int realmStart = pos;
-        pos = skipUntil(value, pos, "\"");
-        String realm = value.substring(realmStart, pos);
-        pos++; // Consume '"' close quote.
-        pos = skipUntil(value, pos, ",");
-        pos++; // Consume ',' comma.
-        pos = skipWhitespace(value, pos);
-        result.add(new Challenge(scheme, realm));
       }
     }
-    return result;
+    return challenges;
   }
 
   public static void receiveHeaders(CookieJar cookieJar, HttpUrl url, Headers headers) {
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index efb1ecd..b99f00f 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,15 @@
 Change Log
 ==========
 
+## Version 3.4.2
+
+_2016-11-03_
+
+ *  Fix: Recover gracefully when an HTTP/2 connection is shutdown. We had a
+    bug where shutdown HTTP/2 connections were considered usable. This caused
+    infinite loops when calls attempted to recover.
+
+
 ## Version 3.4.1
 
 _2016-07-10_
/Fim/
diff --git a/README.md b/README.md
index ffb46f8..5b70072 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.4.1</version>
+  <version>3.4.2</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.4.1'
+compile 'com.squareup.okhttp3:okhttp:3.4.2'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.4.1</version>
+  <version>3.4.2</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.4.1'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.4.2'
 ```
 
 
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/ResponseBodyTest.java b/okhttp-tests/src/test/java/okhttp3/ResponseBodyTest.java
index beba4bd..47feeca 100644
--- a/okhttp-tests/src/test/java/okhttp3/ResponseBodyTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/ResponseBodyTest.java
@@ -58,7 +58,7 @@
   }
 
   @Test public void stringBomUtf8() throws IOException {
-    ResponseBody body = body("efbbff68656c6c6f");
+    ResponseBody body = body("efbbbf68656c6c6f");
     assertEquals("hello", body.string());
   }
 
@@ -128,7 +128,7 @@
   }
 
   @Test public void readerBomUtf8() throws IOException {
-    ResponseBody body = body("efbbff68656c6c6f");
+    ResponseBody body = body("efbbbf68656c6c6f");
     assertEquals("hello", exhaust(body.charStream()));
   }
 
@@ -212,11 +212,11 @@
   }
 
   @Test public void sourceSeesBom() throws IOException {
-    ResponseBody body = body("efbbff68656c6c6f");
+    ResponseBody body = body("efbbbf68656c6c6f");
     BufferedSource source = body.source();
     assertEquals(0xef, source.readByte() & 0xff);
     assertEquals(0xbb, source.readByte() & 0xff);
-    assertEquals(0xff, source.readByte() & 0xff);
+    assertEquals(0xbf, source.readByte() & 0xff);
     assertEquals("hello", source.readUtf8());
   }
 
@@ -251,11 +251,11 @@
   }
 
   @Test public void bytesSeesBom() throws IOException {
-    ResponseBody body = body("efbbff68656c6c6f");
+    ResponseBody body = body("efbbbf68656c6c6f");
     byte[] bytes = body.bytes();
     assertEquals(0xef, bytes[0] & 0xff);
     assertEquals(0xbb, bytes[1] & 0xff);
-    assertEquals(0xff, bytes[2] & 0xff);
+    assertEquals(0xbf, bytes[2] & 0xff);
     assertEquals("hello", new String(bytes, 3, 5, "UTF-8"));
   }
 
@@ -335,11 +335,11 @@
   }
 
   @Test public void byteStreamSeesBom() throws IOException {
-    ResponseBody body = body("efbbff68656c6c6f");
+    ResponseBody body = body("efbbbf68656c6c6f");
     InputStream bytes = body.byteStream();
     assertEquals(0xef, bytes.read());
     assertEquals(0xbb, bytes.read());
-    assertEquals(0xff, bytes.read());
+    assertEquals(0xbf, bytes.read());
     assertEquals("hello", exhaust(new InputStreamReader(bytes, "utf-8")));
   }
 
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/Util.java b/okhttp/src/main/java/okhttp3/internal/Util.java
index 3ce2d46..28c0b79 100644
--- a/okhttp/src/main/java/okhttp3/internal/Util.java
+++ b/okhttp/src/main/java/okhttp3/internal/Util.java
@@ -48,7 +48,7 @@
   public static final ResponseBody EMPTY_RESPONSE = ResponseBody.create(null, EMPTY_BYTE_ARRAY);
   public static final RequestBody EMPTY_REQUEST = RequestBody.create(null, EMPTY_BYTE_ARRAY);
 
-  private static final ByteString UTF_8_BOM = ByteString.decodeHex("efbbff");
+  private static final ByteString UTF_8_BOM = ByteString.decodeHex("efbbbf");
   private static final ByteString UTF_16_BE_BOM = ByteString.decodeHex("feff");
   private static final ByteString UTF_16_LE_BOM = ByteString.decodeHex("fffe");
   private static final ByteString UTF_32_BE_BOM = ByteString.decodeHex("0000ffff");
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index b99f00f..0165564 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,58 @@
 Change Log
 ==========
 
+## Version 3.5.0
+
+_2016-11-30_
+
+ *  **Web Sockets are now a stable feature of OkHttp.** Since being introduced as a beta feature in
+    OkHttp 2.3 our web socket client has matured. Connect to a server's web socket with
+    `OkHttpClient.newWebSocket()`, send messages with `send()`, and receive messages with the
+    `WebSocketListener`.
+
+    The `okhttp-ws` submodule is no longer available and `okhttp-ws` artifacts from previous
+    releases of OkHttp are not compatible with OkHttp 3.5. When upgrading to the new package
+    please note that the `WebSocket` and `WebSocketCall` classes have been merged. Sending messages
+    is now asynchronous and they may be enqueued before the web socket is connected.
+
+ *  **OkHttp no longer attempts a direct connection if the system's HTTP proxy fails.** This
+    behavior was surprising because OkHttp was disregarding the user's specified configuration. If
+    you need to customize proxy fallback behavior, implement your own `java.net.ProxySelector`.
+
+ *  Fix: Support TLSv1.3 on devices that support it.
+
+ *  Fix: Share pooled connections across equivalent `OkHttpClient` instances. Previous releases had
+    a bug where a shared connection pool did not guarantee shared connections in some cases.
+ *  Fix: Prefer the server's response body on all conditional cache misses. Previously we would
+    return the cached response's body if it had a newer `Last-Modified` date.
+ *  Fix: Update the stored timestamp on conditional cache hits.
+ *  New: Optimized HTTP/2 request header encoding. More headers are HPACK-encoded and string
+    literals are now Huffman-encoded.
+ *  New: Expose `Part` headers and body in `Multipart`.
+ *  New: Make `ResponseBody.string()` and `ResponseBody.charStream()` BOM-aware. If your HTTP
+    response body begins with a [byte order mark][bom] it will be consumed and used to select a
+    charset for the remaining bytes. Most applications should not not need a byte order mark.
+
+ *  New: Upgrade to Okio 1.11.0.
+
+     ```xml
+     <dependency>
+       <groupId>com.squareup.okio</groupId>
+       <artifactId>okio</artifactId>
+       <version>1.11.0</version>
+     </dependency>
+
+     com.squareup.okio:okio:1.11.0
+     ```
+
+ *  Fix: Avoid sending empty HTTP/2 data frames when there is no request body.
+ *  Fix: Add a leading `.` for better domain matching in `JavaNetCookieJar`.
+ *  Fix: Gracefully recover from HTTP/2 connection shutdowns at start of request.
+ *  Fix: Be lenient if a `MediaType`'s character set is `'single-quoted'`.
+ *  Fix: Allow horizontal tab characters in header values.
+ *  Fix: When parsing HTTP authentication headers permit challenge parameters in any order.
+
+
 ## Version 3.4.2
 
 _2016-11-03_
@@ -1146,3 +1198,4 @@
  [major_versions]: http://jakewharton.com/java-interoperability-policy-for-major-version-updates/
  [nginx_959]: https://trac.nginx.org/nginx/ticket/959
  [okhttp_idling_resource]: https://github.com/JakeWharton/okhttp-idling-resource
+ [bom]: https://en.wikipedia.org/wiki/Byte_order_mark
/Fim/
diff --git a/README.md b/README.md
index 5b70072..298b139 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.4.2</version>
+  <version>3.5.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.4.2'
+compile 'com.squareup.okhttp3:okhttp:3.5.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.4.2</version>
+  <version>3.5.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.4.2'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.5.0'
 ```
 
 
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 0065b25..0adc4c5 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 9f68096..b40e596 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index edc8684..e10e8c7 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 1485393..9a9a24d 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index ed13f59..288a1f0 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 5f9d786..9d8d9b9 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 18f83cc..e0d2081 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 4b3a04a..5c4e53e 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index bde0490..637e463 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 2e07de0..2219561 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index e1b638c..9fadcbd 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.5.0-SNAPSHOT</version>
+  <version>3.5.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.5.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 8b91ca2..e352db8 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 2d0c791..b4a0742 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 1c0dc8b..f791a20 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index c3330e4..cb37793 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 2b4d58b..4083d6d 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index ca52ac4..7a598cd 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0-SNAPSHOT</version>
+    <version>3.5.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 0adc4c5..e6067ec 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index b40e596..12f9cf4 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index e10e8c7..f2fccf8 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 9a9a24d..7ac8a4d 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 288a1f0..4c1de92 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 9d8d9b9..bec052a 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index e0d2081..a7e166b 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 5c4e53e..215eb4c 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 637e463..34c265c 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 2219561..a3e5aaa 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 9fadcbd..bda83e1 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.5.0</version>
+  <version>3.6.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.5.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index e352db8..7587628 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index b4a0742..4b55e53 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index f791a20..d881084 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index cb37793..b5f4cb4 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 4083d6d..06d7891 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 7a598cd..3d86d04 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.5.0</version>
+    <version>3.6.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 0165564..4242fa8 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,28 @@
 Change Log
 ==========
 
+## Version 3.6.0
+
+_2017-01-29_
+
+ *  Fix: Don't crash with a "cache is closed" error when there is an error initializing the cache.
+ *  Fix: Calling `disconnect()` on a connecting `HttpUrlConnection` could cause it to retry in an
+    infinite loop! This regression was introduced in OkHttp 2.7.0.
+ *  Fix: Drop cookies that contain ASCII NULL and other bad characters. Previously such cookies
+    would cause OkHttp to crash when they were included in a request.
+ *  Fix: Release duplicated multiplexed connections. If we concurrently establish connections to an
+    HTTP/2 server, close all but the first connection.
+ *  Fix: Fail the HTTP/2 connection if first frame isn't `SETTINGS`.
+ *  Fix: Forbid spaces in header names.
+ *  Fix: Don't offer to do gzip if the request is partial.
+ *  Fix: MockWebServer is now usable with JUnit 5. That update [broke the rules][junit_5_rules].
+ *  New: Support `Expect: 100-continue` as a request header. Callers can use this header to
+    pessimistically hold off on transmitting a request body until a server gives the go-ahead.
+ *  New: Permit network interceptors to rewrite the host header for HTTP/2. This makes it possible
+    to do domain fronting.
+ *  New: charset support for `Credentials.basic()`.
+
+
 ## Version 3.5.0
 
 _2016-11-30_
@@ -1199,3 +1221,4 @@
  [nginx_959]: https://trac.nginx.org/nginx/ticket/959
  [okhttp_idling_resource]: https://github.com/JakeWharton/okhttp-idling-resource
  [bom]: https://en.wikipedia.org/wiki/Byte_order_mark
+ [junit_5_rules]: http://junit.org/junit5/docs/current/user-guide/#migrating-from-junit4-rulesupport
/Fim/
diff --git a/README.md b/README.md
index 1f1f83f..ec355ca 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.5.0</version>
+  <version>3.6.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.5.0'
+compile 'com.squareup.okhttp3:okhttp:3.6.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.5.0</version>
+  <version>3.6.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.5.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.6.0'
 ```
 
 ProGuard
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index e6067ec..b724689 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 12f9cf4..c1b1d3f 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index f2fccf8..eb470f0 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 7ac8a4d..0df2e79 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 4c1de92..eca3d04 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index bec052a..41beeb9 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index a7e166b..9462a70 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 215eb4c..d148d81 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 34c265c..c56cf58 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index a3e5aaa..55d89f7 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 3b2b33b..955e104 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.6.0-SNAPSHOT</version>
+  <version>3.6.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.6.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 7587628..dcfe667 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 4b55e53..9b54040 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d881084..f6c78fc 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index b5f4cb4..c658345 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 06d7891..6d9e434 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 3d86d04..7e077e8 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0-SNAPSHOT</version>
+    <version>3.6.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index b724689..f8f4213 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index c1b1d3f..c2b3e2a 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index eb470f0..2b87e8d 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 0df2e79..6cf9bba 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index eca3d04..0779844 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 41beeb9..95262be 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 9462a70..9f06f88 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index d148d81..7758eb2 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index c56cf58..97dbe5d 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 55d89f7..bd2ed1c 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 955e104..6858d3d 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.6.0</version>
+  <version>3.7.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.6.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index dcfe667..b53dd1d 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 9b54040..63e8103 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index f6c78fc..d6a4ebd 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index c658345..63d3bb1 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 6d9e434..7357429 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 7e077e8..46fc4fe 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.6.0</version>
+    <version>3.7.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/EventListener.java b/okhttp/src/main/java/okhttp3/EventListener.java
index cf80538..7efdcae 100644
--- a/okhttp/src/main/java/okhttp3/EventListener.java
+++ b/okhttp/src/main/java/okhttp3/EventListener.java
@@ -18,15 +18,18 @@
 import java.net.InetAddress;
 import java.util.List;
 
-/**
- * Observes, modifies, and potentially short-circuits requests going out and the corresponding
- * responses coming back in. Typically interceptors add, remove, or transform headers on the request
- * or response.
- */
-public class EventListener {
-  public static final EventListener NULL_EVENT_LISTENER = new EventListener() {
+public abstract class EventListener {
+  public static final EventListener NONE = new EventListener() {
   };
 
+  static EventListener.Factory factory(final EventListener listener) {
+    return new EventListener.Factory() {
+      public EventListener create(Call call) {
+        return listener;
+      }
+    };
+  }
+
   public void fetchStart(Call call) {
   }
 
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/OkHttpClient.java b/okhttp/src/main/java/okhttp3/OkHttpClient.java
index 2ec6738..46cc7b8 100644
--- a/okhttp/src/main/java/okhttp3/OkHttpClient.java
+++ b/okhttp/src/main/java/okhttp3/OkHttpClient.java
@@ -196,6 +196,7 @@
   final List<ConnectionSpec> connectionSpecs;
   final List<Interceptor> interceptors;
   final List<Interceptor> networkInterceptors;
+  final EventListener.Factory eventListenerFactory;
   final ProxySelector proxySelector;
   final CookieJar cookieJar;
   final Cache cache;
@@ -228,6 +229,7 @@
     this.connectionSpecs = builder.connectionSpecs;
     this.interceptors = Util.immutableList(builder.interceptors);
     this.networkInterceptors = Util.immutableList(builder.networkInterceptors);
+    this.eventListenerFactory = builder.eventListenerFactory;
     this.proxySelector = builder.proxySelector;
     this.cookieJar = builder.cookieJar;
     this.cache = builder.cache;
@@ -404,6 +406,10 @@
     return networkInterceptors;
   }
 
+  public EventListener.Factory eventListenerFactory() {
+    return eventListenerFactory;
+  }
+
   /**
    * Prepares the {@code request} to be executed at some point in the future.
    */
@@ -431,6 +437,7 @@
     List<ConnectionSpec> connectionSpecs;
     final List<Interceptor> interceptors = new ArrayList<>();
     final List<Interceptor> networkInterceptors = new ArrayList<>();
+    EventListener.Factory eventListenerFactory;
     ProxySelector proxySelector;
     CookieJar cookieJar;
     Cache cache;
@@ -456,6 +463,7 @@
       dispatcher = new Dispatcher();
       protocols = DEFAULT_PROTOCOLS;
       connectionSpecs = DEFAULT_CONNECTION_SPECS;
+      eventListenerFactory = EventListener.factory(EventListener.NONE);
       proxySelector = ProxySelector.getDefault();
       cookieJar = CookieJar.NO_COOKIES;
       socketFactory = SocketFactory.getDefault();
@@ -481,6 +489,7 @@
       this.connectionSpecs = okHttpClient.connectionSpecs;
       this.interceptors.addAll(okHttpClient.interceptors);
       this.networkInterceptors.addAll(okHttpClient.networkInterceptors);
+      this.eventListenerFactory = okHttpClient.eventListenerFactory;
       this.proxySelector = okHttpClient.proxySelector;
       this.cookieJar = okHttpClient.cookieJar;
       this.internalCache = okHttpClient.internalCache;
@@ -878,6 +887,20 @@
       return this;
     }
 
+    public Builder eventListener(EventListener eventListener) {
+      if (eventListener == null) throw new NullPointerException("eventListener == null");
+      this.eventListenerFactory = EventListener.factory(eventListener);
+      return this;
+    }
+
+    public Builder eventListenerFactory(EventListener.Factory eventListenerFactory) {
+      if (eventListenerFactory == null) {
+        throw new NullPointerException("eventListenerFactory == null");
+      }
+      this.eventListenerFactory = eventListenerFactory;
+      return this;
+    }
+
     public OkHttpClient build() {
       return new OkHttpClient(this);
     }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/RealCall.java b/okhttp/src/main/java/okhttp3/RealCall.java
index ab3ddb0..cc26596 100644
--- a/okhttp/src/main/java/okhttp3/RealCall.java
+++ b/okhttp/src/main/java/okhttp3/RealCall.java
@@ -33,6 +33,7 @@
 final class RealCall implements Call {
   final OkHttpClient client;
   final RetryAndFollowUpInterceptor retryAndFollowUpInterceptor;
+  final EventListener eventListener;
 
   /** The application's original request unadulterated by redirects or auth headers. */
   final Request originalRequest;
@@ -42,10 +43,13 @@
   private boolean executed;
 
   RealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) {
+    final EventListener.Factory eventListenerFactory = client.eventListenerFactory();
+
     this.client = client;
     this.originalRequest = originalRequest;
     this.forWebSocket = forWebSocket;
     this.retryAndFollowUpInterceptor = new RetryAndFollowUpInterceptor(client, forWebSocket);
+    this.eventListener = eventListenerFactory.create(this);
   }
 
   @Override public Request request() {
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index bd73498..33e02f9 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,32 @@
 Change Log
 ==========
 
+## Version 3.7.0
+
+_2017-04-15_
+
+ *  **OkHttp no longer recovers from TLS handshake failures by attempting a TLSv1 connection.**
+    The fallback was necessary for servers that implemented version negotiation incorrectly. Now
+    that 99.99% of servers do it right this fallback is obsolete.
+ *  Fix: Do not honor cookies set on a public domain. Previously a malicious site could inject
+    cookies on top-level domains like `co.uk` because our cookie parser didn't honor the [public
+    suffix][public_suffix] list. Alongside this fix is a new API, `HttpUrl.topPrivateDomain()`,
+    which returns the privately domain name if the URL has one.
+ *  Fix: Change `MediaType.charset()` to return null for unexpected charsets.
+ *  Fix: Don't skip cache invalidation if the invalidating response has no body.
+ *  Fix: Don't use a cryptographic random number generator for web sockets. Some Android devices
+    implement `SecureRandom` incorrectly!
+ *  Fix: Correctly canonicalize IPv6 addresses in `HttpUrl`. This prevented OkHttp from trusting
+    HTTPS certificates issued to certain IPv6 addresses.
+ *  Fix: Don't reuse connections after an unsuccessful `Expect: 100-continue`.
+ *  Fix: Handle either `TLS_` or `SSL_` prefixes for cipher suite names. This is necessary for
+    IBM JVMs that use the `SSL_` prefix exclusively.
+ *  Fix: Reject HTTP/2 data frames if the stream ID is 0.
+ *  New: Connection coalescing. OkHttp may reuse HTTP/2 connections across calls that share an IP
+    address and HTTPS certificate, even if their domain names are different.
+ *  New: MockWebServer's `RecordedRequest` exposes the requested `HttpUrl` with `getRequestUrl()`.
+
+
 ## Version 3.6.0
 
 _2017-01-29_
@@ -1222,3 +1248,4 @@
  [okhttp_idling_resource]: https://github.com/JakeWharton/okhttp-idling-resource
  [bom]: https://en.wikipedia.org/wiki/Byte_order_mark
  [junit_5_rules]: http://junit.org/junit5/docs/current/user-guide/#migrating-from-junit4-rulesupport
+ [public_suffix]: https://publicsuffix.org/
/Fim/
diff --git a/README.md b/README.md
index ee219a5..2e6d246 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.6.0</version>
+  <version>3.7.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.6.0'
+compile 'com.squareup.okhttp3:okhttp:3.7.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.6.0</version>
+  <version>3.7.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.6.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.7.0'
 ```
 
 ProGuard
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index f8f4213..0664018 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index c2b3e2a..0d4d33f 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 2b87e8d..49d7074 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 6cf9bba..90696a6 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 0779844..b00f10c 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 95262be..f32104d 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 9f06f88..9a7f8f4 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 7758eb2..b2cdc29 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 97dbe5d..acd171e 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index bd2ed1c..5fe5edb 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 5960164..f14cdb7 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.7.0-SNAPSHOT</version>
+  <version>3.7.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.7.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index b53dd1d..58e9720 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 63e8103..d32682c 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index d6a4ebd..fcdfa29 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 63d3bb1..b6067d1 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 7357429..664fec8 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 46fc4fe..2100efa 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0-SNAPSHOT</version>
+    <version>3.7.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 0664018..270a464 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 0d4d33f..a9ccd9e 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 49d7074..4be5cd4 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 90696a6..3487d8b 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index b00f10c..e6bf0a0 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index f32104d..dcb5375 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 9a7f8f4..4268d0d 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index b2cdc29..37d3c6c 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index acd171e..6d905b9 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 5fe5edb..d393af0 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index f14cdb7..b5f1ea4 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.7.0</version>
+  <version>3.8.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.7.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 58e9720..bfb6634 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index d32682c..893d399 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index fcdfa29..213b985 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index b6067d1..2de5d02 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 664fec8..1889b21 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 2100efa..eb7486d 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.7.0</version>
+    <version>3.8.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Headers.java b/okhttp/src/main/java/okhttp3/Headers.java
index fb007a0..efc5341 100644
--- a/okhttp/src/main/java/okhttp3/Headers.java
+++ b/okhttp/src/main/java/okhttp3/Headers.java
@@ -313,7 +313,7 @@
               "Unexpected char %#04x at %d in header name: %s", (int) c, i, name));
         }
       }
-      if (value == null) throw new NullPointerException("value == null");
+      if (value == null) throw new NullPointerException("value for name " + name + " == null");
       for (int i = 0, length = value.length(); i < length; i++) {
         char c = value.charAt(i);
         if ((c <= '\u001f' && c != '\t') || c >= '\u007f') {
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 43e6497..e02adeb 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,55 @@
 Change Log
 ==========
 
+## Version 3.8.0
+
+_2017-05-13_
+
+
+ *  **OkHttp now uses `@Nullable` to annotate all possibly-null values.** We've
+    added a compile-time dependency on the JSR 305 annotations. This is a
+    [provided][maven_provided] dependency and does not need to be included in
+    your build configuration, `.jar` file, or `.apk`. We use
+    `@ParametersAreNonnullByDefault` and all parameters and return types are
+    never null unless explicitly annotated `@Nullable`.
+
+ *  **Warning: this release is source-incompatible for Kotlin users.**
+    Nullability was previously ambiguous and lenient but now the compiler will
+    enforce strict null checks.
+
+ *  New: The response message is now non-null. This is the "Not Found" in the
+    status line "HTTP 404 Not Found". If you are building responses
+    programmatically (with `new Response.Builder()`) you must now always supply
+    a message. An empty string `""` is permitted. This value was never null on
+    responses returned by OkHttp itself, and it was an old mistake to permit
+    application code to omit a message.
+
+ *  The challenge's scheme and realm are now non-null. If you are calling
+    `new Challenge(scheme, realm)` you must provide non-null values. These were
+    never null in challenges created by OkHttp, but could have been null in
+    application code that creates challenges.
+
+ *  New: The `TlsVersion` of a `Handshake` is now non-null. If you are calling
+    `Handshake.get()` with a null TLS version, you must instead now provide a
+    non-null `TlsVersion`. Cache responses persisted prior to OkHttp 3.0 did not
+    store a TLS version; for these unknown values the handshake is defaulted to
+    `TlsVersion.SSL_3_0`.
+
+ *  New: Upgrade to Okio 1.13.0.
+
+     ```xml
+     <dependency>
+       <groupId>com.squareup.okio</groupId>
+       <artifactId>okio</artifactId>
+       <version>1.13.0</version>
+     </dependency>
+
+     com.squareup.okio:okio:1.13.0
+     ```
+
+ *  Fix: gracefully recover when Android 7.0's sockets throw an unexpected
+    `NullPointerException`.
+
 ## Version 3.7.0
 
 _2017-04-15_
/Fim/
diff --git a/README.md b/README.md
index 2e6d246..8a901b9 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.7.0</version>
+  <version>3.8.0</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.7.0'
+compile 'com.squareup.okhttp3:okhttp:3.8.0'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.7.0</version>
+  <version>3.8.0</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.7.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.8.0'
 ```
 
 ProGuard
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/EventListener.java b/okhttp/src/main/java/okhttp3/EventListener.java
index 369a5e0..dacf475 100644
--- a/okhttp/src/main/java/okhttp3/EventListener.java
+++ b/okhttp/src/main/java/okhttp3/EventListener.java
@@ -18,7 +18,7 @@
 import java.net.InetAddress;
 import java.util.List;
 
-// TODO(jwilson): make this public after the 3.7 release.
+// TODO(jwilson): make this public after the 3.8 release.
 abstract class EventListener {
   public static final EventListener NONE = new EventListener() {
   };
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/OkHttpClient.java b/okhttp/src/main/java/okhttp3/OkHttpClient.java
index 6a11e84..6f1c429 100644
--- a/okhttp/src/main/java/okhttp3/OkHttpClient.java
+++ b/okhttp/src/main/java/okhttp3/OkHttpClient.java
@@ -407,7 +407,7 @@
     return networkInterceptors;
   }
 
-  // TODO(jwilson): make this public after the 3.7 release.
+  // TODO(jwilson): make this public after the 3.8 release.
   /*public*/ EventListener.Factory eventListenerFactory() {
     return eventListenerFactory;
   }
@@ -887,14 +887,14 @@
       return this;
     }
 
-    // TODO(jwilson): make this public after the 3.7 release.
+    // TODO(jwilson): make this public after the 3.8 release.
     /*public*/ Builder eventListener(EventListener eventListener) {
       if (eventListener == null) throw new NullPointerException("eventListener == null");
       this.eventListenerFactory = EventListener.factory(eventListener);
       return this;
     }
 
-    // TODO(jwilson): make this public after the 3.7 release.
+    // TODO(jwilson): make this public after the 3.8 release.
     /*public*/ Builder eventListenerFactory(EventListener.Factory eventListenerFactory) {
       if (eventListenerFactory == null) {
         throw new NullPointerException("eventListenerFactory == null");
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 270a464..ad391f0 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index a9ccd9e..11a06a7 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 4be5cd4..eb75b69 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 6d6b6ed..7af00a5 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index e6bf0a0..c888807 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index b564f75..3791ac7 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 9b561b4..d556200 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 50649d6..cde5c60 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index c1ab2fb..0a54e5d 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index f9dfc6e..4be1db9 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index f831fbb..b57f469 100644
--- a/pom.xml
+++ b/pom.xml
@@ -1,8 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 
-<project xmlns="http://maven.apache.org/POM/4.0.0"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
   <modelVersion>4.0.0</modelVersion>
 
   <parent>
@@ -13,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.8.0-SNAPSHOT</version>
+  <version>3.8.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -65,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.8.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index bfb6634..2636eb1 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 893d399..8182ba2 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 213b985..426a729 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 2de5d02..862a3db 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 1889b21..e0780fb 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index eb7486d..5c31700 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0-SNAPSHOT</version>
+    <version>3.8.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index ad391f0..80ed447 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 11a06a7..00aae47 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index eb75b69..85b6b55 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 7af00a5..ef5f028 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index c888807..5c35b8d 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 3791ac7..1513f73 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index d556200..f6a7c1f 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index cde5c60..2ac6188 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 0a54e5d..64d4797 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 4be1db9..e2a9a72 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index b57f469..c92a23b 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.8.0</version>
+  <version>3.9.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.8.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 2636eb1..ef746a0 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index 8182ba2..d8336f7 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 426a729..4f617d0 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 862a3db..1f8f650 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index e0780fb..d065531 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 5c31700..26f091a 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.8.0</version>
+    <version>3.9.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/CacheTest.java b/okhttp-tests/src/test/java/okhttp3/CacheTest.java
index d7d2705..09b480c 100644
--- a/okhttp-tests/src/test/java/okhttp3/CacheTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/CacheTest.java
@@ -2480,6 +2480,33 @@
     return server.takeRequest(); // conditional get
   }
 
+  @Test public void immutableIsCached() throws Exception {
+    server.enqueue(new MockResponse()
+        .addHeader("Cache-Control", "immutable")
+        .setBody("A"));
+    server.enqueue(new MockResponse()
+        .setBody("B"));
+
+    HttpUrl url = server.url("/");
+    assertEquals("A", get(url).body().string());
+    assertEquals("A", get(url).body().string());
+  }
+
+  @Test public void immutableIsCachedAfterMultipleCalls() throws Exception {
+    server.enqueue(new MockResponse()
+        .setBody("A"));
+    server.enqueue(new MockResponse()
+        .addHeader("Cache-Control", "immutable")
+        .setBody("B"));
+    server.enqueue(new MockResponse()
+        .setBody("C"));
+
+    HttpUrl url = server.url("/");
+    assertEquals("A", get(url).body().string());
+    assertEquals("B", get(url).body().string());
+    assertEquals("B", get(url).body().string());
+  }
+
   private void assertFullyCached(MockResponse response) throws Exception {
     server.enqueue(response.setBody("A"));
     server.enqueue(response.setBody("B"));
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/cache/CacheStrategy.java b/okhttp/src/main/java/okhttp3/internal/cache/CacheStrategy.java
index 410e8ac..9b6cc1a 100644
--- a/okhttp/src/main/java/okhttp3/internal/cache/CacheStrategy.java
+++ b/okhttp/src/main/java/okhttp3/internal/cache/CacheStrategy.java
@@ -204,6 +204,11 @@
         return new CacheStrategy(request, null);
       }
 
+      CacheControl responseCaching = cacheResponse.cacheControl();
+      if (responseCaching.immutable()) {
+        return new CacheStrategy(null, cacheResponse);
+      }
+
       long ageMillis = cacheResponseAge();
       long freshMillis = computeFreshnessLifetime();
 
@@ -217,7 +222,6 @@
       }
 
       long maxStaleMillis = 0;
-      CacheControl responseCaching = cacheResponse.cacheControl();
       if (!responseCaching.mustRevalidate() && requestCaching.maxStaleSeconds() != -1) {
         maxStaleMillis = SECONDS.toMillis(requestCaching.maxStaleSeconds());
       }
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 5422a13..86e3bee 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,16 @@
 Change Log
 ==========
 
+## Version 3.8.1
+
+_2017-06-18_
+
+ *  Fix: Recover gracefully from stale coalesced connections. We had a bug where
+    connection coalescing (introduced in OkHttp 3.7.0) and stale connection
+    recovery could interact to cause a `NoSuchElementException` crash in the
+    `RouteSelector`.
+
+
 ## Version 3.8.0
 
 _2017-05-13_
/Fim/
diff --git a/README.md b/README.md
index 4bd5e13..1754c6d 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.8.0</version>
+  <version>3.8.1</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.8.0'
+compile 'com.squareup.okhttp3:okhttp:3.8.1'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.8.0</version>
+  <version>3.8.1</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.8.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.8.1'
 ```
 
 ProGuard
/Fim/
diff --git a/mockwebserver/src/main/java/okhttp3/mockwebserver/MockResponse.java b/mockwebserver/src/main/java/okhttp3/mockwebserver/MockResponse.java
index 73691d4..3645722 100644
--- a/mockwebserver/src/main/java/okhttp3/mockwebserver/MockResponse.java
+++ b/mockwebserver/src/main/java/okhttp3/mockwebserver/MockResponse.java
@@ -43,6 +43,9 @@
   private long bodyDelayAmount = 0;
   private TimeUnit bodyDelayUnit = TimeUnit.MILLISECONDS;
 
+  private long headersDelayAmount = 0;
+  private TimeUnit headersDelayUnit = TimeUnit.MILLISECONDS;
+
   private List<PushPromise> promises = new ArrayList<>();
   private Settings settings;
   private WebSocketListener webSocketListener;
@@ -253,6 +256,16 @@
     return unit.convert(bodyDelayAmount, bodyDelayUnit);
   }
 
+  public MockResponse setHeadersDelay(long delay, TimeUnit unit) {
+    headersDelayAmount = delay;
+    headersDelayUnit = unit;
+    return this;
+  }
+
+  public long getHeadersDelay(TimeUnit unit) {
+    return unit.convert(headersDelayAmount, headersDelayUnit);
+  }
+
   /**
    * When {@link MockWebServer#setProtocols(java.util.List) protocols} include {@linkplain
    * okhttp3.Protocol#HTTP_2}, this attaches a pushed stream to this response.
/Fim/
diff --git a/mockwebserver/src/main/java/okhttp3/mockwebserver/MockWebServer.java b/mockwebserver/src/main/java/okhttp3/mockwebserver/MockWebServer.java
index 27f0ec2..40cef44 100644
--- a/mockwebserver/src/main/java/okhttp3/mockwebserver/MockWebServer.java
+++ b/mockwebserver/src/main/java/okhttp3/mockwebserver/MockWebServer.java
@@ -690,6 +690,7 @@
 
   private void writeHttpResponse(Socket socket, BufferedSink sink, MockResponse response)
       throws IOException {
+    sleepIfDelayed(response.getBodyDelay(TimeUnit.MILLISECONDS));
     sink.writeUtf8(response.getStatus());
     sink.writeUtf8("\r\n");
 
@@ -705,12 +706,11 @@
 
     Buffer body = response.getBody();
     if (body == null) return;
-    sleepIfDelayed(response);
+    sleepIfDelayed(response.getBodyDelay(TimeUnit.MILLISECONDS));
     throttledTransfer(response, socket, body, sink, body.size(), false);
   }
 
-  private void sleepIfDelayed(MockResponse response) {
-    long delayMs = response.getBodyDelay(TimeUnit.MILLISECONDS);
+  private void sleepIfDelayed(long delayMs) {
     if (delayMs != 0) {
       try {
         Thread.sleep(delayMs);
@@ -948,13 +948,15 @@
         http2Headers.add(new Header(headers.name(i), headers.value(i)));
       }
 
+      sleepIfDelayed(response.getHeadersDelay(TimeUnit.MILLISECONDS));
+
       Buffer body = response.getBody();
       boolean closeStreamAfterHeaders = body != null || !response.getPushPromises().isEmpty();
       stream.sendResponseHeaders(http2Headers, closeStreamAfterHeaders);
       pushPromises(stream, response.getPushPromises());
       if (body != null) {
         BufferedSink sink = Okio.buffer(stream.getSink());
-        sleepIfDelayed(response);
+        sleepIfDelayed(response.getBodyDelay(TimeUnit.MILLISECONDS));
         throttledTransfer(response, socket, body, sink, body.size(), false);
         sink.close();
       } else if (closeStreamAfterHeaders) {
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java b/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java
index 3ef429a..320c7d7 100644
--- a/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java
+++ b/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java
@@ -24,12 +24,16 @@
 import java.util.Arrays;
 import java.util.Collections;
 import java.util.List;
+import java.util.concurrent.BlockingQueue;
 import java.util.concurrent.CountDownLatch;
 import java.util.concurrent.ExecutorService;
 import java.util.concurrent.Executors;
+import java.util.concurrent.SynchronousQueue;
+
 import javax.net.ssl.HostnameVerifier;
 import okhttp3.Cache;
 import okhttp3.Call;
+import okhttp3.Callback;
 import okhttp3.Cookie;
 import okhttp3.Credentials;
 import okhttp3.Headers;
@@ -978,6 +982,31 @@
     assertEquals(0, server.takeRequest().getSequenceNumber());
   }
 
+  @Test public void responseHeadersAfterGoaway() throws Exception {
+    server.enqueue(new MockResponse()
+        .setHeadersDelay(1, SECONDS)
+        .setBody("ABC"));
+    server.enqueue(new MockResponse()
+        .setSocketPolicy(SocketPolicy.DISCONNECT_AT_END)
+        .setBody("DEF"));
+
+    final BlockingQueue<String> bodies = new SynchronousQueue<>();
+    Callback callback = new Callback() {
+      @Override public void onResponse(Call call, Response response) throws IOException {
+        bodies.add(response.body().string());
+      }
+      @Override public void onFailure(Call call, IOException e) {
+        System.out.println(e);
+      }
+    };
+    client.newCall(new Request.Builder().url(server.url("/")).build()).enqueue(callback);
+    client.newCall(new Request.Builder().url(server.url("/")).build()).enqueue(callback);
+
+    assertEquals("DEF", bodies.poll(2, SECONDS));
+    assertEquals("ABC", bodies.poll(2, SECONDS));
+    assertEquals(2, server.getRequestCount());
+  }
+
   /**
    * We don't know if the connection will support HTTP/2 until after we've connected. When multiple
    * connections are requested concurrently OkHttp will pessimistically connect multiple times, then
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http2/Http2Connection.java b/okhttp/src/main/java/okhttp3/internal/http2/Http2Connection.java
index 023a7ff..a79b3b7 100644
--- a/okhttp/src/main/java/okhttp3/internal/http2/Http2Connection.java
+++ b/okhttp/src/main/java/okhttp3/internal/http2/Http2Connection.java
@@ -605,12 +605,12 @@
       }
       Http2Stream stream;
       synchronized (Http2Connection.this) {
-        // If we're shutdown, don't bother with this stream.
-        if (shutdown) return;
-
         stream = getStream(streamId);
 
         if (stream == null) {
+          // If we're shutdown, don't bother with this stream.
+          if (shutdown) return;
+
           // If the stream ID is less than the last created ID, assume it's already closed.
           if (streamId <= lastGoodStreamId) return;
 
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/HeadersTest.java b/okhttp-tests/src/test/java/okhttp3/HeadersTest.java
index 16ef3be..5b14352 100644
--- a/okhttp-tests/src/test/java/okhttp3/HeadersTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/HeadersTest.java
@@ -22,6 +22,7 @@
 import java.util.List;
 import java.util.Map;
 import okhttp3.internal.Internal;
+import okhttp3.internal.Util;
 import okhttp3.internal.http.HttpHeaders;
 import okhttp3.internal.http2.Header;
 import okhttp3.internal.http2.Http2Codec;
@@ -434,4 +435,27 @@
     challenges = HttpHeaders.parseChallenges(headers, "WWW-Authenticate");
     assertEquals(0, challenges.size());
   }
+
+  @Test public void basicChallenge() {
+    Headers headers = new Headers.Builder()
+        .add("WWW-Authenticate: Basic realm=\"protected area\"")
+        .build();
+    assertEquals(Arrays.asList(new Challenge("Basic", "protected area")),
+        HttpHeaders.parseChallenges(headers, "WWW-Authenticate"));
+  }
+
+  @Test public void basicChallengeWithCharset() {
+    Headers headers = new Headers.Builder()
+        .add("WWW-Authenticate: Basic realm=\"protected area\", charset=\"UTF-8\"")
+        .build();
+    assertEquals(Arrays.asList(new Challenge("Basic", "protected area").withCharset(Util.UTF_8)),
+        HttpHeaders.parseChallenges(headers, "WWW-Authenticate"));
+  }
+
+  @Test public void basicChallengeWithUnexpectedCharset() {
+    Headers headers = new Headers.Builder()
+        .add("WWW-Authenticate: Basic realm=\"protected area\", charset=\"US-ASCII\"")
+        .build();
+    assertEquals(Collections.emptyList(), HttpHeaders.parseChallenges(headers, "WWW-Authenticate"));
+  }
 }
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
index a566bab..29558b1 100644
--- a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
@@ -24,6 +24,7 @@
 import java.net.HttpRetryException;
 import java.net.HttpURLConnection;
 import java.net.InetAddress;
+import java.net.PasswordAuthentication;
 import java.net.ProtocolException;
 import java.net.Proxy;
 import java.net.ProxySelector;
@@ -42,7 +43,6 @@
 import java.util.Arrays;
 import java.util.Collections;
 import java.util.EnumSet;
-import java.util.HashSet;
 import java.util.LinkedHashSet;
 import java.util.List;
 import java.util.Map;
@@ -58,7 +58,6 @@
 import javax.net.ssl.SSLException;
 import javax.net.ssl.SSLHandshakeException;
 import javax.net.ssl.SSLProtocolException;
-import javax.net.ssl.SSLSocket;
 import javax.net.ssl.SSLSocketFactory;
 import javax.net.ssl.TrustManager;
 import javax.net.ssl.TrustManagerFactory;
@@ -1930,6 +1929,37 @@
     }
   }
 
+  @Test public void authenticateWithCharset() throws Exception {
+    server.enqueue(new MockResponse().setResponseCode(401)
+        .addHeader("WWW-Authenticate: Basic realm=\"protected area\", charset=\"UTF-8\"")
+        .setBody("Please authenticate with UTF-8."));
+    server.enqueue(new MockResponse().setResponseCode(401)
+        .addHeader("WWW-Authenticate: Basic realm=\"protected area\"")
+        .setBody("Please authenticate with ISO-8859-1."));
+    server.enqueue(new MockResponse()
+        .setBody("Successful auth!"));
+
+    Authenticator.setDefault(new RecordingAuthenticator(
+        new PasswordAuthentication("username", "mtorhead".toCharArray())));
+    urlFactory.setClient(urlFactory.client().newBuilder()
+        .authenticator(new JavaNetAuthenticator())
+        .build());
+    connection = urlFactory.open(server.url("/").url());
+    assertEquals("Successful auth!", readAscii(connection.getInputStream(), Integer.MAX_VALUE));
+
+    // No authorization header for the first request...
+    RecordedRequest request1 = server.takeRequest();
+    assertNull(request1.getHeader("Authorization"));
+
+    // UTF-8 encoding for the first credential.
+    RecordedRequest request2 = server.takeRequest();
+    assertEquals("Basic dXNlcm5hbWU6bcO2dG9yaGVhZA==", request2.getHeader("Authorization"));
+
+    // ISO-8859-1 encoding for the second credential.
+    RecordedRequest request3 = server.takeRequest();
+    assertEquals("Basic dXNlcm5hbWU6bfZ0b3JoZWFk", request3.getHeader("Authorization"));
+  }
+
   /** https://code.google.com/p/android/issues/detail?id=74026 */
   @Test public void authenticateWithGetAndTransparentGzip() throws Exception {
     MockResponse pleaseAuthenticate = new MockResponse().setResponseCode(401)
/Fim/
diff --git a/okhttp-urlconnection/src/main/java/okhttp3/JavaNetAuthenticator.java b/okhttp-urlconnection/src/main/java/okhttp3/JavaNetAuthenticator.java
index b5440a4..2649510 100644
--- a/okhttp-urlconnection/src/main/java/okhttp3/JavaNetAuthenticator.java
+++ b/okhttp-urlconnection/src/main/java/okhttp3/JavaNetAuthenticator.java
@@ -54,7 +54,8 @@
       }
 
       if (auth != null) {
-        String credential = Credentials.basic(auth.getUserName(), new String(auth.getPassword()));
+        String credential = Credentials.basic(
+            auth.getUserName(), new String(auth.getPassword()), challenge.charset());
         return request.newBuilder()
             .header(proxyAuthorization ? "Proxy-Authorization" : "Authorization", credential)
             .build();
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Challenge.java b/okhttp/src/main/java/okhttp3/Challenge.java
index 196de32..4b000ec 100644
--- a/okhttp/src/main/java/okhttp3/Challenge.java
+++ b/okhttp/src/main/java/okhttp3/Challenge.java
@@ -15,18 +15,33 @@
  */
 package okhttp3;
 
+import java.nio.charset.Charset;
 import javax.annotation.Nullable;
 
-/** An RFC 2617 challenge. */
+import static okhttp3.internal.Util.ISO_8859_1;
+
+/** An RFC 7617 challenge. */
 public final class Challenge {
   private final String scheme;
   private final String realm;
+  private final Charset charset;
 
   public Challenge(String scheme, String realm) {
+    this(scheme, realm, ISO_8859_1);
+  }
+
+  private Challenge(String scheme, String realm, Charset charset) {
     if (scheme == null) throw new NullPointerException("scheme == null");
     if (realm == null) throw new NullPointerException("realm == null");
+    if (charset == null) throw new NullPointerException("charset == null");
     this.scheme = scheme;
     this.realm = realm;
+    this.charset = charset;
+  }
+
+  /** Returns a copy of this charset that expects a credential encoded with {@code charset}. */
+  public Challenge withCharset(Charset charset) {
+    return new Challenge(scheme, realm, charset);
   }
 
   /** Returns the authentication scheme, like {@code Basic}. */
@@ -39,20 +54,29 @@
     return realm;
   }
 
+  /** Returns the charset that should be used to encode the credential. */
+  public Charset charset() {
+    return charset;
+  }
+
   @Override public boolean equals(@Nullable Object other) {
     return other instanceof Challenge
         && ((Challenge) other).scheme.equals(scheme)
-        && ((Challenge) other).realm.equals(realm);
+        && ((Challenge) other).realm.equals(realm)
+        && ((Challenge) other).charset.equals(charset);
   }
 
   @Override public int hashCode() {
     int result = 29;
     result = 31 * result + realm.hashCode();
     result = 31 * result + scheme.hashCode();
+    result = 31 * result + charset.hashCode();
     return result;
   }
 
   @Override public String toString() {
-    return scheme + " realm=\"" + realm + "\"";
+    return scheme
+        + " realm=\"" + realm + "\""
+        + " charset=\"" + charset + "\"";
   }
 }
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/Credentials.java b/okhttp/src/main/java/okhttp3/Credentials.java
index efbc170..a27ecae 100644
--- a/okhttp/src/main/java/okhttp3/Credentials.java
+++ b/okhttp/src/main/java/okhttp3/Credentials.java
@@ -18,6 +18,8 @@
 import java.nio.charset.Charset;
 import okio.ByteString;
 
+import static okhttp3.internal.Util.ISO_8859_1;
+
 /** Factory for HTTP authorization credentials. */
 public final class Credentials {
   private Credentials() {
@@ -25,7 +27,7 @@
 
   /** Returns an auth credential for the Basic scheme. */
   public static String basic(String userName, String password) {
-    return basic(userName, password, Charset.forName("ISO-8859-1"));
+    return basic(userName, password, ISO_8859_1);
   }
 
   public static String basic(String userName, String password, Charset charset) {
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/Util.java b/okhttp/src/main/java/okhttp3/internal/Util.java
index ff66cdf..68bbf5f 100644
--- a/okhttp/src/main/java/okhttp3/internal/Util.java
+++ b/okhttp/src/main/java/okhttp3/internal/Util.java
@@ -58,6 +58,7 @@
   private static final ByteString UTF_32_LE_BOM = ByteString.decodeHex("ffff0000");
 
   public static final Charset UTF_8 = Charset.forName("UTF-8");
+  public static final Charset ISO_8859_1 = Charset.forName("ISO-8859-1");
   private static final Charset UTF_16_BE = Charset.forName("UTF-16BE");
   private static final Charset UTF_16_LE = Charset.forName("UTF-16LE");
   private static final Charset UTF_32_BE = Charset.forName("UTF-32BE");
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java b/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java
index 0ce0d07..a1d6712 100644
--- a/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java
+++ b/okhttp/src/main/java/okhttp3/internal/http/HttpHeaders.java
@@ -29,6 +29,7 @@
 import okhttp3.HttpUrl;
 import okhttp3.Request;
 import okhttp3.Response;
+import okhttp3.internal.Util;
 
 import static java.net.HttpURLConnection.HTTP_NOT_MODIFIED;
 import static java.net.HttpURLConnection.HTTP_NO_CONTENT;
@@ -143,7 +144,7 @@
   }
 
   /**
-   * Parse RFC 2617 challenges, also wrong ordered ones.
+   * Parse RFC 7617 challenges, also wrong ordered ones.
    * This API is only interested in the scheme name and realm.
    */
   public static List<Challenge> parseChallenges(Headers responseHeaders, String challengeHeader) {
@@ -158,17 +159,38 @@
       int index = header.indexOf(' ');
       if (index == -1) continue;
 
+      String scheme = header.substring(0, index);
+      String realm = null;
+      String charset = null;
+
       Matcher matcher = PARAMETER.matcher(header);
       for (int i = index; matcher.find(i); i = matcher.end()) {
         if (header.regionMatches(true, matcher.start(1), "realm", 0, 5)) {
-          String scheme = header.substring(0, index);
-          String realm = matcher.group(3);
-          if (realm != null) {
-            challenges.add(new Challenge(scheme, realm));
-            break;
-          }
+          realm = matcher.group(3);
+        } else if (header.regionMatches(true, matcher.start(1), "charset", 0, 7)) {
+          charset = matcher.group(3);
+        }
+
+        if (realm != null && charset != null) {
+          break;
         }
       }
+
+      // "realm" is required.
+      if (realm == null) continue;
+
+      Challenge challenge = new Challenge(scheme, realm);
+
+      // If a charset is provided, RFC 7617 says it must be "UTF-8".
+      if (charset != null) {
+        if (charset.equalsIgnoreCase("UTF-8")) {
+          challenge = challenge.withCharset(Util.UTF_8);
+        } else {
+          continue;
+        }
+      }
+
+      challenges.add(challenge);
     }
     return challenges;
   }
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 86e3bee..6d9e376 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,57 @@
 Change Log
 ==========
 
+## Version 3.9.0
+
+_2017-09-03_
+
+ *  **Interceptors are more capable.** The `Chain` interface now offers access
+    to the call and can adjust all call timeouts. Note that this change is
+    source-incompatible for code that implements the `Chain` interface.
+    We don't expect this to be a problem in practice.
+
+ *  **OkHttp has an experimental new API for tracking metrics.** The new
+    `EventListener` API is designed to help developers monitor HTTP requests'
+    size and duration. This feature is an API preview: the API is subject to
+    change, and the implementation is incomplete. Please try out the API and
+    provide feedback to us. Because this is a big new API we are unlikely to
+    get all of the details right and we're eager for feedback.
+
+ *  New: Support ALPN via Google Play Services' Dynamic Security Provider. This
+    expands HTTP/2 support to older Android devices that have Google Play
+    Services.
+ *  New: Consider all routes when looking for candidate coalesced connections.
+    This increases the likelihood that HTTP/2 connections will be shared.
+ *  New: Authentication challenges and credentials now use a charset. Use this in
+    your authenticator to support user names and passwords with non-ASCII
+    characters.
+ *  New: Accept a charset in `FormBody.Builder`. Previously form bodies were
+    always UTF-8.
+ *  New: Support the `immutable` cache-control directive.
+ *  Fix: Don't crash when an HTTP/2 call is redirected while the connection is
+    being shut down.
+ *  Fix: Don't drop headers of healthy streams that raced with `GOAWAY` frames.
+    This bug would cause HTTP/2 streams to occasional hang when the connection
+    was shutting down.
+ *  Fix: Honor `OkHttpClient.retryOnConnectionFailure()` when the response is a
+    HTTP 408 Request Timeout. If retries are enabled, OkHttp will retry exactly
+    once in response to a 408.
+ *  Fix: Don't crash when reading the empty `HEAD` response body if it specifies
+    a `Content-Length`.
+ *  Fix: Don't crash if the thread is interrupted while reading the public
+    suffix database.
+ *  Fix: Use relative resource path when loading the public suffix database.
+    Loading the resource using a path relative to the class prevents conflicts
+    when the OkHttp classes are relocated (shaded) by allowing multiple private
+    copies of the database.
+ *  Fix: Accept cookies for URLs that have an IPv6 address for a host.
+ *  Fix: Don't log the protocol (HTTP/1.1, h2) in HttpLoggingInterceptor if the
+    protocol isn't negotiated yet! Previously we'd log HTTP/1.1 by default, and
+    this was confusing.
+ *  Fix: Omit the message from MockWebServer's HTTP/2 `:status` header.
+ *  Fix: Handle 'Expect: 100 Continue' properly in MockWebServer.
+
+
 ## Version 3.8.1
 
 _2017-06-18_
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 6d9e376..2003af9 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -13,9 +13,8 @@
  *  **OkHttp has an experimental new API for tracking metrics.** The new
     `EventListener` API is designed to help developers monitor HTTP requests'
     size and duration. This feature is an API preview: the API is subject to
-    change, and the implementation is incomplete. Please try out the API and
-    provide feedback to us. Because this is a big new API we are unlikely to
-    get all of the details right and we're eager for feedback.
+    change, and the implementation is incomplete. This is a big new API we are
+    eager for feedback.
 
  *  New: Support ALPN via Google Play Services' Dynamic Security Provider. This
     expands HTTP/2 support to older Android devices that have Google Play
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 2003af9..7183846 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -8,13 +8,13 @@
  *  **Interceptors are more capable.** The `Chain` interface now offers access
     to the call and can adjust all call timeouts. Note that this change is
     source-incompatible for code that implements the `Chain` interface.
-    We don't expect this to be a problem in practice.
+    We don't expect this to be a problem in practice!
 
  *  **OkHttp has an experimental new API for tracking metrics.** The new
     `EventListener` API is designed to help developers monitor HTTP requests'
-    size and duration. This feature is an API preview: the API is subject to
-    change, and the implementation is incomplete. This is a big new API we are
-    eager for feedback.
+    size and duration. This feature is an unstable preview: the API is subject
+    to change, and the implementation is incomplete. This is a big new API we
+    are eager for feedback.
 
  *  New: Support ALPN via Google Play Services' Dynamic Security Provider. This
     expands HTTP/2 support to older Android devices that have Google Play
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 80ed447..74adf41 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 00aae47..6a7abb0 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 85b6b55..1da7586 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index ef5f028..9b4e3d1 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 5c35b8d..ebd98b6 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 1513f73..a3be84e 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index f6a7c1f..1762b96 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 2ac6188..b2c69f7 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 64d4797..e90c46b 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index e2a9a72..482ced6 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 0dc9ffa..fe391b8 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.9.0-SNAPSHOT</version>
+  <version>3.9.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.9.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index ef746a0..ba57652 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index d8336f7..db7016a 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 4f617d0..7d13653 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 1f8f650..64a7f54 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index d065531..73321ae 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 26f091a..873dd60 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0-SNAPSHOT</version>
+    <version>3.9.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 74adf41..36a9aee 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 6a7abb0..de25842 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 1da7586..c444a23 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 9b4e3d1..e2ff34c 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index ebd98b6..4cf6878 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index a3be84e..275570d 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 1762b96..3605a66 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index b2c69f7..6959cd9 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index e90c46b..3894bbc 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 482ced6..09015c1 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index fe391b8..9294530 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.9.0</version>
+  <version>3.10.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.9.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index ba57652..77eea94 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index db7016a..c654656 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 7d13653..4bb53c9 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 64a7f54..347edef 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 73321ae..c76577e 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 873dd60..30b3cb8 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.0</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/samples/guide/src/main/java/okhttp3/recipes/PrintEvents.java b/samples/guide/src/main/java/okhttp3/recipes/PrintEvents.java
new file mode 100644
index 0000000..a1fdbd0
--- /dev/null
+++ b/samples/guide/src/main/java/okhttp3/recipes/PrintEvents.java
@@ -0,0 +1,183 @@
+/*
+ * Copyright (C) 2017 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3.recipes;
+
+import java.io.IOException;
+import java.net.InetAddress;
+import java.net.InetSocketAddress;
+import java.net.Proxy;
+import java.util.List;
+import java.util.concurrent.atomic.AtomicLong;
+import okhttp3.Call;
+import okhttp3.Callback;
+import okhttp3.Connection;
+import okhttp3.EventListener;
+import okhttp3.Handshake;
+import okhttp3.OkHttpClient;
+import okhttp3.Protocol;
+import okhttp3.Request;
+import okhttp3.Response;
+import okhttp3.ResponseBody;
+
+public final class PrintEvents {
+  private final OkHttpClient client = new OkHttpClient.Builder()
+      .eventListenerFactory(PrintingEventListener.FACTORY)
+      .build();
+
+  public void run() throws Exception {
+    Request washingtonPostRequest = new Request.Builder()
+        .url("https://www.washingtonpost.com/")
+        .build();
+    client.newCall(washingtonPostRequest).enqueue(new Callback() {
+      @Override public void onFailure(Call call, IOException e) {
+      }
+
+      @Override public void onResponse(Call call, Response response) throws IOException {
+        try (ResponseBody body = response.body()) {
+          // Consume and discard the response body.
+          body.source().readByteString();
+        }
+      }
+    });
+
+    Request newYorkTimesRequest = new Request.Builder()
+        .url("https://www.nytimes.com/")
+        .build();
+    client.newCall(newYorkTimesRequest).enqueue(new Callback() {
+      @Override public void onFailure(Call call, IOException e) {
+      }
+
+      @Override public void onResponse(Call call, Response response) throws IOException {
+        try (ResponseBody body = response.body()) {
+          // Consume and discard the response body.
+          body.source().readByteString();
+        }
+      }
+    });
+  }
+
+  public static void main(String... args) throws Exception {
+    new PrintEvents().run();
+  }
+
+  private static final class PrintingEventListener extends EventListener {
+    private static final Factory FACTORY = new Factory() {
+      final AtomicLong nextCallId = new AtomicLong(1L);
+
+      @Override public EventListener create(Call call) {
+        long callId = nextCallId.getAndIncrement();
+        System.out.printf("%04d %s%n", callId, call.request().url());
+        return new PrintingEventListener(callId, System.nanoTime());
+      }
+    };
+
+    final long callId;
+    final long callStartNanos;
+
+    public PrintingEventListener(long callId, long callStartNanos) {
+      this.callId = callId;
+      this.callStartNanos = callStartNanos;
+    }
+
+    private void printEvent(String name) {
+      long elapsedNanos = System.nanoTime() - callStartNanos;
+      System.out.printf("%04d %.3f %s%n", callId, elapsedNanos / 1000000000d, name);
+    }
+
+    @Override public void callStart(Call call) {
+      printEvent("callStart");
+    }
+
+    @Override public void dnsStart(Call call, String domainName) {
+      printEvent("dnsStart");
+    }
+
+    @Override public void dnsEnd(Call call, String domainName, List<InetAddress> inetAddressList) {
+      printEvent("dnsEnd");
+    }
+
+    @Override public void connectStart(
+        Call call, InetSocketAddress inetSocketAddress, Proxy proxy) {
+      printEvent("connectStart");
+    }
+
+    @Override public void secureConnectStart(Call call) {
+      printEvent("secureConnectStart");
+    }
+
+    @Override public void secureConnectEnd(Call call, Handshake handshake) {
+      printEvent("secureConnectEnd");
+    }
+
+    @Override public void connectEnd(
+        Call call, InetSocketAddress inetSocketAddress, Proxy proxy, Protocol protocol) {
+      printEvent("connectEnd");
+    }
+
+    @Override public void connectFailed(Call call, InetSocketAddress inetSocketAddress, Proxy proxy,
+        Protocol protocol, IOException ioe) {
+      printEvent("connectFailed");
+    }
+
+    @Override public void connectionAcquired(Call call, Connection connection) {
+      printEvent("connectionAcquired");
+    }
+
+    @Override public void connectionReleased(Call call, Connection connection) {
+      printEvent("connectionReleased");
+    }
+
+    @Override public void requestHeadersStart(Call call) {
+      printEvent("requestHeadersStart");
+    }
+
+    @Override public void requestHeadersEnd(Call call, Request request) {
+      printEvent("requestHeadersEnd");
+    }
+
+    @Override public void requestBodyStart(Call call) {
+      printEvent("requestBodyStart");
+    }
+
+    @Override public void requestBodyEnd(Call call, long byteCount) {
+      printEvent("requestBodyEnd");
+    }
+
+    @Override public void responseHeadersStart(Call call) {
+      printEvent("responseHeadersStart");
+    }
+
+    @Override public void responseHeadersEnd(Call call, Response response) {
+      printEvent("responseHeadersEnd");
+    }
+
+    @Override public void responseBodyStart(Call call) {
+      printEvent("responseBodyStart");
+    }
+
+    @Override public void responseBodyEnd(Call call, long byteCount) {
+      printEvent("responseBodyEnd");
+    }
+
+    @Override public void callEnd(Call call) {
+      printEvent("callEnd");
+    }
+
+    @Override public void callFailed(Call call, IOException ioe) {
+      printEvent("callFailed");
+    }
+  }
+}
/Fim/
diff --git a/samples/guide/src/main/java/okhttp3/recipes/PrintEventsNonConcurrent.java b/samples/guide/src/main/java/okhttp3/recipes/PrintEventsNonConcurrent.java
new file mode 100644
index 0000000..6acedb1
--- /dev/null
+++ b/samples/guide/src/main/java/okhttp3/recipes/PrintEventsNonConcurrent.java
@@ -0,0 +1,158 @@
+/*
+ * Copyright (C) 2017 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3.recipes;
+
+import java.io.IOException;
+import java.net.InetAddress;
+import java.net.InetSocketAddress;
+import java.net.Proxy;
+import java.util.List;
+import okhttp3.Call;
+import okhttp3.Connection;
+import okhttp3.EventListener;
+import okhttp3.Handshake;
+import okhttp3.OkHttpClient;
+import okhttp3.Protocol;
+import okhttp3.Request;
+import okhttp3.Response;
+
+/**
+ * This prints events for a single in-flight call. It won't work for multiple concurrent calls
+ * because we don't know what callStartNanos refers to.
+ */
+public final class PrintEventsNonConcurrent {
+  private final OkHttpClient client = new OkHttpClient.Builder()
+      .eventListener(new PrintingEventListener())
+      .build();
+
+  public void run() throws Exception {
+    Request request = new Request.Builder()
+        .url("https://publicobject.com/helloworld.txt")
+        .build();
+
+    System.out.println("REQUEST 1 (new connection)");
+    try (Response response = client.newCall(request).execute()) {
+      // Consume and discard the response body.
+      response.body().source().readByteString();
+    }
+
+    System.out.println("REQUEST 2 (pooled connection)");
+    try (Response response = client.newCall(request).execute()) {
+      // Consume and discard the response body.
+      response.body().source().readByteString();
+    }
+  }
+
+  public static void main(String... args) throws Exception {
+    new PrintEventsNonConcurrent().run();
+  }
+
+  private static final class PrintingEventListener extends EventListener {
+    long callStartNanos;
+
+    private void printEvent(String name) {
+      long nowNanos = System.nanoTime();
+      if (name.equals("callStart")) {
+        callStartNanos = nowNanos;
+      }
+      long elapsedNanos = nowNanos - callStartNanos;
+      System.out.printf("%.3f %s%n", elapsedNanos / 1000000000d, name);
+    }
+
+    @Override public void callStart(Call call) {
+      printEvent("callStart");
+    }
+
+    @Override public void dnsStart(Call call, String domainName) {
+      printEvent("dnsStart");
+    }
+
+    @Override public void dnsEnd(Call call, String domainName, List<InetAddress> inetAddressList) {
+      printEvent("dnsEnd");
+    }
+
+    @Override public void connectStart(
+        Call call, InetSocketAddress inetSocketAddress, Proxy proxy) {
+      printEvent("connectStart");
+    }
+
+    @Override public void secureConnectStart(Call call) {
+      printEvent("secureConnectStart");
+    }
+
+    @Override public void secureConnectEnd(Call call, Handshake handshake) {
+      printEvent("secureConnectEnd");
+    }
+
+    @Override public void connectEnd(
+        Call call, InetSocketAddress inetSocketAddress, Proxy proxy, Protocol protocol) {
+      printEvent("connectEnd");
+    }
+
+    @Override public void connectFailed(Call call, InetSocketAddress inetSocketAddress, Proxy proxy,
+        Protocol protocol, IOException ioe) {
+      printEvent("connectFailed");
+    }
+
+    @Override public void connectionAcquired(Call call, Connection connection) {
+      printEvent("connectionAcquired");
+    }
+
+    @Override public void connectionReleased(Call call, Connection connection) {
+      printEvent("connectionReleased");
+    }
+
+    @Override public void requestHeadersStart(Call call) {
+      printEvent("requestHeadersStart");
+    }
+
+    @Override public void requestHeadersEnd(Call call, Request request) {
+      printEvent("requestHeadersEnd");
+    }
+
+    @Override public void requestBodyStart(Call call) {
+      printEvent("requestBodyStart");
+    }
+
+    @Override public void requestBodyEnd(Call call, long byteCount) {
+      printEvent("requestBodyEnd");
+    }
+
+    @Override public void responseHeadersStart(Call call) {
+      printEvent("responseHeadersStart");
+    }
+
+    @Override public void responseHeadersEnd(Call call, Response response) {
+      printEvent("responseHeadersEnd");
+    }
+
+    @Override public void responseBodyStart(Call call) {
+      printEvent("responseBodyStart");
+    }
+
+    @Override public void responseBodyEnd(Call call, long byteCount) {
+      printEvent("responseBodyEnd");
+    }
+
+    @Override public void callEnd(Call call) {
+      printEvent("callEnd");
+    }
+
+    @Override public void callFailed(Call call, IOException ioe) {
+      printEvent("callFailed");
+    }
+  }
+}
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 36a9aee..47c1ea6 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index de25842..f4422df 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index c444a23..3ea5783 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index e2ff34c..0d01a77 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 4cf6878..0467966 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 275570d..5f7578c 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 3605a66..da8b132 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 6959cd9..dc2b989 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 3894bbc..9ce3d7e 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 09015c1..f859c8f 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index ab0b43d..0cc21d7 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.10.0-SNAPSHOT</version>
+  <version>3.9.1</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.9.1</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 77eea94..bf31ec5 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index c654656..ed17f38 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 4bb53c9..9ef5f67 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 347edef..db4517c 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index c76577e..2552440 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 30b3cb8..d33a1c5 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.9.1</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 47c1ea6..36a9aee 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index f4422df..de25842 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 3ea5783..c444a23 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 0d01a77..e2ff34c 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 0467966..4cf6878 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 5f7578c..275570d 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index da8b132..3605a66 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index dc2b989..6959cd9 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 9ce3d7e..3894bbc 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index f859c8f..09015c1 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 0cc21d7..ab0b43d 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.9.1</version>
+  <version>3.10.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.9.1</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index bf31ec5..77eea94 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index ed17f38..c654656 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 9ef5f67..4bb53c9 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index db4517c..347edef 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 2552440..c76577e 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index d33a1c5..30b3cb8 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.9.1</version>
+    <version>3.10.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 7183846..a85ae84 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,17 @@
 Change Log
 ==========
 
+## Version 3.9.1
+
+_2017-11-18_
+
+ *  New: Recover gracefully when Android's DNS crashes with an unexpected
+    `NullPointerException`.
+ *  New: Recover gracefully when Android's socket connections crash with an
+    unexpected `ClassCastException`.
+ *  Fix: Don't include the URL's fragment in `encodedQuery()` when the query
+    itself is empty.
+
 ## Version 3.9.0
 
 _2017-09-03_
/Fim/
diff --git a/README.md b/README.md
index b351426..e07bf83 100644
--- a/README.md
+++ b/README.md
@@ -11,12 +11,12 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>okhttp</artifactId>
-  <version>3.9.0</version>
+  <version>3.9.1</version>
 </dependency>
 ```
 or Gradle:
 ```groovy
-compile 'com.squareup.okhttp3:okhttp:3.9.0'
+compile 'com.squareup.okhttp3:okhttp:3.9.1'
 ```
 
 Snapshots of the development version are available in [Sonatype's `snapshots` repository][snap].
@@ -36,13 +36,13 @@
 <dependency>
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>mockwebserver</artifactId>
-  <version>3.9.0</version>
+  <version>3.9.1</version>
   <scope>test</scope>
 </dependency>
 ```
 or Gradle:
 ```groovy
-testCompile 'com.squareup.okhttp3:mockwebserver:3.9.0'
+testCompile 'com.squareup.okhttp3:mockwebserver:3.9.1'
 ```
 
 ProGuard
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
index eaaa4c0..119c186 100644
--- a/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
+++ b/okhttp-tests/src/test/java/okhttp3/URLConnectionTest.java
@@ -3429,6 +3429,16 @@
     assertEquals(1, requestB.getSequenceNumber());
   }
 
+  @Test public void nullSSLSocketFactory_throws() throws Exception {
+    server.useHttps(sslClient.socketFactory, false /* tunnelProxy */);
+    HttpsURLConnection connection = (HttpsURLConnection) server.url("/").url().openConnection();
+    try {
+      connection.setSSLSocketFactory(null);
+      fail();
+    } catch (IllegalArgumentException expected) {
+    }
+  }
+
   /**
    * We had a bug where we weren't closing Gzip streams on redirects.
    * https://github.com/square/okhttp/issues/441
/Fim/
diff --git a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java
index 0057174..9dc40b8 100644
--- a/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java
+++ b/okhttp-urlconnection/src/main/java/okhttp3/internal/huc/OkHttpsURLConnection.java
@@ -58,6 +58,9 @@
   }
 
   @Override public void setSSLSocketFactory(SSLSocketFactory sslSocketFactory) {
+    if (sslSocketFactory == null) {
+      throw new IllegalArgumentException("sslSocketFactory == null");
+    }
     // This fails in JDK 9 because OkHttp is unable to extract the trust manager.
     delegate.client = delegate.client.newBuilder()
         .sslSocketFactory(sslSocketFactory)
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index a85ae84..382e60b 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -1,6 +1,96 @@
 Change Log
 ==========
 
+## Version 3.10.0
+
+_2018-02-24_
+
+ *  **The pingInterval() feature now aggressively checks connectivity for web
+    sockets and HTTP/2 connections.**
+
+    Previously if you configured a ping interval that would cause OkHttp to send
+    pings, but it did not track whether the reply pongs were received. With this
+    update OkHttp requires that every ping receive a response: if it does not
+    the connection will be closed and the listener's `onFailure()` method will
+    be called.
+
+    Web sockets have always been had pings, but pings on HTTP/2 connections is
+    new in this release. Pings are used for connections that are busy carrying
+    calls and for idle connections in the connection pool. (Pings do not impact
+    when pooled connections are evicted).
+
+    If you have a configured ping interval, you should confirm that it is long
+    enough for a roundtrip from client to server. If your ping interval is too
+    short, slow connections may be misinterpreted as failed connections. A ping
+    interval of 30 seconds is reasonable for most use cases.
+
+ *  **OkHttp now supports [Conscrypt][conscrypt].** Conscrypt is a Java Security
+    Provider that integrates BoringSSL into the Java platform.
+
+    OkHttp will use Conscrypt if you set the `okhttp.platform` system property
+    to `conscrypt`.
+
+    Alternatively, OkHttp will also use Conscrypt if you install it as your
+    preferred security provider. To do so, add the following code to execute
+    before you create your `OkHttpClient`.
+
+    ```
+    Security.insertProviderAt(
+        new org.conscrypt.OpenSSLProvider(), 1);
+    ```
+
+    Conscrypt is the bundled security provider on Android so it is not necessary
+    to configure it on that platform.
+
+ *  New: `HttpUrl.addQueryParameter()` percent-escapes more characters.
+    Previously several ASCII punctuation characters were not percent-escaped
+    when used with this method. This does not impact already-encoded query
+    parameters in APIs like `HttpUrl.parse()` and
+    `HttpUrl.Builder.addEncodedQueryParameter()`.
+ *  New: CBC-mode ECDSA cipher suites have been removed from OkHttp's default
+    configuration: `TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA` and
+    `TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA`. This tracks a [Chromium
+    change][remove_cbc_ecdsa] to remove these cipher suites because they are
+    fragile and rarely-used.
+ *  New: Don't fall back to common name (CN) verification for hostnames. This
+    behavior was deprecated with RFC 2818 in May 2000 and was recently dropped
+    from major web browsers.
+ *  New: Honor the `Retry-After` response header. HTTP 503 (Unavailable)
+    responses are retried automatically if this header is present and its delay
+    is 0 seconds. HTTP 408 (Client Timeout) responses are retried automatically
+    if the header is absent or its delay is 0 seconds.
+ *  New: Allow request bodies for all HTTP methods except GET and HEAD.
+ *  New: Automatic module name of `okhttp3` for use with the Java Platform
+    Module System.
+ *  New: Log gzipped bodies when `HttpLoggingInterceptor` is used as a network
+    interceptor.
+ *  New: `Protocol.QUIC` constant. This protocol is not supported but this
+    constant is included for completeness.
+ *  New: Upgrade to Okio 1.14.0.
+
+     ```xml
+     <dependency>
+       <groupId>com.squareup.okio</groupId>
+       <artifactId>okio</artifactId>
+       <version>1.14.0</version>
+     </dependency>
+
+     com.squareup.okio:okio:1.14.0
+     ```
+
+ *  Fix: Handle `HTTP/1.1 100 Continue` status lines, even on requests that did
+    not send the `Expect: continue` request header.
+ *  Fix: Do not count web sockets toward the dispatcher's per-host connection
+    limit.
+ *  Fix: Avoid using invalid HTTPS sessions. This prevents OkHttp from crashing
+    with the error, `Unexpected TLS version: NONE`.
+ *  Fix: Don't corrupt the response cache when a 304 (Not Modified) response
+    overrides the stored "Content-Encoding" header.
+ *  Fix: Gracefully shut down the HTTP/2 connection before it exhausts the
+    namespace of stream IDs (~536 million streams).
+ *  Fix: Never pass a null `Route` to `Authenticator`. There was a bug where
+    routes were omitted for eagerly-closed connections.
+
 ## Version 3.9.1
 
 _2017-11-18_
@@ -1382,3 +1472,5 @@
  [junit_5_rules]: http://junit.org/junit5/docs/current/user-guide/#migrating-from-junit4-rulesupport
  [public_suffix]: https://publicsuffix.org/
  [maven_provided]: https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html
+ [remove_cbc_ecdsa]: https://developers.google.com/web/updates/2016/12/chrome-56-deprecations#remove_cbc-mode_ecdsa_ciphers_in_tls
+ [conscrypt]: https://github.com/google/conscrypt/
\ No newline at end of file
/Fim/
diff --git a/CHANGELOG.md b/CHANGELOG.md
index 382e60b..7a7fdc8 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -25,7 +25,12 @@
     interval of 30 seconds is reasonable for most use cases.
 
  *  **OkHttp now supports [Conscrypt][conscrypt].** Conscrypt is a Java Security
-    Provider that integrates BoringSSL into the Java platform.
+    Provider that integrates BoringSSL into the Java platform. Conscrypt
+    supports more cipher suites than the JVMs default provider and may also
+    execute more efficiently.
+
+    To use it, first register a [Conscrypt dependency][conscrypt_dependency] in
+    your build system.
 
     OkHttp will use Conscrypt if you set the `okhttp.platform` system property
     to `conscrypt`.
@@ -1473,4 +1478,5 @@
  [public_suffix]: https://publicsuffix.org/
  [maven_provided]: https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html
  [remove_cbc_ecdsa]: https://developers.google.com/web/updates/2016/12/chrome-56-deprecations#remove_cbc-mode_ecdsa_ciphers_in_tls
- [conscrypt]: https://github.com/google/conscrypt/
\ No newline at end of file
+ [conscrypt]: https://github.com/google/conscrypt/
+ [conscrypt_dependency]: https://github.com/google/conscrypt/#download
\ No newline at end of file
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 63681f7..8e3b85b 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 56dc2ae..48b9f0a 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index 9f624ed..a4380b6 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 53420fc..54ee02b 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index 14b0e16..bc50b50 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index c4f86d5..04ea0ff 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 0eaa9ff..51bec5d 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index 6c92951..f642989 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 28fa13d..7f1fa9d 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 7eaae2c..98ea47b 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index acb9902..8b87c20 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.10.0-SNAPSHOT</version>
+  <version>3.10.0</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>HEAD</tag>
+    <tag>parent-3.10.0</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 77eea94..8f10a46 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index c654656..c7d0aae 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 4bb53c9..1a25807 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index 347edef..afd05db 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index c76577e..913d0ef 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index 30b3cb8..ca8cd81 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0-SNAPSHOT</version>
+    <version>3.10.0</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/benchmarks/pom.xml b/benchmarks/pom.xml
index 8e3b85b..7bf9ca0 100644
--- a/benchmarks/pom.xml
+++ b/benchmarks/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>benchmarks</artifactId>
/Fim/
diff --git a/mockwebserver/pom.xml b/mockwebserver/pom.xml
index 48b9f0a..a80b23b 100644
--- a/mockwebserver/pom.xml
+++ b/mockwebserver/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>mockwebserver</artifactId>
/Fim/
diff --git a/okcurl/pom.xml b/okcurl/pom.xml
index a4380b6..f6dfcd5 100644
--- a/okcurl/pom.xml
+++ b/okcurl/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okcurl</artifactId>
/Fim/
diff --git a/okhttp-android-support/pom.xml b/okhttp-android-support/pom.xml
index 54ee02b..e31fa73 100644
--- a/okhttp-android-support/pom.xml
+++ b/okhttp-android-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-android-support</artifactId>
/Fim/
diff --git a/okhttp-apache/pom.xml b/okhttp-apache/pom.xml
index bc50b50..ad3883e 100644
--- a/okhttp-apache/pom.xml
+++ b/okhttp-apache/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-apache</artifactId>
/Fim/
diff --git a/okhttp-logging-interceptor/pom.xml b/okhttp-logging-interceptor/pom.xml
index 04ea0ff..7e8eb5c 100644
--- a/okhttp-logging-interceptor/pom.xml
+++ b/okhttp-logging-interceptor/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>logging-interceptor</artifactId>
/Fim/
diff --git a/okhttp-testing-support/pom.xml b/okhttp-testing-support/pom.xml
index 51bec5d..a52279d 100644
--- a/okhttp-testing-support/pom.xml
+++ b/okhttp-testing-support/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-testing-support</artifactId>
/Fim/
diff --git a/okhttp-tests/pom.xml b/okhttp-tests/pom.xml
index f642989..4247ce1 100644
--- a/okhttp-tests/pom.xml
+++ b/okhttp-tests/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-tests</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/pom.xml b/okhttp-urlconnection/pom.xml
index 7f1fa9d..585b357 100644
--- a/okhttp-urlconnection/pom.xml
+++ b/okhttp-urlconnection/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp-urlconnection</artifactId>
/Fim/
diff --git a/okhttp/pom.xml b/okhttp/pom.xml
index 98ea47b..29f38b6 100644
--- a/okhttp/pom.xml
+++ b/okhttp/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>okhttp</artifactId>
/Fim/
diff --git a/pom.xml b/pom.xml
index 8b87c20..dc7580d 100644
--- a/pom.xml
+++ b/pom.xml
@@ -11,7 +11,7 @@
 
   <groupId>com.squareup.okhttp3</groupId>
   <artifactId>parent</artifactId>
-  <version>3.10.0</version>
+  <version>3.11.0-SNAPSHOT</version>
   <packaging>pom</packaging>
 
   <name>OkHttp (Parent)</name>
@@ -63,7 +63,7 @@
     <url>https://github.com/square/okhttp/</url>
     <connection>scm:git:https://github.com/square/okhttp.git</connection>
     <developerConnection>scm:git:git@github.com:square/okhttp.git</developerConnection>
-    <tag>parent-3.10.0</tag>
+    <tag>HEAD</tag>
   </scm>
 
   <issueManagement>
/Fim/
diff --git a/samples/crawler/pom.xml b/samples/crawler/pom.xml
index 8f10a46..81a9d1a 100644
--- a/samples/crawler/pom.xml
+++ b/samples/crawler/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>crawler</artifactId>
/Fim/
diff --git a/samples/guide/pom.xml b/samples/guide/pom.xml
index c7d0aae..43a4633 100644
--- a/samples/guide/pom.xml
+++ b/samples/guide/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>guide</artifactId>
/Fim/
diff --git a/samples/pom.xml b/samples/pom.xml
index 1a25807..240093f 100644
--- a/samples/pom.xml
+++ b/samples/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3</groupId>
     <artifactId>parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <groupId>com.squareup.okhttp3.sample</groupId>
/Fim/
diff --git a/samples/simple-client/pom.xml b/samples/simple-client/pom.xml
index afd05db..f278111 100644
--- a/samples/simple-client/pom.xml
+++ b/samples/simple-client/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>simple-client</artifactId>
/Fim/
diff --git a/samples/slack/pom.xml b/samples/slack/pom.xml
index 913d0ef..271cdbf 100644
--- a/samples/slack/pom.xml
+++ b/samples/slack/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>slack</artifactId>
/Fim/
diff --git a/samples/static-server/pom.xml b/samples/static-server/pom.xml
index ca8cd81..4fdd5fa 100644
--- a/samples/static-server/pom.xml
+++ b/samples/static-server/pom.xml
@@ -6,7 +6,7 @@
   <parent>
     <groupId>com.squareup.okhttp3.sample</groupId>
     <artifactId>sample-parent</artifactId>
-    <version>3.10.0</version>
+    <version>3.11.0-SNAPSHOT</version>
   </parent>
 
   <artifactId>static-server</artifactId>
/Fim/
diff --git a/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java b/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java
index 104d719..9b079a9 100644
--- a/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java
+++ b/okhttp-urlconnection/src/test/java/okhttp3/UrlConnectionCacheTest.java
@@ -1079,7 +1079,7 @@
     Date lastModifiedDate = new Date(System.currentTimeMillis() + TimeUnit.HOURS.toMillis(-1));
     Date servedDate = new Date(System.currentTimeMillis() + TimeUnit.HOURS.toMillis(-2));
     DateFormat dateFormat = new SimpleDateFormat("EEE dd-MMM-yyyy HH:mm:ss z", Locale.US);
-    dateFormat.setTimeZone(TimeZone.getTimeZone("EDT"));
+    dateFormat.setTimeZone(TimeZone.getTimeZone("America/New_York"));
     String lastModifiedString = dateFormat.format(lastModifiedDate);
     String servedString = dateFormat.format(servedDate);
 
/Fim/
diff --git a/pom.xml b/pom.xml
index de786e1..62bf151 100644
--- a/pom.xml
+++ b/pom.xml
@@ -45,7 +45,7 @@
     <alpn.jdk7.version>7.1.2.v20141202</alpn.jdk7.version>
     <android.version>4.1.1.4</android.version>
     <animal.sniffer.version>1.15</animal.sniffer.version>
-    <apache.http.version>4.2.2</apache.http.version>
+    <apache.http.version>4.2.6</apache.http.version>
     <bouncycastle.version>1.50</bouncycastle.version>
     <guava.version>16.0</guava.version>
     <java.version>1.7</java.version>
@@ -135,7 +135,7 @@
         <plugin>
           <groupId>org.apache.maven.plugins</groupId>
           <artifactId>maven-compiler-plugin</artifactId>
-          <version>3.6.1</version>
+          <version>3.7.0</version>
           <configuration>
             <compilerId>javac-with-errorprone</compilerId>
             <forceJavacCompilerUse>true</forceJavacCompilerUse>
@@ -146,12 +146,12 @@
             <dependency>
               <groupId>org.codehaus.plexus</groupId>
               <artifactId>plexus-compiler-javac-errorprone</artifactId>
-              <version>2.8.1</version>
+              <version>2.8.4</version>
             </dependency>
             <dependency>
               <groupId>com.google.errorprone</groupId>
               <artifactId>error_prone_core</artifactId>
-              <version>2.0.16</version>
+              <version>2.3.1</version>
             </dependency>
           </dependencies>
         </plugin>
@@ -159,7 +159,7 @@
         <plugin>
           <groupId>org.apache.maven.plugins</groupId>
           <artifactId>maven-surefire-plugin</artifactId>
-          <version>2.17</version>
+          <version>2.21.0</version>
           <configuration>
             <systemPropertyVariables>
               <okhttp.platform>${okhttp.platform}</okhttp.platform>
@@ -181,7 +181,7 @@
             <dependency>
               <groupId>org.apache.maven.surefire</groupId>
               <artifactId>surefire-junit47</artifactId>
-              <version>2.17</version>
+              <version>2.21.0</version>
             </dependency>
           </dependencies>
         </plugin>
/Fim/
diff --git a/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java b/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java
index a0409a1..2385292 100644
--- a/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java
+++ b/okhttp-tests/src/test/java/okhttp3/internal/http2/HttpOverHttp2Test.java
@@ -819,6 +819,70 @@
     assertEquals(0, server.takeRequest().getSequenceNumber()); // New connection.
   }
 
+  @Test public void recoverFromCancelReusesConnection() throws Exception {
+    server.enqueue(new MockResponse()
+        .setBodyDelay(10, TimeUnit.SECONDS)
+        .setBody("abc"));
+    server.enqueue(new MockResponse()
+        .setBody("def"));
+
+    client = client.newBuilder()
+        .dns(new DoubleInetAddressDns())
+        .build();
+
+    callAndCancel(0);
+
+    // Make a second request to ensure the connection is reused.
+    Call call = client.newCall(new Request.Builder()
+        .url(server.url("/"))
+        .build());
+    Response response = call.execute();
+    assertEquals("def", response.body().string());
+    assertEquals(1, server.takeRequest().getSequenceNumber());
+  }
+
+  @Test public void recoverFromMultipleCancelReusesConnection() throws Exception {
+    server.enqueue(new MockResponse()
+            .setBodyDelay(10, TimeUnit.SECONDS)
+            .setBody("abc"));
+    server.enqueue(new MockResponse()
+            .setBodyDelay(10, TimeUnit.SECONDS)
+            .setBody("def"));
+    server.enqueue(new MockResponse()
+            .setBody("ghi"));
+
+    client = client.newBuilder()
+            .dns(new DoubleInetAddressDns())
+            .build();
+
+    callAndCancel(0);
+    callAndCancel(1);
+
+    // Make a third request to ensure the connection is reused.
+    Call call = client.newCall(new Request.Builder()
+            .url(server.url("/"))
+            .build());
+    Response response = call.execute();
+    assertEquals("ghi", response.body().string());
+    assertEquals(2, server.takeRequest().getSequenceNumber());
+  }
+
+  /** Make a call and canceling it as soon as it's accepted by the server. */
+  private void callAndCancel(int expectedSequenceNumber) throws InterruptedException {
+    Call call = client.newCall(new Request.Builder()
+        .url(server.url("/"))
+        .build());
+    call.enqueue(new Callback() {
+      @Override public void onFailure(Call call1, IOException e) {
+      }
+
+      @Override public void onResponse(Call call1, Response response) {
+      }
+    });
+    assertEquals(expectedSequenceNumber, server.takeRequest().getSequenceNumber());
+    call.cancel();
+  }
+
   @Test public void noRecoveryFromRefusedStreamWithRetryDisabled() throws Exception {
     noRecoveryFromErrorWithRetryDisabled(ErrorCode.REFUSED_STREAM);
   }
@@ -854,7 +918,7 @@
         .setResponseCode(401));
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.RESET_STREAM_AT_START)
-        .setHttp2ErrorCode(ErrorCode.CANCEL.httpCode));
+        .setHttp2ErrorCode(ErrorCode.INTERNAL_ERROR.httpCode));
     server.enqueue(new MockResponse()
         .setBody("DEF"));
     server.enqueue(new MockResponse()
/Fim/
diff --git a/okhttp/src/main/java/okhttp3/internal/connection/StreamAllocation.java b/okhttp/src/main/java/okhttp3/internal/connection/StreamAllocation.java
index e6025fd..74a8ca4 100644
--- a/okhttp/src/main/java/okhttp3/internal/connection/StreamAllocation.java
+++ b/okhttp/src/main/java/okhttp3/internal/connection/StreamAllocation.java
@@ -427,13 +427,16 @@
 
     synchronized (connectionPool) {
       if (e instanceof StreamResetException) {
-        StreamResetException streamResetException = (StreamResetException) e;
-        if (streamResetException.errorCode == ErrorCode.REFUSED_STREAM) {
+        ErrorCode errorCode = ((StreamResetException) e).errorCode;
+        if (errorCode == ErrorCode.REFUSED_STREAM) {
+          // Retry REFUSED_STREAM errors once on the same connection.
           refusedStreamCount++;
-        }
-        // On HTTP/2 stream errors, retry REFUSED_STREAM errors once on the same connection. All
-        // other errors must be retried on a new connection.
-        if (streamResetException.errorCode != ErrorCode.REFUSED_STREAM || refusedStreamCount > 1) {
+          if (refusedStreamCount > 1) {
+            noNewStreams = true;
+            route = null;
+          }
+        } else if (errorCode != ErrorCode.CANCEL) {
+          // Keep the connection for CANCEL errors. Everything else wants a fresh connection.
           noNewStreams = true;
           route = null;
         }
/Fim/
